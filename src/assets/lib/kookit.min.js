import e from"chinese-s2t";import t from"underscore";import i from"rangy/lib/rangy-core.js";import"rangy/lib/rangy-textrange";import r from"jszip";import{unzlibSync as n}from"fflate";import o from"chardet";import s from"js-untar";import a from"mammoth";import{marked as l}from"marked";import c from"mhtml2html";function h(e,t,i,r){return new(i||(i=Promise))((function(n,o){function s(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))}const d=e=>e?parseFloat(e+""):0,u=(e,t)=>h(void 0,void 0,void 0,(function*(){let i="";if(e.load){let t=yield fetch(yield e.load()).then((e=>e.blob()));i=yield t.text()}return t||(e.loadAsset&&(i=yield p(i,e.loadAsset)),i=g(i)),i})),f=e=>Array.from(e.querySelectorAll("img, image")),p=(e,t)=>h(void 0,void 0,void 0,(function*(){let i=(new DOMParser).parseFromString(e,"text/html"),r=f(i);for(let e=0;e<r.length;e++)r[e].getAttribute("src")?r[e].src=yield t(r[e].getAttribute("src")):r[e].getAttribute("xlink:href")&&r[e].setAttribute("xlink:href",yield t(r[e].getAttribute("xlink:href")));let n=Array.from(i.getElementsByTagName("link"));for(let e=0;e<n.length;e++){const i=n[e];i.getAttribute("href")&&(i.href=yield t(i.getAttribute("href")))}return i.documentElement.innerHTML})),g=e=>{var t;let i=(new DOMParser).parseFromString(e,"text/html"),r=f(i);if(0===r.length)return e;for(let e=0;e<r.length;e++)if("image"!==r[e].tagName){var n=document.createElement("kookitmarker"),o=document.createTextNode("img");n.appendChild(o),n.setAttribute("style","visibility: hidden; position: absolute;display: inline-block; width: 0; height: 0;"),null===(t=r[e])||void 0===t||t.insertAdjacentElement("afterend",n)}return i.documentElement.innerHTML},m=(e,t="")=>{var i=document.createElement("iframe");i.style.width="100%",i.style.border="0",i.style.margin="0",i.style.padding="0",i.style.minHeight="calc(100% - 2px)",i.style.fontSize="100%",i.style.font="inherit",i.scrolling="no",i.tabIndex=0,i.id="kookit-iframe",i.style.verticalAlign="baseline",e.innerHTML="",e.appendChild(i)},y=(e,t,i)=>{let r=Math.floor(i.clientWidth/12),n=r%2==0?r:r-1;return{totalPage:"scroll"===e?1:"single"===e?Math.round(parseFloat(t.body.scrollWidth/(t.body.clientWidth+n)+"")):2*Math.round(parseFloat(t.body.scrollWidth/(t.body.clientWidth+n)+"")),currentPage:Math.round(parseFloat(d(t.body.scrollLeft)/(t.body.clientWidth+n)+""))+1}},b=e=>{let t=e.querySelectorAll("a, article, cite, div, li, p, span, pre, table, bold, font");for(let e=0;e<t.length;e++){const i=t[e];-1===i.className.indexOf("kookit-text")&&(i.className=i.className+" kookit-text")}let i=e.querySelectorAll("h1, h2, h3, h4, h5, h6, title");for(let e=0;e<i.length;e++){const t=i[e];-1===t.className.indexOf("kookit-title")&&(t.className=t.className+" kookit-title")}},v=e=>h(void 0,void 0,void 0,(function*(){const t=new Image;t.src=e;try{yield t.decode()}catch(e){console.error(e)}return t})),w=(e,t,i,r)=>h(void 0,void 0,void 0,(function*(){let n=Math.floor(e.clientWidth/12),o=n%2==0?n:n-1,s=r.querySelectorAll("img, image");for(let n of s){let s=n.parentElement,a=0,l=0,c=n.naturalWidth,h=n.naturalHeight;if("image"===n.tagName){let e=yield v(n.getAttribute("xlink:href"));c=e.naturalWidth,h=e.naturalHeight}if(i.startsWith("CB")&&"scroll"===t)l=s.offsetWidth;else if(i.startsWith("CB")&&"single"===t)a=e.clientHeight,l=e.clientWidth;else if(s&&c&&h){h/c>s.clientHeight/s.clientWidth?(a=s.clientHeight,l=parseInt(a*c/h+"")):(l=s.clientWidth,a=parseInt(l*h/c+"")),a>r.body.clientHeight&&(l=parseInt(l*(r.body.clientHeight/a)+""),a=r.body.clientHeight)}else s&&s.clientWidth&&s.clientWidth>0?(l=s.clientWidth,a=s.clientHeight):(l=e.clientWidth,a=e.clientHeight);l=l?Math.min("scroll"===t||"single"===t?e.clientWidth:(e.clientWidth-o)/2,l):"scroll"===t||"single"===t?e.clientWidth:(e.clientWidth-o)/2,c&&h&&(c>h||a/l>h/c?a=l*(h/c):l=a*(c/h)),(l||a)&&n.setAttribute("style",(n.getAttribute("style")?n.getAttribute("style"):"")+";"+`max-width: ${l>0?l+"px":""};max-height:${a>0?a+"px":""}; margin: 0 auto; ${i.startsWith("CB")?`margin-left: calc(100% - ${n.clientWidth}px);`:""}`),i.startsWith("CB")&&"scroll"===t&&n.setAttribute("style",(n.getAttribute("style")?n.getAttribute("style"):"")+";margin-left: 0px; width: 100%;"),i.startsWith("CB")&&"scroll"!==t&&n.setAttribute("style",(n.getAttribute("style")?n.getAttribute("style"):"")+`;margin-left: calc(50% - ${n.getBoundingClientRect().width/2}px);`)}})),x=(e,t,i)=>{let r=i.createElement("style");if(r.id="default-style",r.textContent="p,empty-line{display: inherit;margin-block-start: inherit;margin-block-end: inherit;margin-inline-start: inherit;margin-inline-end: inherit;}body{margin: 0px}",i.head.appendChild(r),"scroll"===t)return;let n="double"===t?2:1,o=Math.floor(e.clientWidth/12),s=o%2==0?o:o-1;i.body.setAttribute("style",`width: auto;height: 100%;overflow-y: hidden;overflow-X: hidden;padding-left: 0px;padding-right: 0px;margin: 0px;box-sizing: border-box;touch-action:none; overscroll-behavior: none;max-width: inherit;column-fill: auto;column-gap: ${s}px; column-width: ${(e.clientWidth-s)/n}px;`)};function C(e){const t=e.getSelection();if(!t)return null;if(t.rangeCount>0){return t.getRangeAt(0).startContainer.parentElement}return null}const L=e=>"string"==typeof e||e instanceof String;class T{constructor(e){this.book=e,this.chapterList=[],this.flattenChapters=[],this.chapterDocList=[]}unescapeHtml(e){if(!e)return"";return(new DOMParser).parseFromString(e,"text/html").documentElement.textContent||""}getChapter(e){return h(this,void 0,void 0,(function*(){return this.chapterList=e?yield Promise.all(e.map((e=>h(this,void 0,void 0,(function*(){let t=-1;try{t=e.href&&(yield this.book.resolveHref(e.href))?(yield this.book.resolveHref(e.href)).index:-1}catch(e){console.error(e)}return{label:this.unescapeHtml(e.label)?this.unescapeHtml(e.label):t+"",href:e.href?e.href:"title"+t,index:t,subitems:e.subitems?yield this.getChapter(e.subitems):[]}}))))):yield Promise.all(this.book.sections.map(((e,t)=>h(this,void 0,void 0,(function*(){return{label:this.unescapeHtml(e.label)?this.unescapeHtml(e.label):t+"",href:e.href?e.href:"title"+t,index:t,subitems:e.subitems?yield this.getChapter(e.subitems):[]}}))))),this.flattenChapters=this.flatChapter(this.chapterList),this.chapterList}))}getChapterDoc(){return h(this,void 0,void 0,(function*(){const e=this.flattenChapters.map((e=>e.index));return this.book.sections.map(((t,i)=>e.indexOf(i)>-1?{label:this.unescapeHtml(this.flattenChapters[e.indexOf(i)].label),href:this.flattenChapters[e.indexOf(i)].href,text:t}:{label:"",href:"",text:t}))}))}flatChapter(e){let t=[];for(let i=0;i<e.length;i++)e[i].subitems&&e[i].subitems.length>0?(t.push(e[i]),t=t.concat(this.flatChapter(e[i].subitems))):t.push(e[i]);return t}getMetadata(){return new Promise(((e,t)=>h(this,void 0,void 0,(function*(){const i=this.book.metadata;let r=i.author&&i.author[0]&&i.author[0].name&&L(i.author[0].name)?i.author[0].name:i.author&&i.author[0]&&L(i.author[0])?i.author[0]:i.author&&L(i.author)?i.author:"";try{const t=yield this.book.getCover();var n=new FileReader;n.readAsDataURL(t),n.onloadend=()=>{e({name:i.title,author:r,description:i.description,publisher:i.publisher,cover:n.result})}}catch(n){console.error(n);try{e({name:i.title,author:r,description:i.description,publisher:i.publisher,cover:""})}catch(e){console.error(e),t(e)}}}))))}}const M=(e,t)=>[-1,...t,e.length].reduce((({xs:t,a:i},r)=>({xs:t?.concat([e.slice(i+1,r)])??[],a:r})),{}).xs,S=/\d/,D=/^epubcfi\((.*)\)$/,k=e=>e.replace(/[\^[\](),;=]/g,"^$&"),A=(e,t)=>{return i=([e])=>e===t,e.map(((e,t,r)=>i(e,t,r)?t:null)).filter((e=>null!=e));var i},I=e=>{const t=[];let i;for(const[r,n]of e){if("/"===r)t.push({index:n});else{const e=t[t.length-1];if(":"===r)e.offset=n;else if("~"===r)e.temporal=n;else if("@"===r)e.spatial=(e.spatial??[]).concat(n);else if(";s"===r)e.side=n;else if("["===r){if("/"!==i||!n){e.text=(e.text??[]).concat(n);continue}e.id=n}}i=r}return t},E=e=>M(e,A(e,"!")).map(I),N=e=>{const t=(e=>{const t=[];let i,r,n="";const o=e=>(t.push(e),i=null,n=""),s=e=>(n+=e,r=!1);for(const t of Array.from(e.trim()).concat(""))if("^"!==t||r){if("!"===i)o(["!"]);else if(","===i)o([","]);else if("/"===i||":"===i){if(S.test(t)){s(t);continue}o([i,parseInt(n)])}else if("~"===i){if(S.test(t)||"."===t){s(t);continue}o(["~",parseFloat(n)])}else if("@"===i){if(":"===t){o(["@",parseFloat(n)]),i="@";continue}if(S.test(t)||"."===t){s(t);continue}o(["@",parseFloat(n)])}else{if("["===i){";"!==t||r?","!==t||r?"]"!==t||r?s(t):o(["[",n]):(o(["[",n]),i="["):(o(["[",n]),i=";");continue}if(i?.startsWith(";")){"="!==t||r?";"!==t||r?"]"!==t||r?s(t):o([i,n]):(o([i,n]),i=";"):(i=`;${n}`,n="");continue}}"/"!==t&&":"!==t&&"~"!==t&&"@"!==t&&"["!==t&&"!"!==t&&","!==t||(i=t)}else r=!0;return t})((i=e,i.match(D)?.[1]??i));var i;const r=A(t,",");if(!r.length)return E(t);const[n,o,s]=M(t,r).map(E);return{parent:n,start:o,end:s}},R=({index:e,id:t,offset:i,temporal:r,spatial:n,text:o,side:s})=>{const a=s?`;s=${s}`:"";return`/${e}`+(t?`[${k(t)}${a}]`:"")+(null!=i&&e%2?`:${i}`:"")+(r?`~${r}`:"")+(n?`@${n.join(":")}`:"")+(o||!t&&s?"["+(o?.map(k)?.join(",")??"")+a+"]":"")},B=e=>e.parent?[e.parent,e.start,e.end].map(B).join(","):e.map((e=>e.map(R).join(""))).join("!"),P=e=>{return t=B(e),D.test(t)?t:`epubcfi(${t})`;var t},O=(e,t)=>{return"string"==typeof e?P(O(N(e),t)):e.parent?(i=e.parent,r=e[t?"end":"start"],i.slice(0,-1).concat([i[i.length-1].concat(r[0])]).concat(r.slice(1))):e;var i,r},H=({nodeType:e})=>3===e||4===e,F=({nodeType:e})=>1===e,W=e=>{const t=Array.from(e.childNodes).filter((e=>H(e)||F(e))).reduce(((e,t)=>{let i=e[e.length-1];return i?H(t)?Array.isArray(i)?i.push(t):H(i)?e[e.length-1]=[i,t]:e.push(t):F(i)?e.push(null,t):e.push(t):e.push(t),e}),[]);return F(t[0])&&t.unshift("first"),F(t[t.length-1])&&t.push("last"),t.unshift("before"),t.push("after"),t},$=(e,t)=>e?W(e)[t]:null,j=(e,t)=>{const{id:i}=t[t.length-1];if(i){const t=e.ownerDocument.getElementById(i);if(t)return{node:t,offset:0}}for(const{index:i}of t){const t=$(e,i);if("first"===t)return{node:e.firstChild??e};if("last"===t)return{node:e.lastChild??e};if("before"===t)return{node:e,before:!0};if("after"===t)return{node:e,after:!0};e=t}const{offset:r}=t[t.length-1];if(!Array.isArray(e))return{node:e,offset:r};let n=0;for(const t of e){const{length:e}=t.nodeValue;if(n+e>=r)return{node:t,offset:r-n};n+=e}},U=(e,t)=>{const{parentNode:i,id:r}=e,n=W(i),o=n.findIndex((t=>Array.isArray(t)?t.some((t=>t===e)):t===e)),s=n[o];if(Array.isArray(s)){let i=0;for(const r of s){if(r===e){i+=t;break}i+=r.nodeValue.length}t=i}const a={id:r,index:o,offset:t};return i!==e.ownerDocument.documentElement?U(i).concat(a):[a]},q=(e,t)=>j(e.documentElement,O(t)).node,z="urn:oasis:names:tc:opendocument:xmlns:container",X="http://www.w3.org/1999/xhtml",V="http://www.idpf.org/2007/opf",J="http://www.idpf.org/2007/ops",G="http://purl.org/dc/elements/1.1/",_="http://www.w3.org/2001/04/xmlenc#",Z="http://www.daisy.org/z3986/2005/ncx/",Y="http://www.w3.org/1999/xlink",K="http://www.w3.org/ns/SMIL",Q={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},ee=e=>e.toLowerCase().replace(/[-:](.)/g,((e,t)=>t.toUpperCase())),te=(e,t,i)=>i?i=>i.getAttribute(e)?.split(/\s/)?.includes(t):"function"==typeof t?i=>t(i.getAttribute(e)):i=>i.getAttribute(e)===t,ie=(...e)=>t=>t?Object.fromEntries(e.map((e=>[ee(e),t.getAttribute(e)]))):null,re=e=>{return t=e?.textContent,t?t.trim().replace(/\s{2,}/g," "):"";var t},ne=(e,t)=>{const i=e.lookupNamespaceURI(null)===t||e.lookupPrefix(t),r=i?(e,i)=>e=>e.namespaceURI===t&&e.localName===i:(e,t)=>e=>e.localName===t;return{$:(e,t)=>[...e.children].find(r(e,t)),$$:(e,t)=>[...e.children].filter(r(e,t)),$$$:i?(e,i)=>[...e.getElementsByTagNameNS(t,i)]:(e,i)=>[...e.getElementsByTagName(t,i)]}},oe=(e,t)=>{try{if(t.includes(":"))return new URL(e,t);const i="whatever://whatever/";return decodeURI(new URL(e,i+t).href.replace(i,""))}catch(t){return console.warn(t),e}},se=e=>/^(?!blob)\w+:/i.test(e),ae=async(e,t,i)=>{const r=[];e.replace(t,((...e)=>(r.push(e),null)));const n=[];for(const e of r)n.push(await i(...e));return e.replace(t,(()=>n.shift()))},le=e=>e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),ce={attrs:["dir","xml:lang"]},he={name:"alternate-script",many:!0,...ce,props:["file-as"]},de={many:!0,...ce,props:[{name:"role",many:!0,attrs:["scheme"]},"file-as",he]},ue=[{name:"title",many:!0,...ce,props:["title-type","display-seq","file-as",he]},{name:"identifier",many:!0,props:[{name:"identifier-type",attrs:["scheme"]}]},{name:"language",many:!0},{name:"creator",...de},{name:"contributor",...de},{name:"publisher",...ce,props:["file-as",he]},{name:"description",...ce,props:[he]},{name:"rights",...ce,props:[he]},{name:"date"},{name:"dcterms:modified",type:"meta"},{name:"subject",many:!0,...ce,props:["term","authority",he]},{name:"belongs-to-collection",type:"meta",many:!0,...ce,props:["collection-type","group-position","dcterms:identifier","file-as",he,{name:"belongs-to-collection",recursive:!0}]}],fe=(e,t=e=>e)=>{const{$:i,$$:r,$$$:n}=ne(e,X),o=e=>r=>{const n=i(r,"a")??i(r,"span"),o=i(r,"ol"),a=(e=>e?decodeURI(t(e)):null)(n?.getAttribute("href")),l={label:re(n)||n?.getAttribute("title"),href:a,subitems:s(o)};return e&&(l.type=n?.getAttributeNS(J,"type")?.split(/\s/)),l},s=(e,t)=>e?r(e,"li").map(o(t)):null,a=(e,t)=>s(i(e,"ol"),t),l=n(e,"nav");let c=null,h=null,d=null,u=[];for(const e of l){const t=e.getAttributeNS(J,"type")?.split(/\s/)??[];t.includes("toc")?c??=a(e):t.includes("page-list")?h??=a(e):t.includes("landmarks")?d??=a(e,!0):u.push({label:re(e.firstElementChild),type:t,list:a(e)})}return{toc:c,pageList:h,landmarks:d,others:u}},pe=(e,t=e=>e)=>{const{$:i,$$:r}=ne(e,Z),n=e=>{const o=i(e,"navLabel"),s=i(e,"content"),a=re(o),l=(e=>e?decodeURI(t(e)):null)(s.getAttribute("src"));if("navPoint"===e.localName){const t=r(e,"navPoint");return{label:a,href:l,subitems:t.length?t.map(n):null}}return{label:a,href:l}},o=(e,t)=>r(e,t).map(n),s=(t,r)=>{const n=i(e.documentElement,t);return n?o(n,r):null};return{toc:s("navMap","navPoint"),pageList:s("pageList","pageTarget"),others:r(e.documentElement,"navList").map((e=>({label:re(i(e,"navLabel")),list:o(e,"navTarget")})))}},ge=e=>{if(!e)return;const t=e.split(":").map((e=>parseFloat(e)));if(3===t.length){const[e,i,r]=t;return 60*e*60+60*i+r}if(2===t.length){const[e,i]=t;return 60*e+i}const[i,r]=e.split(/(?=[^\d.])/);return parseFloat(i)*("h"===r?3600:"min"===r?60:"ms"===r?.001:1)},me=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,ye=e=>re(e.getElementById(e.documentElement.getAttribute("unique-identifier"))??e.getElementsByTagNameNS(G,"identifier")[0]),be=async(e,t,i)=>{const r=new Uint8Array(await i.slice(0,t).arrayBuffer());t=Math.min(t,r.length);for(var n=0;n<t;n++)r[n]=r[n]^e[n%e.length];return new Blob([r,i.slice(t)],{type:i.type})},ve=async e=>{const t=(new TextEncoder).encode(e),i=await globalThis.crypto.subtle.digest("SHA-1",t);return new Uint8Array(i)},we=(e=ve)=>({"http://www.idpf.org/2008/embedding":{key:t=>e(ye(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(e,t)=>be(e,1040,t)},"http://ns.adobe.com/pdf/enc#RC":{key:e=>{const t=(e=>{for(const t of e.getElementsByTagNameNS(G,"identifier")){const[e]=re(t).split(":").slice(-1);if(me.test(e))return e}return""})(e).replaceAll("-","");return Uint8Array.from({length:16},((e,i)=>parseInt(t.slice(2*i,2*i+2),16)))},decode:(e,t)=>be(e,1024,t)}});class xe{#e=new Map;#t=new Map;#i;constructor(e){this.#i=e}async init(e,t){if(!e)return;const i=Array.from(e.getElementsByTagNameNS(_,"EncryptedData"),(e=>({algorithm:e.getElementsByTagNameNS(_,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:e.getElementsByTagNameNS(_,"CipherReference")[0]?.getAttribute("URI")})));for(const{algorithm:e,uri:r}of i){if(!this.#t.has(e)){const i=this.#i[e];if(!i){console.warn("Unknown encryption algorithm");continue}const r=await i.key(t);this.#t.set(e,(e=>i.decode(r,e)))}this.#e.set(r,e)}}getDecoder(e){return this.#t.get(this.#e.get(e))??(e=>e)}}class Ce{constructor({opf:e,resolveHref:t}){this.opf=e;const{$:i,$$:r,$$$:n}=ne(e,V),o=i(e.documentElement,"manifest"),s=i(e.documentElement,"spine"),a=r(s,"itemref");this.manifest=r(o,"item").map(ie("href","id","media-type","properties","media-overlay")).map((e=>(e.href=t(e.href),e.properties=e.properties?.split(/\s/),e))),this.spine=a.map(ie("idref","id","linear","properties")).map((e=>(e.properties=e.properties?.split(/\s/),e))),this.pageProgressionDirection=s.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(s.getAttribute("toc"))??this.manifest.find((e=>e.mediaType===Q.NCX)))?.href;const l=i(e.documentElement,"guide");l&&(this.guide=r(l,"reference").map(ie("type","title","href")).map((({type:e,title:i,href:r})=>({label:i,type:e.split(/\s/),href:t(r)})))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID("cover-image")??this.getItemByID(n(e,"meta").find(te("name","cover"))?.getAttribute("content"))??this.getItemByID("cover")??this.getItemByID("cover.jpg")??this.getItemByID("cover.png")??this.getItemByID("cover.jpeg")??this.getItemByHref(this.guide?.find((e=>e.type.includes("cover")&&!e.href.includes("html")&&!e.href.includes("xml")))?.href),this.cfis=(e=>{const t=[],{parentNode:i}=e[0],r=U(i);for(const[n,o]of W(i).entries()){const i=e[t.length];o===i&&t.push(P([r.concat({id:i.id,index:n})]))}return t})(a)}getItemByID(e){return this.manifest.find((t=>t.id===e))}getItemByHref(e){return this.manifest.find((t=>t.href===e))}getItemByProperty(e){return this.manifest.find((t=>t.properties?.includes(e)))}resolveCFI(e){const t=N(e),i=(t.parent??t).shift();let r=q(this.opf,i);r&&"idref"!==r.nodeName&&(i.at(-1).id=null,r=q(this.opf,i));const n=r?.getAttribute("idref");return{index:this.spine.findIndex((e=>e.idref===n)),anchor:e=>((e,t)=>{const i=O(t),r=O(t,!0),n=e.documentElement,o=j(n,i[0]),s=j(n,r[0]),a=e.createRange();return o.before?a.setStartBefore(o.node):o.after?a.setStartAfter(o.node):a.setStart(o.node,o.offset),s.before?a.setEndBefore(s.node):s.after?a.setEndAfter(s.node):a.setEnd(s.node,s.offset),a})(e,t)}}}class Le{#r=new Map;#n=new Map;#o=new Map;allowScript=!1;constructor({loadText:e,loadBlob:t,resources:i}){this.loadText=e,this.loadBlob=t,this.manifest=i.manifest,this.assets=i.manifest}createURL(e,t,i,r){if(!t)return"";const n=URL.createObjectURL(new Blob([t],{type:i}));if(this.#r.set(e,n),this.#o.set(e,1),r){const t=this.#n.get(r);t?t.push(e):this.#n.set(r,[e])}return n}ref(e,t){const i=this.#n.get(t);return i?.includes(e)||(this.#o.set(e,this.#o.get(e)+1),i?i.push(e):this.#n.set(t,[e])),this.#r.get(e)}unref(e){if(!this.#o.has(e))return;const t=this.#o.get(e)-1;if(t<1){URL.revokeObjectURL(this.#r.get(e)),this.#r.delete(e),this.#o.delete(e);const t=this.#n.get(e);if(t)for(;t.length;)this.unref(t.pop());this.#n.delete(e)}else this.#o.set(e,t)}async loadItem(e,t=[]){if(!e)return null;const{href:i,mediaType:r}=e,n=Q.JS.test(e.mediaType);if(n&&!this.allowScript)return null;const o=t.at(-1);if(this.#r.has(i))return this.ref(i,o);return(n||[Q.XHTML,Q.HTML,Q.CSS,Q.SVG].includes(r))&&t.every((e=>e!==i))?this.loadReplaced(e,t):this.createURL(i,await this.loadBlob(i),r,o)}async loadHref(e,t,i=[]){if(se(e))return e;const r=oe(e,t);let n=this.manifest.find((e=>e.href===r));return n||(n={href:r,mediaType:""}),this.loadItem(n,i.concat(t))}async loadReplaced(e,t=[]){const{href:i,mediaType:r}=e,n=t.at(-1),o=await this.loadText(i);if(!o)return null;if([Q.XHTML,Q.HTML,Q.SVG].includes(r)){let s=(new DOMParser).parseFromString(o,r);if(r===Q.XHTML&&s.querySelector("parsererror")&&(console.warn(s.querySelector("parsererror").innerText),e.mediaType=Q.HTML,s=(new DOMParser).parseFromString(o,e.mediaType)),[Q.XHTML,Q.SVG].includes(e.mediaType)){let e=s.firstChild;for(;e instanceof ProcessingInstruction;){if(e.data){const r=await ae(e.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,((e,r,n,o)=>this.loadHref(n,i,t).then((e=>`${r}${e}${o}`))));e.replaceWith(s.createProcessingInstruction(e.target,r))}e=e.nextSibling}}const a=async(e,r)=>e.setAttribute(r,await this.loadHref(e.getAttribute(r),i,t));for(const e of s.querySelectorAll("link[href]"))await a(e,"href");for(const e of s.querySelectorAll("[src]"))await a(e,"src");for(const e of s.querySelectorAll("[poster]"))await a(e,"poster");for(const e of s.querySelectorAll("object[data]"))await a(e,"data");for(const e of s.querySelectorAll("[*|href]:not([href]"))e.setAttributeNS(Y,"href",await this.loadHref(e.getAttributeNS(Y,"href"),i,t));for(const e of s.querySelectorAll("style"))e.textContent&&(e.textContent=await this.replaceCSS(e.textContent,i,t));for(const e of s.querySelectorAll("[style]"))e.setAttribute("style",await this.replaceCSS(e.getAttribute("style"),i,t));const l=(new XMLSerializer).serializeToString(s);return this.createURL(i,l,e.mediaType,n)}const s=r===Q.CSS?await this.replaceCSS(o,i,t):await this.replaceString(o,i,t);return this.createURL(i,s,r,n)}async replaceCSS(e,t,i=[]){const r=await ae(e,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,((e,r)=>this.loadHref(r,t,i).then((e=>`url("${e}")`)))),n=await ae(r,/@import\s*["']([^"'\n]*?)["']/gi,((e,r)=>this.loadHref(r,t,i).then((e=>`@import "${e}"`)))),o=window?.innerWidth??800,s=window?.innerHeight??600;return n.replace(/-epub-/gi,"").replace(/(\d*\.?\d+)vw/gi,((e,t)=>parseFloat(t)*o/100+"px")).replace(/(\d*\.?\d+)vh/gi,((e,t)=>parseFloat(t)*s/100+"px")).replace(/page-break-(after|before|inside)/gi,((e,t)=>`-webkit-column-break-${t}`))}replaceString(e,t,i=[]){const r=new Map,n=this.assets.map((e=>{if(e.href===t)return;const i=((e,t)=>{if(!e)return t;const i=e.replace(/\/$/,"").split("/"),r=t.replace(/\/$/,"").split("/"),n=(i.length>r.length?i:r).findIndex(((e,t)=>i[t]!==r[t]));return n<0?"":Array(i.length-n).fill("..").concat(r.slice(n)).join("/")})((e=>e.slice(0,e.lastIndexOf("/")+1))(t),e.href),n=encodeURI(i),o="/"+e.href,s=encodeURI(o),a=new Set([i,n,o,s]);for(const t of a)r.set(t,e);return Array.from(a)})).flat().filter((e=>e));if(!n.length)return e;const o=new RegExp(n.map(le).join("|"),"g");return ae(e,o,(async e=>this.loadItem(r.get(e.replace(/^\//,"")),i.concat(t))))}unloadItem(e){this.unref(e?.href)}}const Te=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};class Me{parser=new DOMParser;#s;constructor({loadText:e,loadBlob:t,getSize:i,sha1:r}){this.loadText=e,this.loadBlob=t,this.getSize=i,this.#s=new xe(we(r))}#a(e){return e&&e.includes("opf:scheme")&&(e=e.replaceAll("opf:scheme","scheme")),e?this.parser.parseFromString(e,Q.XML):null}async#l(e){return this.#a(await this.loadText(e))}async init(){const e=await this.#l("META-INF/container.xml");if(!e)throw new Error("Failed to load container file");const t=Array.from(e.getElementsByTagNameNS(z,"rootfile"),ie("full-path","media-type")).filter((e=>"application/oebps-package+xml"===e.mediaType));if(!t.length)throw new Error("No package document defined in container");const i=t[0].fullPath,r=await this.#l(i);if(!r)throw new Error("Failed to load package document");const n=await this.#l("META-INF/encryption.xml");await this.#s.init(n,r),this.resources=new Ce({opf:r,resolveHref:e=>oe(e,i)});const o=new Le({loadText:this.loadText,loadBlob:e=>Promise.resolve(this.loadBlob(e)).then(this.#s.getDecoder(e)),resources:this.resources});this.sections=this.resources.spine.map(((e,t)=>{const{idref:i,linear:r,properties:n=[]}=e,s=this.resources.getItemByID(i);return s?{id:this.resources.getItemByID(i)?.href,load:()=>o.loadItem(s),unload:()=>o.unloadItem(s),createDocument:()=>this.loadDocument(s),size:this.getSize(s.href),cfi:this.resources.cfis[t],linear:r,pageSpread:Te(n),resolveHref:e=>oe(e,s.href),loadMediaOverlay:()=>this.loadMediaOverlay(s)}:(console.warn(`Could not find item with ID "${i}" in manifest`),null)})).filter((e=>e));const{navPath:s,ncxPath:a}=this.resources;if(s)try{const e=e=>oe(e,s),t=fe(await this.#l(s),e);this.toc=t.toc,this.pageList=t.pageList,this.landmarks=t.landmarks}catch(e){console.warn(e)}if((!this.toc||0===this.toc.length)&&a)try{const e=e=>oe(e,a),t=pe(await this.#l(a),e);this.toc=t.toc,this.pageList=t.pageList}catch(e){console.warn(e)}this.landmarks??=this.resources.guide;const{metadata:l,rendition:c,media:h}=(e=>{const{$:t,$$:i}=ne(e,V),r=t(e.documentElement,"metadata"),n=Array.from(r.children),o=(e,t)=>{if(!t)return null;const{props:i=[],attrs:r=[]}=e,s=re(t);if(!i.length&&!r.length)return s;const a=t.getAttribute("id"),l=a?n.filter(te("refines","#"+a)):[];return Object.fromEntries([["value",s]].concat(i.map((t=>{const{many:i,recursive:r}=t,n="string"==typeof t?t:t.name,s=te("property",n),a=r?e:t;return[ee(n),i?l.filter(s).map((e=>o(a,e))):o(a,l.find(s))]}))).concat(r.map((e=>[ee(e),t.getAttribute(e)]))))},s=n.filter(te("refines",null)),a=e=>Object.fromEntries(i(r,"meta").filter(te("property",(t=>t?.startsWith(e)))).map((t=>[t.getAttribute("property").replace(e,""),re(t)])));return{metadata:Object.fromEntries(ue.map((e=>{const{type:t,name:i,many:r}=e,n="meta"===t?e=>e.namespaceURI===V&&e.getAttribute("property")===i:e=>e.namespaceURI===G&&e.localName===i;return[ee(i),r?s.filter(n).map((t=>o(e,t))):o(e,s.find(n))]}))),rendition:a("rendition:"),media:a("media:")}})(r);this.rendition=c,this.media=h,h.duration=ge(h.duration),this.dir=this.resources.pageProgressionDirection,this.rawMetadata=l;const d=l?.title?.[0];this.metadata={title:d?.value,sortAs:d?.fileAs,language:l?.language,identifier:ye(r),description:l?.description?.value,publisher:l?.publisher?.value,published:l?.date,modified:l?.dctermsModified,subject:l?.subject?.filter((({value:e,code:t})=>e||t))?.map((({value:e,code:t,scheme:i})=>({name:e,code:t,scheme:i}))),rights:l?.rights?.value};const u={art:"artist",aut:"author",bkp:"producer",clr:"colorist",edt:"editor",ill:"illustrator",trl:"translator",pbl:"publisher"},f=e=>t=>{const i=[...new Set(t.role?.map((({value:t,scheme:i})=>(i&&"marc:relators"!==i?null:u[t])??e)))],r={name:t.value,sortAs:t.fileAs};return[i?.length?i:[e],r]};return l?.creator?.map(f("author"))?.concat(l?.contributor?.map?.(f("contributor")))?.forEach((([e,t])=>e.forEach((e=>{this.metadata[e]?this.metadata[e].push(t):this.metadata[e]=[t]})))),this}async loadDocument(e){const t=await this.loadText(e.href);return this.parser.parseFromString(t,e.mediaType)}async loadMediaOverlay(e){const t=e.mediaOverlay;if(!t)return null;const i=this.resources.getItemByID(t),r=((e,t=e=>e)=>{const{$:i,$$$:r}=ne(e,K);return r(e,"par").map((e=>{const r=i(e,"text")?.getAttribute("src")?.split("#")?.[1],n=i(e,"audio");return n?{id:r,audio:{src:(o=n.getAttribute("src"),o?decodeURI(t(o)):null),clipBegin:ge(n.getAttribute("clipBegin")),clipEnd:ge(n.getAttribute("clipEnd"))}}:{id:r};var o}))})(await this.#l(i.href),(e=>oe(e,i.href)));return r}resolveCFI(e){return this.resources.resolveCFI(e)}resolveHref(e){const[t,i]=e.split("#"),r=this.resources.getItemByHref(decodeURI(t));if(!r)return null;return{index:this.resources.spine.findIndex((({idref:e})=>e===r.id)),anchor:i?e=>((e,t)=>e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`))(e,i):()=>0}}splitTOCHref(e){return e?.split("#")??[]}getTOCFragment(e,t){return e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`)}isExternal(e){return se(e)}async getCover(){const e=this.resources?.cover;return e?.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){const e=await this.loadText("META-INF/calibre_bookmarks.txt"),t="encoding=json+base64:";if(e?.startsWith(t)){const t=atob(e.slice(21));return JSON.parse(t)}}}const Se=(e,t=!1,i="",r)=>{const n=(new DOMParser).parseFromString(t?$e(e,i,r):e,"text/html");let o=Ee(n);0===o.length&&(o=qe(n));for(let e=0;e<o.length;e++){var s=document.createElement("kookitmarker"),a=document.createTextNode(" ");s.appendChild(a),o[e].parentNode&&o[e].parentNode.insertBefore(s,o[e])}const l=We(n.body.innerHTML),c={getCover:()=>""};return c.sections=l.map((e=>({id:e.index,load:()=>{return t=e.index,h(void 0,void 0,void 0,(function*(){return URL.createObjectURL(new Blob([l[t].text],{type:"text/html"}))}));var t},unload:()=>{e.index}}))),c.toc=l.map((e=>({label:e.label,href:"title"+e.index}))).filter((e=>""!==e.label)),c.rendition={layout:"pre-paginated"},c.resolveHref=e=>({index:parseInt(e.substring(5,e.length))}),c.splitTOCHref=e=>[e,null],c.getTOCFragment=e=>e.documentElement,c};let De=["章","节","回","節","卷","部","輯","辑","話","集","话","篇"," ","　"],ke=[],Ae=["CHAPTER","Chapter","序章","前言","声明","写在前面的话","后记","楔子","后序","章节目录","尾声"],Ie=[" ","　","、","·",".","：",":"];const Ee=e=>Array.from(e.querySelectorAll("h1,h2,h3,h4,h5,h6,title")),Ne=e=>e.trim().replace(/(\r\n|\n|\r|\t)/gm,"").substring(0,100).split("").filter((e=>"="!==e&&"-"!==e&&"_"!==e&&"+"!==e)).join(""),Re=(e,t="")=>t?new RegExp(t).test(e):e&&e.length<40&&!Be(e)&&(Pe(e)||e.startsWith("第")&&He(e)||e.startsWith("卷")&&Fe(e)||e.indexOf("第")>-1&&e.lastIndexOf("第")<4&&He(e.substr(e.indexOf("第")))||Oe(e)),Be=e=>ke.filter((t=>e.indexOf(t)>-1)).length>0,Pe=t=>Ae.filter((i=>t.startsWith(i)||t.startsWith(e.s2t(i))||t.startsWith(e.t2s(i)))).length>0,Oe=e=>Ie.filter((t=>e.indexOf(t)>-1&&(/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(0,e.indexOf(t)))||/^\d+$/.test(e.substring(0,e.indexOf(t)))))).length>0,He=e=>{let t=!1;for(let i=0;i<De.length&&((/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf(De[i])).trim())||/^\d+$/.test(e.substring(1,e.indexOf(De[i])).trim()))&&(t=!0),!t);i++);return t},Fe=e=>!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf(" ")))&&!/^\d+$/.test(e.substring(1,e.indexOf(" "))))||(!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf("　")))&&!/^\d+$/.test(e.substring(1,e.indexOf("　"))))||!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1))&&!/^\d+$/.test(e.substring(1)))),We=e=>{let t=[],i=e.split("<kookitmarker> </kookitmarker>").filter((e=>""!==e.trim())),r=i.map((e=>je(e)||Ue(e)));return t=i.map(((e,t)=>({index:t,label:r[t],text:e,href:"title"+t}))),t},$e=(e,t,i)=>{let r=e.split("\n");1===r.length&&(r=e.split("\r"));const n=[];let o=!1;if(i&&i.refresh&&(o=!0),r.length>1e4&&!o){i&&i.text||(i={text:r[0],chapterTitle:"",chapterDocIndex:0});let e=r.findIndex((e=>Ne(e)===Ne(i.text)));-1===e&&(e=0);const o=Math.max(e-1e3,0),s=Math.min(e+1e3,r.length),a=r.slice(o,s),l=a.filter((e=>{const i=Ne(e);return i&&Re(i,t)})),c=new Set(l.map((e=>Ne(e))));let h=l.findIndex((e=>Ne(e)===Ne(i.chapterTitle)));if(-1===h&&(h=0),h<parseInt(i.chapterDocIndex||"0")-1){let e=parseInt(i.chapterDocIndex||"0")-h;if(e>0)for(let t=0;t<e;t++)n.push(`<h1>Chapter ${t}</h1>`),n.push(`<p>Chapter ${t}</p>`)}for(const e of a){const t=Ne(e);t&&c.has(t)?n.push(`<h1>${t}</h1>`):n.push(`<p>${e}</p>`)}}else for(const e of r){const i=Ne(e);i&&Re(i,t)?n.push(`<h1>${i}</h1>`):n.push(`<p>${e}</p>`)}const s=n.join("");return s||`<h1>Title</h1><p>${e}</p>`},je=e=>{var t;const i=(new DOMParser).parseFromString(e,"text/html").querySelector("h1, h2, h3, h4, h5, h6");return i&&(null===(t=i.textContent)||void 0===t?void 0:t.trim())||""},Ue=e=>{var t;const i=(new DOMParser).parseFromString(e,"text/html").querySelector("title");return i&&(null===(t=i.textContent)||void 0===t?void 0:t.trim())||""},qe=e=>{let t=e.getElementsByTagName("*"),i=Array.from(t).filter((e=>1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE&&Re(Ne(e.textContent)))),r=[];for(let e=0;e<i.length;e++){const t=i[e],n=document.createElement("h1");n.innerHTML=t.innerText,t.parentNode.replaceChild(n,t),r.push(n)}return r};let ze=!1;const Xe=e=>Array.from(e.querySelectorAll("h1,h2,h3,h4,h5,h6,p,div,ul,dl,ol,pre,blockquote,address,kookitmarker")),Ve=(e,t,i,r,n,o,s)=>h(void 0,void 0,void 0,(function*(){let a=Math.floor(e.clientWidth/12),l=a%2==0?a:a-1;const c=e.clientWidth;if("mimical"===t&&"yes"!==s){let e=document.getElementById("book");e&&(e.style.display="block",i>0?o():i<0&&n(),setTimeout((()=>{if(!e)return{};e.style.display="none"}),1e3))}i>0?r.body.scrollBy({top:0,left:-c-l,behavior:"sliding"===t&&"yes"!==s?"smooth":"auto"}):i<0&&r.body.scrollBy({top:0,left:c+l,behavior:"sliding"===t&&"yes"!==s?"smooth":"auto"})})),Je=(e,i,r,n)=>{let o=t.findLastIndex(r,(e=>e.href===i||e.href&&e.href.includes("#")&&e.href.includes(i)));return i&&t.findLastIndex(r,(e=>e.href===i||e.href&&e.href.includes("#")&&e.href.includes(i)))>-1||(o=e),"prev"===n?Object.assign(Object.assign({},r[o-1]),{index:o-1}):Object.assign(Object.assign({},r[o+1]),{index:o+1})},Ge=(e,t,i,r,n,o,s,a)=>h(void 0,void 0,void 0,(function*(){let t=parseInt(o.chapterDocIndex||"0"),l=o.chapterHref||"";if(0===t)return;let c=Je(t,l,i,"prev");c&&(o.text="prevChapter",o.page="",yield _e(c.index,c.label,c.href,i,e,r,n,o,s,a))})),_e=(e,i,r,n,o,s,a,l,c,d)=>h(void 0,void 0,void 0,(function*(){if(c.body.innerHTML="",d.height="0px",c.body.scrollTo(0,0),i&&!e||n[e]&&n[e].label&&i&&i!==n[e].label&&-1===r.indexOf("#")){let r=t.findLastIndex(n,{label:i});-1!==r&&(e=r)}if(-1===e&&r.indexOf("#")>-1){let i=r.split("#")[0],o=t.findLastIndex(n,(e=>e.href===i||e.href&&e.href.includes("#")&&e.href.includes(i)));-1!==o&&(e=o)}(-1===e||e>n.length-1)&&(e=0);let f=yield u(n[e].text,!1),p=function(e){const t=e.match(/<body\b([^>]*)>/i);if(!t)return{};const i=t[1],r={},n=/([\w-]+)\s*=\s*(?:"([^"]*)"|'([^']*)'|([^>\s]+))/g;let o;for(;null!==(o=n.exec(i));){const e=o[2]||o[3]||o[4]||"";r[o[1]]=e}return r}(f);c.body.innerHTML=f,p&&Object.keys(p).forEach((e=>{c.body.setAttribute(e,p[e]+" "+c.body.getAttribute(e))})),yield Ze(c),l.chapterTitle=i,l.chapterHref=r,l.chapterDocIndex=e+"",l.percentage=e/n.length+"",l.text="",yield((e,t,i,r,n)=>h(void 0,void 0,void 0,(function*(){if(yield Promise.race([Promise.all(Array.from([...n.images,...n.querySelectorAll("image")]).map((e=>e.complete?Promise.resolve(0!==e.naturalHeight):new Promise((t=>{e.addEventListener("load",(()=>t(!0))),e.addEventListener("error",(()=>t(!1)))}))))),new Promise(((e,t)=>{setTimeout((()=>{console.info("image load timeout"),e("image load timeout")}),3e3)}))]),yield w(e,t,i,n),b(n),"scroll"!==t){if(r.height=e.clientHeight+"px","double"===t){let t=Math.floor(e.clientWidth/12),i=t%2==0?t:t-1,r=(e.clientWidth+i)/2;if((n.body.scrollWidth-n.body.clientWidth)/r%2==1){let e=document.createElement("div");e.setAttribute("style","height: "+n.body.clientHeight+"px; display: inline-block; width: "+(r-i)+"px"),n.body.appendChild(e)}}}else r.height=n.body.scrollHeight+"px",r.height=n.body.scrollHeight+300+"px"})))(o,s,a,d,c),yield Ye(o,s,"","","","",c)}));const Ze=e=>h(void 0,void 0,void 0,(function*(){let t=Array.from(e.getElementsByTagName("link"));if(0===t.length)return;for(let e=0;e<t.length;e++){t[e].onload=()=>{console.info("finished")}}let i=[];for(let e=0;e<t.length;e++){const r=t[e];r.href.endsWith("null")||i.push(new Promise(((e,t)=>{r.addEventListener("load",e)})))}try{yield Promise.race([Promise.all(i),new Promise(((e,t)=>{setTimeout((()=>{console.info("css load timeout"),e("css load timeout")}),1e3)}))])}catch(e){console.error(e)}})),Ye=(t,i,r,n,o,s,a)=>h(void 0,void 0,void 0,(function*(){let l=0,c=a.body;if(s&&"scroll"!==i){let e=Math.floor(t.clientWidth/12),i=e%2==0?e:e-1;l=((h=getComputedStyle(t).width,parseFloat(h.substring(0,h.length-2)))+i)*(parseInt(s)-1)}else if(r){let o=Xe(a.body).filter(((t,i)=>Ne(t.textContent)&&(Ne(t.textContent)===Ne(r)||Ne(t.textContent)===e.t2s(Ne(r))||Ne(t.textContent)===e.s2t(Ne(r)))&&(Math.abs(i-parseInt(n))<2||"search"===n||"ignore"===n||"next"===n)));if(0===o.length)return void console.info("failed");c=Ke(o[0],t,i),l=c?d(c.offsetLeft)-d(c.marginLeft||parseFloat(getComputedStyle(c).marginLeft)):"prevChapter"===r?a.body.scrollWidth:0}else if(o&&o.indexOf("#")>-1){let e=CSS.escape(o.split("#").reverse()[0]);if(!a.body.querySelector("#"+e))return;c=Ke(a.body.querySelector("#"+e)||a.body,t,i),l=c?d(c.offsetLeft)-d(c.marginLeft||parseFloat(getComputedStyle(c).marginLeft)):0}var h;"scroll"!==i?a.body.scrollTo(l,0):c.scrollIntoView()})),Ke=(e,t,i)=>{let r=Math.floor(t.clientWidth/12),n=r%2==0?r:r-1,o=d(e.offsetLeft)-d(e.marginLeft||parseFloat(getComputedStyle(e).marginLeft));return"scroll"===i||"scroll"!==i&&Qe(parseInt(o+""),(t.clientWidth+n)/2)?e:e.parentElement?Ke(e.parentElement,t,i):e},Qe=(e,t)=>{for(let i=e-10;i<=e+10;i++)if(i%t==0)return!0;return!1},et=(e,t,i,r,n,o,s)=>h(void 0,void 0,void 0,(function*(){var a;if(ze)return;let l=Xe(o.body),c=l.filter((i=>st(e,i,t)&&(i.textContent||"").trim())),h=c[0];s&&(h=s);let d=0;for(let i=0;i<l.length;i++)if(st(e,l[i],t)&&h&&l[i].innerHTML===h.innerHTML){d=i;break}it(c,i,n),h&&!tt(h,e,t)?(n.text=h.textContent||"",n.count=d+"",n.page="",n.percentage=parseInt(n.chapterDocIndex)/r.length+1/r.length*(d/l.length)+""):n.page=(null===(a=yield y(t,o,e))||void 0===a?void 0:a.currentPage)+"",ze=!0,setTimeout((()=>{ze=!1}),100)})),tt=(e,t,i)=>{let r=Math.floor(t.clientWidth/12),n=r%2==0?r:r-1;return Math.abs(e.offsetLeft-Ke(e,t,i).offsetLeft)>(t.clientWidth+n)/2},it=(e,i,r)=>{let n=r.chapterHref||"",o=n.lastIndexOf("#"),s="";s=-1===o?n:n.substring(0,o);for(let n=0;n<e.length;n++){const o=e[n];if(o.id){let e=s+"#"+o.id,n=t.findLastIndex(i,{href:e});n>-1&&(r.chapterHref=e,r.chapterTitle=i[n].label)}}},rt=(e,t,i,r,n,o,s,a)=>h(void 0,void 0,void 0,(function*(){let t=parseInt(o.chapterDocIndex||"0"),l=o.chapterHref||"";if(t>=i.length-1)return void(o.percentage="1");let c=Je(t,l,i,"next");c&&(o.page="",yield _e(c.index,c.label,c.href,i,e,r,n,o,s,a))})),nt=(e,t,i)=>Xe(i.body).filter((e=>!ot(e))).filter((i=>st(e,i,t)&&(i.textContent||"").trim())).filter((e=>"img"!==e.textContent)).map((e=>e.textContent)),ot=e=>{var t=e.children;let i=!1;var r=/^(address|kookitmarker|section|blockquote|body|center|dir|div|dl|fieldset|form|h[1-6]|hr|isindex|menu|noframes|noscript|ol|p|pre|table|ul|dd|dt|frameset|li|tbody|td|tfoot|th|thead|tr|html)$/i;if(Array.from(t).filter((e=>r.test(e.nodeName))).length<3)return!1;for(var n=0;n<t.length;n++)if(r.test(t[n].nodeName)){i=!0;break}return i},st=(e,t,i)=>{var r=!1,n=t.getBoundingClientRect();if("scroll"!==i&&t.textContent&&t.textContent.trim()){let t=n.left;r=t>-10&&t<=e.clientWidth}else if("scroll"===i&&t.textContent&&t.textContent.trim()){let t=n.top;r=t>=e.scrollTop&&t<=e.scrollTop+e.clientHeight}else if("scroll"!==i){let t=n.left;r=t>=0&&t<=e.clientWidth}return r};class at{constructor(){this.callbacks={},this.callbacks.base={}}on(e,t){const i=this;if(void 0===e||""===e)return console.warn("wrong names"),!1;if(void 0===t)return console.warn("wrong callback"),!1;return this.resolveNames(e).forEach((function(e){const r=i.resolveName(e);i.callbacks[r.namespace]instanceof Object||(i.callbacks[r.namespace]={}),i.callbacks[r.namespace][r.value]instanceof Array||(i.callbacks[r.namespace][r.value]=[]),i.callbacks[r.namespace][r.value].push(t)})),this}off(e){const t=this;if(void 0===e||""===e)return console.warn("wrong name"),!1;return this.resolveNames(e).forEach((function(e){const i=t.resolveName(e);if("base"!==i.namespace&&""===i.value)delete t.callbacks[i.namespace];else if("base"===i.namespace)for(const e in t.callbacks)t.callbacks[e]instanceof Object&&t.callbacks[e][i.value]instanceof Array&&(delete t.callbacks[e][i.value],0===Object.keys(t.callbacks[e]).length&&delete t.callbacks[e]);else t.callbacks[i.namespace]instanceof Object&&t.callbacks[i.namespace][i.value]instanceof Array&&(delete t.callbacks[i.namespace][i.value],0===Object.keys(t.callbacks[i.namespace]).length&&delete t.callbacks[i.namespace])})),this}trigger(e,t=[]){if(void 0===e||""===e)return console.warn("wrong name"),!1;const i=this;const r=t instanceof Array?t:[];let n=this.resolveNames(e);n=this.resolveName(n[0]),setTimeout((()=>{if("base"===n.namespace)for(const e in i.callbacks){if(i.callbacks[e]instanceof Object&&i.callbacks[e][n.value]instanceof Array&&i.callbacks[e][n.value])i.callbacks[e][n.value].forEach((function(e){e.apply(i,r)}));else if(this.callbacks[n.namespace]instanceof Object&&i.callbacks[n.namespace][n.value]){if(""===n.value)return console.warn("wrong name"),this;i.callbacks[n.namespace][n.value].forEach((function(e){e.apply(i,r)}))}return null}}),100)}resolveNames(e){let t=e;return t=t.replace(/[^a-zA-Z0-9 ,/.]/g,""),t=t.replace(/[,/]+/g," "),t=t.split(" "),t}resolveName(e){const t={},i=e.split(".");return t.original=e,t.value=i[0],t.namespace="base",i.length>1&&""!==i[1]&&(t.namespace=i[1]),t}}const lt=Node.ELEMENT_NODE,ct=Node.TEXT_NODE,ht=Node.CDATA_SECTION_NODE;function dt(e,t,i){let r,n,o,s=0,a=0,l=!0;for(n=0;n<e.length;n++)if(o=e[n],o.nodeType===lt){if(r||l?(s+=2,l=!1):s++,t===o)return"img"===o.tagName.toLowerCase()?{count:s,offset:i}:{count:s};a=0,r=!0}else{if((null==o?void 0:o.nodeType)!==ct&&(null==o?void 0:o.nodeType)!==ht)continue;if((r||l)&&(s++,l=!1),t===o)return{count:s,offset:i+a};a+=o.textContent.length,r=!1}throw new Error("The specified node was not found in the array of siblings")}function ut(e,t){const i="number"==typeof e,r="number"==typeof t;return i||r?!i&&r?-1:i&&!r?1:(e||0)-(t||0):0}function ft(e,t){if(!e&&!t)return 0;if(!e&&t)return-1;if(e&&!t)return 1;const i=(e.y||0)-(t.y||0);return i||(e.x||0)-(t.x||0)}class pt{constructor(e,t){this.isRange=!1,this.opts=Object.assign({flattenRange:!1,stricter:!0},t||{}),this.cfi=e,this.parts=[];const i=(e=e.trim()).match(/^epubcfi\((.*)\)$/);if(!i)throw new Error("Not a valid CFI");if(i.length<2)return;let r,n,o;e=i[1]||"";let s=[],a=0;for(;e.length;){if(({parsed:r,offset:n,newDoc:o}=this.parse(e)),!r||null===n)throw new Error("Parsing failed");if(a&&o)throw new Error("CFI is a range that spans multiple documents. This is not allowed");s.push(r),(o||e.length-n<=0)&&(2===a?this.to=s:this.parts.push(s),s=[]),","===(e=e.slice(n))[0]&&(0===a?(s.length&&this.parts.push(s),s=[]):1===a&&(s.length&&(this.from=s),s=[]),e=e.slice(1),a++)}this.from&&this.from.length&&(!this.opts.flattenRange&&this.to&&this.to.length?this.isRange=!0:(this.parts=this.parts.concat(this.from),delete this.from,delete this.to)),this.opts.stricter&&this.removeIllegalOpts()}removeIllegalOpts(e){if(!e)if(this.from){if(this.removeIllegalOpts(this.from),!this.to)return;e=this.to}else e=this.parts;let t,i,r,n;for(t=0;t<e.length;t++)for(r=e[t],i=0;i<r.length-1;i++)n=r[i],delete n.temporal,delete n.spatial,delete n.offset,delete n.textLocationAssertion}static generatePart(e,t,i){let r,n="";for(;e.parentNode;)r=dt(e.parentNode.childNodes,e,t),!n&&r.offset&&(n=":"+r.offset),n="/"+r.count+(e.id?"["+(e.id.replace(/[\[\]\^,();]/g,"^$&")+"]"):"")+n,e=e.parentNode;return n}static generate(e,t,i){let r;if(Array.isArray(e)){const t=[];for(const r of e)t.push(this.generatePart(r.node,r.offset,i));r=t.join("!")}else r=this.generatePart(e,t,i);return i&&(r+=i),"epubcfi("+r+")"}static toParsed(e){return e.isRange?e.getFrom():e.get()}static comparePath(e,t){const i=Math.max(e.length,t.length);let r,n,o,s;for(r=0;r<i;r++){if(n=e[r],o=t[r],!n)return-1;if(!o)return 1;if(s=this.compareParts(n,o),s)return s}return 0}static sort(e){e.sort(((e,t)=>this.compare(e,t)))}static compare(e,t){let i=e.get(),r=t.get();if(e.isRange||t.isRange){if(e.isRange&&t.isRange){const e=this.comparePath(i.from,r.from);return e||this.comparePath(i.to,r.to)}return e.isRange&&(i=i.from),t.isRange&&(r=r.from),this.comparePath(i,r)}return this.comparePath(i,r)}static compareParts(e,t){const i=Math.max(e.length,t.length);let r,n,o,s;for(r=0;r<i;r++){if(n=e[r],o=t[r],!n)return-1;if(!o)return 1;if(s=n.nodeIndex-o.nodeIndex,s)return s;if(0===n.nodeIndex)return 0;if(!(r<i-1)){if(n.nodeIndex%2==0){if(s=ut(n.temporal,o.temporal),s)return s;if(s=ft(n.spatial,o.spatial),s)return s}if(s=(n.offset||0)-(o.offset||0),s)return s}}return 0}decodeEntities(e,t){try{const i=e.createElement("textarea");return i.innerHTML=t,i.value||""}catch(e){return t}}trueLength(e,t){return this.decodeEntities(e,t).length}getFrom(){if(!this.isRange)throw new Error("Trying to get beginning of non-range CFI");if(!this.from)return this.deepClone(this.parts);const e=this.deepClone(this.parts);return e[e.length-1]=e[e.length-1].concat(this.from),e}getTo(){if(!this.isRange)throw new Error("Trying to get end of non-range CFI");const e=this.deepClone(this.parts);return e[e.length-1]=e[e.length-1].concat(this.to),e}get(){return this.isRange?{from:this.getFrom(),to:this.getTo(),isRange:!0}:this.deepClone(this.parts)}parseSideBias(e,t){if(!t)return;const i=t.trim().match(/^(.*);s=([ba])$/);!i||i.length<3?"object"==typeof e.textLocationAssertion?e.textLocationAssertion.post=t:e.textLocationAssertion=t:(i[1]&&("object"==typeof e.textLocationAssertion?e.textLocationAssertion.post=i[1]:e.textLocationAssertion=i[1]),"a"===i[2]?e.sideBias="after":e.sideBias="before")}parseSpatialRange(e){if(!e)return;const t=e.trim().match(/^([\d\.]+):([\d\.]+)$/);if(!t||t.length<3)return;const i={x:parseInt(t[1]),y:parseInt(t[2])};return"number"==typeof i.x&&"number"==typeof i.y?i:void 0}parse(e){const t={},i=/[\d]/;let r,n,o,s,a,l,c=!1,h=!1;for(l=0;l<=e.length;l++)if(s=l<e.length?e[l]:"","^"!==s||a){if("/"===n){if(s.match(i)){r?r+=s:r=s,a=!1;continue}r&&(t.nodeIndex=parseInt(r),r=null),o=n,n=null}if(":"===n){if(s.match(i)){r?r+=s:r=s,a=!1;continue}r&&(t.offset=parseInt(r),r=null),o=n,n=null}if("@"===n){let e=!1;if(s.match(i)||"."===s||":"===s?":"===s&&(c?e=!0:c=!0):e=!0,!e){r?r+=s:r=s,a=!1;continue}o=n,n=null,r&&c&&(t.spatial=this.parseSpatialRange(r)),r=null}if("~"===n){if(s.match(i)||"."===s){r?r+=s:r=s,a=!1;continue}r&&(t.temporal=parseFloat(r)),o=n,n=null,r=null}if(!n){if("!"===s){l++,n=s;break}if(","===s)break;if("/"===s){if(h)break;h=!0,o=n,n=s,a=!1;continue}if(":"===s||"~"===s||"@"===s){if(this.opts.stricter){if(":"===s&&(void 0!==t.temporal||void 0!==t.spatial))break;if(("~"===s||"@"===s)&&void 0!==t.offset)break}o=n,n=s,a=!1,c=!1;continue}if("["===s&&!a&&":"===o){o=n,n="[",a=!1;continue}if("["===s&&!a&&"/"===o){o=n,n="nodeID",a=!1;continue}}"["!==n?("nodeID"!==n||("]"!==s||a?r?r+=s:r=s:(o=n,n=null,t.nodeID=r,r=null)),a=!1):("]"!==s||a?","!==s||a?r?r+=s:r=s:(t.textLocationAssertion={},r&&(t.textLocationAssertion.pre=r),r=null):(o=n,n=null,this.parseSideBias(t,r),r=null),a=!1)}else a=!0;if(!t.nodeIndex&&0!==t.nodeIndex)throw new Error("Missing child node index in CFI");return{parsed:t,offset:l,newDoc:"!"===n}}getChildNodeByCFIIndex(e,t,i,r){const n=t.childNodes;if(!n.length)return{node:t,offset:0};if(i<=0)return{node:n[0],relativeToNode:"before",offset:0};let o,s,a,l=0;for(s=0;s<n.length;s++)switch(a=n[s],a.nodeType){case lt:if(l%2==0){if(l+=2,l>=i)return"img"===a.tagName.toLowerCase()&&r?{node:a,offset:r}:{node:a,offset:0}}else{if(l+=1,l===i)return"img"===a.tagName.toLowerCase()&&r?{node:a,offset:r}:{node:a,offset:0};if(l>i)return o?{node:o,offset:this.trueLength(e,o.textContent)}:{node:t,offset:0}}o=a;break;case ct:case ht:if(0!==l&&l%2!=0||(l+=1),l===i){const t=this.trueLength(e,a.textContent);if(!(r>=t))return{node:a,offset:r};r-=t}o=a;break;default:continue}if(i>l){const i={relativeToNode:"after",offset:0};return i.node=o||t,this.isTextNode(i.node)&&(i.offset=this.trueLength(e,i.node.textContent.length)),i}}isTextNode(e){return!!e&&(e.nodeType===ct||e.nodeType===ht)}correctOffset(e,t,i,r){let n,o=t;if("string"==typeof r?n=this.decodeEntities(e,r):(r.pre=this.decodeEntities(e,r.pre),r.post=this.decodeEntities(e,r.post),n=r.pre+"."+r.post),!this.isTextNode(t))return{node:t,offset:0};for(;this.isTextNode(o.previousSibling);)o=o.previousSibling;const s=o;let a;const l=[];let c="",h=0;for(;this.isTextNode(o)&&(a=this.decodeEntities(e,o.textContent),l[h]=a.length,c+=a,o.nextSibling);)o=o.nextSibling,h++;const d=r.pre?r.pre.length:0,u=function(e,t,i){i=i||0;const r=[];let n,o=0;do{if(n=e.match(t),!n)break;r.push(n.index+i),o+=n.index+n.length,e=e.slice(n.index+n.length)}while(o<e.length);return r}(c,new RegExp(n),d);if(!u.length)return{node:t,offset:i};let f=function(e,t){let i,r,n,o;for(n=0;n<e.length;n++)o=Math.abs(e[n]-t),(!n||o<i)&&(o=i,r=e[n]);return r}(u,i);if(o===t&&f===i)return{node:t,offset:i};for(h=0,o=s;f>=l[h];){if(f-=l[h],f<0)return{node:t,offset:i};const e=[];if(!o.nextSibling||h+1>=e.length)return{node:t,offset:i};h++,o=o.nextSibling}return{node:o,offset:f}}resolveNode(e,t,i,r){if(r=Object.assign({},r||{}),!i)throw new Error("Missing DOM argument");let n;if(0===e&&(n=i.querySelector("package")),!n)for(const e of i.childNodes)if(e.nodeType===lt){n=e;break}if(n=i,!n)throw new Error("Document incompatible with CFIs");let o,s,a=n,l=0;for(o=t.length-1;o>=0;o--)if(s=t[o],!r.ignoreIDs&&s.nodeID&&(a=i.getElementById(s.nodeID))){l=o+1;break}a||(a=n);let c={node:a,offset:0};for(o=l;o<t.length;o++)s=t[o],s&&(c=this.getChildNodeByCFIIndex(i,c.node,s.nodeIndex,s.offset),s.textLocationAssertion&&(c=this.correctOffset(i,c.node,s.offset,s.textLocationAssertion)));return c}resolveURI(e,t,i){if(i=i||{},e<0||e>this.parts.length-2)throw new Error("index is out of bounds");const r=this.parts[e];if(!r)throw new Error("Missing CFI part for index: "+e);let n=this.resolveNode(e,r,t,i).node;const o=n.tagName.toLowerCase();if("itemref"===o&&"spine"===n.parentNode.tagName.toLowerCase()){const e=n.getAttribute("idref");if(!e)throw new Error("Referenced node had not 'idref' attribute");if(n=t.getElementById(e),!n)throw new Error("Specified node is missing from manifest");const i=n.getAttribute("href");if(!i)throw new Error("Manifest item is missing href attribute");return i}if("iframe"===o||"embed"===o){const e=n.getAttribute("src");if(!e)throw new Error(o+" element is missing 'src' attribute");return e}if("object"===o){const e=n.getAttribute("data");if(!e)throw new Error(o+" element is missing 'data' attribute");return e}if("image"===o||"use"===o){const e=n.getAttribute("xlink:href");if(!e)throw new Error(o+" element is missing 'xlink:href' attribute");return e}throw new Error("No URI found")}deepClone(e){return JSON.parse(JSON.stringify(e))}resolveLocation(e,t){const i=t.length-1,r=t[i];if(!r)throw new Error("Missing CFI part for index: "+i);const n=this.resolveNode(i,r,e),o=this.deepClone(r[r.length-1]);return delete o.nodeIndex,o.offset||delete n.offset,Object.assign(Object.assign({},o),n)}resolveLast(e,t){if(t=Object.assign({range:!1},t||{}),!this.isRange)return this.resolveLocation(e,this.parts);if(t.range){const t=e.createRange(),i=this.getFrom();"before"===i.relativeToNode?t.setStartBefore(i.node,i.offset):"after"===i.relativeToNode?t.setStartAfter(i.node,i.offset):t.setStart(i.node,i.offset);const r=this.getTo();return"before"===r.relativeToNode?t.setEndBefore(r.node,r.offset):"after"===r.relativeToNode?t.setEndAfter(r.node,r.offset):t.setEnd(r.node,r.offset),t}return{from:this.resolveLocation(e,this.getFrom()),to:this.resolveLocation(e,this.getTo()),isRange:!0}}resolve(e,t){return this.resolveLast(e,t)}}const gt=["color-0","color-1","color-2","color-3","line-0","line-1","line-2","line-3"],mt=["#FEF3CD","#FBFACC","#CEFACD","#CDE9FA"],yt=["#FF0000","#000080","#0000FF","#2EFF2E"],bt=["#fac106","#ebe702","#0be603","#0493e6"],vt=(e,t,r,n,o,s)=>{var a,l;i.init();let c=gt[t],h=s.contentWindow||(null===(a=s.contentDocument)||void 0===a?void 0:a.defaultView),d=e;d=[d],i.getSelection(s).restoreCharacterRanges(o,d);let u=o.getSelection();if(!u)return;let f=u.getRangeAt(0);for(var p=Tt(f),g=0;g<p.length;g++)Ct(p[g],c,r,n,o);h&&h.getSelection()&&(null===(l=h.getSelection())||void 0===l||l.empty())},wt=(e,t,i,r,n,o,s)=>{let a=gt[t],l=s.querySelector(".noteLayer"),c=s.querySelector("#koodoPDFLayer");var h=n.getViewport({scale:o});for(let t=0;t<e.coords.length;t++){const n=e.coords[t];var d=h.convertToViewportRectangle(n);if(!(Math.abs(Math.abs(d[1]-d[3])-h.height)<10||Math.abs(Math.abs(d[0]-d[2])-h.width)<10)){var u=document.createElement("div");c&&(null==u||u.setAttribute("style","position: absolute;"+(a.indexOf("color")>-1?"background-color: ":"border-bottom: ")+(a.indexOf("color")>-1?bt[a.split("-")[1]]:`2px solid ${yt[a.split("-")[1]]}`)+"; left:"+(Math.min(d[0],d[2])+parseFloat(getComputedStyle(c).marginLeft))+"px; top:"+Math.min(d[1],d[3])+"px;width:"+Math.abs(d[0]-d[2])+"px; height:"+Math.abs(d[1]-d[3])+"px; z-index: 1; cursor: pointer; opacity: "+(a.indexOf("color")>-1?.3:1)+";"),null==u||u.setAttribute("data-key",i),null==u||u.setAttribute("class","kookit-note"),null==u||u.addEventListener("click",(e=>{e&&e.target&&e.target.dataset&&e.target.dataset.key&&r(e)})),u.ontouchend=e=>{e&&e.target&&e.target.dataset&&e.target.dataset.key&&r(e),e.preventDefault(),e.stopPropagation()},l.appendChild(u))}}},xt=e=>{const t=e.querySelectorAll(".kookit-note");for(let e=0;e<t.length;e++){const i=t[e];i.parentNode.removeChild(i)}},Ct=(e,t,i,r,n)=>{const o=Lt(e.getClientRects());for(let e=0;e<o.length;e++){const l=o[e];var s=document.createElement("span");null==s||s.setAttribute("style","position: absolute;"+(t.indexOf("color")>-1?"background-color: ":"border-bottom: ")+(t.indexOf("color")>-1?mt[t.split("-")[1]]+";opacity: 1":`2px solid ${yt[t.split("-")[1]]}`)+";left:"+(Math.min(l.left,l.x)+n.body.scrollLeft)+"px; top:"+(Math.min(l.top,l.y)+n.body.scrollTop)+"px;width:"+l.width+"px; height:"+l.height+"px; z-index:-1;opacity: "+(t.indexOf("color")>-1?.8:1)+"; cursor: pointer;"),s.setAttribute("class"," kookit-note"),s.setAttribute("data-key",i),n.body.appendChild(s);var a=document.createElement("span");null==a||a.setAttribute("style","position: absolute;left:"+(Math.min(l.left,l.x)+n.body.scrollLeft)+"px; top:"+(Math.min(l.top,l.y)+n.body.scrollTop)+"px;width:"+l.width+"px; height:"+l.height+"px; z-index:1;"),a.setAttribute("class"," kookit-note"),a.setAttribute("data-key",i),a.addEventListener("click",(e=>{e&&e.target&&e.target.dataset&&e.target.dataset.key&&r(e)})),a.ontouchend=e=>{e&&e.target&&e.target.dataset&&e.target.dataset.key&&r(e),e.preventDefault(),e.stopPropagation()},n.body.appendChild(a)}},Lt=e=>{let t=[];for(let i=0;i<e.length;i++){const r=e[i];t.push(r)}return t},Tt=e=>{var t=e.commonAncestorContainer,i=new Array(0),r=new Array(0);if(e.startContainer!==t)for(let r=e.startContainer;r!==t;r=r.parentNode)i.push(r);if(i.length>0)for(let t=0;t<i.length;t++){var n=document.createRange();t?(n.setStartAfter(i[t-1]),n.setEndAfter(i[t].lastChild)):(n.setStart(i[t],e.startOffset),n.setEndAfter(i[t].nodeType===Node.TEXT_NODE?i[t]:i[t].lastChild)),r.push(n)}var o=new Array(0),s=new Array(0);if(e.endContainer!==t)for(var a=e.endContainer;a!==t;a=a.parentNode)o.push(a);if(o.length>0)for(let t=0;t<o.length;t++){var l=document.createRange();t?(l.setStartBefore(o[t].firstChild),l.setEndBefore(o[t-1])):(l.setStartBefore(o[t].nodeType===Node.TEXT_NODE?o[t]:o[t].firstChild),l.setEnd(o[t],e.endOffset)),s.unshift(l)}if(!(i.length>0&&o.length>0))return[e];var c=document.createRange();return c.setStartAfter(i[i.length-1]),c.setEndBefore(o[o.length-1]),r.push(c),r.concat(s)};const Mt=(e,t,i)=>{!function(e){let t=document.getElementById("book");t&&t.remove();const i=document.createElement("div");i.id="book";const r=document.createElement("canvas");r.id="pageflip-canvas";const n=document.createElement("div");n.id="pages";for(let t=0;t<e;t++){const e=document.createElement("section");n.appendChild(e)}i.appendChild(r),i.appendChild(n),document.body.appendChild(i);let o=document.createElement("style");o.innerHTML="\n      #book {\n        position: fixed;\n        width: 200vw;\n        height: 100vh;\n        left: -100vw;\n        top: 0vh;\n        float: left;\n        margin: 0;\n        display: none;\n      }\n\n      #pages section {\n        display: block;\n        width: 100vw;\n        height: 100vh;\n        position: absolute;\n        left: 100vw;\n        top: 0px;\n        overflow: hidden;\n        margin: 0;\n      }\n\n      #pageflip-canvas {\n        position: absolute;\n        z-index: 100;\n        margin: 0;\n      }\n    ",document.head.appendChild(o)}(e+1);var r=window.innerWidth,n=window.innerHeight,o=2*r-0,s=n-0,a=r,l=n,c=0,h=0,d=(s-l)/2,u=0,f=document.getElementById("pageflip-canvas");if(f){var p=f.getContext("2d"),g={x:0,y:0},m=[],y=document.getElementById("book");if(y){for(var b=y.getElementsByTagName("section"),v=0,w=b.length;v<w;v++)b[v].style.zIndex=w-v+"",m.push({progress:1,target:1,page:b[v],dragging:!1});return f.width=o+0,f.height=s+0,f.style.top="0px",f.style.left="0px",setInterval((function(){p.clearRect(0,0,f.width,f.height);for(var e=0;e<m.length;e++){var t=m[e];t.dragging&&(t.target=Math.max(Math.min(g.x/a,1),-1)),t.progress+=.2*(t.target-t.progress),(t.dragging||Math.abs(t.progress)<.997)&&T(t)}}),30),document.addEventListener("mousemove",x,!1),document.addEventListener("mousedown",C,!1),document.addEventListener("mouseup",L,!1),y.addEventListener("touchmove",x,!1),y.addEventListener("touchstart",C,!1),y.addEventListener("touchend",L,!1),{flipToNextPage:()=>{console.info("flipToNextPage"),u+1<m.length&&(m[u].target=-1,u=Math.min(u+1,m.length))},flipToPrevPage:()=>{console.info("flipToPrevPage"),u-1>=0&&(m[u-1].target=1,u=Math.max(u-1,0))},mouseDownHandler:C,mouseUpHandler:L,mouseMoveHandler:x}}}function x(e){if(!y)return;const t=e.touches[0],i=t.screenX,r=t.screenY;g.x=i-y.offsetLeft-o/2,g.y=r-y.offsetTop}function C(e){const t=e.touches[0];c=t.screenX,t.screenX<window.screen.width/2&&u-1>=0?m[u-1].dragging=!0:t.screenX>window.screen.width/2&&u+1<m.length&&(m[u].dragging=!0),e.preventDefault()}function L(e){const t=e.changedTouches[0];h=t.screenX;for(var i=0;i<m.length;i++)m[i].dragging&&(g.x<a/4*3&&h-c<0?(m[i].target=-1,u=Math.min(u+1,m.length)):g.x>a/4*1&&h-c>0?(m[i].target=1,u=Math.max(u-1,0)):i===u?m[i].target=1:i===u-1&&(m[i].target=-1)),m[i].dragging=!1}function T(e){var r=1-Math.abs(e.progress),n=.5*a*(1-e.progress),s=a*e.progress+n,c=20*r,h=.5*a*Math.max(Math.min(1-e.progress,.5),0),u=.5*a*Math.max(Math.min(r,.5),0),f=.5*a*Math.max(Math.min(r,.5),0);e.page.style.width=Math.max(s,0)+"px",p.save(),p.translate(0+o/2,d+0),p.strokeStyle=("no"===t?"rgba(0,0,0,":"rgba(255,255,255,")+.05*r+")",p.lineWidth=30*r,p.beginPath(),p.moveTo(s-n,.5*-c),p.lineTo(s-n,l+.5*c),p.stroke();var g=p.createLinearGradient(s,0,s+u,0);g.addColorStop(0,("no"===t?"rgba(0,0,0,":"rgba(255,255,255,")+.2*r+")"),g.addColorStop(.8,("no"===t?"rgba(0,0,0,":"rgba(255,255,255,")+"0.0)"),p.fillStyle=g,p.beginPath(),p.moveTo(s,0),p.lineTo(s+u,0),p.lineTo(s+u,l),p.lineTo(s,l),p.fill();var m=p.createLinearGradient(s-n-f,0,s-n,0);m.addColorStop(0,("no"===t?"rgba(0,0,0,":"rgba(255,255,255,")+"0.0)"),m.addColorStop(1,("no"===t?"rgba(0,0,0,":"rgba(255,255,255,")+.15*+r+")"),p.fillStyle=m,p.beginPath(),p.moveTo(s-n-f,0),p.lineTo(s-n,0),p.lineTo(s-n,l),p.lineTo(s-n-f,l),p.fill();var y=p.createLinearGradient(s-h,0,s,0);i?(y.addColorStop(.35,i),y.addColorStop(.73,i),y.addColorStop(.9,i),y.addColorStop(1,i)):"no"===t?(y.addColorStop(.35,"#fafafa"),y.addColorStop(.73,"#eeeeee"),y.addColorStop(.9,"#fafafa"),y.addColorStop(1,"#e2e2e2")):(y.addColorStop(.35,"#333"),y.addColorStop(.73,"#444"),y.addColorStop(.9,"#333"),y.addColorStop(1,"#444")),p.fillStyle=y,p.strokeStyle=("no"===t?"rgba(0,0,0,":"rgba(255,255,255,")+"0.06)",p.lineWidth=.5,p.beginPath(),p.moveTo(s,0),p.lineTo(s,l),p.quadraticCurveTo(s,l+2*c,s-n,l+c),p.lineTo(s-n,-c),p.quadraticCurveTo(s,2*-c,s,0),p.fill(),p.stroke(),p.restore()}},St=(e,t,i,r)=>h(void 0,void 0,void 0,(function*(){let{width:n,height:o}=yield i[r].text.getDimension(),s="double"===t?2:1,a=Math.floor(e.clientWidth/12),l=a%2==0?a:a-1,c=(e.clientWidth-l)/s;"single"===t&&(c=e.clientWidth);let h=e.clientHeight,d=Math.min(c/n,h/o);return"scroll"===t&&(d=c/n),d})),Dt=(e,t)=>{var i;const r=t.getElementById("pdf-container-"+e);if(!r)return;let n=document.createElement("iframe");n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.border="0",n.style.margin="0",n.style.padding="0",n.style.fontSize="100%",n.style.font="inherit",n.scrolling="no",n.tabIndex=0,n.id="pdf-iframe-"+e;let o=document.createElement("style");return o.id="default-style",o.textContent="p,empty-line{display: inherit;margin-block-start: inherit;margin-block-end: inherit;margin-inline-start: inherit;margin-inline-end: inherit;}body{margin: 0px}",r.appendChild(n),null===(i=n.contentDocument)||void 0===i||i.head.appendChild(o),n},kt=(e,t,i)=>h(void 0,void 0,void 0,(function*(){let r=i.getElementById("pdf-container-"+e);if(r){if("scroll"!==t){let e=r?d(r.offsetLeft)-d(r.marginLeft||parseFloat(getComputedStyle(r).marginLeft)):0;i.body.scrollTo(e,0)}else r.scrollIntoView();r.scrollIntoView()}})),At=(e,t,i)=>{var r=!1,n=t.getBoundingClientRect();if("scroll"!==i){let t=n.left;r=t>-10&&t<=e.clientWidth}else{let t=n.top,i=n.bottom;r=t-10>=e.scrollTop&&t+10<=e.scrollTop+e.clientHeight||i-10>=e.scrollTop&&i+10<=e.scrollTop+e.clientHeight||t+10<=e.scrollTop&&i-10>=e.scrollTop+e.clientHeight}return r},It=(e,t,i,r,n,o,s,a,l)=>h(void 0,void 0,void 0,(function*(){let c=Math.floor(e.clientWidth/12),h=c%2==0?c:c-1;const d=e.clientWidth;if("mimical"===t&&"yes"!==s){let e=document.getElementById("book");e&&(e.style.display="block",i>0?o():i<0&&n(),setTimeout((()=>{if(!e)return{};e.style.display="none"}),1e3))}if(i>0)if("single"===l){let e=r.querySelector("#pdf-container-"+(a-1));e&&e.scrollIntoView()}else r.body.scrollBy(-(d+h)/2,0);else if(i<0)if("single"===l){let e=r.querySelector("#pdf-container-"+(a+1));e&&e.scrollIntoView()}else r.body.scrollBy((d+h)/2,0)})),Et=e=>{const t=e.target;if(!t)return;const i=function(e){if("A"===e.tagName)return e;let t=e;for(;t&&"BODY"!==t.tagName;){if("A"===t.tagName)return t;t=t.parentElement}return null}(t);if(i){e.preventDefault(),e.stopPropagation();const t=i.getAttribute("href");return window.ReactNativeWebView.postMessage(JSON.stringify({event:"link-clicked",href:t})),!1}};const Nt=(e,t,r,n,o,s,a)=>{var l;let c=t.contentWindow||(null===(l=t.contentDocument)||void 0===l?void 0:l.defaultView),d=a.getDocument(),u=0,f=0,p=0,g=0;let m=Math.floor(r.clientWidth/12),y=m%2==0?m:m-1,b=!1,v=0;e.addEventListener("touchend",(function(t){console.info("touchend");let i=(new Date).getTime();if(i-g<=300)return void t.preventDefault();g=i;const l=t.changedTouches[0],h=Date.now();let m=l.screenX,v=l.screenY;const x=h-u,C=m-f,L=v-p;if(b&&"mimical"===o&&"scroll"!==n)return b=!1,a.mouseUpHandler(t),l.screenX<window.screen.width/4*3&&m-f<0?a.next():l.screenX>window.screen.width/4*1&&m-f>0&&a.prev(),void setTimeout((()=>{let e=document.getElementById("book");e&&(e.style.display="none")}),400);if(b&&"sliding"===o&&"scroll"!==n){let I="PDF"===s?d:e;if(window.scrollAnimationId&&cancelAnimationFrame(window.scrollAnimationId),Math.abs(I.body.scrollWidth-I.body.scrollLeft-r.clientWidth)<10)return w&&clearTimeout(w),void(w=setTimeout((()=>{a.next()}),300));if(0===I.body.scrollLeft)return w&&clearTimeout(w),void(w=setTimeout((()=>{a.prev()}),300));I.body.style.transform="";let E,N=r.clientWidth+y,R=I.body.scrollLeft;const B=Math.round(R/N),P=Math.abs(C)/window.screen.width,O=.1;E=C>0&&P>O?(B-1)*N:C<0&&P>O?(B+1)*N:B*N,E=Math.max(0,Math.min(E,I.body.scrollWidth-N)),I.body.scrollWidth-E<N+y&&(E=I.body.scrollWidth);const H=performance.now(),F=I.body.scrollLeft,W=E-F,$=300;I.body.style.willChange="scroll-position";const j=e=>1-Math.pow(1-e,3);function U(e){const t=e-H;if(t>=$)return I.body.scrollLeft=E,I.body.style.willChange="auto",a.record(),void(b=!1);const i=j(t/$),r=F+W*i;I.body.scrollLeft=r,window.scrollAnimationId=requestAnimationFrame(U)}window.scrollAnimationId=requestAnimationFrame(U)}else{var T=c.getSelection().toString();if(T)window.ReactNativeWebView.postMessage(JSON.stringify({event:"select-text-after-touch",selectedText:T}));else if(window.visualViewport.scale>1&&"PDF"===s)t.preventDefault();else if(x<500&&Math.abs(C)<30&&Math.abs(L)<30){var M=window.screen.width/3,S=window.screen.height/3,D=Math.floor(m/M),k=Math.floor(v/S),A="";0===k&&(0===D||1===D)||1===k&&0===D||2===k&&0===D||0===k&&1===D?A="left":1===k&&1===D?A="center":(0===k&&2===D||1===k&&2===D||2===k&&2===D||2===k&&1===D)&&(A="right"),window.ReactNativeWebView.postMessage(JSON.stringify({event:A}))}else(Math.abs(C)>=30||Math.abs(L)>=30)&&(console.info("Swipe detected"),window.ReactNativeWebView.postMessage(JSON.stringify({event:"swipe"})),"scroll"===n&&Math.abs(r.scrollHeight-r.scrollTop-r.clientHeight)<10&&window.ReactNativeWebView.postMessage(JSON.stringify({event:"scroll-bottom"})),"scroll"===n&&0===r.scrollTop&&window.ReactNativeWebView.postMessage(JSON.stringify({event:"scroll-top"})))}}),!1),e.addEventListener("touchstart",(function(e){if(!1===Et(e))return;const t=e.target;if(!t)return;if("IMG"===t.tagName){const e=t.src||t.getAttribute("xlink:href");window.ReactNativeWebView.postMessage(JSON.stringify({event:"view-image",imgSrc:e}))}e.touches.length>1&&e.preventDefault();const i=e.touches[0];u=Date.now(),f=i.screenX,p=i.screenY}),!1),e.addEventListener("touchmove",(function(t){if(!b&&Math.abs(t.touches[0].screenX-f)<=10)return;if(t.preventDefault(),window.visualViewport.scale>1&&"PDF"===s)return void t.preventDefault();const i=t.touches[0],r=i.screenX,l=i.screenY,c=r-f,h=l-p;if(!b&&Math.abs(c)>Math.abs(h)&&Math.abs(c)>10){if(b=!0,v=r,e.body.style.transform="translateZ(0)","mimical"===o&&"scroll"!==n){window.ReactNativeWebView.postMessage(JSON.stringify({event:"swipe-start"}));let e=document.getElementById("book");e&&(e.style.display="block",a.mouseDownHandler(t))}}else if(b&&"mimical"===o&&"scroll"!==n&&a.mouseMoveHandler(t),b&&"sliding"===o&&"scroll"!==n){let t="PDF"===s?d:e;const i=r-v,n=t.body.scrollLeft;t.body.scrollLeft=n-i,v=r,requestAnimationFrame((()=>{}))}}),!1),e.addEventListener("click",Et,!0);let w=null;e.body.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1};let x=0;e.addEventListener("selectstart",(t=>{"scroll"!==n&&(x=e.body.scrollLeft)}),!1),e.addEventListener("selectionchange",(t=>{x>0&&(e.body.scrollLeft=x),w&&clearTimeout(w),w=setTimeout((()=>h(void 0,void 0,void 0,(function*(){var e;const n=c.getSelection().toString().trim();if(n){var o=c.getSelection().getRangeAt(0);let d=a.getPageSize();var l=o.getBoundingClientRect();if("PDF"===s){let e=o.getClientRects();if(e.length>0){e=Array.from(e).filter((e=>Math.abs(e.height-d.sectionHeight)>10&&Math.abs(e.width-d.sectionWidth)>10&&e.height>0&&e.width>0));let t=1/0,i=1/0,r=-1/0,n=-1/0;for(let o=0;o<e.length;o++){const s=e[o];t=Math.min(t,s.top),i=Math.min(i,s.left),r=Math.max(r,s.bottom),n=Math.max(n,s.right)}l={top:t,left:i,bottom:r,right:n,width:n-i,height:r-t}}}var h={top:l.top-r.scrollTop,left:l.left,width:l.width,height:l.height,screenWidth:window.innerWidth,screenHeight:window.innerHeight,sectionHeight:d.sectionHeight,chapterDocIndex:0,sectionWidth:d.sectionWidth,gap:d.gap,scale:window.visualViewport.scale};i.init();let u=null;if("PDF"===s){let i=t.target,r=null===(e=null==i?void 0:i.defaultView)||void 0===e?void 0:e.frameElement,n=(null==r?void 0:r.getAttribute("id"))||"",o=n?parseInt(n.split("-").reverse()[0]):0;u=yield a.getHightlightCoords(o),h.chapterDocIndex=o;let s=r.parentElement;s&&(h.top=h.top+parseFloat(getComputedStyle(s).top))}else u=yield a.getHightlightCoords();window.ReactNativeWebView.postMessage(JSON.stringify({event:"select-text",selectedText:n,position:h,range:u}))}}))),"PDF"===s?300:100)}),!1)},Rt=(e,t,r,n,o,s,a)=>{var l;let c=t.contentWindow||(null===(l=t.contentDocument)||void 0===l?void 0:l.defaultView),d=a.getDocument(),u=0,f=0,p=0,g=0;let m=Math.floor(r.clientWidth/12),y=m%2==0?m:m-1,b=!1,v=0;e.addEventListener("touchend",(function(t){var l,m;return h(this,void 0,void 0,(function*(){let h=(new Date).getTime();if(h-g<=300)return void t.preventDefault();g=h;const v=t.changedTouches[0],x=Date.now(),C=v.screenX,L=v.screenY,T=x-u,M=C-f,S=L-p;if(b&&"mimical"===o&&"scroll"!==n)return b=!1,a.mouseUpHandler(t),C<window.screen.width/4*3&&C-f<0?a.next():C>window.screen.width/4*1&&C-f>0&&a.prev(),void setTimeout((()=>{let e=document.getElementById("book");e&&(e.style.display="none")}),400);if(b&&"sliding"===o&&"scroll"!==n){let E="PDF"===s?d:e;if(window.scrollAnimationId&&cancelAnimationFrame(window.scrollAnimationId),Math.abs(E.body.scrollWidth-E.body.scrollLeft-r.clientWidth)<10)return w&&clearTimeout(w),void(w=setTimeout((()=>{a.next()}),300));if(0===E.body.scrollLeft)return w&&clearTimeout(w),void(w=setTimeout((()=>{a.prev()}),300));E.body.style.transform="";let N,R=r.clientWidth+y,B=E.body.scrollLeft;const P=Math.round(B/R),O=Math.abs(M)/window.screen.width,H=.1;N=M>0&&O>H?(P-1)*R:M<0&&O>H?(P+1)*R:P*R,N=Math.max(0,Math.min(N,E.body.scrollWidth-R)),E.body.scrollWidth-N<R+y&&(N=E.body.scrollWidth);const F=performance.now(),W=E.body.scrollLeft,$=N-W,j=300;E.body.style.willChange="scroll-position";const U=e=>1-Math.pow(1-e,3);function q(e){const t=e-F;if(t>=j)return E.body.scrollLeft=N,E.body.style.willChange="auto",a.record(),void(b=!1);const i=U(t/j),r=W+$*i;E.body.scrollLeft=r,window.scrollAnimationId=requestAnimationFrame(q)}return void(window.scrollAnimationId=requestAnimationFrame(q))}const D=c.getSelection().toString().trim();if(D){var k=c.getSelection().getRangeAt(0).getBoundingClientRect(),A=a.getPageSize(),I={top:k.top-r.scrollTop,left:k.left,width:k.width,height:k.height,screenWidth:window.innerWidth,screenHeight:window.innerHeight,sectionHeight:A.sectionHeight,chapterDocIndex:0,sectionWidth:A.sectionWidth,gap:A.gap,scale:window.visualViewport.scale};i.init();let z=null;if("PDF"===s){let X=t.target.ownerDocument,V=null===(l=null==X?void 0:X.defaultView)||void 0===l?void 0:l.frameElement,J=(null==V?void 0:V.getAttribute("id"))||"",G=J?parseInt(J.split("-").reverse()[0]):0;I.chapterDocIndex=G,z=yield a.getHightlightCoords(G);let _=V.parentElement;_&&(I.top=I.top+parseFloat(getComputedStyle(_).top))}else z=yield a.getHightlightCoords();window.ReactNativeWebView.postMessage(JSON.stringify({event:"select-text",selectedText:D,position:I,range:z}))}else if(T<500&&Math.abs(M)<30&&Math.abs(S)<30){const Z=document.documentElement.clientWidth;document.documentElement.clientHeight;let Y=Math.min(Math.max(C,0),Z);if("PDF"===s&&"double"===n){let te=t.target.ownerDocument,ie=null===(m=null==te?void 0:te.defaultView)||void 0===m?void 0:m.frameElement,re=(null==ie?void 0:ie.getAttribute("id"))||"";(re?parseInt(re.split("-").reverse()[0]):0)%2==1&&(Y+=Z/2)}if(window.visualViewport.scale>1&&"PDF"===s)return void t.preventDefault();let K="";const Q=Z/3,ee=Math.min(Math.floor(Y/Q),2);0===ee?K="left":1===ee?K="center":2===ee&&(K="right"),window.ReactNativeWebView.postMessage(JSON.stringify({event:K}))}else(Math.abs(M)>=30||Math.abs(S)>=30)&&(window.ReactNativeWebView.postMessage(JSON.stringify({event:"swipe"})),"scroll"===n&&Math.abs(r.scrollHeight-r.scrollTop-r.clientHeight)<10&&window.ReactNativeWebView.postMessage(JSON.stringify({event:"scroll-bottom"})),"scroll"===n&&0===r.scrollTop&&window.ReactNativeWebView.postMessage(JSON.stringify({event:"scroll-top"})))}))}),!1),e.addEventListener("touchstart",(function(e){if(!1===Et(e))return;const t=e.target;if(!t)return;if("IMG"===t.tagName){const e=t.src||t.getAttribute("xlink:href");window.ReactNativeWebView.postMessage(JSON.stringify({event:"view-image",imgSrc:e}))}e.touches.length>1&&e.preventDefault();const i=e.touches[0];u=Date.now(),f=i.screenX,p=i.screenY}),!1),e.addEventListener("touchmove",(function(t){const i=c.getSelection().toString().trim();if(!b&&Math.abs(t.touches[0].screenX-f)<=10||i)return;if(window.visualViewport.scale>1&&"PDF"===s)return void t.preventDefault();t.preventDefault();const r=t.touches[0],l=r.screenX,h=r.screenY,u=l-f,g=h-p;if(!b&&Math.abs(u)>Math.abs(g)&&Math.abs(u)>10){if(b=!0,v=l,"mimical"===o&&"scroll"!==n){window.ReactNativeWebView.postMessage(JSON.stringify({event:"swipe-start"}));let e=document.getElementById("book");e&&(e.style.display="block",a.mouseDownHandler(t))}}else if(b&&"mimical"===o&&"scroll"!==n&&a.mouseMoveHandler(t),b&&"sliding"===o&&"scroll"!==n){let t="PDF"===s?d:e;const i=l-v,r=t.body.scrollLeft;t.body.scrollLeft=r-i,v=l,requestAnimationFrame((()=>{}))}}),!1),e.addEventListener("click",Et,!0);let w=null;e.addEventListener("touchmove",(e=>{}),!1),e.body.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1}};class Bt extends at{constructor(t){super(),this.tsTransform=()=>{let t=this.getDocument();t&&("Simplified To Traditional"===this.convertChinese?t.querySelectorAll("h1,h2,h3,h4,h5,h6,p,div,ul,dl,ol,pre,blockquote,address,kookitmarker").forEach((t=>{t.innerHTML=t.innerHTML.split("").map((t=>e.s2t(t))).join("")})):"Traditional To Simplified"===this.convertChinese&&t.querySelectorAll("h1,h2,h3,h4,h5,h6,p,div,ul,dl,ol,pre,blockquote,address,kookitmarker").forEach((t=>{t.innerHTML=t.innerHTML.split("").map((t=>e.t2s(t))).join("")})))},this.addPageAnimation=e=>{if("mimical"===this.animation){let t=this.getProgress();if(!t)return;const i=Mt(t.totalPage,this.isDarkMode,e);i&&(this.flipToNextPage=i.flipToNextPage,this.flipToPrevPage=i.flipToPrevPage,this.mouseDownHandler=i.mouseDownHandler,this.mouseUpHandler=i.mouseUpHandler,this.mouseMoveHandler=i.mouseMoveHandler)}},this.readerMode=t.readerMode,this.animation=t.animation,this.format=t.format,this.convertChinese=t.convertChinese,this.isDarkMode=t.isDarkMode,this.isMobile=t.isMobile,this.chapterList=[],this.chapterDocList=[],this.flattenChapters=[],this.book="",this.element="",this.tempLocation={},this.flipToNextPage=()=>{},this.flipToPrevPage=()=>{},this.mouseDownHandler=()=>{},this.mouseUpHandler=()=>{},this.mouseMoveHandler=e=>{},this.touchEventSet={},"yes"===this.isMobile&&(console.log=function(...e){window.ReactNativeWebView.postMessage(e.map((e=>String(e))).join(", "))},console.info=function(...e){window.ReactNativeWebView.postMessage(e.map((e=>String(e))).join(", "))},console.error=function(...e){window.ReactNativeWebView.postMessage(e.map((e=>String(e))).join(", "))})}getPageSize(){let e="double"===this.readerMode?2:1,t=Math.floor(this.element.clientWidth/12),i=t%2==0?t:t-1,r=this.getIframe();if(!r)return;let n=null==r?void 0:r.getBoundingClientRect().height;return{width:this.element.clientWidth,height:this.element.clientHeight,left:this.element.offsetLeft,top:this.element.offsetTop,scrollTop:this.element.scrollTop,sectionWidth:(this.element.clientWidth-i)/e,sectionHeight:n,gap:i}}resolveChapter(e){let t=e,i=-1;for(let e=0;e<this.flattenChapters.length;e++)if(this.flattenChapters[e].href.includes(t)){i=e;break}if(i>-1)return this.flattenChapters[i];{let r=e.split("#")[0];for(let e=0;e<this.flattenChapters.length;e++)if(this.flattenChapters[e].href.includes(r.substring(1))){i=e;break}if(i>-1)return this.flattenChapters[i];for(let e=0;e<this.chapterDocList.length;e++)if(this.chapterDocList[e].text&&this.chapterDocList[e].text.id&&(this.chapterDocList[e].text.id+"").includes(t)){i=e;break}return i>-1?{label:"",href:"",index:i}:null}}flatChapter(e){let t=[];for(let i=0;i<e.length;i++)e[i].subitems&&e[i].subitems.length>0?(t.push(e[i]),t=t.concat(this.flatChapter(e[i].subitems))):t.push(e[i]);return this.flattenChapters=t,t}getChapter(){return this.chapterList}getChapterDoc(){return this.chapterDocList}goToPercentage(e){return h(this,void 0,void 0,(function*(){if(this.flattenChapters.length>0){let t=1===e?this.flattenChapters.length-1:Math.floor(this.flattenChapters.length*e);yield this.goToChapter(this.flattenChapters[t].index.toString(),this.flattenChapters[t].href,this.flattenChapters[t].label)}}))}goToChapterIndex(e){return h(this,void 0,void 0,(function*(){this.flattenChapters.length>0&&(yield this.goToChapter(this.flattenChapters[e].index,this.flattenChapters[e].href,this.flattenChapters[e].label))}))}goToChapter(e,t,i){return h(this,void 0,void 0,(function*(){let r=this.getDocument(),n=this.getIframe();r&&n&&(yield _e(parseInt(e),i,t,this.chapterDocList,this.element,this.readerMode,this.format,this.tempLocation,r,n),t&&t.indexOf("#")>-1&&(yield Ye(this.element,this.readerMode,"","",t,"",r)),yield this.record(),this.trigger("rendered"))}))}goToPosition(e){return h(this,void 0,void 0,(function*(){let t=this.getDocument(),i=this.getIframe();if(!t||!i)return;let r=JSON.parse(e);this.tempLocation={text:r.text,chapterTitle:r.chapterTitle,chapterDocIndex:r.chapterDocIndex,chapterHref:r.chapterHref,count:r.count,page:r.page,percentage:r.percentage};let{text:n,chapterTitle:o,chapterDocIndex:s,chapterHref:a,count:l,page:c,cfi:h}=r;if(yield _e(parseInt(s),o,a,this.chapterDocList,this.element,this.readerMode,this.format,this.tempLocation,t,i),h){const e=new pt(h,{});let t=this.getDocument();if(!t)return;const{node:i,offset:r}=e.resolve(t,{});if(i){let e=null,t=i;for(;t;){const i=t;if(i.tagName&&"h1,h2,h3,h4,h5,h6,p,div,ul,dl,ol,pre,blockquote,address,kookitmarker".indexOf(i.tagName.toLowerCase())>-1){e=i;break}t=t.parentNode}e&&(l="ignore",n=e.textContent)}}yield Ye(this.element,this.readerMode,n,l,"",c,t),yield this.record(),this.trigger("rendered")}))}getDocument(){let e=document.getElementById("page-area");if(!e)return null;let t=e.getElementsByTagName("iframe")[0];if(!t)return null;let i=t.contentDocument;return i||null}getIframe(){let e=document.getElementById("page-area");if(!e)return null;let t=e.getElementsByTagName("iframe")[0];return t||null}goToNode(e){return h(this,void 0,void 0,(function*(){let t=this.getDocument();if(!t)return;let i=Ke(e,this.element,this.readerMode),r=i?d(i.offsetLeft)-d(i.marginLeft||parseFloat(getComputedStyle(i).marginLeft)):0,n=i?d(i.offsetTop)-d(i.marginTop||parseFloat(getComputedStyle(i).marginTop)):0;"scroll"!==this.readerMode?t.body.scrollTo(r,0):this.element.scrollTo(0,n),yield this.record(),this.trigger("rendered")}))}removeContent(){this.element.innerHTML=""}prev(){return h(this,void 0,void 0,(function*(){let e=this.getDocument(),t=this.getIframe();if(e&&t){if("scroll"===this.readerMode&&0===d(this.element.scrollTop)||"scroll"!==this.readerMode&&0===d(e.body.scrollLeft)){if("0"===this.tempLocation.chapterDocIndex)return;yield Ge(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.readerMode,this.format,this.tempLocation,e,t),parseInt(this.tempLocation.chapterDocIndex||"-1")>-1&&("scroll"===this.readerMode?this.element.scrollTo(0,e.body.scrollHeight):e.body.scrollTo(e.body.scrollWidth,0)),this.trigger("rendered")}else"scroll"===this.readerMode?this.element.scrollBy({left:0,top:-(this.element.clientHeight-50),behavior:"smooth"}):yield Ve(this.element,this.animation,1,e,this.flipToNextPage,this.flipToPrevPage,this.isMobile);yield this.record()}}))}next(){return h(this,void 0,void 0,(function*(){let e=this.getDocument(),t=this.getIframe();e&&t&&(Math.abs(e.body.scrollWidth-d(e.body.scrollLeft)-e.body.clientWidth)<10&&"scroll"!==this.readerMode||Math.abs(this.element.scrollHeight-d(this.element.scrollTop)-this.element.clientHeight)<10&&"scroll"===this.readerMode?(yield rt(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.readerMode,this.format,this.tempLocation,e,t),this.trigger("rendered")):"scroll"===this.readerMode?this.element.scrollBy({left:0,top:this.element.clientHeight-50,behavior:"smooth"}):yield Ve(this.element,this.animation,-1,e,this.flipToNextPage,this.flipToPrevPage,this.isMobile),yield this.record())}))}prevChapter(){return h(this,void 0,void 0,(function*(){let e=this.getDocument(),t=this.getIframe();e&&t&&(yield Ge(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.readerMode,this.format,this.tempLocation,e,t),yield this.record(),this.trigger("rendered"))}))}nextChapter(){return h(this,void 0,void 0,(function*(){let e=this.getDocument(),t=this.getIframe();e&&t&&(yield rt(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.readerMode,this.format,this.tempLocation,e,t),yield this.record(),this.trigger("rendered"))}))}visibleText(){return h(this,void 0,void 0,(function*(){let e=this.getDocument();return e?nt(this.element,this.readerMode,e):""}))}audioText(){return h(this,void 0,void 0,(function*(){let e=this.getDocument();return e?((e,t,i)=>{let r=Xe(i.body).filter((e=>!ot(e))).filter((e=>(e.textContent||"").trim())).filter((e=>"img"!==e.textContent)).map((e=>e.textContent)),n=0,o=nt(e,t,i);if(o&&o.length>0){let e=o[0];n=r.indexOf(e)}return r.slice(n)})(this.element,this.readerMode,e):""}))}chapterText(){return h(this,void 0,void 0,(function*(){let e=this.getDocument();return e&&e.body.textContent||""}))}highlightNode(e,t){let i=this.getDocument();i&&((e,t,i)=>{let r=Xe(i.body).filter((i=>(i.getAttribute("style")===t&&i.setAttribute("style",""),(i.textContent||"").trim()&&i.textContent===e)));r.length>0&&r[0].setAttribute("style",t)})(e,t,i)}doSearch(e){return h(this,void 0,void 0,(function*(){return"PDF"===this.format?yield((e,i)=>h(void 0,void 0,void 0,(function*(){let r=[];for(let t=0;t<i.length;t++){let n=yield i[t].text.getTextContent(),o=n.items.findIndex((t=>t.str.indexOf(e)>-1));o>-1&&r.push({excerpt:n.items[o].str,cfi:JSON.stringify({text:n.items[o].str+"#"+t,chapterTitle:i[t].label,chapterDocIndex:t,chapterHref:i[t].href,count:"search",percentage:t/i.length})})}return t.uniq(r,"excerpt")})))(e,this.chapterDocList):yield((e,i)=>h(void 0,void 0,void 0,(function*(){var r;let n=[];for(let t=0;t<i.length;t++){let o=(new DOMParser).parseFromString(yield u(i[t].text,!0),"text/html"),s=Xe(o.body).filter((e=>!ot(e)));for(let o=0;o<s.length;o++){let a=(s[o].textContent||"").indexOf(e);a>-1&&n.push({excerpt:(null===(r=s[o].textContent)||void 0===r?void 0:r.substring(a-100,a+100))||"",cfi:JSON.stringify({text:s[o].textContent,chapterTitle:i[t].label,chapterDocIndex:t,chapterHref:i[t].href,count:"search",percentage:t/i.length})})}}return t.uniq(n,"excerpt")})))(e,this.chapterDocList)}))}getProgress(){let e=this.getDocument();if(e)return y(this.readerMode,e,this.element)}record(){return h(this,void 0,void 0,(function*(){""!==this.animation&&(yield new Promise((e=>setTimeout(e,1e3))));let e=this.getDocument();e&&(yield et(this.element,this.readerMode,this.flatChapter(this.chapterList),this.chapterDocList,this.tempLocation,e,null),this.trigger("page-changed"))}))}getPosition(){return this.tempLocation}getNotePosition(){return h(this,void 0,void 0,(function*(){let e=this.getDocument();if(!e)return;let t=C(e);return t?(yield et(this.element,this.readerMode,this.flatChapter(this.chapterList),this.chapterDocList,this.tempLocation,e,t),this.tempLocation):void 0}))}setStyle(e){let t=this.getDocument();if(t){var i=document.createElement("style");i.innerHTML=e,t.head.appendChild(i)}}getHightlightCoords(){return h(this,void 0,void 0,(function*(){i.init();let e=this.getDocument(),t=this.getIframe();if(e&&t)return i.getSelection(t).saveCharacterRanges(e.body)[0]}))}renderHighlighters(e,t){return h(this,void 0,void 0,(function*(){let i=this.getDocument(),r=this.getIframe();if(i&&r){xt(i);for(let n=0;n<e.length;n++){const o=e[n];try{vt(JSON.parse(o.range),o.color,o.key,t,i,r)}catch(e){return void console.error(e,"Exception has been caught when restore character ranges.")}}}}))}removeOneNote(e,t){let i=this.getDocument();if(!i)return;const r=i.querySelectorAll(".kookit-note");for(let t=0;t<r.length;t++){const i=r[t];i.getAttribute("data-key")===e&&i.parentNode.removeChild(i)}}createOneNote(e,t){return h(this,void 0,void 0,(function*(){let i=this.getDocument(),r=this.getIframe();i&&r&&vt(JSON.parse(e.range),e.color,e.key,t,i,r)}))}displayFontBase64(e,t,i,r){return h(this,void 0,void 0,(function*(){let n=this.getDocument();if(!n||0===t.length)return;const o=new FontFace(e,`url(data:font/${r};charset=utf-8;base64,${t})`);let s=yield o.load();document.fonts.add(s);const a="@font-face {  font-family: '"+e+"';  src: url('data:font/"+r+";charset=utf-8;base64,"+t+"') format('"+i+"');}",l=document.createElement("style");l.type="text/css",l.appendChild(document.createTextNode(a)),n.head.appendChild(l)}))}displayFontUrl(e,t){return h(this,void 0,void 0,(function*(){let i=this.getDocument();if(!i)return;const r=new FontFace(e,`url(${t})`);let n=yield r.load();document.fonts.add(n);const o="@font-face {  font-family: '"+e+"';  src: url('"+t+"') format('truetype');}",s=document.createElement("style");s.type="text/css",s.appendChild(document.createTextNode(o)),i.head.appendChild(s)}))}getAllDocuments(){let e=this.getDocument();if(!e)return[];if("PDF"!==this.format)return[e];let t=e.querySelectorAll("iframe"),i=[];return t.forEach((e=>{let t=e.contentDocument;t&&i.push(t)})),[e,...i]}getAllIframes(){let e=this.getIframe();if(!e)return[];if("PDF"!==this.format)return[e];let t=this.getDocument();if(!t)return[];let i=t.querySelectorAll("iframe"),r=[];return i.forEach((e=>{let t=e;r.push(t)})),[e,...r]}addTouchEvent(e){let t=this.getAllDocuments(),i=this.getAllIframes();for(let r=0;r<t.length;r++){const n=t[r],o=i[r];if(!n||!o)continue;let s=o.id;this.touchEventSet[s]||(this.touchEventSet[s]=!0,"yes"===e?Nt(n,o,this.element,this.readerMode,this.animation,this.format,this):Rt(n,o,this.element,this.readerMode,this.animation,this.format,this))}}clearSelection(){var e,t;let i=this.getAllIframes();for(let r=0;r<i.length;r++){const n=i[r];if(!n)continue;let o=n.contentWindow||(null===(e=n.contentDocument)||void 0===e?void 0:e.defaultView);if(!o||!o.getSelection())return;null===(t=o.getSelection())||void 0===t||t.empty()}}clearSelectionKeepHighlight(){var e,t;if("PDF"===this.format)return;let r=this.getDocument(),n=this.getIframe();if(!r||!n)return;let o=n.contentWindow||(null===(e=n.contentDocument)||void 0===e?void 0:e.defaultView);if(!o||!o.getSelection())return;let s=r.getSelection();if(!s)return;let a=s.getRangeAt(0);for(var l=Tt(a),c=0;c<l.length;c++){const e=Lt(l[c].getClientRects());for(let t=0;t<e.length;t++){const i=e[t];let n=document.createElement("span");null==n||n.setAttribute("style","position: absolute; background-color: #f3a6a68c;left:"+(Math.min(i.left,i.x)+r.body.scrollLeft)+"px; top:"+(Math.min(i.top,i.y)+r.body.scrollTop)+"px;width:"+i.width+"px; height:"+i.height+"px; z-index:-1;"),n.setAttribute("id","temp-highlight"),r.body.appendChild(n)}}let h=i.getSelection(n).saveCharacterRanges(r.body)[0];window.charRange=h,null===(t=o.getSelection())||void 0===t||t.removeAllRanges()}restoreSelectionClearHighlight(){if("PDF"===this.format)return;let e=this.getDocument();if(!e)return;e.querySelectorAll("#temp-highlight").forEach((e=>{var t;null===(t=e.parentNode)||void 0===t||t.removeChild(e)}));let t=this.getIframe();if(!t)return;i.init();let r=window.charRange;r&&i.getSelection(t).restoreCharacterRanges(e,[r])}}const Pt={svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed",tar:"application/x-tar",html:"text/html",htm:"text/html",xml:"text/xml",xhtml:"application/xhtml+xml",css:"text/css"},Ot={"image/svg+xml":"svg","image/png":"png","image/jpeg":"jpg","image/gif":"gif","image/webp":"webp","application/zip":"zip","application/x-rar-compressed":"rar","application/x-7z-compressed":"7z","application/x-tar":"tar","text/html":"html","text/xml":"xml","application/xhtml+xml":"xhtml","text/css":"css"},Ht=e=>h(void 0,void 0,void 0,(function*(){let i=yield r.loadAsync(e);var n=i.file("toc.json");let o=[];n&&(o=JSON.parse(yield n.async("string")));var s=i.file("sections.json");let a=[];s&&(a=JSON.parse(yield s.async("string")));const l={getCover:()=>""};return l.sections=a.map(((e,t)=>({id:e.href,load:()=>(e=>h(void 0,void 0,void 0,(function*(){var t=i.file("chapters/"+e+".html");let r="";return t&&(r=yield t.async("string")),URL.createObjectURL(new Blob([r],{type:"text/html"}))})))(t),unload:()=>{},loadAsset:e=>(e=>h(void 0,void 0,void 0,(function*(){var t=i.file(e);let r;return t&&(r=yield t.async("arraybuffer")),URL.createObjectURL(new Blob([r],{type:Pt[e.split(".").reverse()[0]]}))})))(e)}))),l.toc=o.map((e=>({label:e.label,href:e.href,subitems:e.subitems}))),l.rendition={layout:"pre-paginated"},l.resolveHref=e=>({index:t.findLastIndex(a,{href:e})}),l.splitTOCHref=e=>[e,null],l.getTOCFragment=e=>e.documentElement,l})),Ft=e=>new Promise(((t,i)=>h(void 0,void 0,void 0,(function*(){let i=new T(e),n=yield i.getChapter(e.toc),o=yield i.getChapterDoc(),s=n,a=o.map((e=>({href:e.href,label:e.label}))),l=yield Promise.all(o.map((e=>h(void 0,void 0,void 0,(function*(){let t="";if(e.text.load){let i=yield fetch(yield e.text.load()).then((e=>e.blob()));t=yield i.text()}return t}))))),c=new r;c.file("toc.json",JSON.stringify(s)),c.file("sections.json",JSON.stringify(a));let d=[];for(let e=0;e<l.length;e++){let t=(new DOMParser).parseFromString(l[e],"text/html"),i=f(t);for(let t=0;t<i.length;t++){let r=c.folder("imgs/"+e);if(!r)break;let n=i[t].getAttribute("src")||i[t].getAttribute("xlink:href");if(n)try{let o=yield fetch(yield n).then((e=>e.blob()));r.file(t+"."+Ot[o.type],o);let s="imgs/"+e+"/"+t+"."+Ot[o.type];i[t].src=s,i[t].getAttribute("xlink:href")&&i[t].setAttribute("xlink:href",s)}catch(e){console.error(e)}}let r=Array.from(t.getElementsByTagName("link"));for(let t=0;t<r.length;t++){let i=r[t],n=c.folder("css/"+e);if(!n)break;if(i.getAttribute("href"))try{let r=yield fetch(yield i.getAttribute("href")).then((e=>e.blob()));n.file(t+"."+Ot[r.type],r),i.href="css/"+e+"/"+t+"."+Ot[r.type]}catch(e){console.error(e)}}d.push(t.documentElement.innerHTML)}let u=c.folder("chapters");if(u){for(let e=0;e<d.length;e++)u.file(e+".html",d[e]);c.generateAsync({type:"blob"}).then((e=>h(void 0,void 0,void 0,(function*(){t(yield new Response(e).arrayBuffer())})))).catch((e=>{t("err")}))}}))));class Wt extends Bt{constructor(e,t){super(Object.assign({format:"EPUB"},t)),this.epubBuffer=e}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let i=new T(this.book);this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),m(e);let r=this.getDocument();r&&(x(e,this.readerMode,r),t())}))))}parse(){return h(this,void 0,void 0,(function*(){let e=new Blob([this.epubBuffer]),t=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});try{const e=yield this.makeZipLoader(t);this.book=yield new Me(e).init()}catch(e){throw console.error(e),e}}))}preCache(){return h(this,void 0,void 0,(function*(){try{return this.book||(yield this.parse()),yield Ft(this.book)}catch(e){return""}}))}makeZipLoader(e){return h(this,void 0,void 0,(function*(){let t=yield r.loadAsync(e);const i=t.files;return{entries:Object.values(i).map((e=>({filename:e.name}))),loadText:e=>h(this,void 0,void 0,(function*(){let i=t.file(e);return i?i.async("string"):""})),loadBlob:e=>h(this,void 0,void 0,(function*(){let i=t.file(e);if(i){let e=yield i.async("arraybuffer");return new Blob([e])}return new Blob([new ArrayBuffer(0)])})),getSize:e=>0}}))}getMetadata(){return h(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());let e=new T(this.book);return yield e.getMetadata()}catch(e){throw console.error(e,"error"),e}}))}}const $t=e=>{if(!e)return"";const t=document.createElement("textarea");return t.innerHTML=e,t.value},jt={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},Ut={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},qt={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},zt={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},Xt={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},Vt={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},Jt={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},Gt={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},_t={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},Zt={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},Yt={magic:[0,4,"string"],numEntries:[8,4,"uint"]},Kt={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},Qt={1252:"windows-1252",65001:"utf-8"},ei={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},ti={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},ii=(e,t)=>{const i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},ri=(e,t,i)=>{const r=new e.constructor(e.length+t.length+i.length);return r.set(e),r.set(t,e.length),r.set(i,e.length+t.length),r},ni=new TextDecoder,oi=e=>ni.decode(e),si=e=>{if(!e)return;const t=e.byteLength,i=4===t?"getUint32":2===t?"getUint16":"getUint8";return new DataView(e)[i](0)},ai=(e,t)=>Object.fromEntries(Array.from(Object.entries(e)).map((([e,[i,r,n]])=>[e,("string"===n?oi:si)(t.slice(i,i+r))]))),li=e=>new TextDecoder(Qt[e]),ci=(e,t=0)=>{let i=0,r=0;for(const n of e.subarray(t,t+4))if(i=i<<7|(127&n)>>>0,r++,128&n)break;return{value:i,length:r}},hi=e=>{let t=0;for(const i of e.subarray(-4))128&i&&(t=0),t=t<<7|127&i;return t},di=e=>{let t=0;for(;e>0;e>>=1)1&~e||t++;return t},ui=e=>{let t=0;for(;!(1&e);)e>>=1,t++;return t},fi=e=>{let t=[];for(let i=0;i<e.length;i++){const r=e[i];if(0===r)t.push(0);else if(r<=8)for(const n of e.subarray(i+1,(i+=r)+1))t.push(n);else if(r<=127)t.push(r);else if(r<=191){const n=r<<8|e[1+i++],o=(16383&n)>>>3,s=3+(7&n);for(let e=0;e<s;e++)t.push(t[t.length-o])}else t.push(32,128^r)}return Uint8Array.from(t)},pi=(e,t)=>{const i=t+32,r=i>>3;let n=0n;for(let i=t>>3;i<=r;i++)n=n<<8n|BigInt(e[i]??0);return n>>8n-BigInt(7&i)&0xffffffffn},gi=async(e,t)=>{const i=await t(e),r=ai(Jt,i);if("INDX"!==r.magic)throw new Error("Invalid INDX record");const n=li(r.encoding),o=i.slice(r.length),s=ai(Gt,o);if("TAGX"!==s.magic)throw new Error("Invalid TAGX section");const a=(s.length-12)/4,l=Array.from({length:a},((e,t)=>new Uint8Array(o.slice(12+4*t,12+4*t+4)))),c={};let h=0;for(let i=0;i<r.numCncx;i++){const o=await t(e+r.numRecords+i+1),s=new Uint8Array(o);for(let e=0;e<s.byteLength;){const t=e,{value:i,length:r}=ci(s,e);e+=r;const a=o.slice(e,e+i);e+=i,c[h+t]=n.decode(a)}h+=65536}const d=[];for(let i=0;i<r.numRecords;i++){const r=await t(e+1+i),n=new Uint8Array(r),o=ai(Jt,r);if("INDX"!==o.magic)throw new Error("Invalid INDX record");for(let e=0;e<o.numRecords;e++){const t=o.idxt+4+2*e,i=si(r.slice(t,t+2)),a=si(r.slice(i,i+1)),c=oi(r.slice(i+1,i+1+a)),h=[],u=i+1+a;let f=0,p=u+s.numControlBytes;for(const[e,t,i,o]of l){if(1&o){f++;continue}const s=u+f,a=si(r.slice(s,s+1))&i;if(a===i)if(di(i)>1){const{value:i,length:r}=ci(n,p);h.push([e,null,i,t]),p+=r}else h.push([e,1,null,t]);else h.push([e,a>>ui(i),null,t])}const g={};for(const[e,t,i,r]of h){const o=[];if(null!=t)for(let e=0;e<t*r;e++){const{value:e,length:t}=ci(n,p);o.push(e),p+=t}else{let e=0;for(;e<i;){const{value:t,length:i}=ci(n,p);o.push(t),p+=i,e+=i}}g[e]=o}d.push({name:c,tagMap:g})}}return{table:d,cncx:c}};class mi{#c;#h;pdb;async open(e){this.#c=e;const t=ai(Ut,await e.slice(0,78).arrayBuffer());this.pdb=t;const i=await e.slice(78,78+8*t.numRecords).arrayBuffer();this.#h=Array.from({length:t.numRecords},((e,t)=>si(i.slice(8*t,8*t+4)))).map(((e,t,i)=>[e,i[t+1]]))}loadRecord(e){const t=this.#h[e];if(!t)throw new RangeError("Record index out of bounds");return this.#c.slice(...t).arrayBuffer()}async loadMagic(e){const t=this.#h[e][0];return oi(await this.#c.slice(t,t+4).arrayBuffer())}}class yi extends mi{#d=0;#u;#f;#p;#g;#m;constructor({unzlib:e}){super(),this.unzlib=e}async open(e){await super.open(e),this.headers=this.#y(await super.loadRecord(0)),this.#u=this.headers.mobi.resourceStart;let t=this.headers.mobi.version>=8;if(!t){const e=this.headers.exth?.boundary;if(e<4294967295)try{this.headers=this.#y(await super.loadRecord(e)),this.#d=e,t=!0}catch(e){console.warn(e),console.warn("Failed to open KF8; falling back to MOBI")}}return await this.#b(),t?new Di(this).init():new wi(this).init()}#y(e){const t=ai(qt,e),i=ai(zt,e);if("MOBI"!==i.magic)throw new Error("Missing MOBI header");const{titleOffset:r,titleLength:n,localeLanguage:o,localeRegion:s}=i;i.title=e.slice(r,r+n);const a=ti[o];i.language=a?.[s>>2]??a?.[0];const l=64&i.exthFlag?((e,t)=>{const{magic:i,count:r}=ai(Vt,e);if("EXTH"!==i)throw new Error("Invalid EXTH header");const n=li(t),o={};let s=12;for(let t=0;t<r;t++){const t=si(e.slice(s,s+4)),i=si(e.slice(s+4,s+8));if(t in ei){const[r,a,l]=ei[t],c=e.slice(s+8,s+i),h="uint"===a?si(c):n.decode(c);l?(o[r]??=[],o[r].push(h)):o[r]=h}s+=i}return o})(e.slice(i.length+16),i.encoding):null;return{palmdoc:t,mobi:i,exth:l,kf8:i.version>=8?ai(Xt,e):null}}async#b(){const{palmdoc:e,mobi:t}=this.headers;this.#f=li(t.encoding),this.#p=new TextEncoder;const{compression:i}=e;if(this.#g=1===i?e=>e:2===i?fi:17480===i?await(async(e,t)=>{const i=await t(e.huffcdic),{magic:r,offset1:n,offset2:o}=ai(_t,i);if("HUFF"!==r)throw new Error("Invalid HUFF record");const s=Array.from({length:256},((e,t)=>n+4*t)).map((e=>si(i.slice(e,e+4)))).map((e=>[128&e,31&e,e>>>8])),a=[null].concat(Array.from({length:32},((e,t)=>o+8*t)).map((e=>[si(i.slice(e,e+4)),si(i.slice(e+4,e+8))]))),l=[];for(let i=1;i<e.numHuffcdic;i++){const r=await t(e.huffcdic+i),n=ai(Zt,r);if("CDIC"!==n.magic)throw new Error("Invalid CDIC record");const o=Math.min(1<<n.codeLength,n.numEntries-l.length),s=r.slice(n.length);for(let e=0;e<o;e++){const t=si(s.slice(2*e,2*e+2)),i=si(s.slice(t,t+2)),r=32767&i,n=32768&i,o=new Uint8Array(s.slice(t+2,t+2+r));l.push([o,n])}}const c=e=>{let t=new Uint8Array;const i=8*e.byteLength;for(let r=0;r<i;){const n=Number(pi(e,r));let[o,h,d]=s[n>>>24];if(!o){for(;n>>>32-h<a[h][0];)h+=1;d=a[h][1]}if((r+=h)>i)break;const u=d-(n>>>32-h);let[f,p]=l[u];p||(f=c(f),l[u]=[f,!0]),t=ii(t,f)}return t};return c})(t,this.loadRecord.bind(this)):null,!this.#g)throw new Error("Unknown compression type");const{trailingFlags:r}=t,n=1&r,o=di(r>>>1);this.#m=e=>{for(let t=0;t<o;t++){const t=hi(e);e=e.subarray(0,-t)}if(n){const t=1+(3&e[e.length-1]);e=e.subarray(0,-t)}return e}}decode(...e){return this.#f.decode(...e)}encode(...e){return this.#p.encode(...e)}loadRecord(e){return super.loadRecord(this.#d+e)}loadMagic(e){return super.loadMagic(this.#d+e)}loadText(e){return this.loadRecord(e+1).then((e=>new Uint8Array(e))).then(this.#m).then(this.#g)}async loadResource(e){const t=await super.loadRecord(this.#u+e),i=oi(t.slice(0,4));return"FONT"===i?(async(e,t)=>{const{flags:i,dataStart:r,keyLength:n,keyStart:o}=ai(Kt,e),s=new Uint8Array(e.slice(r));if(2&i){const t=16===n?1024:1040,i=new Uint8Array(e.slice(o,o+n)),r=Math.min(t,s.length);for(var a=0;a<r;a++)s[a]=s[a]^i[a%i.length]}if(1&i)try{return await t(s)}catch(e){console.warn(e),console.warn("Failed to decompress font")}return s})(t,this.unzlib):"VIDE"===i||"AUDI"===i?t.slice(12):t}getNCX(){const e=this.headers.mobi.indx;if(e<4294967295)return(async(e,t)=>{const{table:i,cncx:r}=await gi(e,t),n=i.map((({tagMap:e},t)=>({index:t,offset:e[1]?.[0],size:e[2]?.[0],label:r[e[3]]??"",headingLevel:e[4]?.[0],pos:e[6],parent:e[21]?.[0],firstChild:e[22]?.[0],lastChild:e[23]?.[0]}))),o=e=>(null==e.firstChild||(e.children=n.filter((t=>t.parent===e.index)).map(o)),e);return n.filter((e=>0===e.headingLevel)).map(o)})(e,this.loadRecord.bind(this))}getMetadata(){const{mobi:e,exth:t}=this.headers;return{identifier:e.uid.toString(),title:$t(t?.title||this.decode(e.title)),author:t?.creator?.map($t),publisher:$t(t?.publisher),language:t?.language??e.language,published:t?.date,description:$t(t?.description),subject:t?.subject?.map($t),rights:$t(t?.rights)}}async getCover(){const{exth:e}=this.headers,t=e?.coverOffset<4294967295?e?.coverOffset:e?.thumbnailOffset<4294967295?e?.thumbnailOffset:null;if(null!=t){const e=await this.loadResource(t);return new Blob([e])}}}const bi=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,vi=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi;class wi{parser=new DOMParser;serializer=new XMLSerializer;#v=new Map;#w=new Map;#r=new Map;#x;#C=[];#L=jt.HTML;constructor(e){this.mobi=e}async init(){let e=new Uint8Array;for(let t=0;t<this.mobi.headers.palmdoc.numTextRecords;t++)e=ii(e,await this.mobi.loadText(t));const t=Array.from(new Uint8Array(e),(e=>String.fromCharCode(e))).join("");this.#x=[0].concat(Array.from(t.matchAll(bi),(e=>e.index))).map(((e,i,r)=>t.slice(e,r[i+1]))).map((e=>Uint8Array.from(e,(e=>e.charCodeAt(0))))).map((e=>({book:this,raw:e}))).reduce(((e,t)=>{const i=e[e.length-1];return t.start=i?.end??0,t.end=t.start+t.raw.byteLength,e.concat(t)}),[]),this.sections=this.#x.map(((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start})));try{this.landmarks=await this.getGuide();const e=this.landmarks.find((({type:e})=>e?.includes("toc")))?.href;if(e){const{index:t}=this.resolveHref(e),i=await this.sections[t].createDocument();let r,n=0,o=0;const s=new Map,a=new Map;this.toc=Array.from(i.querySelectorAll("a[filepos]")).reduce(((e,t)=>{const i=(e=>{let t=0;for(;e;){const i=e.parentElement;if(i){const e=i.tagName.toLowerCase();"p"===e?t+=1.5:"blockquote"===e&&(t+=2)}e=i}return t})(t),l={label:t.innerText?.trim(),href:`filepos:${t.getAttribute("filepos")}`},c=i>o?n+1:i===o?n:s.get(i)??Math.max(0,n-1);if(c>n)r?(r.subitems??=[],r.subitems.push(l),a.set(c,r)):e.push(l);else{const t=a.get(c);t?t.subitems.push(l):e.push(l)}return r=l,n=c,o=i,s.set(i,c),e}),[])}}catch(e){console.warn(e)}return this.#C=[...new Set(Array.from(t.matchAll(vi),(e=>e[1])))].map((e=>({filepos:e,number:Number(e)}))).sort(((e,t)=>e.number-t.number)),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const e=await this.createDocument(this.#x[0]);return Array.from(e.getElementsByTagName("reference"),(e=>({label:e.getAttribute("title"),type:e.getAttribute("type")?.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`})))}async loadResource(e){if(this.#v.has(e))return this.#v.get(e);const t=await this.mobi.loadResource(e),i=URL.createObjectURL(new Blob([t]));return this.#v.set(e,i),i}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(const t of e.querySelectorAll("img[recindex]")){const e=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e)}catch(t){console.warn(`Failed to load image ${e}`)}}for(const t of e.querySelectorAll("[mediarecindex]")){const e=t.getAttribute("mediarecindex"),i=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e),i&&(t.poster=await this.loadRecindex(i))}catch(t){console.warn(`Failed to load media ${e}`)}}for(const t of e.querySelectorAll("[filepos]")){const e=t.getAttribute("filepos");t.href=`filepos:${e}`}}async loadText(e){if(this.#w.has(e))return this.#w.get(e);const{raw:t}=e,i=this.#C.filter((({number:t})=>t>=e.start&&t<e.end)).map((t=>({...t,offset:t.number-e.start})));let r=t;i.length&&(r=t.subarray(0,i[0].offset),i.forEach((({filepos:e,offset:n},o)=>{const s=i[o+1],a=this.mobi.encode(`<a id="filepos${e}"></a>`);r=ri(r,a,t.subarray(n,s?.offset))})));const n=this.mobi.decode(r).replaceAll(bi,"");return this.#w.set(e,n),n}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,this.#L)}async loadSection(e){if(this.#r.has(e))return this.#r.get(e);const t=await this.createDocument(e),i=t.createElement("style");t.head.append(i),i.append(t.createTextNode("blockquote {\n            margin-block-start: 0;\n            margin-block-end: 0;\n            margin-inline-start: 1em;\n            margin-inline-end: 0;\n        }")),await this.replaceResources(t);const r=this.serializer.serializeToString(t),n=URL.createObjectURL(new Blob([r],{type:this.#L}));return this.#r.set(e,n),n}resolveHref(e){const t=e.match(/filepos:(.*)/)[1],i=Number(t);return{index:this.#x.findIndex((e=>e.end>i)),anchor:e=>e.getElementById(`filepos${t}`)}}splitTOCHref(e){const t=e.match(/filepos:(.*)/)[1],i=Number(t);return[this.#x.findIndex((e=>e.end>i)),`filepos${t}`]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}destroy(){for(const e of this.#v.values())URL.revokeObjectURL(e);for(const e of this.#r.values())URL.revokeObjectURL(e)}}const xi=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,Ci=/kindle:pos:fid:(\w+):off:(\w+)/,Li=e=>{const[t,i]=e.match(Ci).slice(1);return{fid:parseInt(t,32),off:parseInt(i,32)}},Ti=(e=0,t=0)=>`kindle:pos:fid:${e.toString(32).toUpperCase().padStart(4,"0")}:off:${t.toString(32).toUpperCase().padStart(10,"0")}`,Mi=e=>{const t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;const[,i,r]=t;return`[${i}="${CSS.escape(r)}"]`},Si=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};class Di{parser=new DOMParser;serializer=new XMLSerializer;#r=new Map;#T=new Map;#M=new Map;#S={};#x;#D;#k=new Uint8Array;#A=new Uint8Array;#I=-1;#E=-1;#L=jt.XHTML;#N=new Map;constructor(e){this.mobi=e}async init(){const e=this.mobi.loadRecord.bind(this.mobi),{kf8:t}=this.mobi.headers;try{const i=await e(t.fdst),r=ai(Yt,i);if("FDST"!==r.magic)throw new Error("Missing FDST record");const n=Array.from({length:r.numEntries},((e,t)=>12+8*t)).map((e=>[si(i.slice(e,e+4)),si(i.slice(e+4,e+8))]));this.#S.fdstTable=n,this.#D=n[n.length-1][1]}catch{}const i=(await gi(t.skel,e)).table.map((({name:e,tagMap:t},i)=>({index:i,name:e,numFrag:t[1][0],offset:t[6][0],length:t[6][1]}))),r=await gi(t.frag,e),n=r.table.map((({name:e,tagMap:t})=>({insertOffset:parseInt(e),selector:r.cncx[t[2][0]],index:t[4][0],offset:t[6][0],length:t[6][1]})));this.#S.skelTable=i,this.#S.fragTable=n,this.#x=i.reduce(((e,t)=>{const i=e[e.length-1],r=i?.fragEnd??0,o=r+t.numFrag,s=n.slice(r,o),a=t.length+s.map((e=>e.length)).reduce(((e,t)=>e+t)),l=(i?.totalLength??0)+a;return e.concat({skel:t,frags:s,fragEnd:o,length:a,totalLength:l})}),[]);const o=await this.getResourcesByMagic(["RESC","PAGE"]),s=new Map;if(o.RESC){const e=await this.mobi.loadRecord(o.RESC),t=this.mobi.decode(e.slice(16)).replace(/\0/g,""),i=t.search(/\?>/),r=`<package>${t.slice(i)}</package>`,n=this.parser.parseFromString(r,jt.XML);for(const e of n.querySelectorAll("spine > itemref")){const t=parseInt(e.getAttribute("skelid"));s.set(t,Si(e.getAttribute("properties")?.split(" ")??[]))}}this.sections=this.#x.map(((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length,pageSpread:s.get(t)}:{linear:"no"}));try{const e=await this.mobi.getNCX(),t=({label:e,pos:i,children:r})=>{const[n,o]=i,s=Ti(n,o),a=this.#T.get(n);return a?a.push(o):this.#T.set(n,[o]),{label:$t(e),href:s,subitems:r?.map(t)}};this.toc=e?.map(t),this.landmarks=await this.getGuide()}catch(e){console.warn(e)}const{exth:a}=this.mobi.headers;return this.dir=a.pageProgressionDirection,this.rendition={layout:"true"===a.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(a.originalResolution?.split("x")?.slice(0,2)?.map(((e,t)=>[t?"height":"width",e]))??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(e){const t={},i=this.mobi.headers.kf8.resourceStart,r=this.mobi.pdb.numRecords;for(let n=i;n<r;n++)try{const i=await this.mobi.loadMagic(n),r=e.find((e=>e===i));r&&(t[r]=n)}catch{}return t}async getGuide(){const e=this.mobi.headers.kf8.guide;if(e<4294967295){const t=this.mobi.loadRecord.bind(this.mobi),{table:i,cncx:r}=await gi(e,t);return i.map((({name:e,tagMap:t})=>({label:r[t[1][0]]??"",type:e?.split(/\s/),href:Ti(t[6]?.[0]??t[3]?.[0])})))}}async loadResourceBlob(e){const{resourceType:t,id:i,type:r}=(e=>{const[t,i,r]=e.match(xi).slice(1);return{resourceType:t,id:parseInt(i,32),type:r}})(e),n="flow"===t?await this.loadFlow(i):await this.mobi.loadResource(i-1),o=[jt.XHTML,jt.HTML,jt.CSS,jt.SVG].includes(r)?await this.replaceResources(this.mobi.decode(n)):n,s=r===jt.SVG?this.parser.parseFromString(o,r):null;return[new Blob([o],{type:r}),s?.getElementsByTagNameNS("http://www.w3.org/2000/svg","image")?.length?s.documentElement:null]}async loadResource(e){if(this.#r.has(e))return this.#r.get(e);const[t,i]=await this.loadResourceBlob(e),r=i?e:URL.createObjectURL(t);return i&&this.#N.set(r,i),this.#r.set(e,r),r}replaceResources(e){return(async(e,t,i)=>{const r=[];e.replace(t,((...e)=>(r.push(e),null)));const n=[];for(const e of r)n.push(await i(...e));return e.replace(t,(()=>n.shift()))})(e,new RegExp(xi,"g"),this.loadResource.bind(this))}async loadRaw(e,t){const i=t-this.#k.length,r=null==this.#D?1/0:this.#D-this.#A.length-e;if(i<0||i<r){for(;this.#k.length<t;){const e=++this.#I,t=await this.mobi.loadText(e);this.#k=ii(this.#k,t)}return this.#k.slice(e,t)}for(;this.#D-this.#A.length>e;){const e=this.mobi.headers.palmdoc.numTextRecords-1-++this.#E,t=await this.mobi.loadText(e);this.#A=ii(t,this.#A)}const n=this.#D-this.#A.length;return this.#A.slice(e-n,t-n)}loadFlow(e){if(e<4294967295)return this.loadRaw(...this.#S.fdstTable[e])}async loadText(e){const{skel:t,frags:i,length:r}=e,n=await this.loadRaw(t.offset,t.offset+r);let o=n.slice(0,t.length);for(const e of i){const i=e.insertOffset-t.offset,r=t.length+e.offset,s=n.slice(r,r+e.length);o=ri(o.slice(0,i),s,o.slice(i));const a=this.#T.get(e.index);if(a)for(const t of a){const i=this.mobi.decode(s).slice(t),r=Mi(i);this.#R(e.index,t,r)}}return this.mobi.decode(o)}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,this.#L)}async loadSection(e){if(this.#r.has(e))return this.#r.get(e);const t=await this.loadText(e),i=await this.replaceResources(t);let r=this.parser.parseFromString(i,this.#L);r.querySelector("parsererror")&&(this.#L=jt.HTML,r=this.parser.parseFromString(i,this.#L));for(const[e,t]of this.#N)for(const i of r.querySelectorAll(`img[src="${e}"]`))i.replaceWith(t);const n=URL.createObjectURL(new Blob([this.serializer.serializeToString(r)],{type:this.#L}));return this.#r.set(e,n),n}getIndexByFID(e){return this.#x.findIndex((t=>t.frags.some((t=>t.index===e))))}#R(e,t,i){const r=this.#M.get(e);if(r)r.set(t,i);else{const r=new Map;this.#M.set(e,r),r.set(t,i)}}async resolveHref(e){const{fid:t,off:i}=Li(e),r=this.getIndexByFID(t);if(r<0)return;const n=this.#M.get(t)?.get(i);if(n)return{index:r,anchor:e=>e.querySelector(n)};const{skel:o,frags:s}=this.#x[r],a=s.find((e=>e.index===t)),l=o.offset+o.length+a.offset,c=await this.loadRaw(l,l+a.length),h=this.mobi.decode(c).slice(i),d=Mi(h);this.#R(t,i,d);return{index:r,anchor:e=>e.querySelector(d)}}splitTOCHref(e){const t=Li(e);return[this.getIndexByFID(t.fid),t]}getTOCFragment(e,{fid:t,off:i}){const r=this.#M.get(t)?.get(i);return e.querySelector(r)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}destroy(){for(const e of this.#r.values())URL.revokeObjectURL(e)}}class ki extends Bt{constructor(e,t){super(Object.assign({format:"MOBI"},t)),this.mobiBuffer=e}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let i=new T(this.book);this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),m(e);let r=this.getDocument();r&&(x(e,this.readerMode,r),t())}))))}parse(){return h(this,void 0,void 0,(function*(){try{let e=new Blob([this.mobiBuffer]),t=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});(yield(async e=>"BOOKMOBI"===oi(await e.slice(60,68).arrayBuffer()))(t))&&(this.book=yield new yi({unzlib:n}).open(t))}catch(e){throw console.error(e),e}}))}preCache(){return h(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield Ft(this.book)}))}getMetadata(){return h(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());let e=new T(this.book);return yield e.getMetadata()}catch(e){throw console.error(e),e}}))}}const Ai=e=>`${Ni()?".":""}/lib/pdfjs/${e}`,Ii=window.pdfjsLib,Ei=async e=>await(await fetch(e)).text(),Ni=()=>"undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type||(!("undefined"==typeof process||"object"!=typeof process.versions||!process.versions.electron)||"object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron")>=0),Ri=async()=>await Ei(Ai("text_layer_builder.css")),Bi=async()=>await Ei(Ai("annotation_layer_builder.css")),Pi=async(e,t)=>{const i=e.getViewport({scale:1});if(t){const t=document.createElement("canvas");t.height=i.height,t.width=i.width;const r=t.getContext("2d");return await e.render({canvasContext:r,viewport:i}).promise,new Promise((e=>t.toBlob(e)))}return URL.createObjectURL(new Blob([`\n        <!DOCTYPE html>\n        <html lang="en">\n        <meta charset="utf-8">\n        <meta name="viewport" content="width=${i.width}, height=${i.height}">\n        <style>\n        html, body {\n            margin: 0;\n            padding: 0;\n        }\n        ${await Ri()}\n        ${await Bi()}\n        </style>\n        <div class="noteLayer"></div>\n        <div class="koodoPDFLayer" id="koodoPDFLayer">\n            <div class="textLayer" id="textLayer"></div>\n            <div class="annotationLayer" id="annotationLayer"></div>\n            <div id="canvas"></div>\n        </div>\n    `],{type:"text/html"}))},Oi=e=>({label:e.title,href:e.dest?JSON.stringify(e.dest):null,subitems:e.items.length?e.items.map(Oi):null}),Hi=async(e,t)=>{const i=new Ii.PDFDataRangeTransport(e.size,[]);i.requestDataRange=(t,r)=>{e.slice(t,r).arrayBuffer().then((e=>{i.onDataRange(t,e)}))};const r=await Ii.getDocument({range:i,cMapUrl:Ai("cmaps/"),standardFontDataUrl:Ai("standard_fonts/"),isEvalSupported:!1}).promise,n={rendition:{layout:"pre-paginated"}},{metadata:o,info:s}=await r.getMetadata()??{};n.metadata={title:o?.get("dc:title")??s?.Title,author:o?.get("dc:creator")??s?.Author,contributor:o?.get("dc:contributor"),description:o?.get("dc:description")??s?.Subject,language:o?.get("dc:language"),publisher:o?.get("dc:publisher"),subject:o?.get("dc:subject"),identifier:o?.get("dc:identifier"),source:o?.get("dc:source"),rights:o?.get("dc:rights")};const a=await r.getOutline();n.toc=a?.map(Oi);const l=new Map;return n.sections=Array.from({length:r.numPages}).map(((e,t)=>({id:t,load:async()=>{const e=l.get(t);if(e)return e;const i=await Pi(await r.getPage(t+1));return l.set(t,i),i},unload:async()=>{(await r.getPage(t+1)).cleanup()},render:async(e,i,n)=>{await(async(e,t,i,r)=>{let n=window.devicePixelRatio*("yes"===r?1/i*1.5:1);const o=i*n;let s=t.querySelector("#koodoPDFLayer");s.style.visibility="hidden",s.style.transform=`scale(${1/n})`,s.style.transformOrigin="top left",s.style.setProperty("--scale-factor",o);const a=e.getViewport({scale:o}),l=document.createElement("canvas");s.style.width=`${a.width}px`,s.style.height=`${a.height}px`,l.height=a.height,l.width=a.width;const c=l.getContext("2d");await e.render({canvasContext:c,viewport:a,background:"rgba(0,0,0,0)"}).promise,t.querySelector("#canvas").replaceChildren(t.adoptNode(l)),s.style.overflow="hidden";const h=t.querySelector("#textLayer"),d=new Ii.TextLayer({textContentSource:await e.streamTextContent(),container:h,viewport:a});await d.render();for(const e of document.querySelectorAll(".hiddenCanvasElement"))Object.assign(e.style,{position:"absolute",top:"0",left:"0",width:"0",height:"0",display:"none"});const u=document.createElement("div");u.className="endOfContent",h.append(u);let f=!1,p=null;h.onpointerdown=()=>{h.classList.add("selecting"),f=!0},"yes"!==r?(h.onpointerup=()=>{h.classList.remove("selecting"),f=!1,u.remove(),h.append(u)},h.onpointermove=e=>{if(!f)return;let t=e.target.closest(".textLayer > span");const i=null!==t;h.style.cursor=i?"text":"default",i&&(p=t),u.remove(),h.insertBefore(u,p)}):t.addEventListener("selectionchange",(e=>{if(!f)return;let i=t?.defaultView;var r=i.getSelection().getRangeAt(0).endContainer;let n=r.nodeType===Node.TEXT_NODE?r.parentNode:r;n=n.closest(".textLayer > span");const o=null!==n;h.style.cursor=o?"text":"default",o&&(p=n),u.remove(),h.insertBefore(u,p.nextSibling)}));const g=t.querySelector("#annotationLayer");await new Ii.AnnotationLayer({page:e,viewport:a,div:g}).render({annotations:await e.getAnnotations(),linkService:{goToDestination:()=>{},getDestinationHash:e=>JSON.stringify(e),addLinkAttributes:(e,t)=>e.href=t}}),s.style.marginLeft=`calc(50% - ${s.getBoundingClientRect().width/2}px)`,s.style.visibility="visible"})(await r.getPage(t+1),e,i,n)},getTextContent:async()=>{const e=await r.getPage(t+1);return await e.getTextContent()},size:1e3,getDimension:async()=>{let e=(await r.getPage(t+1)).getViewport({scale:1});return{width:e.width,height:e.height}},getPage:async()=>await r.getPage(t+1)}))),n.isExternal=e=>/^\w+:/i.test(e),n.resolveHref=async e=>{const t=JSON.parse(e),i="string"==typeof t?await r.getDestination(t):t;return{index:await r.getPageIndex(i[0])}},n.splitTOCHref=async e=>{const t=JSON.parse(e),i="string"==typeof t?await r.getDestination(t):t;return[await r.getPageIndex(i[0]),null]},n.getTOCFragment=e=>e.documentElement,n.getCover=async()=>Pi(await r.getPage(1),!0),n.destroy=()=>r.destroy(),n};class Fi extends Bt{constructor(e,t){super(Object.assign(Object.assign({format:"PDF"},t),{convertChinese:"Default"})),this.pdfBuffer=e}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let i=new T(this.book);this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),m(e);const r=yield this.chapterDocList[0].text.getDimension();let n=this.getDocument();if(!n)return;((e,t,i,r)=>{for(let n=0;n<t.length;n++){const t=document.createElement("div");t.style.position="relative",t.style.width="100%",t.id="pdf-container-"+n,t.className="pdf-container";const o=(null==i?void 0:i.width)/(null==i?void 0:i.height)||.75;t.style.paddingTop=1/o*100+"%","double"===r&&(t.style.breakInside="avoid"),e.appendChild(t)}})(n.body||n.documentElement,this.chapterDocList,r,this.readerMode);let o=null;"scroll"===this.readerMode?this.element.addEventListener("scroll",(e=>{o&&clearTimeout(o),o=setTimeout((()=>h(this,void 0,void 0,(function*(){yield this.handlePDFScrollEvent(n),yield this.record()}))),200)})):n.addEventListener("scroll",(e=>{o&&clearTimeout(o),o=setTimeout((()=>h(this,void 0,void 0,(function*(){yield this.handlePDFScrollEvent(n),yield this.record()}))),200)})),((e,t,i)=>{if("scroll"===t)return;let r="double"===t?2:1,n=Math.floor(e.clientWidth/12),o=n%2==0?n:n-1;i.body.setAttribute("style",e.getAttribute("style")+`height: 100%;overflow-y: hidden;overflow-X: hidden;padding-left: 0px;padding-right: 0px;margin: 0px;box-sizing: border-box;touch-action: manipulation; overscroll-behavior: none;max-width: inherit;column-fill: auto;column-gap: ${o}px; column-width: ${(e.clientWidth-o)/r}px;`)})(e,this.readerMode,n),t()}))))}handlePDFScrollEvent(e){return h(this,void 0,void 0,(function*(){let t=e.querySelectorAll(".pdf-container");for(let i=0;i<t.length;i++){let r=t[i],n=r.getAttribute("id");if(!n)continue;let o=parseInt(n.split("-").reverse()[0]);At(this.element,r,this.readerMode)&&(yield this.renderPdfPage(o,e))}}))}parse(){return h(this,void 0,void 0,(function*(){try{let e=new Blob([this.pdfBuffer]),t=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});(yield(async e=>{const t=new Uint8Array(await e.slice(0,5).arrayBuffer());return 37===t[0]&&80===t[1]&&68===t[2]&&70===t[3]&&45===t[4]})(t))&&(this.book=yield Hi(t,this.readerMode))}catch(e){throw console.error(e),e}}))}preCache(){return h(this,void 0,void 0,(function*(){return""}))}goToChapterIndex(e){return h(this,void 0,void 0,(function*(){this.chapterDocList.length>0&&(yield this.goToChapter(e,this.chapterDocList[e].href,this.chapterDocList[e].label))}))}getPageSize(){let e="double"===this.readerMode?2:1,t=Math.floor(this.element.clientWidth/12),i=t%2==0?t:t-1,r=this.getDocument();if(!r)return;let n=r.querySelectorAll("iframe")[0],o=null==n?void 0:n.getBoundingClientRect().height;return{width:this.element.clientWidth,height:this.element.clientHeight,left:this.element.offsetLeft,top:this.element.offsetTop,scrollTop:this.element.scrollTop,sectionWidth:(this.element.clientWidth-i)/e,sectionHeight:o,gap:i}}goToChapter(e,t,i){return h(this,void 0,void 0,(function*(){"double"===this.readerMode&&e%2==1&&e--;let t=this.getDocument(),i=this.getIframe();t&&i&&(yield this.renderPdfPage(e,t),yield kt(parseInt(e),this.readerMode,t),yield this.record())}))}getPositionByChapter(e){return{percentage:e/this.chapterDocList.length,chapterDocIndex:e+"",chapterHref:this.chapterDocList[e].href,chapterTitle:this.chapterDocList[e].label,text:""}}goToPercentage(e){return h(this,void 0,void 0,(function*(){if(this.chapterDocList.length>0){let t=1===e?this.chapterDocList.length-1:Math.floor(this.chapterDocList.length*e);yield this.goToChapter(t,this.chapterDocList[t].href,this.chapterDocList[t].label)}}))}goToPosition(e){var t;return h(this,void 0,void 0,(function*(){let i=this.getDocument(),r=this.getIframe();if(!i||!r)return;let n=JSON.parse(e);void 0===n.chapterDocIndex&&(n.chapterDocIndex=0),this.tempLocation={text:n.text,chapterTitle:n.chapterTitle,chapterDocIndex:n.chapterDocIndex,chapterHref:n.chapterHref,count:n.count,page:n.page,percentage:n.percentage};let{chapterTitle:o,chapterDocIndex:s,chapterHref:a}=n;if("double"===this.readerMode&&s%2==1&&s--,yield this.renderPdfPage(parseInt(s),i),"scroll"===this.readerMode){let e=this.getSubIframe(void 0!==s?s:parseInt(this.tempLocation.chapterDocIndex));if(!e)return;let i=(null===(t=e.parentElement)||void 0===t?void 0:t.getBoundingClientRect().height)||0;r.style.height=i*this.chapterDocList.length+"px"}if("single"===this.readerMode||"double"===this.readerMode){let e=i.querySelectorAll(".pdf-container");for(let t=0;t<e.length;t++){let i=e[t];i.style.top=`calc(${this.element.clientHeight/2}px - ${i.getBoundingClientRect().height/2}px)`,"double"!==this.readerMode&&(this.element.clientHeight>parseFloat(getComputedStyle(i).paddingTop)?i.style.height=this.element.clientHeight-parseFloat(getComputedStyle(i).paddingTop)+"px":i.style.marginBottom=this.element.clientHeight-parseFloat(getComputedStyle(i).paddingTop)+"px")}}yield kt(parseInt(s),this.readerMode,i),yield this.record(),this.trigger("page-changed")}))}prev(e){return h(this,void 0,void 0,(function*(){let t=this.getDocument(),i=this.getIframe();t&&i&&("scroll"===this.readerMode?this.element.scrollBy({left:0,top:-(this.element.clientHeight-50),behavior:"smooth"}):("ios"===e?yield It(this.element,this.animation,1,t,this.flipToNextPage,this.flipToPrevPage,this.isMobile,parseInt(this.tempLocation.chapterDocIndex||"0"),this.readerMode):yield Ve(this.element,this.animation,1,t,this.flipToNextPage,this.flipToPrevPage,this.isMobile),yield this.renderPdfPage(parseInt(this.tempLocation.chapterDocIndex)-("double"===this.readerMode?2:1),t)),yield this.record())}))}next(e){return h(this,void 0,void 0,(function*(){let t=this.getDocument(),i=this.getIframe();t&&i&&("scroll"===this.readerMode?this.element.scrollBy({left:0,top:this.element.clientHeight-50,behavior:"smooth"}):("ios"===e?yield It(this.element,this.animation,-1,t,this.flipToNextPage,this.flipToPrevPage,this.isMobile,parseInt(this.tempLocation.chapterDocIndex||"0"),this.readerMode):yield Ve(this.element,this.animation,-1,t,this.flipToNextPage,this.flipToPrevPage,this.isMobile),yield this.renderPdfPage(parseInt(this.tempLocation.chapterDocIndex)+("double"===this.readerMode?2:1),t)),yield this.record())}))}prevChapter(){return h(this,void 0,void 0,(function*(){yield this.prev()}))}nextChapter(){return h(this,void 0,void 0,(function*(){yield this.next()}))}visibleText(){return h(this,void 0,void 0,(function*(){return this.getDocument()?yield(e=parseInt(this.tempLocation.chapterDocIndex||"0"),t=this.chapterDocList,i=this.readerMode,h(void 0,void 0,void 0,(function*(){let r=(yield t[e].text.getTextContent()).items.map((e=>e.str));if("double"===i){let i=(yield t[e+1].text.getTextContent()).items.map((e=>e.str));r=r.concat(i)}return r}))):"";var e,t,i}))}audioText(){return h(this,void 0,void 0,(function*(){return yield this.visibleText()}))}chapterText(){return h(this,void 0,void 0,(function*(){return(yield this.visibleText()).join(" ")}))}record(){return h(this,void 0,void 0,(function*(){""!==this.animation&&(yield new Promise((e=>setTimeout(e,1e3))));let e=this.getDocument();e&&(yield this.handlePDFRecord(e))}))}handlePDFRecord(e){return h(this,void 0,void 0,(function*(){let t=e.querySelectorAll(".pdf-container");if(t.length>0&&At(this.element,t[t.length-1],this.readerMode))this.handleRecord(t[t.length-1]);else for(let e=0;e<t.length;e++){let i=t[e];if(At(this.element,i,this.readerMode)){this.handleRecord(i);break}}}))}handleRecord(e){let t=e.getAttribute("id");if(!t)return;let i=parseInt(t.split("-").reverse()[0]);i!==parseInt(this.tempLocation.chapterDocIndex)&&(this.tempLocation.chapterDocIndex=i+"",this.tempLocation.percentage=i/(this.chapterDocList.length-1)+"",this.tempLocation.chapterHref=this.chapterDocList[i].href,this.tempLocation.chapterTitle=this.chapterDocList[i].label,this.tempLocation.text="",this.trigger("page-changed"))}getMetadata(){return h(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());let e=new T(this.book);return yield e.getMetadata()}catch(e){throw console.error(e),e}}))}highlightNode(e,t){let i=this.getDocument();i&&((e,t,i)=>{let r=parseInt(e.split("#").reverse()[0]),n=e.split("#").slice(0,-1).join("#"),o=i.getElementById("pdf-iframe-"+r);o||(o=Dt(r,i));let s=null==o?void 0:o.contentDocument;if(!s)return;let a=s.querySelectorAll("p,span"),l=Array.from(a).filter(((e,t)=>(e.textContent||"").trim()&&e.textContent===n));l.length>0&&l[0].setAttribute("style",l[0].getAttribute("style")+t)})(e,t,i)}getProgress(){return{totalPage:this.chapterDocList.length,currentPage:parseInt(this.tempLocation.chapterDocIndex||"0")+1}}getNotePosition(){var e;return h(this,void 0,void 0,(function*(){let t=this.getDocument();if(!t)return;let i=C(t);if(!i)return;let r=i.ownerDocument,n=null===(e=null==r?void 0:r.defaultView)||void 0===e?void 0:e.frameElement,o=(null==n?void 0:n.getAttribute("id"))||"",s=o?parseInt(o.split("-").reverse()[0]):0;return Object.assign(Object.assign({},this.tempLocation),{chapterDocIndex:s})}))}getSubDocument(e){let t=document.getElementById("page-area");if(!t)return null;let i=t.getElementsByTagName("iframe")[0];if(!i)return null;let r=i.contentDocument;if(!r)return null;let n=r.getElementById("pdf-iframe-"+e);return n||(Dt(e||0,r),n=r.getElementById("pdf-iframe-"+e)),n.contentDocument}getSubIframe(e){let t=document.getElementById("page-area");if(!t)return null;let i=t.getElementsByTagName("iframe")[0];if(!i)return null;let r=i.contentDocument;return r?(i=r.getElementById("pdf-iframe-"+e),i||(Dt(e||0,r),i=r.getElementById("pdf-iframe-"+e)),i):null}getHightlightCoords(e){return h(this,void 0,void 0,(function*(){let t=void 0!==e?e:parseInt(this.tempLocation.chapterDocIndex),i=this.getSubDocument(e);if(!i)return;var r=i.getSelection().getRangeAt(0).getClientRects();let n=yield this.chapterDocList[t].text.getPage(),o=yield St(this.element,this.readerMode,this.chapterDocList,t);var s=n.getViewport({scale:o});let a=i.querySelector("canvas");var l=null==a?void 0:a.getClientRects()[0];let c=[];for(let e=0;e<r.length;e++)0===e?c.push({bottom:r[e].bottom,top:r[e].top,left:r[e].left,right:r[e].right}):Math.abs(c[c.length-1].bottom-r[e].bottom)<5?(c[c.length-1].left>r[e].left&&(c[c.length-1].left=r[e].left),c[c.length-1].right<r[e].right&&(c[c.length-1].right=r[e].right)):c.push({bottom:r[e].bottom,top:r[e].top,left:r[e].left,right:r[e].right});return{page:t,coords:c.map((function(e){return s.convertToPdfPoint(e.left-l.x,e.top-l.y).concat(s.convertToPdfPoint(e.right-l.x,e.bottom-l.y))})),readerMode:this.readerMode}}))}renderHighlighters(e,t){var i,r;return h(this,void 0,void 0,(function*(){if(0===e.length)return;let n=e[0].chapterIndex,o=this.getSubIframe(n),s=this.getSubDocument(n);if(!s||!o)return;xt(s);let a=o.contentWindow||(null===(i=o.contentDocument)||void 0===i?void 0:i.defaultView);for(let i=0;i<e.length;i++){const o=e[i];let c=JSON.parse(o.range);var l=parseInt(c.page+"");if(l!==n)continue;let h=yield this.chapterDocList[l].text.getPage(),d=yield St(this.element,this.readerMode,this.chapterDocList,l);try{wt(c,o.color,o.key,t,h,d,s)}catch(e){return void console.warn(e,"Exception has been caught when restore character ranges.")}if(!a||!a.getSelection())return;null===(r=a.getSelection())||void 0===r||r.empty()}}))}removeOneNote(e,t){let i=this.getSubDocument(void 0!==t?t:parseInt(this.tempLocation.chapterDocIndex));if(!i)return;const r=i.querySelectorAll(".kookit-note");for(let t=0;t<r.length;t++){const i=r[t];i.getAttribute("data-key")===e&&i.parentNode.removeChild(i)}}createOneNote(e,t){return h(this,void 0,void 0,(function*(){let i=this.getSubIframe(e.chapterIndex),r=this.getSubDocument(e.chapterIndex);if(!r||!i)return;let n=JSON.parse(e.range);var o=parseInt(n.page+"");let s=yield this.chapterDocList[o].text.getPage(),a=yield St(this.element,this.readerMode,this.chapterDocList,o);wt(n,e.color,e.key,t,s,a,r),this.clearSelection()}))}handleRenderPDFChapter(e,t){return h(this,void 0,void 0,(function*(){if(e>=this.chapterDocList.length||e<0)return;let i=t.getElementById("pdf-iframe-"+e);i||(i=Dt(e,t));let r=null==i?void 0:i.contentDocument;if(!r)return;if(r.body.innerHTML)return;r.body.innerHTML="";let n=yield fetch(yield this.chapterDocList[e].text.load()).then((e=>e.blob())),o=yield n.text();r.body.innerHTML=o;let s=yield St(this.element,this.readerMode,this.chapterDocList,e);yield this.chapterDocList[e].text.render(r,s,this.isMobile),this.trigger("rendered")}))}handleUnloadPDFChapter(e,t){return h(this,void 0,void 0,(function*(){if(e>=this.chapterDocList.length||e<0)return;let i=t.getElementById("pdf-iframe-"+e),r=null==i?void 0:i.contentDocument;r&&""!==r.body.innerHTML&&(yield this.chapterDocList[e].text.unload(),r.body.innerHTML="")}))}renderPdfPage(e,t){return h(this,void 0,void 0,(function*(){yield this.handleRenderPDFChapter(e,t),yield this.handleRenderPDFChapter(e+1,t)}))}}class Wi extends Bt{constructor(e,t){super(Object.assign({format:"TXT"},t)),this.txtBuffer=e,this.charset=t.charset,this.parserRegex=t.parserRegex}renderTo(e,t){return new Promise(((i,r)=>h(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse(t));let r=new T(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),m(e);let n=this.getDocument();n&&(x(e,this.readerMode,n),i())}))))}parse(e){return h(this,void 0,void 0,(function*(){try{const t=new TextDecoder(this.charset),i=new Uint8Array(this.txtBuffer);let r=t.decode(i);this.book=Se(r,!0,this.parserRegex,e)}catch(e){throw console.error(e),e}}))}refreshContent(){return h(this,void 0,void 0,(function*(){yield this.parse({refresh:!0});let e=new T(this.book);return this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),this.chapterList}))}preCache(){return h(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield Ft(this.book)}))}getMetadata(e){return h(this,void 0,void 0,(function*(){try{const t=4096,i=e.byteLength,r=Math.min(i,t),n=new Uint8Array(e,0,r);const s=o.detect(n)||"utf8";return this.charset=s,{charset:s}}catch(e){return console.error("Error detecting charset:",e),this.charset="utf8",{charset:"utf8"}}}))}}const $i=({entries:e,loadBlob:t,getSize:i},r,n)=>{const o=new Map,s=new Map,a=async(e,i)=>{if(o.has(e))return o.get(e);if(i){const r=URL.createObjectURL(await t(e)),n=URL.createObjectURL(await t(i)),a=URL.createObjectURL(new Blob([`<div style="width:100%; height:100%"><img src="${r}"></div><div style="width:100%; height:100%"><img src="${n}"></div>`],{type:"text/html"}));return s.set(e,[r,a]),o.set(e,a),a}{const i=URL.createObjectURL(await t(e)),r=URL.createObjectURL(new Blob([`<div style="width:100%; height:100%"><img src="${i}"></div>`],{type:"text/html"}));return s.set(e,[i,r]),o.set(e,r),r}},l=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".svg"],c=e.map((e=>e.filename)).filter((e=>l.some((t=>e.endsWith(t))))).sort(((e,t)=>{const i=parseInt(e.replace(/\D/g,"")),r=parseInt(t.replace(/\D/g,""));return isNaN(i)||isNaN(r)?isNaN(i)?isNaN(r)?e.localeCompare(t):1:-1:i-r})),h={getCover:()=>t(c[0])};return h.metadata={title:r.name},h.sections=c.map(((e,t)=>({id:e,load:()=>{if("double"===n){const i=c[t+1];return a(e,i)}return a(e)},unload:()=>(e=>{s.get(e)?.forEach?.((e=>URL.revokeObjectURL(e))),s.delete(e),o.delete(e)})(e),size:i(e)}))).filter(((e,t)=>"double"!==n||t%2==0)),h.toc=c.map((e=>({label:e,href:e}))).filter(((e,t)=>"double"!==n||t%2==0)),h.rendition={layout:"pre-paginated"},h.resolveHref=e=>({index:h.sections.findIndex((t=>t.id===e))}),h.splitTOCHref=e=>[e,null],h.getTOCFragment=e=>e.documentElement,h};class ji extends Bt{constructor(e,t){super(t),this.comicBuffer=e,this.readerMode=t.readerMode,this.format=t.format,this.chapterList=[],this.chapterDocList=[],this.book="",this.element="",this.rpc}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){if(this.element=e,m(e),!this.book)try{yield this.parse()}catch(e){console.error(e),i(e)}let r=new T(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc();let n=this.getDocument();n&&(x(e,this.readerMode,n),t())}))))}parse(){return h(this,void 0,void 0,(function*(){try{let e=new Blob([this.comicBuffer]),t=new File([e],"book."+this.format.toLocaleLowerCase(),{lastModified:(new Date).getTime(),type:e.type});if("CBZ"===this.format){const e=yield this.makeZipLoader(t);this.book=$i(e,t,this.readerMode)}else if("CBT"===this.format){const e=yield this.makeTarLoader();this.book=$i(e,t,this.readerMode)}else if("CBR"===this.format){this.rpc=yield window.RPC.new("./lib/libunrar/worker.js",{loaded:function(){console.info("loaded")},progressShow:function(e,t,i){console.info(i)}}),yield new Promise((e=>setTimeout(e,200)));const e=yield this.makeRarLoader();this.book=$i(e,t,this.readerMode)}else if("CB7"===this.format){const e=yield this.make7zLoader();this.book=$i(e,t,this.readerMode)}}catch(e){throw console.error(e),e}}))}preCache(){return h(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield Ft(this.book)}))}makeZipLoader(e){return h(this,void 0,void 0,(function*(){let t=yield r.loadAsync(e);const i=t.files;return{entries:Object.values(i).map((e=>({filename:e.name}))),loadText:e=>h(this,void 0,void 0,(function*(){let i=t.file(e);return i?i.async("string"):""})),loadBlob:e=>h(this,void 0,void 0,(function*(){let i=t.file(e);if(i){let e=yield i.async("arraybuffer");return new Blob([e])}return new Blob([new ArrayBuffer(0)])})),getSize:e=>0}}))}makeTarLoader(){return h(this,void 0,void 0,(function*(){const e=yield s(this.comicBuffer),t=new Map(e.map((e=>[e.name,e]))),i=e=>(i,...r)=>t.has(i)?e(t.get(i),...r):null,r=i((e=>e.readAsString())),n=i(((e,t)=>e.blob));return{entries:e.map((e=>({filename:e.name}))),loadText:r,loadBlob:n,getSize:e=>{var i,r;return null!==(r=null===(i=t.get(e))||void 0===i?void 0:i.size)&&void 0!==r?r:0}}}))}makeRarLoader(){return h(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{var i=[this.comicBuffer],r=[{name:"book.rar",content:this.comicBuffer}];this.rpc.transferables=i,this.rpc.unrar(r,null,0).then((t=>{let i=this.getRarEntries(t.ls);const r=new Map(Object.values(i).map((e=>[e.fullFileName,e]))),n=e=>(t,...i)=>r.has(t)?e(r.get(t),...i):null,o=n((e=>e.fullFileName)),s=n(((e,t)=>new Blob([e.fileContent])));e({entries:Object.values(i).map((e=>({filename:e.fullFileName}))),loadText:o,loadBlob:s,getSize:e=>{var t,i;return null!==(i=null===(t=r.get(e))||void 0===t?void 0:t.fileSize)&&void 0!==i?i:0}})})).catch((e=>{console.error(e),t(e)}))}))}))}make7zLoader(){return h(this,void 0,void 0,(function*(){const e="./lib/7z-wasm/7zz.wasm";if(!window.wasmBinary){const t=yield fetch(e,{credentials:"same-origin"});if(!t.ok)throw"failed to load wasm binary file at '"+e+"'";window.wasmBinary=yield t.arrayBuffer()}const t=yield window.SevenZip({wasmBinary:window.wasmBinary}),i=new Uint8Array(this.comicBuffer),r="archive.cb7",n=t.FS.open(r,"w+");t.FS.write(n,i,0,i.length),t.FS.close(n),t.callMain(["x",r]);const o=t.FS,s=this.get7zEntries(o.lookupPath("/").node),a=new Map(s.map((e=>[e.name,e]))),l=e=>(t,...i)=>a.has(t)?e(a.get(t),...i):null,c=l((e=>e.name)),h=l(((e,t)=>new Blob([e.buffer])));return{entries:s.map((e=>({filename:e.name}))),loadText:c,loadBlob:h,getSize:e=>{var t,i;return null!==(i=null===(t=a.get(e))||void 0===t?void 0:t.packSize)&&void 0!==i?i:0}}}))}getRarEntries(e){const t=Object.keys(e);let i=[];for(let r=0;r<t.length;r++){const n=t[r];"dir"===e[n].type?i=i.concat(this.getRarEntries(e[n].ls)):i.push({fullFileName:n,fileContent:e[n].fileContent,fileSize:e[n].fileSize})}return i}get7zEntries(e){const t=e.contents,i=Object.keys(t).filter((e=>"archive.cb7"!=e&&"dev"!=e&&"home"!=e&&"proc"!=e&&"tmp"!=e));let r=[];for(let e=0;e<i.length;e++){const n=i[e];t[n].isFolder?r=r.concat(this.get7zEntries(t[n])):r.push({name:n,buffer:t[n].contents,size:t[n].usedBytes})}return r}getMetadata(){return h(this,void 0,void 0,(function*(){return new Promise(((e,t)=>h(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());const t=yield this.book.getCover();var i=new FileReader;i.readAsDataURL(t),i.onloadend=()=>{e({cover:i.result})}}catch(e){console.error(e),t(e)}}))))}))}}const Ui=e=>e?.trim()?.replace(/\s{2,}/g," "),qi=e=>Ui(e?.textContent),zi={XLINK:"http://www.w3.org/1999/xlink",EPUB:"http://www.idpf.org/2007/ops"},Xi="application/xml",Vi="application/xhtml+xml",Ji={strong:["strong","self"],emphasis:["em","self"],style:["span","self"],a:"anchor",strikethrough:["s","self"],sub:["sub","self"],sup:["sup","self"],code:["code","self"],image:"image"},Gi={epigraph:["blockquote"],subtitle:["h2",Ji],"text-author":["p",Ji],date:["p",Ji],stanza:"stanza"},_i={title:["header",{p:["h1",Ji],"empty-line":["br"]}],epigraph:["blockquote","self"],image:"image",annotation:["aside"],section:["section","self"],p:["p",Ji],poem:["blockquote",Gi],subtitle:["h2",Ji],cite:["blockquote","self"],"empty-line":["br"],table:["table",{tr:["tr",["align"]],th:["th",["colspan","rowspan","align","valign"]],td:["td",["colspan","rowspan","align","valign"]]}],"text-author":["p",Ji]};Gi.epigraph.push(_i);const Zi={image:"image",title:["section",{p:["h1",Ji],"empty-line":["br"]}],epigraph:["section",_i],section:["section",_i]},Yi=e=>{const t=e.getAttributeNS(zi.XLINK,"href"),[,i]=t.split("#"),r=e.getRootNode().getElementById(i);return r?`data:${r.getAttribute("content-type")};base64,${r.textContent}`:t};class Ki{constructor(e){this.fb2=e,this.doc=document.implementation.createDocument(zi.XHTML,"html")}image(e){const t=this.doc.createElement("img");return t.alt=e.getAttribute("alt"),t.title=e.getAttribute("title"),t.setAttribute("src",Yi(e)),t}anchor(e){const t=this.convert(e,{a:["a",Ji]});return t.setAttribute("href",e.getAttributeNS(zi.XLINK,"href")),"note"===e.getAttribute("type")&&t.setAttributeNS(zi.EPUB,"epub:type","noteref"),t}stanza(e){const t=this.convert(e,{stanza:["p",{title:["header",{p:["strong",Ji],"empty-line":["br"]}],subtitle:["p",Ji]}]});for(const i of e.children)"v"===i.nodeName&&(t.append(this.doc.createTextNode(i.textContent)),t.append(this.doc.createElement("br")));return t}convert(e,t){if(3===e.nodeType)return this.doc.createTextNode(e.textContent);if(4===e.nodeType)return this.doc.createCDATASection(e.textContent);if(8===e.nodeType)return this.doc.createComment(e.textContent);const i=t?.[e.nodeName];if(!i)return null;if("string"==typeof i)return this[i](e);const[r,n]=i,o=this.doc.createElement(r);if(e.id&&(o.id=e.id),o.classList.add(e.nodeName),Array.isArray(n))for(const t of n)o.setAttribute(t,e.getAttribute(t));const s="self"===n?t:Array.isArray(n)?null:n;let a=e.firstChild;for(;a;){const e=this.convert(a,s);e&&o.append(e),a=a.nextSibling}return o}}const Qi=URL.createObjectURL(new Blob(['\n@namespace epub "http://www.idpf.org/2007/ops";\nbody > img, section > img {\n    display: block;\n    margin: auto;\n}\n.title {\n    text-align: center;\n}\nbody > section > .title, body.notesBodyType > .title {\n    margin: 3em 0;\n}\nbody.notesBodyType > section .title {\n    text-align: left;\n    margin: 1em 0;\n}\np {\n    text-indent: 1em;\n    margin: 0;\n}\n:not(p) + p, p:first-child {\n    text-indent: 0;\n}\n.poem p {\n    text-indent: 0;\n    margin: 1em 0;\n}\n.text-author, .date {\n    text-align: end;\n}\n.text-author:before {\n    content: "—";\n}\ntable {\n    border-collapse: collapse;\n}\ntd, th {\n    padding: .25em;\n}\na[epub|type~="noteref"] {\n    font-size: .75em;\n    vertical-align: super;\n}\nbody:not(.notesBodyType) > .title, body:not(.notesBodyType) > .epigraph {\n    margin: 3em 0;\n}\n'],{type:"text/css"})),er="data-foliate-id",tr=async e=>{const t={},i=await(async e=>{const t=await e.arrayBuffer(),i=new TextDecoder("utf-8").decode(t),r=new DOMParser,n=r.parseFromString(i,Xi),o=n.xmlEncoding||i.match(/^<\?xml\s+version\s*=\s*["']1.\d+"\s+encoding\s*=\s*["']([A-Za-z0-9._-]*)["']/)?.[1];if(o&&"utf-8"!==o.toLowerCase()){const e=new TextDecoder(o).decode(t);return r.parseFromString(e,Xi)}return n})(e),r=new Ki(i),n=e=>i.querySelector(e),o=e=>[...i.querySelectorAll(e)],s=e=>{const t=qi(e.querySelector("nickname"));if(t)return t;const i=qi(e.querySelector("first-name")),r=qi(e.querySelector("middle-name")),n=qi(e.querySelector("last-name"));return{name:[i,r,n].filter((e=>e)).join(" "),sortAs:n?[n,[i,r].filter((e=>e)).join(" ")].join(", "):null}},a=e=>e?.getAttribute("value")??qi(e),l=n("title-info annotation");t.metadata={title:qi(n("title-info book-title")),identifier:qi(n("document-info id")),language:qi(n("title-info lang")),author:o("title-info author").map(s),translator:o("title-info translator").map(s),producer:o("document-info author").map(s).concat(o("document-info program-used").map(qi)),publisher:qi(n("publish-info publisher")),published:a(n("title-info date")),modified:a(n("document-info date")),description:l?r.convert(l,{annotation:["div",_i]}).innerHTML:null,subject:o("title-info genre").map(qi)},t.getCover=()=>fetch(Yi(n("coverpage image"))).then((e=>e.blob()));const c=Array.from(i.querySelectorAll("body"),(e=>{const t=r.convert(e,{body:["body",Zi]});return[Array.from(t.children,(e=>{const t=[e,...e.querySelectorAll("[id]")].map((e=>e.id));return{el:e,ids:t}})),t]})),h=c[0][0].map((({el:e,ids:t})=>({ids:t,titles:Array.from(e.querySelectorAll(":scope > section > .title"),((e,t)=>(e.setAttribute(er,t),{title:qi(e),index:t}))),el:e}))).concat(c.slice(1).map((([e,t])=>{const i=e.map((e=>e.ids)).flat();return t.classList.add("notesBodyType"),{ids:i,el:t,linear:"no"}}))).map((({ids:e,titles:t,el:i,linear:r})=>{const n=(o=i.outerHTML,`<?xml version="1.0" encoding="utf-8"?>\n<html xmlns="http://www.w3.org/1999/xhtml">\n    <head><link href="${Qi}" rel="stylesheet" type="text/css"/></head>\n    <body>${o}</body>\n</html>`);var o;const s=new Blob([n],{type:Vi}),a=URL.createObjectURL(s);return{ids:e,title:Ui(i.querySelector(".title, .subtitle, p")?.textContent??(i.classList.contains("title")?i.textContent:"")),titles:t,load:()=>a,createDocument:()=>(new DOMParser).parseFromString(n,Vi),size:s.size-Array.from(i.querySelectorAll("[src]"),(e=>e.getAttribute("src")?.length??0)).reduce(((e,t)=>e+t),0),linear:r}})),d=new Map;return t.sections=h.map(((e,t)=>{const{ids:i,load:r,createDocument:n,size:o,linear:s}=e;for(const e of i)e&&d.set(e,t);return{id:t,load:r,createDocument:n,size:o,linear:s}})),t.toc=h.map((({title:e,titles:t},i)=>{const r=i.toString();return{label:e,href:r,subitems:t?.length?t.map((({title:e,index:t})=>({label:e,href:`${r}#${t}`}))):null}})).filter((e=>e)),t.resolveHref=e=>{const[t,i]=e.split("#");return t?{index:Number(t),anchor:e=>e.querySelector(`[${er}="${i}"]`)}:{index:d.get(i),anchor:e=>e.getElementById(i)}},t.splitTOCHref=e=>e?.split("#")?.map((e=>Number(e)))??[],t.getTOCFragment=(e,t)=>e.querySelector(`[${er}="${t}"]`),t};class ir extends Bt{constructor(e,t){super(Object.assign({format:"FB2"},t)),this.fb2Buffer=e}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let i=new T(this.book);this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),m(e);let r=this.getDocument();r&&(x(e,this.readerMode,r),t())}))))}parse(){return h(this,void 0,void 0,(function*(){try{let e=new Blob([this.fb2Buffer]);this.book=yield tr(e)}catch(e){throw console.error(e),e}}))}preCache(){return h(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield Ft(this.book)}))}getMetadata(){return h(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());let e=new T(this.book);return yield e.getMetadata()}catch(e){throw console.error(e),e}}))}}class rr extends Bt{constructor(e,t){super(Object.assign({format:"CACHE"},t)),this.cacheBuffer=e}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){this.element=e,this.book=yield Ht(this.cacheBuffer);let i=new T(this.book);this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),m(e);let r=this.getDocument();r&&(x(e,this.readerMode,r),t())}))))}}class nr extends Bt{constructor(e,t){super(Object.assign({format:"DOCX"},t)),this.docxBuffer=e}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let i=new T(this.book);this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),m(e);let r=this.getDocument();r&&(x(e,this.readerMode,r),t())}))))}parse(){return h(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{a.convertToHtml({arrayBuffer:this.docxBuffer}).then((t=>h(this,void 0,void 0,(function*(){this.book=Se(t.value,!1),e()}))))}catch(e){console.error(e),t(e)}}))}))}preCache(){return h(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield Ft(this.book)}))}}class or extends Bt{constructor(e,t){super(Object.assign({format:"MD"},t)),this.mdBuffer=e}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let i=new T(this.book);this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),m(e);let r=this.getDocument();r&&(x(e,this.readerMode,r),t())}))))}parse(){return h(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{var i=new Blob([this.mdBuffer],{type:"text/plain"}),r=new FileReader;r.onload=t=>h(this,void 0,void 0,(function*(){var i;let r=yield l(null===(i=t.target)||void 0===i?void 0:i.result);this.book=Se(r,!1),e()})),r.readAsText(i,"UTF-8")}catch(e){console.error(e),t(e)}}))}))}preCache(){return h(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield Ft(this.book)}))}}class sr extends Bt{constructor(e,t){super(t),this.htmlBuffer=e}renderTo(e){return new Promise(((t,i)=>h(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let i=new T(this.book);this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),m(e);let r=this.getDocument();r&&(x(e,this.readerMode,r),t())}))))}parse(){return h(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{var i=new Blob([this.htmlBuffer],{type:Pt[this.format.toLocaleLowerCase()]}),r=new FileReader;r.onload=t=>h(this,void 0,void 0,(function*(){var i;let r=null===(i=t.target)||void 0===i?void 0:i.result;"MHTML"===this.format&&(r=c.convert(r).window.document.documentElement.innerHTML),this.book=Se(r,!1),e()})),r.readAsText(i,"UTF-8")}catch(e){console.error(e),t(e)}}))}))}preCache(){return h(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield Ft(this.book)}))}}export{rr as CacheRender,ji as ComicRender,nr as DocxRender,Wt as EpubRender,ir as Fb2Render,sr as HtmlRender,or as MdRender,ki as MobiRender,Fi as PdfRender,Wi as TxtRender};
