import e from"axios";import t from"fs";import i from"path";import{promisify as o}from"util";import r from"stream";import{Client as s}from"basic-ftp";import{S3Client as n,ListObjectsV2Command as a,DeleteObjectCommand as d,PutObjectCommand as l,GetObjectCommand as c}from"@aws-sdk/client-s3";import{AuthType as u,createClient as h}from"webdav";import p from"ssh2-sftp-client";import f from"form-data";import{Storage as g}from"megajs";import y from"crypto";import m from"os";import{SSE as v}from"sse.js";import k from"electron-store";import b from"node-machine-id";function F(e,t,i,o){return new(i||(i=Promise))((function(r,s){function n(e){try{d(o.next(e))}catch(e){s(e)}}function a(e){try{d(o.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}d((o=o.apply(e,t||[])).next())}))}const E=e=>"json"===e?"application/json":["jpg","jpeg","png","gif","bmp"].includes(e)?"image/"+e:"zip"===e?"application/zip":"epub"===e?"application/epub+zip":"txt"===e?"text/plain":"pdf"===e?"application/pdf":"mobi"===e?"application/x-mobipocket-ebook":"azw3"===e||"azw"===e?"application/vnd.amazon.ebook":"cbz"===e?"application/x-cbz":"cbr"===e?"application/x-cbr":"cbt"===e?"application/x-cbt":"cb7"===e?"application/x-cb7":"fb2"===e?"application/x-fictionbook+xml":"html"===e?"text/html":"css"===e?"text/css":"js"===e?"application/javascript":"xml"===e?"application/xml":"xhtml"===e?"application/xhtml+xml":"opf"===e?"application/oebps-package+xml":"ncx"===e?"application/x-dtbncx+xml":"mp3"===e?"audio/mpeg":"wav"===e?"audio/wav":"ogg"===e?"audio/ogg":"mp4"===e?"video/mp4":"webm"===e?"video/webm":"avi"===e?"video/x-msvideo":"wmv"===e?"video/x-ms-wmv":"flv"===e?"video/x-flv":"m3u8"===e?"application/x-mpegURL":"ts"===e?"video/MP2T":"3gp"===e?"video/3gpp":"3g2"===e?"video/3gpp2":"db"===e?"application/x-sqlite3":void 0,w={_chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",encode(e){if("string"!=typeof e)throw new Error("Input must be a string");let t="",i=0;const o=this._stringToUtf8Bytes(e),r=o.length;for(;i<r;){const e=o[i++]||0,s=o[i++]||0,n=o[i++]||0,a=e>>2,d=(3&e)<<4|s>>4,l=(15&s)<<2|n>>6,c=63&n;t+=this._chars.charAt(a),t+=this._chars.charAt(d),t+=i-2>=r?"=":this._chars.charAt(l),t+=i-1>=r?"=":this._chars.charAt(c)}return t},decode(e){if("string"!=typeof e)throw new Error("Input must be a string");for(e=e.replace(/[^A-Za-z0-9+/]/g,"");e.length%4!=0;)e+="=";const t=[];let i=0;const o=e.length;for(;i<o;){const o=this._chars.indexOf(e.charAt(i++)),r=this._chars.indexOf(e.charAt(i++)),s=this._chars.indexOf(e.charAt(i++)),n=this._chars.indexOf(e.charAt(i++));if(-1===o||-1===r)throw new Error("Invalid Base64 character");const a=o<<2|r>>4,d=(15&r)<<4|s>>2,l=(3&s)<<6|n;t.push(a),-1!==s&&t.push(d),-1!==n&&t.push(l)}return this._utf8BytesToString(t)},_stringToUtf8Bytes(e){const t=[];for(let i=0;i<e.length;i++){const o=e.charCodeAt(i);if(o<128)t.push(o);else if(o<2048)t.push(192|o>>6),t.push(128|63&o);else if(55296==(64512&o)&&i+1<e.length){const r=o,s=e.charCodeAt(++i);if(56320==(64512&s)){const e=65536+((1023&r)<<10|1023&s);t.push(240|e>>18),t.push(128|e>>12&63),t.push(128|e>>6&63),t.push(128|63&e)}else t.push(239,191,189),i--}else t.push(224|o>>12),t.push(128|o>>6&63),t.push(128|63&o)}return t},_utf8BytesToString(e){let t="",i=0;for(;i<e.length;){const o=e[i++];if(o<128)t+=String.fromCharCode(o);else if(192==(224&o)){const r=e[i++];t+=128==(192&r)?String.fromCharCode((31&o)<<6|63&r):"�"}else if(224==(240&o)){const r=e[i++],s=e[i++];t+=128==(192&r)&&128==(192&s)?String.fromCharCode((15&o)<<12|(63&r)<<6|63&s):"�"}else if(240==(248&o)){const r=e[i++],s=e[i++],n=e[i++];if(128==(192&r)&&128==(192&s)&&128==(192&n)){const e=(7&o)<<18|(63&r)<<12|(63&s)<<6|63&n;if(e>65535){const i=e-65536;t+=String.fromCharCode(55296|i>>10),t+=String.fromCharCode(56320|1023&i)}else t+=String.fromCharCode(e)}else t+="�"}else t+="�"}return t},encodeURL(e){return this.encode(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},decodeURL(e){for(e=e.replace(/-/g,"+").replace(/_/g,"/");e.length%4;)e+="=";return this.decode(e)}};class S{constructor(e){this.queue=[],this.runningTasks=0,this.totalTasks=0,this.completedTasks=0,this.hasFailedTasks=!1,this.downloadedSize=0,this.maxConcurrency=e}addTask(e){return F(this,void 0,void 0,(function*(){return this.totalTasks++,new Promise(((t,i)=>{if(this.hasFailedTasks)return void t(void 0);const o=()=>F(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return this.completedTasks++,t(i),i}catch(e){throw this.completedTasks++,i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(!this.hasFailedTasks&&this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}clearQueue(){this.queue=[]}getStats(){return{total:this.totalTasks,completed:this.completedTasks,pending:this.queue.length,running:this.runningTasks,hasFailedTasks:this.hasFailedTasks}}resetCounters(){this.totalTasks=0,this.completedTasks=0,this.hasFailedTasks=!1}getDownloadedSize(){return this.downloadedSize}setDownloadedSize(e){this.downloadedSize=e}}const T="https://cloud.koodoreader.cn",O="https://stream.koodoreader.cn",R="https://cloudtest.960960.xyz",_="https://web.koodoreader.cn/",x="vnc67byrssocvy1",C="e5305b62f53844b1994f77a840fd0a37",A="pg8ten0B3vH",$="ltimecqanmpxoaicn9qw3es6l3sdl1ya",I="kc0Ls6xLZugGgLLVhZ8yhUU1cRkRoKNU",P="100197197",L="506df58a-29ab-4020-afc5-6f423dc80f35",z="1051055003225-ph1f5fvh328dhv7bco5jitlnfhg6ks2t.apps.googleusercontent.com",Q="a128ae7b9c094545af623de61dc0a1ef";class j{constructor(e){this.config=e,this.taskQueue=new S(3)}retryOperation(e,t=3){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;let o=[],r=!0,s=null;for(;r;){let n;n=s?yield e.post("https://api.dropboxapi.com/2/files/list_folder/continue",{cursor:s},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}):yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+t,limit:2e3},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});const a=n.data.entries||[];o=o.concat(a),r=n.data.has_more,s=n.data.cursor}return[...new Set(o.map((e=>({name:e.name,size:e.size||0,type:e[".tag"],modified:e.client_modified}))))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;yield e.post("https://api.dropboxapi.com/2/files/delete_v2",{path:"/"+t},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});return!0}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.access_token}))}getAuthUrl(e){return`https://www.dropbox.com/oauth2/authorize?response_type=code&token_access_type=offline&client_id=${x}&redirect_uri=${e}`}}const D=o(r.pipeline);class U extends j{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{const s=this.config.access_token,n=t.createReadStream(i.join(this.storagePath,o));return yield e.post("https://content.dropboxapi.com/2/files/upload",n,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+r,mode:"overwrite",autorename:!0,mute:!1})},maxContentLength:1/0,maxBodyLength:1/0}),!0}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{const s=this.config.access_token,n=t.createWriteStream(i.join(this.storagePath,r)),a=yield e({url:"https://content.dropboxapi.com/2/files/download",method:"GET",responseType:"stream",headers:{Authorization:`Bearer ${s}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+o})},maxContentLength:1/0,maxBodyLength:1/0});let d=0;return a.data.on("data",(e=>{d+=e.length,this.taskQueue.setDownloadedSize(d)})),yield D(a.data,n),!0}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class M{constructor(e){this.config=e,this.storagePath=e.storagePath,this.taskQueue=new S(1),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=0){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}getClient(){return F(this,void 0,void 0,(function*(){try{if(this.client&&!1===this.client.closed)return this.client;let{url:e,username:t,password:i,dir:o,ssl:r,port:n}=this.config;const a=new s(0);a.ftp.verbose=!0;const d=a.access({host:e,port:parseInt(n),user:t,password:i,secure:"1"===r}),l=new Promise(((e,t)=>{setTimeout((()=>t(new Error("FTP connection timeout"))),5e3)}));return yield Promise.race([d,l]),this.client=a,a}catch(e){throw console.error("Error connecting to FTP server:",e),this.client=null,e}}))}uploadFile(e,t){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{let{dir:o}=this.config;o=o&&"KoodoReader"===this.baseFolder?o:this.baseFolder;const r=yield this.getClient(),s=()=>F(this,void 0,void 0,(function*(){yield r.ensureDir(i.dirname(o+"/"+t)),yield r.cd("/"),yield r.uploadFrom(i.join(this.storagePath,e),o+"/"+t)}));try{return yield s(),!0}catch(e){return console.error(e),!1}}catch(e){return console.error("Error in uploadFile:",e),!1}}))))))}))}downloadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{let{dir:r}=this.config;r=r&&"KoodoReader"===this.baseFolder?r:this.baseFolder;const s=yield this.getClient(),n=t.createWriteStream(i.join(this.storagePath,o)),a=()=>F(this,void 0,void 0,(function*(){s.trackProgress((e=>{this.taskQueue.setDownloadedSize(e.bytes||0)})),yield s.downloadTo(n,r+"/"+e),s.trackProgress()}));try{return yield a(),!0}catch(e){return console.error(e),!1}}catch(e){return console.error("Error in downloadFile:",e),!1}}))))))}))}listFiles(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.listFilesWithoutQueue(e)}))))))}))}listFilesWithoutQueue(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(e){return F(this,void 0,void 0,(function*(){let{dir:t}=this.config;t=t&&"KoodoReader"===this.baseFolder?t:this.baseFolder;const i=yield this.getClient(),o=()=>F(this,void 0,void 0,(function*(){return yield i.list(t+"/"+e)}));try{return(yield o()).map((e=>({name:e.name,size:e.size||0,type:e.isFile?"file":"folder",modified:e.modifiedAt?e.modifiedAt.toISOString():""})))}catch(e){return console.error(e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(e){return F(this,void 0,void 0,(function*(){let{dir:t}=this.config;t=t&&"KoodoReader"===this.baseFolder?t:this.baseFolder;const i=yield this.getClient(),o=()=>F(this,void 0,void 0,(function*(){yield i.remove(t+"/"+e)}));try{return yield o(),!0}catch(e){return console.error(e),!1}}))}}class B{constructor(e){this.isExp=!1,this.baseUrl="https://graph.microsoft.com/v1.0/me/drive/special/approot",this.config=e,this.taskQueue=new S(3),this.isExp=this.config.isExp||!1,this.baseUrl=this.isExp?"https://graph.microsoft.com/v1.0/me/drive/root":"https://graph.microsoft.com/v1.0/me/drive/special/approot",void 0===this.config.baseFolder?this.baseFolder=this.isExp?"KoodoReader":"":this.baseFolder=this.config.baseFolder}retryOperation(e,t=3){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;for(t=this.baseFolder+"/"+t;t.startsWith("/");)t=t.substring(1);let o,r=[];if(""===t)o=`${this.baseUrl}/children`;else{const e=encodeURIComponent(t);o=`${this.baseUrl}:/${e}:/children`}for(;o;){const t=yield e.get(o,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});if(t.status>=300)break;const s=t.data.value||[];r=r.concat(s),o=t.data["@odata.nextLink"]||""}return[...new Set(r.map((e=>({name:e.name,size:e.size||0,type:e.folder?"folder":"file",modified:e.lastModifiedDateTime}))))]}catch(e){return console.error("Error occurred during file list:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;for(t=this.baseFolder+"/"+t;t.startsWith("/");)t=t.substring(1);const o=yield e.delete(`${this.baseUrl}:/${t}`,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});return!(o.status>=300)||(console.error("Error deleting file:",o),!0)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.access_token}))}getAuthUrl(e){return`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${L}&scope=${this.isExp?"files.readwrite.all":"files.readwrite.appfolder"} offline_access&response_type=code&redirect_uri=${e}`}}const W=209715200;class N extends B{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){var s;let n=null;try{const s=this.config.access_token;let a=this.baseFolder+"/"+r;for(;a.startsWith("/");)a=a.substring(1);const d=i.join(this.storagePath,o),l=yield this.getFileSize(d),c=a.split(".").pop(),u=(E(c||""),`${this.baseUrl}:/${a}:/createUploadSession`),h=(yield e.post(u,{item:{"@microsoft.graph.conflictBehavior":"replace"}},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}})).data.uploadUrl;n=yield t.promises.open(d,"r");let p=0,f=Buffer.alloc(W);for(;p<l;){const t=Math.min(W,l-p);t<W&&(f=Buffer.alloc(t));const{bytesRead:i}=yield n.read(f,0,t,p);if(0===i)break;const o=`bytes ${p}-${p+i-1}/${l}`;console.info(`Uploading chunk: ${o}`);const r=f.slice(0,i),s=yield e.put(h,r,{headers:{"Content-Length":i.toString(),"Content-Range":o},maxContentLength:1/0,maxBodyLength:1/0,timeout:0});if(200!==s.status&&201!==s.status&&202!==s.status)throw new Error(`Chunk upload failed with status: ${s.status}`);200===s.status||201===s.status?console.info("Upload complete",s.data):console.info("Next expected range:",s.data.nextExpectedRanges),p+=i}return console.info(`File ${o} uploaded successfully.`),!0}catch(e){return console.error("Error occurred during file upload:",(null===(s=e.response)||void 0===s?void 0:s.data)||e.message||e),!1}finally{n&&(yield n.close())}}))))))}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{const s=this.config.access_token;let n=this.baseFolder+"/"+o;for(;n.startsWith("/");)n=n.substring(1);const a=`${this.baseUrl}:/${n}:/content`;let d=(yield fetch(a,{headers:{Authorization:"Bearer "+s},redirect:"manual"})).headers.get("location");if(d){const o=yield e.get(d,{responseType:"stream"});let s=0;const n=t.createWriteStream(i.join(this.storagePath,r));return o.data.on("data",(e=>{s+=e.length,this.taskQueue.setDownloadedSize(s)})),yield new Promise(((e,t)=>{o.data.pipe(n),n.on("finish",(()=>{e()})),n.on("error",t)})),!0}return!1}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}getFileSize(e){return F(this,void 0,void 0,(function*(){try{return(yield t.promises.stat(e)).size}catch(e){throw e}}))}}class K{constructor(e){this.isExp=!1,this.config=e,this.taskQueue=new S(3),this.isExp=this.config.isExp||!1,this.baseFolder="KoodoReader"}retryOperation(e,t=3){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}getFileId(t,i){return F(this,void 0,void 0,(function*(){const o=this.config.access_token,r=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+'${i}'+in+parents&fields=files(id,name)`;try{const t=yield e.get(r,{headers:{Authorization:"Bearer "+o}});if(0===t.data.files.length)return"";const i=t.data.files;return i.length>0?i[0].id:null}catch(e){return console.error("Error occurred during file list retrieval:",e),""}}))}checkFolder(t){return F(this,void 0,void 0,(function*(){t=this.baseFolder+"/"+t;const i=this.config.access_token;if(""===t)return"root";const o=t.split("/").filter((e=>""!==e.trim()));let r="root";for(const t of o){let o=yield this.getFolderId(t,r);if(!o){const s={name:t,mimeType:"application/vnd.google-apps.folder",parents:[r]};try{o=(yield e.post("https://www.googleapis.com/drive/v3/files",s,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.id}catch(e){throw console.error(`Error occurred during folder creation for ${t}:`,e),e}}r=o}return r}))}getFolderId(t,i){return F(this,void 0,void 0,(function*(){const o=this.config.access_token,r=`https://www.googleapis.com/drive/v3/files?q=name='${t=encodeURIComponent(t)}'+and+mimeType='application/vnd.google-apps.folder'+and+'${i}'+in+parents&fields=files(id,name)`;try{const t=(yield e.get(r,{headers:{Authorization:`Bearer ${o}`}})).data.files;return t.length>0?t[0].id:null}catch(e){throw console.error("Error occurred during fetching folder ID:",e),e}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;let o=yield this.checkFolder(t),r=[],s="",n=!0;for(;n;){let t=`https://www.googleapis.com/drive/v3/files?q='${o}'+in+parents&fields=nextPageToken,files(id,name,size,mimeType)&pageSize=1000`;s&&(t+=`&pageToken=${s}`);const a=yield e.get(t,{headers:{Authorization:`Bearer ${i}`}}),d=a.data.files||[];r=r.concat(d),s=a.data.nextPageToken,n=!!s}return[...new Set(r.map((e=>({name:e.name,size:e.size||0,type:"application/vnd.google-apps.folder"===e.mimeType?"folder":"file",modified:e.modifiedTime}))))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQue(e)}))))))}))}deleteFileWithoutQue(t){return F(this,void 0,void 0,(function*(){const i=t.split("/")[1],o=yield this.checkFolder(t),r=this.config.access_token,s=yield this.getFileId(i,o);if(""===s)return console.error("File not found:",i),!0;try{const t=yield e.delete(`https://www.googleapis.com/drive/v3/files/${s}`,{headers:{Authorization:`Bearer ${r}`}});return console.error("File deleted:",t),!0}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.access_token}))}getAuthUrl(e){return`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${e}&prompt=consent&response_type=code&client_id=${z}&scope=https://www.googleapis.com/auth/${this.isExp?"drive":"drive.file"}&access_type=offline`}}class H extends K{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{const s=this.config.access_token;let n=o.split("/").pop(),a=r.split(".").pop(),d=E(a||""),l=r.split("/").slice(0,-1).join("/"),c=yield this.checkFolder(l),u=yield this.getFileId(n||"",c);const h={mimeType:d,name:n,parents:[c]},p=u?`https://www.googleapis.com/upload/drive/v3/files/${u}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",f=(yield e({method:u?"PATCH":"POST",url:p,data:u?null:JSON.stringify(h),headers:{Authorization:"Bearer "+s,"Content-Type":"application/json; charset=UTF-8"},maxContentLength:1/0,maxBodyLength:1/0})).headers.location;let g=yield this.getFileSize(i.join(this.storagePath,o));const y=t.createReadStream(i.join(this.storagePath,o));yield e.put(f,y,{headers:{Authorization:"Bearer "+s,"Content-Type":"application/zip","Content-Range":`bytes 0-${g-1}/${g}`},maxContentLength:1/0,maxBodyLength:1/0});return!0}catch(e){return console.error("Error occurred during upload:",e),!1}}))))))}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{const s=this.config.access_token;let n=o.split("/").pop(),a=o.split("/").slice(0,-1).join("/"),d=yield this.checkFolder(a),l=yield this.getFileId(n||"",d);if(!l)return console.error("File not found"),!0;const c=`https://www.googleapis.com/drive/v3/files/${l}?alt=media`;return new Promise((o=>{const n=t.createWriteStream(i.join(this.storagePath,r));e({url:c,method:"GET",responseType:"stream",headers:{Authorization:"Bearer "+s},maxContentLength:1/0,maxBodyLength:1/0}).then((e=>{let t=0;e.data.on("data",(e=>{t+=e.length,this.taskQueue.setDownloadedSize(t)})),e.data.pipe(n),n.on("finish",(()=>{o(!0)})),n.on("error",(()=>{o(!1)}))})).catch((e=>{console.error("Error downloading file:",e),o(!1)}))}))}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}getFileSize(e){return F(this,void 0,void 0,(function*(){try{return(yield t.promises.stat(e)).size}catch(e){throw e}}))}}class q{constructor(e){this.config=e,this.taskQueue=new S(5),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=0){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}shouldUsePathStyle(e){try{const t=new URL(e),i=t.hostname,o=/^(\d{1,3}\.){3}\d{1,3}$/.test(i),r=""!==t.port;return!o&&r}catch(e){return!0}}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(e){return F(this,void 0,void 0,(function*(){let{endpoint:t,region:i,bucketName:o,accessKeyId:r,secretAccessKey:s,dir:d}=this.config;d=d&&"KoodoReader"===this.baseFolder?d:this.baseFolder;let l=d+"/"+e;for(;l.startsWith("/");)l=l.substring(1);""===l||l.endsWith("/")||(l+="/");const c=new n({endpoint:t,region:i,credentials:{accessKeyId:r,secretAccessKey:s},forcePathStyle:this.shouldUsePathStyle(t)});try{let e,t=[],i=[],r=!0;for(;r;){const s=yield c.send(new a({Bucket:o,Prefix:l,Delimiter:"/",ContinuationToken:e}));s.Contents&&(t=t.concat(s.Contents)),s.CommonPrefixes&&(i=i.concat(s.CommonPrefixes)),e=s.NextContinuationToken,r=!!e}let s=[];return t.forEach((e=>{if(!e.Key.endsWith("/")){const t=e.Key.substring(l.length);t.includes("/")||s.push({name:t,size:e.Size||0,type:"file",modified:e.LastModified?e.LastModified.toISOString():""})}})),i.forEach((e=>{const t=e.Prefix.substring(l.length).replace(/\/$/,"");t&&s.push({name:t,size:0,type:"folder",modified:""})})),s}catch(e){return console.error(e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){let{endpoint:t,region:i,bucketName:o,accessKeyId:r,secretAccessKey:s,dir:a}=this.config;a=a&&"KoodoReader"===this.baseFolder?a:this.baseFolder;const l=new n({endpoint:t,region:i,credentials:{accessKeyId:r,secretAccessKey:s},forcePathStyle:this.shouldUsePathStyle(t)});let c=a+"/"+e;for(;c.startsWith("/");)c=c.substring(1);try{return yield l.send(new d({Bucket:o,Key:c})),!0}catch(e){return console.error(e),!1}}))}}class J extends q{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){let{endpoint:r,region:s,bucketName:a,accessKeyId:d,secretAccessKey:c,dir:u}=this.config;const h=new n({endpoint:r,region:s,credentials:{accessKeyId:d,secretAccessKey:c},forcePathStyle:this.shouldUsePathStyle(r)});u=u&&"KoodoReader"===this.baseFolder?u:this.baseFolder;let p=u+"/"+o;for(;p.startsWith("/");)p=p.substring(1);try{let o=yield h.send(new l({Bucket:a,Key:p,Body:t.createReadStream(i.join(this.storagePath,e))}));return 200===o.$metadata.httpStatusCode||(console.error("Error uploading file:",o),!1)}catch(e){return console.error("Error: ",e),!1}}))))))}))}downloadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);let{endpoint:r,region:s,bucketName:a,accessKeyId:d,secretAccessKey:l,dir:u}=this.config;u=u&&"KoodoReader"===this.baseFolder?u:this.baseFolder;const h=(e,t,i,o)=>new Promise(((r,s)=>F(this,void 0,void 0,(function*(){const s=yield e.send(new c({Bucket:t,Key:i}));let n=0;s.Body?(s.Body.on("data",(e=>{n+=e.length,this.taskQueue.setDownloadedSize(n)})),s.Body.pipe(o),o.on("finish",(e=>{e&&r(!1),r(!0)}))):r(!1)})))),p=()=>new Promise(((c,p)=>{const f=new n({region:s,endpoint:r,credentials:{accessKeyId:d,secretAccessKey:l},forcePathStyle:this.shouldUsePathStyle(r)});let g=t.createWriteStream(i.join(this.storagePath,o)),y=u+"/"+e;for(;y.startsWith("/");)y=y.substring(1);h(f,a,y,g).then((e=>{c(!0)})).catch((e=>{console.error(e),c(!1)}))}));try{return yield p()}catch(e){return console.error(e),!1}}))))))}))}}class V{constructor(e){let{username:t,password:i,url:o,dir:r,AuthType:s,createClient:n}=e;void 0===e.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=e.baseFolder,r=r&&"KoodoReader"===this.baseFolder?r:this.baseFolder,this.username=t,this.password=i,this.url=o,this.dir=r,this.taskQueue=new S(5),this.AuthType=s,this.createClient=n}getClient(){return F(this,void 0,void 0,(function*(){return this.webdavClient||(this.url=yield this.handleUrlRedirection(this.url),this.webdavClient=this.createClient(this.url,{authType:this.AuthType.Password,username:this.username,password:this.password})),this.webdavClient}))}handleUrlRedirection(t){return F(this,void 0,void 0,(function*(){try{const i=yield e.head(t,{maxRedirects:0,validateStatus:()=>!0});return i.request&&i.request.responseURL&&i.request.responseURL!==t?i.request.responseURL:i.status>=300&&i.status<400&&i.headers.location?i.headers.location:t}catch(e){return console.info("Error handling URL redirection:",e),t}}))}retryOperation(e,t=1){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(e){return F(this,void 0,void 0,(function*(){const t=yield this.getClient();try{return(yield t.getDirectoryContents(this.dir+"/"+e)).filter((t=>"."!==t.filename&&".."!==t.filename&&t.filename!==e)).map((e=>({name:e.basename,size:e.size||0,type:"directory"===e.type?"folder":"file",modified:e.lastmod})))}catch(i){return i.response&&404===i.response.status&&(yield t.createDirectory(this.dir+"/"+e)),console.error("Error listing files:",i),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){const t=yield this.getClient();try{return yield t.deleteFile(this.dir+"/"+e),!0}catch(e){return console.error("Error deleting file:",e),!1}}))}ensureDirectoryExists(e){return F(this,void 0,void 0,(function*(){let t=yield this.getClient();try{const i=e.replace(/^\/+|\/+$/g,"").split("/").filter((e=>e.length>0));let o="";for(const e of i)o=o?`${o}/${e}`:e,(yield t.exists(`/${o}`))||(yield t.createDirectory(`/${o}`));return!0}catch(e){return console.error("Error ensuring directory exists:",e),!1}}))}}class Y extends V{constructor(e){super(Object.assign(Object.assign({},e),{AuthType:u,createClient:h})),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{let s=yield this.getClient();const n=s.exists(i.dirname(this.dir+"/"+r)),a=new Promise(((e,t)=>{setTimeout((()=>t(new Error("WebDAV exists check timeout"))),5e3)}));!1===(yield Promise.race([n,a]))&&(yield this.ensureDirectoryExists(i.dirname(this.dir+"/"+r)));let d=s.createWriteStream(this.dir+"/"+r);return t.createReadStream(i.join(this.storagePath,o)).pipe(d),new Promise(((n,a)=>{d.on("finish",(()=>{n(!0)})),d.on("error",(a=>F(this,void 0,void 0,(function*(){console.error("Error occurred during file upload:",a);try{let a=t.readFileSync(i.join(this.storagePath,o)),d=s.getFileUploadLink(this.dir+"/"+r);const l=new URL(d);l.search="",d=l.toString();const c=Buffer.from(this.username+":"+this.password,"binary").toString("base64");yield e.put(d,a,{headers:{Authorization:"Basic "+c},maxContentLength:1/0,maxBodyLength:1/0});n(!0)}catch(e){console.error("Error occurred during file upload:",e),n(!1)}}))))}))}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){if(this.taskQueue.setDownloadedSize(0),-1===e.indexOf("."))return new ArrayBuffer(0);try{let r=yield this.getClient();if(!1===(yield r.exists(this.dir+"/"+e)))return!0;let s=0,n=t.createWriteStream(i.join(this.storagePath,o)),a=r.createReadStream(this.dir+"/"+e);return a.on("data",(e=>{s+=e.length,this.taskQueue.setDownloadedSize(s)})),a.pipe(n),new Promise(((e,t)=>{n.on("finish",(()=>{e(!0)})),n.on("error",(t=>{e(!1)}))}))}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class X{constructor(e){this.config=e,this.taskQueue=new S(3),void 0===this.config.baseFolder?this.baseFolder="/KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=3){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){var i,o;return F(this,void 0,void 0,(function*(){try{const r=this.config.access_token;for(t=this.baseFolder+"/"+t;t.startsWith("/");)t=t.substring(1);let s=[],n=0;const a=1e3;let d=!0;for(;d;){const l=yield e.get("https://cloud-api.yandex.net/v1/disk/resources",{headers:{Authorization:`OAuth ${r}`,"Content-Type":"application/json"},params:{path:t?`/${t}`:"/",limit:a,offset:n,fields:"_embedded.items.name,_embedded.items.size,_embedded.items.type,_embedded.items.modified,_embedded.total"}}),c=(null===(i=l.data._embedded)||void 0===i?void 0:i.items)||[];s=s.concat(c);const u=(null===(o=l.data._embedded)||void 0===o?void 0:o.total)||0;n+=c.length,d=n<u}return[...new Set(s.map((e=>({name:e.name,size:e.size||0,type:"file"===e.type?"file":"folder",modified:e.modified}))))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;for(t=this.baseFolder+"/"+t;t.startsWith("/");)t=t.substring(1);const o=yield e.delete("https://cloud-api.yandex.net/v1/disk/resources",{headers:{Authorization:`OAuth ${i}`,"Content-Type":"application/json"},params:{path:t?`/${t}`:"/",permanently:!1}});return 202===o.status||204===o.status}catch(e){return console.error("Error deleting file:",e),!1}}))}ensureDirectoryExists(t){var i,o;return F(this,void 0,void 0,(function*(){try{const r=this.config.access_token,s=t.split("/").filter((e=>e.length>0));let n="";for(const t of s){n+="/"+t;try{yield e.get("https://cloud-api.yandex.net/v1/disk/resources",{headers:{Authorization:`OAuth ${r}`,"Content-Type":"application/json"},params:{path:n}})}catch(t){if(404!==(null===(i=t.response)||void 0===i?void 0:i.status))return console.error("Error checking directory:",t),!1;try{yield e.put(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(n)}`,null,{headers:{Authorization:`OAuth ${r}`}})}catch(e){if(409!==(null===(o=e.response)||void 0===o?void 0:o.status))return console.error("Error creating directory:",e),!1}}}return!0}catch(e){return console.error("Error ensuring directory exists:",e),!1}}))}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.access_token}))}getAuthUrl(e){return`https://oauth.yandex.com/authorize?response_type=code&client_id=${C}&redirect_uri=${e}&force_confirm=true`}}const G=o(r.pipeline);class Z extends X{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{const s=this.config.access_token;let n=this.baseFolder+"/"+r;for(;n.startsWith("/");)n=n.substring(1);const a=n.substring(0,n.lastIndexOf("/"));if(a){if(!(yield this.ensureDirectoryExists(a)))return console.error("Failed to create directory:",a),!1}const d=yield e.get("https://cloud-api.yandex.net/v1/disk/resources/upload",{headers:{Authorization:`OAuth ${s}`,"Content-Type":"application/json"},params:{path:`/${n}`,overwrite:!0}});if(200!==d.status)return console.error("Error getting upload URL:",d),!1;const l=d.data.href,c=t.createReadStream(i.join(this.storagePath,o));return yield e.put(l,c,{headers:{"Content-Type":"application/octet-stream"},maxContentLength:1/0,maxBodyLength:1/0}),!0}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);let s=this.baseFolder+"/"+o;for(;s.startsWith("/");)s=s.substring(1);try{const o=this.config.access_token,n=yield e.get("https://cloud-api.yandex.net/v1/disk/resources/download",{headers:{Authorization:`OAuth ${o}`,"Content-Type":"application/json"},params:{path:`/${s}`}});if(200!==n.status)return console.error("Error getting download URL:",n),!1;const a=n.data.href,d=t.createWriteStream(i.join(this.storagePath,r)),l=yield e({url:a,method:"GET",responseType:"stream",maxContentLength:1/0,maxBodyLength:1/0});let c=0;return l.data.on("data",(e=>{c+=e.length,this.taskQueue.setDownloadedSize(c)})),yield G(l.data,d),!0}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class ee{constructor(e){this.config=e,this.storagePath=e.storagePath,this.taskQueue=new S(5),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=0){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}getClient(){return F(this,void 0,void 0,(function*(){try{if(this.client)return this.client;let{url:e,username:t,password:i,dir:o,port:r}=this.config;const s=new p,n=s.connect({host:e||"",port:r||22,username:t||"",password:i||""}),a=new Promise(((e,t)=>{setTimeout((()=>t(new Error("SFTP connection timeout"))),5e3)}));return yield Promise.race([n,a]),this.client=s,s}catch(e){throw console.error("Error connecting to SFTP server:",e),this.client=null,e}}))}uploadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{let{dir:r}=this.config;r=r&&"KoodoReader"===this.baseFolder?r:this.baseFolder;let s=yield this.getClient();const n=()=>new Promise(((n,a)=>F(this,void 0,void 0,(function*(){let a=t.createReadStream(i.join(this.storagePath,e)),d="/"+r+"/"+o,l="/"+r+"/"+i.dirname(o);(yield s.exists(l))||(yield s.mkdir(l,!0)),s.put(a,d).then((()=>{n(!0)})).catch((e=>{console.error(e.message),n(!1)}))}))));try{return yield n()}catch(e){return console.error(e),!1}}catch(e){return console.error("Error in uploadFile:",e),!1}}))))))}))}downloadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{let{dir:r}=this.config;r=r&&"KoodoReader"===this.baseFolder?r:this.baseFolder;let s=yield this.getClient();const n=()=>new Promise(((n,a)=>F(this,void 0,void 0,(function*(){let a="/"+r+"/"+e,d=i.join(this.storagePath,o),l=t.createWriteStream(d);s.get(a,l).then((()=>{this.taskQueue.setDownloadedSize(l.bytesWritten||0),n(!0)})).catch((e=>{console.error(e.message),n(!1)}))}))));try{return yield n()}catch(e){return console.error(e),!1}}catch(e){return console.error("Error in downloadFile:",e),!1}}))))))}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(e){return F(this,void 0,void 0,(function*(){let{dir:t}=this.config;t=t&&"KoodoReader"===this.baseFolder?t:this.baseFolder;let i=yield this.getClient();const o=()=>new Promise(((o,r)=>F(this,void 0,void 0,(function*(){let r="/"+t+"/"+e;(yield i.exists(r))||(yield i.mkdir(r,!0),o([])),i.list(r).then((e=>{o(e.map((e=>({name:e.name,size:e.size||0,type:"d"===e.type?"folder":"file",modified:e.modifyTime}))))})).catch((e=>F(this,void 0,void 0,(function*(){console.error(e.message,"list file error"),o([])}))))}))));try{return yield o()}catch(e){return console.error(e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){let{dir:t}=this.config;t=t&&"KoodoReader"===this.baseFolder?t:this.baseFolder;let i=yield this.getClient();try{return yield new Promise(((o,r)=>{let s="/"+t+"/"+e;i.delete(s).then((()=>{o(!0)})).catch((e=>{console.error(e.message),o(!1)}))}))}catch(e){return console.error(e),!1}}))}}class te{downloadFile(e,t){return F(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}uploadFile(e,t){return F(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}listFiles(e){return F(this,void 0,void 0,(function*(){return new Promise((e=>{e([])}))}))}getAuthUrl(){return""}}class ie{constructor(e){this.config=e,this.taskQueue=new S(3),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=3){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}getFolderIdByPath(t){return F(this,void 0,void 0,(function*(){if(""==t)return"0";const i=this.config.access_token,o=t.split("/");let r="0";for(const t of o){const o=`https://api.box.com/2.0/folders/${r}/items?fields=id,name&type=folder&limit=1000`;try{const s=(yield e.get(o,{headers:{Authorization:`Bearer ${i}`}})).data.entries.find((e=>e.name===t&&"folder"===e.type));if(s)r=s.id;else{const o={name:t,parent:{id:r},type:"folder"};r=(yield e.post("https://api.box.com/2.0/folders",o,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.id}}catch(e){return console.error("Error occurred during folder creation:",e),""}}return r}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;let o=this.baseFolder+"/"+t;for(;o.startsWith("/");)o=o.substring(1);let r=yield this.getFolderIdByPath(o),s=[],n=0,a=!0;const d=1e3;for(;a;){const t=yield e.get(`https://api.box.com/2.0/folders/${r}/items`,{params:{limit:d,offset:n},headers:{Authorization:`Bearer ${i}`}}),o=t.data.entries||[];s=s.concat(o),n+=o.length,a=o.length===d&&t.data.total_count>n}return[...new Set(s.map((e=>({name:e.name,size:e.size||0,type:e.type,modified:e.content_modified_at}))))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token,o=t.substring(0,t.lastIndexOf("/")),r=t.substring(t.lastIndexOf("/")+1);let s=this.baseFolder+"/"+o;for(;s.startsWith("/");)s=s.substring(1);const n=yield this.getFolderIdByPath(s);if(!n)return!0;const a=`https://api.box.com/2.0/folders/${n}/items?fields=id,name&type=file&limit=1000`,d=(yield e.get(a,{headers:{Authorization:`Bearer ${i}`}})).data.entries.find((e=>e.name===r&&"file"===e.type));return!d||(yield e.delete(`https://api.box.com/2.0/files/${d.id}`,{headers:{Authorization:`Bearer ${i}`}}),!0)}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.access_token}))}getAuthUrl(e){return`https://account.box.com/api/oauth2/authorize?${new URLSearchParams({response_type:"code",client_id:$,redirect_uri:e,grant_type:"authorization_code",box_subject_type:"enterprise",scope:"root_readwrite"}).toString()}`}}class oe extends ie{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{const s=this.config.access_token,n=r.substring(0,r.lastIndexOf("/")),a=r.substring(r.lastIndexOf("/")+1);let d=this.baseFolder+"/"+n;for(;d.startsWith("/");)d=d.substring(1);const l=yield this.getFolderIdByPath(d);if(!l)throw new Error("Folder not found");const c=yield this.listFiles(n);c.find((e=>e===a))&&(yield this.deleteFileWithoutQueue(n+"/"+a));const u=new f,h=JSON.stringify({name:a,parent:{id:l}});u.append("attributes",h),u.append("file",t.createReadStream(i.join(this.storagePath,o)));const p=yield e.post("https://upload.box.com/api/2.0/files/content",u,{headers:Object.assign({Authorization:`Bearer ${s}`},u.getHeaders()),maxContentLength:1/0,maxBodyLength:1/0});return!(p.status>=300)||(console.error("Error occurred during file upload:",p),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{const s=this.config.access_token,n=o.substring(0,o.lastIndexOf("/")),a=o.substring(o.lastIndexOf("/")+1);let d=this.baseFolder+"/"+n;for(;d.startsWith("/");)d=d.substring(1);const l=yield this.getFolderIdByPath(d);if(!l)return console.error("Folder not found"),!0;const c=`https://api.box.com/2.0/folders/${l}/items?fields=id,name&type=file&limit=1000`,u=(yield e.get(c,{headers:{Authorization:`Bearer ${s}`}})).data.entries.find((e=>e.name===a&&"file"===e.type));if(!u)return console.error("File not found:",a),!0;const h=yield e({url:`https://api.box.com/2.0/files/${u.id}/content`,method:"get",responseType:"stream",headers:{Authorization:`Bearer ${s}`}});return yield new Promise(((e,o)=>{let s=0;const n=t.createWriteStream(i.join(this.storagePath,r));h.data.on("data",(e=>{s+=e.length,this.taskQueue.setDownloadedSize(s)})),h.data.pipe(n),n.on("finish",e),n.on("error",o)})),!0}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class re{constructor(e){this.folderCreationLocks=new Map,this.config=e,this.taskQueue=new S(3),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=2){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}getStorage(){return F(this,void 0,void 0,(function*(){if(this.storage)return this.storage;let{email:e,password:t}=this.config;return this.storage=yield new g({email:e,password:t,userAgent:"KoodoReader/1.0"}).ready,this.storage}))}getRoot(){return F(this,void 0,void 0,(function*(){if(this.root)return this.root;const e=(yield this.getStorage()).root;if(""===this.baseFolder)return this.root=e,this.root;let t=e.children.find((e=>e.name===this.baseFolder&&e.directory));return t||(t=yield e.mkdir(this.baseFolder)),this.root=t,this.root}))}createFolder(e,t){return F(this,void 0,void 0,(function*(){const i=`${e.nodeId}_${t}`;if(this.folderCreationLocks.has(i))return yield this.folderCreationLocks.get(i);const o=(()=>F(this,void 0,void 0,(function*(){try{let i=e.children.find((e=>e.name===t&&e.directory));return i||(i=yield e.mkdir(t),i)}finally{this.folderCreationLocks.delete(i)}})))();return this.folderCreationLocks.set(i,o),yield o}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(e){return F(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();if(e){const i=e.split("/").filter((e=>e));for(const e of i){const i=t.children.find((t=>t.name===e&&t.directory));if(!i)return[];t=i}}return t.children.map((e=>({name:e.name,size:e.size||0,type:e.directory?"folder":"file",modified:e.timestamp?new Date(1e3*e.timestamp).toISOString():""})))}catch(e){return console.error("Error listing MEGA files:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(e){return F(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();const i=e.split("/"),o=i.pop();for(const e of i){if(!e)continue;const i=t.children.find((t=>t.name===e&&t.directory));if(!i)return!0;t=i}const r=t.children.find((e=>e.name===o&&!e.directory));return!r||(yield r.delete(),!0)}catch(e){return console.error("Error deleting MEGA file:",e),!1}}))}}class se extends re{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{let r=yield this.getRoot();const s=o.split("/"),n=s.pop()||"";for(const e of s){if(!e)continue;let t=r.children.find((t=>t.name===e&&t.directory));t||(t=yield this.createFolder(r,e)),r=t}const a=r.children.find((e=>e.name===n&&!e.directory));a&&(yield a.delete());const d=t.createReadStream(i.join(this.storagePath,e)),l=t.statSync(i.join(this.storagePath,e)).size;return yield r.upload({name:n,size:l},d).complete,!0}catch(e){return console.error("Error occurred during MEGA file upload:",e),!1}}))))))}))}downloadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{let r=yield this.getRoot();const s=e.split("/"),n=s.pop()||"";for(const e of s){if(!e)continue;const t=r.children.find((t=>t.name===e&&t.directory));if(!t)return!0;r=t}const a=r.children.find((e=>e.name===n&&!e.directory));if(!a)return!0;const d=t.createWriteStream(i.join(this.storagePath,o));let l=0;return new Promise((e=>{const t=a.download();t.on("data",(e=>{l+=e.length,this.taskQueue.setDownloadedSize(l)})),t.pipe(d),d.on("finish",(()=>e(!0))),d.on("error",(t=>{console.error("Error writing file:",t),e(!1)}))}))}catch(e){return console.error("Error occurred during MEGA file download:",e),!1}}))))))}))}}class ne{constructor(e){this.config=e,this.driveId="",this.taskQueue=new S(1),void 0===this.config.baseFolder?this.baseFolder="/KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=3){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}getDriveId(){return F(this,void 0,void 0,(function*(){if(this.driveId)return this.driveId;const t=this.config.access_token,i=yield e.post("https://openapi.alipan.com/adrive/v1.0/user/getDriveInfo",{},{headers:{Authorization:`Bearer ${t}`}});return this.driveId=i.data.default_drive_id,this.driveId}))}getFolderIdByPath(t){return F(this,void 0,void 0,(function*(){const i=this.config.access_token,o=yield this.getDriveId();try{try{const r=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:o,file_path:t},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});if(r.data)return r.data.file_id}catch(r){const s=t.split("/").filter((e=>e));let n="",a="root";for(const t of s){n+="/"+t;try{a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:o,file_path:n},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.file_id}catch(r){a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:o,parent_file_id:a,name:t,type:"folder",check_name_mode:"refuse"},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.file_id}}return a}}catch(e){return console.error("Error getting/creating folder by path:",e),""}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token,o=yield this.getDriveId(),r=yield this.getFolderIdByPath(this.baseFolder+"/"+t);let s=[],n="",a=!0;for(;a;){const t=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/list",{drive_id:o,parent_file_id:r,marker:n||void 0},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),d=t.data.items.filter((e=>!e.punish_flag||2!==e.punish_flag))||[];s=s.concat(d),n=t.data.next_marker,a=!!n&&100===d.length}return[...new Set(s.map((e=>({name:e.name,size:e.size,type:e.type,modified:e.updated_at}))))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token,o=yield this.getDriveId(),r=yield this.getFolderIdByPath(this.baseFolder+"/"+t);return!r||(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/delete",{drive_id:o,file_id:r},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),!0)}catch(e){return console.error("Error deleting file:",e),!1}}))}checkExists(t){var i;return F(this,void 0,void 0,(function*(){try{const o=this.config.access_token,r=yield this.getDriveId(),s=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:r,file_path:t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});(null===(i=s.data)||void 0===i?void 0:i.file_id)&&(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/recyclebin/trash",{drive_id:r,file_id:s.data.file_id},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}}))}catch(e){}}))}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.access_token}))}getAuthUrl(e){return`https://openapi.alipan.com/oauth/authorize?${new URLSearchParams({response_type:"code",client_id:Q,redirect_uri:e,grant_type:"authorization_code",scope:"user:base,file:all:write,file:all:read"}).toString()}`}}class ae extends ne{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{const s=this.config.access_token,n=yield this.getDriveId(),a=r.substring(0,r.lastIndexOf("/")),d=r.substring(r.lastIndexOf("/")+1);yield this.deleteFileWithoutQueue(r);const l=yield this.getFolderIdByPath(this.baseFolder+"/"+a),c=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:n,parent_file_id:l,name:d,type:"file",check_name_mode:"ignore"},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}),{file_id:u,upload_id:h,part_info_list:p}=c.data,f=yield t.promises.readFile(i.join(this.storagePath,o));return yield fetch(p[0].upload_url,{method:"PUT",body:f,headers:{"Content-Length":t.statSync(i.join(this.storagePath,o)).size.toString()}}),yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/complete",{drive_id:n,file_id:u,upload_id:h},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}),!0}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{const s=this.config.access_token,n=yield this.getDriveId(),a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:n,file_path:this.baseFolder+"/"+o},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}})).data.file_id,d=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/getDownloadUrl",{drive_id:n,file_id:a},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}),l=yield e({url:d.data.url,method:"get",responseType:"stream"});let c=0;const u=t.createWriteStream(i.join(this.storagePath,r+".temp"));return l.data.on("data",(e=>{c+=e.length,this.taskQueue.setDownloadedSize(c)})),l.data.pipe(u),new Promise((e=>{u.on("finish",(()=>{t.renameSync(i.join(this.storagePath,r+".temp"),i.join(this.storagePath,r)),e(!0)})),u.on("error",(t=>{console.error("Error occurred during file download:",t),e(!1)}))}))}catch(e){return console.error("Error downloading file:",e),!1}}))))))}))}}class de{constructor(e){this.baseUrl="https://api.pcloud.com",this.config=e,this.taskQueue=new S(3),this.baseUrl="2"===e.region?"https://eapi.pcloud.com":"https://api.pcloud.com"}retryOperation(e,t=3){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}checkFolderExists(t,i){return F(this,void 0,void 0,(function*(){try{return 0===(yield e.get(`${this.baseUrl}/listfolder`,{params:{access_token:i,path:`/${t}`}})).data.result}catch(e){return console.error("Error checking folder:",e),!1}}))}createFolder(t,i){return F(this,void 0,void 0,(function*(){try{return 0===(yield e.get(`${this.baseUrl}/createfolderifnotexists`,{params:{access_token:i,path:`/${t}`}})).data.result}catch(e){return console.error("Error creating folder:",e),!1}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token,o=yield e.get(`${this.baseUrl}/listfolder`,{params:{access_token:i,path:"/"+t,recursive:0}});return 0!==o.data.result?[]:o.data.metadata.contents.map((e=>({name:e.name,size:e.size||0,type:e.isfolder?"folder":"file",modified:e.modified})))}catch(e){return console.error("Error occurred during file list:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token,o=yield e.get(`${this.baseUrl}/deletefile`,{params:{access_token:i,path:"/"+t}});return 0===o.data.result||(console.error("Error deleting file:",o.data),!0)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.refresh_token}))}getAuthUrl(e){return`https://my.pcloud.com/oauth2/authorize?client_id=${A}&response_type=code&redirect_uri=${e}`}}class le extends de{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{const s=this.config.access_token,n=r.split("/").slice(0,-1).join("/");if(!(yield this.checkFolderExists(n,s))){if(!(yield this.createFolder(n,s)))return!1}const a=i.join(this.storagePath,o),d=t.createReadStream(a),l=t.statSync(a),c=i.basename(o),u=yield e({method:"put",url:`${this.baseUrl}/uploadfile`,params:{access_token:s,path:`/${n}`,renew:1,filename:c},data:d,headers:{"Content-Length":l.size,"Content-Type":"application/octet-stream"},maxContentLength:1/0,maxBodyLength:1/0});return 0===u.data.result||(console.error("Error uploading file:",u.data),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{const s=this.config.access_token,n=yield e.get(`${this.baseUrl}/getfilelink`,{params:{access_token:s,path:`/${o}`}});if(0!==n.data.result)return console.error("Error getting file link:",n.data),!1;const a=i.join(this.storagePath,r),d=t.createWriteStream(a),l=`https://${n.data.hosts[0]}${n.data.path}`,c=yield e({method:"get",url:l,responseType:"stream",maxContentLength:1/0,maxBodyLength:1/0});return new Promise((e=>{let t=0;c.data.on("data",(e=>{t+=e.length,this.taskQueue.setDownloadedSize(t)})),c.data.pipe(d),d.on("finish",(()=>{e(!0)})),d.on("error",(t=>{console.error("Error writing file:",t),e(!1)}))}))}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class ce{constructor(e){this.config=e,this.taskQueue=new S(3),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=1){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;let o=this.baseFolder;t&&""!==t.trim()&&(o=o+"/"+t),o=o.replace(/\/+/g,"/"),o.startsWith("/")&&(o=o.substring(1));let r=[],s=0;const n=1e3;for(;;){const t=yield e.get("https://pan.baidu.com/rest/2.0/xpan/file",{params:{method:"list",access_token:i,dir:"/"+o,start:s,limit:n,order:"name",desc:0,web:1,folder:0},headers:{"User-Agent":"pan.baidu.com"}});if(t.status>=300||0!==t.data.errno){console.error("百度网盘API错误:",t.data);break}const a=t.data.list||[];if(0===a.length)break;if(r=r.concat(a),a.length<n)break;s+=n}return r.map((e=>({name:e.server_filename,size:e.size||0,type:e.isdir?"folder":"file",modified:new Date(1e3*e.server_mtime).toISOString(),path:e.path})))}catch(e){return console.error("获取百度网盘文件列表时发生错误:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;let o=this.baseFolder+"/"+t;o=o.replace(/\/+/g,"/"),o.startsWith("/")&&(o=o.substring(1));const r=new URLSearchParams({async:"0",filelist:JSON.stringify(["/"+o])}),s=yield e.post(`https://pan.baidu.com/rest/2.0/xpan/file?method=filemanager&access_token=${i}&opera=delete`,r.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":"pan.baidu.com"}});if(0!==s.data.errno)return console.error("百度网盘删除文件API错误:",s.data),-9===s.data.errno?console.error("文件不存在"):111===s.data.errno?console.error("有其他异步任务正在执行"):-7===s.data.errno&&console.error("文件名非法"),!1;const n=s.data.info||[];for(const e of n)if(0!==e.errno)return console.error(`文件删除失败: ${e.path}, 错误码: ${e.errno}`),!1;return!0}catch(e){return console.error("删除文件时发生错误:",e),!1}}))}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.access_token}))}getAuthUrl(e){return`https://openapi.baidu.com/oauth/2.0/authorize?response_type=code&client_id=${I}&redirect_uri=${e}&scope=basic,netdisk&device_id=119827642&display=page&qrcode=1`}}const ue=4194304;class he extends ce{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){var s;let n=null;try{const s=this.config.access_token;let a=this.baseFolder+"/"+r;a=a.replace(/\/+/g,"/"),a.startsWith("/")&&(a=a.substring(1));const d=i.join(this.storagePath,o),l=yield this.getFileSize(d),{contentMd5:c,sliceMd5:u,blockList:h}=yield this.calculateFileMd5(d,l),p=new URLSearchParams({path:"/"+a,size:l.toString(),isdir:"0",autoinit:"1",rtype:"3",block_list:JSON.stringify(h),"content-md5":c,"slice-md5":u,local_ctime:Math.floor(Date.now()/1e3).toString(),local_mtime:Math.floor(Date.now()/1e3).toString()}),g=yield e.post(`https://pan.baidu.com/rest/2.0/xpan/file?method=precreate&access_token=${s}`,p.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":"pan.baidu.com"}});if(0!==g.data.errno)return console.error("预上传失败:",g.data),-7===g.data.errno?console.error("文件或目录名错误或无权访问"):-10===g.data.errno&&console.error("容量不足"),!1;const y=g.data.uploadid,m=g.data.block_list||[];if(0===m.length)return!0;const v=yield this.getUploadDomain(s,"/"+a,y);if(!v)return console.error("获取上传域名失败"),!1;n=yield t.promises.open(d,"r");for(const t of m){const i=t*ue,o=Math.min(ue,l-i),r=Buffer.alloc(o),{bytesRead:d}=yield n.read(r,0,o,i);if(0===d)break;const c=r.slice(0,d),u=h[t],p=new f;p.append("file",c,{filename:`chunk_${t}`,contentType:"application/octet-stream",knownLength:c.length});const g=`${v}/rest/2.0/pcs/superfile2?method=upload&access_token=${s}&type=tmpfile&path=${encodeURIComponent("/"+a)}&uploadid=${y}&partseq=${t}`,m=yield e.post(g,p,{headers:Object.assign(Object.assign({"User-Agent":"pan.baidu.com"},p.getHeaders()),{"Content-Length":p.getLengthSync().toString()}),maxContentLength:1/0,maxBodyLength:1/0,timeout:0});if(m.status>=300)throw 31024===m.data.errno?console.error("没有申请上传权限"):31299===m.data.errno?console.error("第一个分片的大小小于4MB"):31364===m.data.errno?console.error("超出分片大小限制"):31363===m.data.errno&&console.error("分片缺失"),new Error(`分片上传失败: ${JSON.stringify(m.data)}`);const k=m.data.md5;k&&k!==u&&console.warn(`分片 ${t} MD5不匹配: 期望 ${u}, 实际 ${k}`)}const k=new URLSearchParams({path:"/"+a,size:l.toString(),isdir:"0",block_list:JSON.stringify(h),uploadid:y,rtype:"3",local_ctime:Math.floor(Date.now()/1e3).toString(),local_mtime:Math.floor(Date.now()/1e3).toString()}),b=yield e.post(`https://pan.baidu.com/rest/2.0/xpan/file?method=create&access_token=${s}`,k.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":"pan.baidu.com"}});return 0===b.data.errno||(console.error("创建文件失败:",b.data),-7===b.data.errno?console.error("文件或目录名错误或无权访问"):-8===b.data.errno?console.error("文件或目录已存在"):-10===b.data.errno?console.error("云端容量已满"):10===b.data.errno?console.error("创建文件失败，一般是分片问题"):31190===b.data.errno?console.error("文件不存在，一般是分片上传阶段有问题"):31355===b.data.errno?console.error("参数异常，一般是uploadid参数传的有问题"):31365===b.data.errno&&console.error("文件总大小超限"),!1)}catch(e){return console.error("文件上传过程中发生错误:",(null===(s=e.response)||void 0===s?void 0:s.data)||e.message||e),!1}finally{n&&(yield n.close())}}))))))}))}getUploadDomain(t,i,o){return F(this,void 0,void 0,(function*(){try{const r=yield e.get("https://d.pcs.baidu.com/rest/2.0/pcs/file",{params:{method:"locateupload",appid:"250528",access_token:t,path:i,uploadid:o,upload_version:"2.0"},headers:{"User-Agent":"pan.baidu.com"}});if(0!==r.data.error_code)return console.error("获取上传域名失败:",r.data),null;const s=r.data.servers||[],n=s.find((e=>e.server.startsWith("https://")));return n?n.server:s.length>0?s[0].server:(console.error("没有可用的上传服务器"),null)}catch(e){return console.error("获取上传域名时出错:",e),null}}))}calculateFileMd5(e,i){return F(this,void 0,void 0,(function*(){const o=yield t.promises.open(e,"r");try{const e=y.createHash("md5"),t=[];let r="",s=0;for(;s<i;){const n=Math.min(ue,i-s),a=Buffer.alloc(n),{bytesRead:d}=yield o.read(a,0,n,s);if(0===d)break;const l=a.slice(0,d),c=y.createHash("md5").update(l).digest("hex");if(t.push(c),e.update(l),0===s){const e=Math.min(262144,d),t=l.slice(0,e);r=y.createHash("md5").update(t).digest("hex")}s+=d}return{contentMd5:e.digest("hex"),sliceMd5:r,blockList:t}}catch(e){throw e}finally{yield o.close()}}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){var s,n;this.taskQueue.setDownloadedSize(0);try{const a=this.config.access_token;let d,l=this.baseFolder+"/"+o;l=l.replace(/\/+/g,"/"),l.startsWith("/")&&(l=l.substring(1));const c=yield e.get("https://pan.baidu.com/rest/2.0/xpan/file",{params:{method:"list",access_token:a,dir:"/"+l.substring(0,l.lastIndexOf("/")),web:1},headers:{"User-Agent":"pan.baidu.com"}});if(0!==c.data.errno)return console.error("获取文件列表失败:",c.data),!1;const u=l.split("/").pop(),h=null===(s=c.data.list)||void 0===s?void 0:s.find((e=>e.server_filename===u));if(!h)return console.error("文件不存在:",o),!1;const p=yield e.get("https://pan.baidu.com/rest/2.0/xpan/multimedia",{params:{method:"filemetas",access_token:a,fsids:JSON.stringify([h.fs_id]),dlink:1},headers:{"User-Agent":"pan.baidu.com"}});if(0!==p.data.errno||!(null===(n=p.data.list)||void 0===n?void 0:n[0]))return console.error("获取下载链接失败:",p.data),!1;d=p.data.list[0];const f=d.dlink,g=yield e.get(f,{responseType:"stream",params:{access_token:a},headers:{"User-Agent":"pan.baidu.com"}});let y=0;const m=t.createWriteStream(i.join(this.storagePath,r));g.data.on("data",(e=>{y+=e.length,this.taskQueue.setDownloadedSize(y)})),yield new Promise(((e,t)=>{g.data.pipe(m),m.on("finish",(()=>{e()})),m.on("error",t)}));return(yield this.getFileSize(i.join(this.storagePath,r)))===d.size||(console.error("Downloaded file size does not match expected size."),yield t.promises.unlink(i.join(this.storagePath,r)),!1)}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}getFileSize(e){return F(this,void 0,void 0,(function*(){try{return(yield t.promises.stat(e)).size}catch(e){throw e}}))}}class pe{constructor(e){this.username=e.username,this.password=e.password,this.url=e.url,this.taskQueue=new S(3)}retryOperation(e,t=1){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{return(yield e.get(`${this.url}/list`,{params:{dir:t},auth:{username:this.username,password:this.password}})).data.files.map((e=>({name:e.name,size:e.size||0,type:"file"===e.type?"file":"folder",modified:e.modifiedTime})))||[]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{return(yield e.delete(`${this.url}/delete`,{params:{dir:t.split("/").slice(0,-1).join("/")||"",filename:t.split("/").pop()},auth:{username:this.username,password:this.password}})).data.success}catch(e){return console.error("Error deleting file:",e),!1}}))}}const fe=o(r.pipeline);class ge extends pe{constructor(e){super(e),this.storagePath=e.storagePath}getAuthHeader(){return`Basic ${btoa(`${this.username}:${this.password}`)}`}uploadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{r.split("/").pop();const s=r.substring(0,r.lastIndexOf("/"))||"";let n=this.listFiles("");const a=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Docker connection timeout"))),5e3)}));yield Promise.race([n,a]);const d=t.createReadStream(i.join(this.storagePath,o)),l=new f;l.append("file",d);const c=yield e.post(`${this.url}/upload?dir=${encodeURIComponent(s)}`,l,{headers:Object.assign(Object.assign({},l.getHeaders()),{Authorization:this.getAuthHeader()}),maxContentLength:1/0,maxBodyLength:1/0});return!(c.status>=300)||(console.error("Error occurred during file upload:",c),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{const s=o.split("/").pop()||"",n=o.substring(0,o.lastIndexOf("/"))||"",a=t.createWriteStream(i.join(this.storagePath,r)),d=yield e({url:`${this.url}/download`,method:"GET",params:{dir:n,filename:s},headers:{Authorization:this.getAuthHeader()},maxContentLength:1/0,maxBodyLength:1/0,responseType:"stream"});if(d.status>=300)return console.error("Error occurred during file download:",d),a.destroy(),t.existsSync(i.join(this.storagePath,r))&&t.unlinkSync(i.join(this.storagePath,r)),!1;let l=0;return d.data.on("data",(e=>{l+=e.length,this.taskQueue.setDownloadedSize(l)})),yield fe(d.data,a),!0}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class ye{constructor(e){this.baseUrl="https://proapi.115.com",this.config=e,this.taskQueue=new S(1),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=3){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}getUploadCredentials(t){return F(this,void 0,void 0,(function*(){try{const i=yield e.get(`${this.baseUrl}/open/upload/get_token`,{headers:{Authorization:`Bearer ${t}`}});return i.status>=300||!i.data.state?(console.error("Error getting upload credentials:",i.data),null):i.data.data}catch(e){return console.error("Error occurred during get upload credentials:",e),null}}))}generateOSSPolicy(e,t,i=new Date(Date.now()+36e5)){const o={expiration:i.toISOString(),conditions:[{bucket:e},{key:t},["starts-with","$success_action_status","2"],["content-length-range",0,1073741824]]};return JSON.stringify(o)}refreshToken(){return F(this,void 0,void 0,(function*(){return this.config.access_token}))}getAuthUrl(e){return`https://passportapi.115.com/open/authorize?client_id=${P}&response_type=code&redirect_uri=${e}`}}class me extends ye{constructor(e){super(e),this.storagePath=e.storagePath}uploadFile(e,t){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){var o;try{const o=this.config.access_token;let r=this.baseFolder+"/"+t;r.startsWith("/")||(r="/"+r);let s=i.dirname(r),n=yield this.getFolderInfo(s,!0),a="0";if(n)a=n.file_id;else{let e=yield this.createFolder(s);if(!e)return console.error("Failed to create folder:",s),!1;a=e}const d=i.join(this.storagePath,e),l=yield this.getFileSize(d),c=yield this.calculateFileSha1(d),u=yield this.calculatePreSha1(d),h=i.basename(t);yield this.deleteFileWithoutQueue(t);let p=yield this.initializeUpload(a,h,l,c,u,o);if(!p)return console.error("Failed to initialize upload"),!1;if((6===p.status||7===p.status||8===p.status)&&(p=yield this.handleSecondAuth(a,p,d,h,l,c,u,o),!p))return console.error("Second authentication failed"),!1;if(2===p.status)return console.info(`File ${e} uploaded successfully via instant upload.`),!0;const f=yield this.getUploadCredentials(o);if(!f)return console.error("Failed to get upload credentials"),!1;return(yield this.uploadToObjectStorage(d,p,f))?(console.info(`File ${e} uploaded successfully.`),!0):(console.error("Failed to upload to object storage"),!1)}catch(e){return console.error("Error occurred during file upload:",(null===(o=e.response)||void 0===o?void 0:o.data)||e.message||e),!1}}))))))}))}calculateFileSha1(e){return F(this,void 0,void 0,(function*(){return new Promise(((i,o)=>{const r=y.createHash("sha1"),s=t.createReadStream(e);s.on("data",(e=>{r.update(e)})),s.on("end",(()=>{i(r.digest("hex"))})),s.on("error",(e=>{o(e)}))}))}))}calculatePreSha1(e){return F(this,void 0,void 0,(function*(){return new Promise(((i,o)=>{const r=y.createHash("sha1"),s=t.createReadStream(e,{start:0,end:131071});s.on("data",(e=>{r.update(e)})),s.on("end",(()=>{i(r.digest("hex"))})),s.on("error",(e=>{o(e)}))}))}))}handleSecondAuth(e,i,o,r,s,n,a,d){return F(this,void 0,void 0,(function*(){try{if(!i.sign_check)return console.error("No sign_check provided for second authentication"),null;const[l,c]=i.sign_check.split("-"),u=parseInt(l),h=parseInt(c),p=Buffer.alloc(h-u+1),f=yield t.promises.open(o,"r");try{yield f.read(p,0,p.length,u);const t=y.createHash("sha1");t.update(p);const o=t.digest("hex").toUpperCase();return yield this.initializeUpload(e,r,s,n,a,d,i.sign_key,o,i.pick_code)}finally{yield f.close()}}catch(e){return console.error("Error during second authentication:",e),null}}))}calculateOSSSignature(e,t){const i=Buffer.from(t).toString("base64");return y.createHmac("sha1",e).update(i).digest("base64")}uploadToObjectStorage(o,r,s){var n;return F(this,void 0,void 0,(function*(){try{const n=s.endpoint,a=r.bucket,d=r.object;let l;if(n.includes(a))l=n;else{l=`https://${a}.${n.replace(/^https?:\/\//,"")}`}const c=this.generateOSSPolicy(a,d),u=this.calculateOSSSignature(s.AccessKeySecret,c),h=Buffer.from(c).toString("base64"),p=new f;if(p.append("key",d),p.append("policy",h),p.append("OSSAccessKeyId",s.AccessKeyId),p.append("signature",u),p.append("x-oss-security-token",s.SecurityToken),p.append("success_action_status","200"),r.callback&&r.callback.callback){const e=Buffer.from(r.callback.callback).toString("base64");if(p.append("callback",e),r.callback.callback_var){const e=JSON.parse(r.callback.callback_var);for(const[t,i]of Object.entries(e))p.append(t,String(i))}}const g=t.createReadStream(o);p.append("file",g,i.basename(o));const y=yield e.post(l,p,{headers:Object.assign({},p.getHeaders()),maxContentLength:1/0,maxBodyLength:1/0});return 200===y.status||204===y.status||(console.error("Upload failed with status:",y.status),!1)}catch(e){return console.error("Error uploading file via REST API:",(null===(n=e.response)||void 0===n?void 0:n.data)||e.message||e),!1}}))}downloadFile(o,r){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{let s=this.baseFolder+"/"+o;s=s.replace(/\/+/g,"/"),s.startsWith("/")||(s="/"+s);const n=yield this.getFolderInfo(s,!1);if(!n||!n.pick_code)return console.error("Failed to get file info or pick_code for:",o),!1;const a=yield this.getFileDownloadUrl(n.pick_code);if(!a)return console.error("Failed to get download URL for:",o),!1;const d=yield e.get(a.url,{responseType:"stream"});let l=0;const c=t.createWriteStream(i.join(this.storagePath,r));return d.data.on("data",(e=>{l+=e.length,this.taskQueue.setDownloadedSize(l)})),yield new Promise(((e,t)=>{d.data.pipe(c),c.on("finish",(()=>{e()})),c.on("error",t)})),!0}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;(t=this.baseFolder+"/"+t).startsWith("/")||(t="/"+t);let o=[],r=0;const s=1150;let n=!0,a=yield this.getFolderInfo(t,!0),d="";if(a)d=a.file_id;else{let e=yield this.createFolder(t);if(!e)return console.error("Failed to create folder:",t),[];d=e}if(!d)return console.error("Failed to get or create folder ID:",t),[];let l=d;for(;n;){const t={offset:r,limit:s,cur:1,show_dir:1};l&&(t.cid=l);const a=yield e.get(`${this.baseUrl}/open/ufile/files`,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},params:t});if(a.status>=300)break;const d=a.data.data||[];o=o.concat(d),d.length<s?n=!1:r+=s}return o.map((e=>({name:e.fn,size:e.fs||0,type:"0"===e.fc?"folder":"file",modified:new Date(1e3*e.upt).toISOString()})))}catch(e){return console.error("Error occurred during file list:",e),[]}}))}getFileDownloadUrl(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token,o=new f;o.append("pick_code",t);const r=yield e.post(`${this.baseUrl}/open/ufile/downurl`,o,{headers:Object.assign({Authorization:`Bearer ${i}`},o.getHeaders())});if(r.status>=300)return console.error("Error getting download URL:",r.data),null;const s=r.data.data,n=Object.keys(s)[0];return n&&s[n]?s[n].url:(console.error("No file data found in download URL response"),null)}catch(e){return console.error("Error occurred during get download URL:",e),null}}))}initializeUpload(t,i,o,r,s,n,a,d,l){return F(this,void 0,void 0,(function*(){try{const c=new f;c.append("file_name",i),c.append("file_size",o.toString()),t?c.append("target","U_1_"+t):c.append("target","U_1_0"),c.append("fileid",r),c.append("preid",s),c.append("topupload","0"),l&&c.append("pick_code",l),a&&c.append("sign_key",a),d&&c.append("sign_val",d);const u=yield e.post(`${this.baseUrl}/open/upload/init`,c,{headers:Object.assign({Authorization:`Bearer ${n}`},c.getHeaders())});return u.status>=300||!u.data.state?(console.error("Error initializing upload:",u.data),null):u.data.data}catch(e){return console.error("Error occurred during upload initialization:",e),null}}))}createFolder(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token,o=t.replace(/^\/+|\/+$/g,"");if(!o)return"";const r=o.split("/");let s="",n="0";for(const t of r){s=s?`${s}/${t}`:t;const o=yield this.getFolderInfo(s,!0);if(o&&o.file_id)n=o.file_id;else{const o=new f;o.append("pid",n),o.append("file_name",t);const r=yield e.post(`${this.baseUrl}/open/folder/add`,o,{headers:Object.assign({Authorization:`Bearer ${i}`},o.getHeaders())});if(r.status>=300||!r.data.state)return console.error("Error creating folder:",r.data),"";n=r.data.data.file_id}}return n}catch(e){return console.error("Error occurred during folder creation:",e),""}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return F(this,void 0,void 0,(function*(){try{const i=this.config.access_token;t=this.baseFolder+"/"+t;let o=yield this.getFolderInfo(t,!1);if(!o)return!0;let r=new f;r.append("file_ids",o.file_id);const s=yield e.post(`${this.baseUrl}/open/ufile/delete`,r,{headers:Object.assign({Authorization:`Bearer ${i}`},r.getHeaders())});return!(s.status>=300||!s.data.state)||(console.error("Error deleting file:",s),!1)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}getFolderInfo(t,i){return F(this,void 0,void 0,(function*(){if(""===t||"/"===t)return{file_id:"0"};t.startsWith("/")||(t="/"+t);try{const i=this.config.access_token;let o=new f;o.append("path",t);const r=yield e.post(`${this.baseUrl}/open/folder/get_info`,o,{headers:Object.assign(Object.assign({},o.getHeaders()),{Authorization:`Bearer ${i}`})});return r.status>=300||!r.data.state||0===r.data.data.length?(console.error("Error getting file info:",r.data),null):r.data.data}catch(e){return console.error("Error occurred during get file info:",e),null}}))}getFileSize(e){return F(this,void 0,void 0,(function*(){try{return(yield t.promises.stat(e)).size}catch(e){throw e}}))}}const ve=()=>{let e="";if("darwin"===process.platform){const o=i.join(m.homedir(),"Library","Mobile Documents","iCloud~com~koodoreader~expo","Documents");t.existsSync(o)&&(e=o)}else if("win32"===process.platform){const o=[i.join(m.homedir(),"iCloudDrive","iCloud~com~koodoreader~expo")];for(const i of o)if(t.existsSync(i)){e=i;break}}return e&&t.existsSync(e)&&e&&t.existsSync(e)?e:""};class ke{constructor(e){this.config=e,this.storagePath=e.storagePath,this.taskQueue=new S(5)}retryOperation(e,t=0){return F(this,void 0,void 0,(function*(){let i=0;for(;;){const o=yield e();if(o)return o;if(i>=t)return this.taskQueue.hasFailedTasks=!0,this.taskQueue.clearQueue(),o;i++;const r=1e3*Math.pow(2,i);console.info(`Retry attempt ${i} after ${r}ms`),yield new Promise((e=>setTimeout(e,r)))}}))}uploadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){try{const r=()=>new Promise(((r,s)=>F(this,void 0,void 0,(function*(){let s=ve();if(!s)return console.error("iCloud Drive path not found"),void r(!1);let n=s+"/"+o,a=s+"/"+i.dirname(o);t.existsSync(a)||t.mkdirSync(a,{recursive:!0}),t.copyFile(i.join(this.storagePath,e),n,(e=>{e?(console.error("Error uploading file:",e),r(!1)):r(!0)}))}))));try{return yield r()}catch(e){return console.error(e),!1}}catch(e){return console.error("Error in uploadFile:",e),!1}}))))))}))}downloadFile(e,o){return F(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>F(this,void 0,void 0,(function*(){this.taskQueue.setDownloadedSize(0);try{const r=()=>new Promise(((r,s)=>F(this,void 0,void 0,(function*(){let s=ve();if(!s)return console.error("iCloud Drive path not found"),void r(!1);let n=s+"/"+e,a=i.join(this.storagePath,o);console.log(n,"remotepath"),t.copyFile(n,a,(e=>{if(e)console.error("Error downloading file:",e),r(!1);else{let e=t.statSync(a);console.log(e,"status"),this.taskQueue.setDownloadedSize(e.size),r(!0)}}))}))));try{return yield r()}catch(e){return console.error(e),!1}}catch(e){return console.error("Error in downloadFile:",e),!1}}))))))}))}listFiles(e){return F(this,void 0,void 0,(function*(){return(yield this.listFileInfos(e)).map((e=>e.name))}))}listFileInfos(e){return F(this,void 0,void 0,(function*(){const o=()=>new Promise(((o,r)=>F(this,void 0,void 0,(function*(){let r=ve();if(!r)return console.error("iCloud Drive path not found"),void o(!1);let s=r+"/"+e;t.existsSync(s)||t.mkdirSync(s,{recursive:!0}),t.readdir(s,{withFileTypes:!0},((e,r)=>{if(e)return console.error("Error reading directory:",e),void o([]);let n=r.map((e=>{let o=i.join(s,e.name),r=t.statSync(o);return{name:e.name,size:r.size,type:e.isDirectory()?"folder":"file",modified:r.mtime.toISOString()}}));o(n)}))}))));try{return yield o()}catch(e){return console.error(e),[]}}))}deleteFile(e){return F(this,void 0,void 0,(function*(){try{return yield new Promise(((i,o)=>{let r=ve();if(!r)return console.error("iCloud Drive path not found"),void i(!1);let s=r+"/"+e;t.unlink(s,(e=>{e?(console.error("Error deleting file:",e),i(!1)):i(!0)}))}))}catch(e){return console.error(e),!1}}))}}const be=["book","config","cover","font"];class Fe{constructor(e,t){this.type=e,this.storagePath=t.storagePath,this.remote="dropbox"===e?new U(t):"microsoft"===e?new N(t):"google"===e?new H(t):"microsoft_exp"===e?new N(Object.assign(Object.assign({},t),{isExp:!0})):"google_exp"===e?new H(Object.assign(Object.assign({},t),{isExp:!0})):"s3compatible"===e?new J(t):"webdav"===e?new Y(t):"docker"===e?new ge(t):"ftp"===e?new M(t):"sftp"===e?new ee(t):"boxnet"===e?new oe(t):"mega"===e?new se(t):"adrive"===e?new ae(t):"pcloud"===e?new le(t):"dubox"===e?new he(t):"yandex"===e?new Z(t):"yiyiwu"===e?new me(t):"icloud"===e?new ke(t):new te}downloadFile(e,o,r){return F(this,void 0,void 0,(function*(){if(t.existsSync(i.join(this.storagePath+"/"+r))||t.mkdirSync(i.join(this.storagePath+"/"+r)),"cover"!==r){if(!(yield this.listFiles(r)).find((t=>e.indexOf(t)>-1)))return!1}return yield this.remote.downloadFile(r+"/"+e,r+"/"+o)}))}uploadFile(e,t,i){return F(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(i+"/"+e,i+"/"+t)}))}deleteFile(e,t){return F(this,void 0,void 0,(function*(){return!!(yield this.listFiles(t)).find((t=>e.indexOf(t)>-1))&&(yield this.remote.deleteFile(t+"/"+e))}))}isExist(e,t){return F(this,void 0,void 0,(function*(){return(yield this.listFiles(t)).find((t=>-1!==t.indexOf(e)))}))}listFiles(e){return F(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}listFileInfos(e){return F(this,void 0,void 0,(function*(){return yield this.remote.listFileInfos(e)}))}downloadAllFiles(){return F(this,void 0,void 0,(function*(){for(let e of be){let t=yield this.listFiles(e);for(let i of t)yield this.downloadFile(i,i,e)}}))}getAuthUrl(e){return this.remote.getAuthUrl(e)}getStats(){return this.remote.taskQueue.getStats()}resetCounters(){this.remote.taskQueue.resetCounters()}getDownloadedSize(){return this.remote.taskQueue.getDownloadedSize()}}const Ee={notes:"SELECT * FROM notes WHERE key = ?",bookmarks:"SELECT * FROM bookmarks WHERE key = ?",books:"SELECT * FROM books WHERE key = ?",plugins:"SELECT * FROM plugins WHERE key = ?",words:"SELECT * FROM words WHERE key = ?"},we={notes:"SELECT * FROM notes WHERE bookKey = ?",bookmarks:"SELECT * FROM bookmarks WHERE bookKey = ?",words:"SELECT * FROM words WHERE bookKey = ?",books:"SELECT * FROM books WHERE key = ?"},Se={notes:"DELETE FROM notes WHERE bookKey = ?",bookmarks:"DELETE FROM bookmarks WHERE bookKey = ?",words:"DELETE FROM words WHERE bookKey = ?"};function Te(e){for(const t in e)e.hasOwnProperty(t)&&(e[`temp-${t}`]=e[t]);return e}const Oe={notes:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t.tag=JSON.parse(e.tag),t},bookmarks:e=>e,books:e=>e,plugins:e=>{let t=Object.assign({},e);return e.autoValue||delete t.autoValue,e.langList?t.langList=JSON.parse(e.langList):delete t.langList,e.voiceList?t.voiceList=JSON.parse(e.voiceList):delete t.voiceList,t.config=JSON.parse(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t}};var Re={sqlStatement:{createTableStatement:Te({notes:'\n      CREATE TABLE IF NOT EXISTS "notes" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "chapter" text,\n        "chapterIndex" integer,\n        "text" text,\n        "cfi" text,\n        "range" text,\n        "notes" text,\n        "percentage" text,\n        "color" integer,\n        "tag" array\n      )\n    ',bookmarks:'\n      CREATE TABLE IF NOT EXISTS "bookmarks" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "cfi" text,\n        "label" text,\n        "percentage" text,\n        "chapter" text\n      );\n    ',books:'\n      CREATE TABLE IF NOT EXISTS "books" (\n        "key" text PRIMARY KEY,\n        "name" text,\n        "author" text,\n        "description" text,\n        "md5" text,\n        "cover" text,\n        "format" text,\n        "publisher" text,\n        "size" integer,\n        "page" integer,\n        "path" text,\n        "charset" text\n      );\n    ',plugins:'\n      CREATE TABLE IF NOT EXISTS "plugins" (\n        "key" text PRIMARY KEY,\n        "type" text,\n        "displayName" text,\n        "icon" text,\n        "version" text,\n        "config" object,\n        "autoValue" string,\n        "langList" text,\n        "voiceList" text,\n        "scriptSHA256" text,\n        "script" text\n      );\n    ',words:'\n      CREATE TABLE IF NOT EXISTS "words" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "word" text,\n        "chapter" text\n      );\n    '}),getAllStatement:Te({notes:"SELECT * FROM notes",bookmarks:"SELECT * FROM bookmarks",books:"SELECT * FROM books",plugins:"SELECT * FROM plugins",words:"SELECT * FROM words"}),getPagedStatement:Te({notes:"SELECT * FROM notes LIMIT ? OFFSET ?",bookmarks:"SELECT * FROM bookmarks LIMIT ? OFFSET ?",books:"SELECT * FROM books LIMIT ? OFFSET ?",plugins:"SELECT * FROM plugins LIMIT ? OFFSET ?",words:"SELECT * FROM words LIMIT ? OFFSET ?"}),getCountStatement:Te({notes:"SELECT COUNT(*) as count FROM notes",bookmarks:"SELECT COUNT(*) as count FROM bookmarks",books:"SELECT COUNT(*) as count FROM books",plugins:"SELECT COUNT(*) as count FROM plugins",words:"SELECT COUNT(*) as count FROM words"}),saveStatement:Te({notes:"INSERT OR REPLACE INTO notes (key, bookKey, chapter, chapterIndex, text, cfi, range, notes, date, percentage, color, tag) VALUES (@key, @bookKey, @chapter, @chapterIndex, @text, @cfi, @range, @notes, @date, @percentage, @color, @tag)",bookmarks:"INSERT OR REPLACE INTO bookmarks (key, bookKey, cfi, label, percentage, chapter) VALUES (@key, @bookKey, @cfi, @label, @percentage, @chapter)",books:"INSERT OR REPLACE INTO books (key, name, author, description, md5, cover, format, publisher, size, page, path, charset) VALUES (@key, @name, @author, @description, @md5, @cover, @format, @publisher, @size, @page, @path, @charset)",plugins:"INSERT OR REPLACE INTO plugins (key, type, displayName, icon, version, config, autoValue, langList, voiceList, scriptSHA256, script) VALUES (@key, @type, @displayName, @icon, @version, @config, @autoValue, @langList, @voiceList, @scriptSHA256, @script)",words:"INSERT OR REPLACE INTO words (key, bookKey, date, word, chapter) VALUES (@key, @bookKey, @date, @word, @chapter)"}),deleteAllStatement:Te({notes:"DELETE FROM notes",bookmarks:"DELETE FROM bookmarks",books:"DELETE FROM books",plugins:"DELETE FROM plugins",words:"DELETE FROM words"}),updateStatement:Te({notes:"UPDATE notes SET bookKey = @bookKey, chapter = @chapter, chapterIndex = @chapterIndex, text = @text, cfi = @cfi, range = @range, notes = @notes, date = @date, percentage = @percentage, color = @color, tag = @tag WHERE key = @key",bookmarks:"UPDATE bookmarks SET bookKey = @bookKey, cfi = @cfi, label = @label, percentage = @percentage, chapter = @chapter WHERE key = @key",books:"UPDATE books SET name = @name, author = @author, description = @description, md5 = @md5, cover = @cover, format = @format, publisher = @publisher, size = @size, page = @page, path = @path, charset = @charset WHERE key = @key",plugins:"UPDATE plugins SET type = @type, displayName = @displayName, icon = @icon, version = @version, config = @config, autoValue = @autoValue, langList = @langList, voiceList = @voiceList, scriptSHA256 = @scriptSHA256, script = @script WHERE key = @key",words:"UPDATE words SET bookKey = @bookKey, date = @date, word = @word, chapter = @chapter WHERE key = @key"}),deleteStatement:Te({notes:"DELETE FROM notes WHERE key = ?",bookmarks:"DELETE FROM bookmarks WHERE key = ?",books:"DELETE FROM books WHERE key = ?",plugins:"DELETE FROM plugins WHERE key = ?",words:"DELETE FROM words WHERE key = ?"}),dropStatement:Te({notes:"DROP TABLE IF EXISTS notes",bookmarks:"DROP TABLE IF EXISTS bookmarks",books:"DROP TABLE IF EXISTS books",plugins:"DROP TABLE IF EXISTS plugins",words:"DROP TABLE IF EXISTS words"}),getStatement:Te(Ee),getByBookKeyStatement:Te(we),getByBookKeysStatement:Te({notes:e=>`SELECT * FROM notes WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,bookmarks:e=>`SELECT * FROM bookmarks WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,words:e=>`SELECT * FROM words WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,books:e=>`SELECT * FROM books WHERE key IN (${e.map((()=>"?")).join(",")})`}),getKeysStatement:Te({notes:"SELECT key FROM notes",bookmarks:"SELECT key FROM bookmarks",books:"SELECT key FROM books",plugins:"SELECT key FROM plugins",words:"SELECT key FROM words"}),getWithSortAndPageStatement:Te({notes:(e,t,i,o)=>`SELECT * FROM notes ORDER BY ${e} ${t} LIMIT ${i} OFFSET ${o}`,bookmarks:(e,t,i,o)=>`SELECT * FROM bookmarks ORDER BY ${e} ${t} LIMIT ${i} OFFSET ${o}`,books:(e,t,i,o)=>`SELECT * FROM books ORDER BY ${e} ${t} LIMIT ${i} OFFSET ${o}`,plugins:(e,t,i,o)=>`SELECT * FROM plugins ORDER BY ${e} ${t} LIMIT ${i} OFFSET ${o}`,words:(e,t,i,o)=>`SELECT * FROM words ORDER BY ${e} ${t} LIMIT ${i} OFFSET ${o}`}),getByKeysStatement:Te({notes:e=>`SELECT * FROM notes WHERE key IN (${e.map((()=>"?")).join(",")}) ORDER BY CASE key ${e.map(((e,t)=>`WHEN ? THEN ${t}`)).join(" ")} END`,bookmarks:e=>`SELECT * FROM bookmarks WHERE key IN (${e.map((()=>"?")).join(",")}) ORDER BY CASE key ${e.map(((e,t)=>`WHEN ? THEN ${t}`)).join(" ")} END`,books:e=>`SELECT * FROM books WHERE key IN (${e.map((()=>"?")).join(",")}) ORDER BY CASE key ${e.map(((e,t)=>`WHEN ? THEN ${t}`)).join(" ")} END`,plugins:e=>`SELECT * FROM plugins WHERE key IN (${e.map((()=>"?")).join(",")}) ORDER BY CASE key ${e.map(((e,t)=>`WHEN ? THEN ${t}`)).join(" ")} END`,words:e=>`SELECT * FROM words WHERE key IN (${e.map((()=>"?")).join(",")}) ORDER BY CASE key ${e.map(((e,t)=>`WHEN ? THEN ${t}`)).join(" ")} END`}),deleteByBookKeyStatement:Te(Se)},jsonToSqlite:Te({notes:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t.tag=JSON.stringify(e.tag),t},bookmarks:e=>e,books:e=>{let t=Object.assign({},e);return t.page=e.page||0,t},plugins:e=>{let t=Object.assign({},e);return e.autoValue||(t.autoValue=null),e.langList?t.langList=JSON.stringify(e.langList):t.langList=null,e.voiceList?t.voiceList=JSON.stringify(e.voiceList):t.voiceList=null,t.config=JSON.stringify(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t}}),sqliteToJson:Te(Oe)};const _e=R,xe=T,Ce=O;class Ae{constructor(e,t,i){this.TokenService=e,this.ConfigService=t,this.baseUrl="china"===i?xe:_e,this.serverRegion=i,this.refreshToken="",this.accessToken="",this.streamPromise=null,this.expiresAt=0}refreshUserToken(){return F(this,void 0,void 0,(function*(){if(this.refreshToken=yield this.TokenService.getToken("refresh_token"),!this.refreshToken)return{code:401,message:"refresh token not found"};let t=(yield e.post(this.baseUrl+"/api/v1/public/user/refresh_token",{refresh_token:this.refreshToken})).data;return 200===t.code&&(yield this.TokenService.setToken("access_token",t.data.access_token),yield this.TokenService.setToken("refresh_token",t.data.refresh_token),yield this.TokenService.setToken("expires_at",(1e3*t.data.expires_at).toString()),this.accessToken=t.data.access_token,this.refreshToken=t.data.refresh_token,this.expiresAt=1e3*t.data.expires_at),t}))}requestWithRetry(e){return F(this,void 0,void 0,(function*(){return Ae.requestQueue||(Ae.requestQueue=[]),new Promise(((t,i)=>{Ae.requestQueue.push({config:e,resolve:t,reject:i}),Ae.processingQueue||this.processQueue()}))}))}isTokenValid(){return F(this,void 0,void 0,(function*(){if(this.accessToken||(this.accessToken=(yield this.TokenService.getToken("access_token"))||""),!this.expiresAt){const e=yield this.TokenService.getToken("expires_at");this.expiresAt=e?parseInt(e):(new Date).getTime()+31536e9}return""!==this.accessToken&&this.expiresAt>(new Date).getTime()+6e4}))}processQueue(){return F(this,void 0,void 0,(function*(){if(!Ae.processingQueue){Ae.processingQueue=!0;try{for(;Ae.requestQueue.length>0;){const e=Ae.requestQueue.shift();try{let t=yield this.executeRequest(e.config);t&&"object"==typeof t&&"code"in t&&503===t.code&&(t.msg="Network error, please try again later. 网络错误，请稍后再试。"),e.resolve(t)}catch(t){e.reject(t)}}}finally{Ae.processingQueue=!1}}}))}executeRequest(t){return F(this,void 0,void 0,(function*(){try{(yield this.isTokenValid())||(yield this.refreshUserToken());let i="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);if(t.baseURL=this.baseUrl,"china"===this.serverRegion&&"/api/v1/pro/reader/get_tts_audio"===t.url&&(t.baseURL=Ce),t.headers)t.headers.Authorization="Bearer "+this.accessToken,t.headers["X-Request-ID"]=i;else{let e=this.ConfigService.getItem("appVersion"),o=this.ConfigService.getItem("appPlatform");t.headers={Authorization:"Bearer "+this.accessToken,"X-Request-ID":i,"X-App-Version":e||"1.0.0","X-App-Platform":o||"web"}}let o=(yield e(t)).data;if(402===o.code){let i=yield this.refreshUserToken();if(200===i.code){return t.headers=t.headers||{},t.headers.Authorization="Bearer "+this.accessToken,(yield e(t)).data}return i}return 200!==o.code&&console.error("Request error:",o),o}catch(e){return console.error("Request execution error:",e),{code:503,message:"network error",data:null}}}))}requestWithStream(e,t,i){return F(this,void 0,void 0,(function*(){return this.streamPromise||(this.streamPromise=(()=>F(this,void 0,void 0,(function*(){try{(yield this.isTokenValid())||(yield this.refreshUserToken());let o=this.accessToken||"",r="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);return new Promise(((s,n)=>{let a=this.ConfigService.getItem("appVersion"),d=this.ConfigService.getItem("appPlatform");const l=new i(("china"===this.serverRegion?Ce:this.baseUrl)+e.url,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+o,"X-Request-ID":r,"X-App-Version":a||"1.0.0","X-App-Platform":d||"web"},method:e.method,body:JSON.stringify(e.data),pollingInterval:0});l.addEventListener("open",(()=>{console.info("Connection to OpenAI established.")})),l.addEventListener("message",(e=>F(this,void 0,void 0,(function*(){if(!e.data)return;const i=JSON.parse(e.data);i.done?(l.close(),s(i)):t(i.data)})))),l.addEventListener("error",(e=>{if(console.info("Error:",e),!e.data)return;const t=JSON.parse(e.data);s(t),l.close()}))}))}finally{this.streamPromise=null}})))()),this.streamPromise}))}requestWithFetch(e,t){return F(this,void 0,void 0,(function*(){return this.streamPromise||(this.streamPromise=(()=>F(this,void 0,void 0,(function*(){try{(yield this.isTokenValid())||(yield this.refreshUserToken());let i=this.accessToken||"",o="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);return new Promise(((r,s)=>F(this,void 0,void 0,(function*(){let s=this.ConfigService.getItem("appVersion"),n=this.ConfigService.getItem("appPlatform");var a=new v(("china"===this.serverRegion?Ce:this.baseUrl)+e.url,{headers:{"Content-Type":"text/plain",Authorization:"Bearer "+i,"X-Request-ID":o,"X-App-Version":s||"1.0.0","X-App-Platform":n||"web"},payload:JSON.stringify(e.data),method:"POST"});a.addEventListener("message",(e=>F(this,void 0,void 0,(function*(){if(!e.data)return;const i=JSON.parse(e.data);i.done?(a.close(),r(i)):t(i.data)})))),a.addEventListener("open",(e=>{console.info(e,"Connection to OpenAI established.")})),a.addEventListener("error",(e=>{if(console.error(e,"Error occurred while connecting to OpenAI"),!e.data)return;const t=JSON.parse(e.data);r(t),a.close()}))}))))}finally{this.streamPromise=null}})))()),this.streamPromise}))}}Ae.processingQueue=!1,Ae.requestQueue=[];class $e extends Ae{constructor(e,t,i){super(e,t,i),this.serverRegion=i}encryptToken(e){return F(this,void 0,void 0,(function*(){let t=e.token,i=w.encode(t),{extracted:o,remaining:r}=function(e){let t="",i="",o=[],r=1;for(;r<=e.length;)o.push(r-1),r*=2;for(let r=0;r<e.length;r++)o.includes(r)?t+=e[r]:i+=e[r];return{extracted:t,remaining:i}}(i);e.token=o;const s={method:"post",url:"/api/v1/pro/thirdparty/encrypt_token",data:e};let n=yield this.requestWithRetry(s),a=r+"#"+n.data.encrypted_token;return n.data.encrypted_token=a,n}))}decryptToken(e){return F(this,void 0,void 0,(function*(){let t=e.encrypted_token;if(t.indexOf("#")>-1){let i=t.split("#");e.encrypted_token=i[1]}const i={method:"post",url:"/api/v1/pro/thirdparty/decrypt_token",data:e};let o=yield this.requestWithRetry(i);if(t.indexOf("#")>-1&&o.data&&o.data.token){let e=t.split("#"),i=function(e,t){let i="",o=[],r=1,s=e.length+t.length;for(;r<=s;)o.push(r-1),r*=2;let n=0,a=0;for(let r=0;r<s;r++)o.includes(r)?i+=e[n++]:i+=t[a++];return i}(o.data.token,e[0]);o.data.token=w.decode(i)}return o}))}authThirdToken(e){return F(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/auth_token",data:e};return"china"!==this.serverRegion||"microsoft"!==e.provider&&"microsoft_exp"!==e.provider&&"adrive"!==e.provider||(t.data.redirect_uri=_),yield this.requestWithRetry(t)}))}refreshThirdToken(e){return F(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/refresh_token",data:e};return yield this.requestWithRetry(t)}))}getSyncDataByType(e){return F(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/get_sync_data_by_type",data:e};return yield this.requestWithRetry(t)}))}getSyncToken(){return F(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/pro/thirdparty/get_sync_token"})}))}updateSyncData(e){return F(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/update_sync_data",data:e};return yield this.requestWithRetry(t)}))}}const Ie=new k;const Pe=(Le=class{static getItem(e){return Ie.get(e)}static setItem(e,t){Ie.set(e,t)}static removeItem(e){Ie.delete(e)}},ze="desktop",(Qe=class extends Le{static getReaderConfig(e){return JSON.parse(this.getItem("readerConfig")||"{}")[e]}static setReaderConfig(e,t,i=!0){let o=JSON.parse(this.getItem("readerConfig")||"{}");o[e]=t,this.setItem("readerConfig",JSON.stringify(o)),i&&this.setSyncRecord({type:"config",catergory:"readerConfig",name:ze,key:e},{operation:"update",time:Date.now()})}static getAllListConfig(e){return("{}"!==this.getItem(e)&&this.getItem(e)?JSON.parse(this.getItem(e)||""):[])||[]}static deleteListConfig(e,t){let i=this.getAllListConfig(t);const o=i.indexOf(e);o>-1&&i.splice(o,1),this.setAllListConfig(i,t)}static setListConfig(e,t){let i=this.getAllListConfig(t);const o=i.indexOf(e);o>-1?(i.splice(o,1),i.unshift(e)):i.unshift(e),this.setAllListConfig(i,t)}static setAllListConfig(e,t,i=!0){this.setItem(t,JSON.stringify(e)),i&&this.setSyncRecord({type:"config",catergory:"listConfig",name:"general",key:t},{operation:"update",time:Date.now()})}static setObjectConfig(e,t,i,o=!0){let r=this.getAllObjectConfig(i);r[e]=t,o&&this.setSyncRecord({type:"config",catergory:"objectConfig",name:i,key:e},{operation:"update",time:Date.now()}),this.setAllObjectConfig(r,i)}static getObjectConfig(e,t,i){return this.getAllObjectConfig(t)[e]||i}static getAllObjectConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static setAllObjectConfig(e,t){this.setItem(t,JSON.stringify(e))}static deleteObjectConfig(e,t){let i=this.getAllObjectConfig(t);delete i[e],this.setSyncRecord({type:"config",catergory:"objectConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllObjectConfig(i,t)}static getAllMapConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static getMapConfig(e,t){return this.getAllMapConfig(t)[e]||[]}static setAllMapConfig(e,t){this.setItem(t,JSON.stringify(e))}static setMapConfig(e,t,i){let o=this.getAllMapConfig(i);void 0===o[e]&&(o[e]=[]),t&&-1===o[e].indexOf(t)&&o[e].unshift(t),this.setSyncRecord({type:"config",catergory:"mapConfig",name:i,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,i)}static setOneMapConfig(e,t,i,o=!0){let r=this.getAllMapConfig(i);r[e]=t,o&&this.setSyncRecord({type:"config",catergory:"mapConfig",name:i,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(r,i)}static deleteFromMapConfig(e,t,i){let o=this.getAllMapConfig(i),r=o[e].indexOf(t);o[e].splice(r,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:i,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,i)}static deleteFromAllMapConfig(e,t){let i=this.getAllMapConfig(t);Object.keys(i).forEach((o=>{let r=i[o].indexOf(e);r>-1&&(i[o].splice(r,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:o},{operation:"update",time:Date.now()}))})),this.setAllMapConfig(i,t)}static deleteMapConfig(e,t){let i=this.getAllMapConfig(t);delete i[e],this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllMapConfig(i,t)}static getFromAllMapConfig(e,t){let i=this.getAllMapConfig(t),o=[];for(let t in i)i[t]&&i[t].indexOf(e)>-1&&o.push(t);return o}static getSyncRecord(e){return JSON.parse(this.getItem("syncRecord")||"{}")[e.type+"."+e.catergory+"."+e.name+"."+e.key]||{operation:"",time:0}}static getAllSyncRecord(){return JSON.parse(this.getItem("syncRecord")||"{}")}static flushSyncRecords(){if(0===Object.keys(this.pendingSyncRecords).length)return;let e=JSON.parse(this.getItem("syncRecord")||"{}");Object.assign(e,this.pendingSyncRecords),this.setItem("syncRecord",JSON.stringify(e)),this.pendingSyncRecords={},this.syncRecordTimer=null}static setSyncRecord(e,t){const i=e.type+"."+e.catergory+"."+e.name+"."+e.key;this.pendingSyncRecords[i]=t,null!==this.syncRecordTimer&&clearTimeout(this.syncRecordTimer),this.syncRecordTimer=setTimeout((()=>{this.flushSyncRecords()}),this.DEBOUNCE_DELAY)}static setAllSyncRecord(e){this.setItem("syncRecord",JSON.stringify(e))}}).pendingSyncRecords={},Qe.syncRecordTimer=null,Qe.DEBOUNCE_DELAY=1e3,Qe);var Le,ze,Qe;let je;const De=new Uint8Array(16);function Ue(){if(!je&&(je="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!je))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return je(De)}const Me=[];for(let e=0;e<256;++e)Me.push((e+256).toString(16).slice(1));var Be={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function We(e,t,i){if(Be.randomUUID&&!t&&!e)return Be.randomUUID();const o=(e=e||{}).random||(e.rng||Ue)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=o[e];return t}return function(e,t=0){return Me[e[t+0]]+Me[e[t+1]]+Me[e[t+2]]+Me[e[t+3]]+"-"+Me[e[t+4]]+Me[e[t+5]]+"-"+Me[e[t+6]]+Me[e[t+7]]+"-"+Me[e[t+8]]+Me[e[t+9]]+"-"+Me[e[t+10]]+Me[e[t+11]]+Me[e[t+12]]+Me[e[t+13]]+Me[e[t+14]]+Me[e[t+15]]}(o)}const Ne=new k;class Ke{static encrypt(e,t){let i="";for(let o=0;o<e.length;o++){const r=e.charCodeAt(o)^t.charCodeAt(o%t.length);i+=String.fromCharCode(r)}return Buffer.from(i).toString("base64")}static decrypt(e,t){const i=Buffer.from(e,"base64").toString();let o="";for(let e=0;e<i.length;e++){const r=i.charCodeAt(e)^t.charCodeAt(e%t.length);o+=String.fromCharCode(r)}return o}static saveAllToken(e){return F(this,void 0,void 0,(function*(){try{let t=this.encrypt(e,yield this.getFingerprint());Ne.set("encryptedToken",t)}catch(e){throw console.error("Failed to save token:",e),e}}))}static getAllToken(){return F(this,void 0,void 0,(function*(){try{let e=Ne.get("encryptedToken");if(!e)return"";let t=this.decrypt(e,yield this.getFingerprint());if(t.startsWith("{")&&t.endsWith("}"))return t;const{safeStorage:i}=require("electron");return t=i.decryptString(Buffer.from(e,"base64")),yield this.saveAllToken(t),t}catch(e){return console.error("Failed to read token:",e),null}}))}static setToken(e,t){return F(this,void 0,void 0,(function*(){try{const i=JSON.parse((yield this.getAllToken())||"{}");i[e]=t,yield this.saveAllToken(JSON.stringify(i))}catch(e){throw console.error("Failed to set token:",e),e}}))}static getToken(e){return F(this,void 0,void 0,(function*(){try{return JSON.parse((yield this.getAllToken())||"{}")[e]||null}catch(e){return console.error("Failed to get token:",e),null}}))}static deleteToken(e){return F(this,void 0,void 0,(function*(){try{const t=JSON.parse((yield this.getAllToken())||"{}");delete t[e],yield this.saveAllToken(JSON.stringify(t))}catch(e){throw console.error("Failed to delete token:",e),e}}))}static getFingerprint(){return F(this,void 0,void 0,(function*(){let e=Pe.getItem("fingerPrint");if(e)return e;try{let e=b.machineIdSync();if(e&&"string"==typeof e&&e.length>0)return Pe.setItem("fingerPrint",e),e}catch(e){console.error("Failed to get machine ID:",e)}let t=We().replace(/-/g,"");return Pe.setItem("fingerPrint",t),t}))}}export{Pe as ConfigService,Re as SqlStatement,Fe as SyncUtil,$e as ThirdpartyRequest,Ke as TokenService};
