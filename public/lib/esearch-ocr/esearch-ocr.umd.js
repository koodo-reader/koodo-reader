(function(B,O){typeof exports=="object"&&typeof module<"u"?O(exports):typeof define=="function"&&define.amd?define(["exports"],O):(B=typeof globalThis<"u"?globalThis:B||self,O(B["esearch-ocr"]={}))})(this,(function(B){"use strict";var Fn=Object.defineProperty;var jn=(B,O,F)=>O in B?Fn(B,O,{enumerable:!0,configurable:!0,writable:!0,value:F}):B[O]=F;var vt=(B,O,F)=>jn(B,typeof O!="symbol"?O+"":O,F);let O=(t,e)=>new OffscreenCanvas(t,e);function F(t,e){return O(t,e)}function Qt(t){O=t}function Tt(t){return t>0?Math.floor(t):Math.ceil(t)}function X(t,e,s){return Math.max(e,Math.min(t,s))}function gt(t,e,s,o,a="high"){return Zt(t,e,s,o,a).getImageData(0,0,e,s)}function Zt(t,e,s,o,a="high"){const r=H(t),u=F(e,s).getContext("2d");return u.imageSmoothingEnabled=a!==!1,a&&(u.imageSmoothingQuality=a),o==="fill"?u.scale(Math.min(e/t.width,1),Math.min(s/t.height,1)):u.scale(e/t.width,s/t.height),u.drawImage(r,0,0),u}function H(t,e,s){const o=F(e||t.width,s||t.height);return o.getContext("2d").putImageData(t,0,0),o}function bt(t,e,s){const o=t.data,a=[],r=[],i=[];let u=0,m=0;for(let h=0;h<o.length;h+=4)i[m]||(i[m]=[]),r[m]||(r[m]=[]),a[m]||(a[m]=[]),a[m][u]=(o[h]/255-e[0])/s[0],r[m][u]=(o[h+1]/255-e[1])/s[1],i[m][u]=(o[h+2]/255-e[2])/s[2],u++,u===t.width&&(u=0,m++);return[i,r,a]}class Pt{constructor(e){vt(this,"tl",[]);vt(this,"name");this.name=e}l(e){const s=performance.now();this.tl.push({t:e,n:s});const o=[];for(let r=1;r<this.tl.length;r++){const i=this.tl[r].n-this.tl[r-1].n,u=this.tl[r-1].t,m=o.find(h=>h.n===u);m?(m.c++,m.d+=i):o.push({d:i,n:u,c:1})}const a=[];for(const r of o){const i=r.c>1?`${r.n}x${r.c}`:r.n;a.push(`${i} ${r.d}`)}a.push(this.tl.at(-1).t),console.log(`${this.name} ${o.map(r=>r.d).reduce((r,i)=>r+i,0)}ms: `,a.join(" "))}}async function Jt(t,e,s,o,a,r){const{transposedData:i,image:u}=tn(t,a,r),h=(await nn(i,u,e,s))[0].data,l=h.reduce((p,x)=>Math.max(p,x)),d=h.findIndex(p=>p===l);return o[d]}function tn(t,e,s){const o=gt(t,e,s);return{transposedData:bt(o,[.485,.456,.406],[.229,.224,.225]),image:o}}async function nn(t,e,s,o){const a=t.flat(Number.POSITIVE_INFINITY),r=Float32Array.from(a),i=new s.Tensor("float32",r,[1,3,e.height,e.width]),u={};u[o.inputNames[0]]=i;const m=await o.run(u);return Object.values(m)}function en(t){if(t.length===0)throw new Error("Empty contour");const e=on([...t]);let s=Number.POSITIVE_INFINITY;const o={center:{x:0,y:0},size:{width:0,height:0},angle:0};for(let a=0;a<e.length;a++){const r=e[a],i=e[(a+1)%e.length],u={x:i.x-r.x,y:i.y-r.y},m=Math.hypot(u.x,u.y),[h,l]=[u.x/m,u.y/m];let d=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,x=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY;for(const I of e){const k=(I.x-r.x)*h+(I.y-r.y)*l;d=Math.min(d,k),p=Math.max(p,k);const S=-(I.x-r.x)*l+(I.y-r.y)*h;x=Math.min(x,S),y=Math.max(y,S)}const b=(p-d)*(y-x);if(b<s){s=b;const I=(d+p)/2,k=(x+y)/2;o.center={x:r.x+h*I-l*k,y:r.y+l*I+h*k},o.size={width:p-d,height:y-x},o.angle=Math.atan2(l,h)*(180/Math.PI)}}return o.size.width<o.size.height&&([o.size.width,o.size.height]=[o.size.height,o.size.width],o.angle+=90),o.angle=(o.angle%180+180)%180,o}function on(t){t.sort((o,a)=>o.x-a.x||o.y-a.y);const e=[];for(const o of t){for(;e.length>=2&&Et(e[e.length-2],e[e.length-1],o)<=0;)e.pop();e.push(o)}const s=[];for(let o=t.length-1;o>=0;o--){const a=t[o];for(;s.length>=2&&Et(s[s.length-2],s[s.length-1],a)<=0;)s.pop();s.push(a)}return e.slice(0,-1).concat(s.slice(0,-1))}function Et(t,e,s){return(e.x-t.x)*(s.y-t.y)-(e.y-t.y)*(s.x-t.x)}function sn(t,e,s="CHAIN_APPROX_SIMPLE"){const o=t.length,a=o>0?t[0].length:0,r=Array.from({length:o},()=>new Array(a).fill(!1));for(let i=0;i<o;i++)for(let u=0;u<a;u++)if(t[i][u]!==0&&!r[i][u]&&At(t,u,i)){const m=cn(t,r,u,i,s==="CHAIN_APPROX_SIMPLE");e.push(m)}}function At(t,e,s){return t[s][e]!==0&&(s>0&&t[s-1][e]===0||s<t.length-1&&t[s+1][e]===0||e>0&&t[s][e-1]===0||e<t[0].length-1&&t[s][e+1]===0)}function cn(t,e,s,o,a){const r=[];let i={x:s,y:o},u={x:s-1,y:o};const m=new Map,h=new Map;function l(b){return b.x+b.y*t[0].length}function d(b){const I=Math.floor(b/t[0].length);return{x:b%t[0].length,y:I}}function p(b,I){const k=l(b),S=l(I),v=yt(I.x-b.x,I.y-b.y),A=yt(b.x-I.x,b.y-I.y),_=m.get(k)??[],T=m.get(S)??[];m.set(k,[..._,v]),m.set(S,[...T,A])}function x(b){const I=l(i);u=i,i={x:i.x+lt[b].dx,y:i.y+lt[b].dy},p(u,i);const S=(h.get(I)??[]).filter(v=>v!==b);S.length>0?h.set(I,S):h.delete(I)}m.set(l(i),[yt(-1,0)]);let y=0;do{r.push(i),e[i.y][i.x]=!0;const b=rn(t,m,i);if(b.length===0){if(h.size===0)break;const[I,k]=Array.from(h.entries()).at(0),S=k[0];i=d(I),x(S)}if(b.length>=1){const I=l(i);h.set(I,b);const k=b[0];x(k)}y++}while(y<1e9);return a?ln(r):r}const lt=[{dx:1,dy:0},{dx:1,dy:-1},{dx:0,dy:-1},{dx:-1,dy:-1},{dx:-1,dy:0},{dx:-1,dy:1},{dx:0,dy:1},{dx:1,dy:1}];function rn(t,e,s){function o(i){return i.x+i.y*t[0].length}const a=e.get(o(s))??[],r=[];for(const[i,{dx:u,dy:m}]of lt.entries()){if(a.includes(i))continue;const h=s.x+u,l=s.y+m;h>=0&&h<t[0].length&&l>=0&&l<t.length&&At(t,h,l)&&r.push(i)}return r}function yt(t,e){const s=lt.findIndex(({dx:o,dy:a})=>t===o&&e===a);return s===-1?0:s}function ln(t){if(t.length<3)return[...t];const e=[t[0]];for(let s=1;s<t.length-1;s++){const o=e[e.length-1],a=t[s],r=t[s+1];an(o,a,r)||e.push(a)}return e.push(t[t.length-1]),e}function an(t,e,s){return(e.x-t.x)*(s.y-e.y)===(e.y-t.y)*(s.x-e.x)}const q=new Pt("t"),Y=new Pt("af_det");let j=!1,pt=!1,W=null;function st(t,e){var o;const s=document.createElement("canvas");s.width=t.width,s.height=t.height,s.getContext("2d").drawImage(t,0,0),e&&(s.id=e);try{(o=document==null?void 0:document.body)==null||o.append(s)}catch{}}let at=(t,e,s)=>new ImageData(t,e,s);function L(...t){pt&&console.log(...t)}function un(...t){pt&&console.log(t.map(e=>`%c${e}`).join(""),...t.map(e=>`color: ${e}`))}async function hn(t){_t(t);const e={det:"det"in t?t.det:{input:t.detPath,ratio:t.detRatio,on:async o=>{t.onDet&&t.onDet(o),t.onProgress&&t.onProgress("det",1,1)}},rec:"rec"in t?t.rec:{input:t.recPath,decodeDic:t.dic,imgh:t.imgh,on:async(o,a,r)=>{t.onRec&&t.onRec(o,{text:a.map(i=>i[0].t).join(""),mean:a.map(i=>i[0].mean).reduce((i,u)=>i+u,0)/a.length}),t.onProgress&&t.onProgress("rec",r,o+1)}},docCls:"rec"in t?t.docCls:t.docClsPath?{input:t.docClsPath}:void 0,analyzeLayout:"rec"in t?t.analyzeLayout:{columnsTip:t.columnsTip,docDirs:t.docDirs},...t},s=await mn(e);return W=s,s}function _t(t){j=!!t.dev,pt=j||!!t.log,j||(q.l=()=>{},Y.l=()=>{}),t.canvas&&Qt(t.canvas),t.imageData&&(at=t.imageData)}async function Ot(t){let e;if(typeof window>"u"){const s=t;if(!s.data||!s.width||!s.height)throw new Error("invalid image data");return s}if(typeof t=="string"?(e=new Image,e.src=t,await new Promise(s=>{e.onload=s})):(t instanceof ImageData,e=t),e instanceof HTMLImageElement){const o=F(e.naturalWidth,e.naturalHeight).getContext("2d");if(!o)throw new Error("canvas context is null");o.drawImage(e,0,0),e=o.getImageData(0,0,e.naturalWidth,e.naturalHeight)}if(e instanceof HTMLCanvasElement){const s=e.getContext("2d");if(!s)throw new Error("canvas context is null");e=s.getImageData(0,0,e.width,e.height)}return e}function It(){try{F(1,1),at(new Uint8ClampedArray(4),1,1)}catch(t){throw console.log("nodejs need set canvas, please use setOCREnv to set canvas and imageData"),t}}async function fn(t){if(!W)throw new Error("need init");return W.ocr(t)}async function dn(t){if(!W)throw new Error("need init");return W.det(t)}async function xn(t){if(!W)throw new Error("need init");return W.rec(t)}async function mn(t){It();const e={ort:t.ort,ortOption:t.ortOption},s=t.docCls?await zt({...t.docCls,...e}):void 0,o=await Rt({...t.det,...e}),a=await Lt({...t.rec,...e});return{ocr:async r=>{let i=await Ot(r),u=0;s&&(u=await s.docCls(i),L("dir",u),i=kt(i,360-u));const m=await o.det(i),h=await a.rec(m),l=Ft(h,t.analyzeLayout);return L(h,l),q.l("end"),{src:h,...l,docDir:u}},det:o.det,rec:a.rec,recRaw:a.rawRec}}function wt(t,e,s){return typeof e=="string"||e instanceof ArrayBuffer||e instanceof SharedArrayBuffer,t.InferenceSession.create(e,s)}async function zt(t){const e=await wt(t.ort,t.input,t.ortOption);return{docCls:async o=>Jt(o,t.ort,e,[0,90,180,270],224,224)}}async function Rt(t){It();let e=1;const s=await wt(t.ort,t.input,t.ortOption);t.ratio!==void 0&&(e=t.ratio);async function o(a){var x;const r=a;if(j){const y=H(r);st(y)}q.l("pre_det");const{data:i,width:u,height:m}=pn(r,e),{transposedData:h,image:l}=i;q.l("det");const d=await bn(h,l,s,t.ort);q.l("aft_det");const p=In({data:d.data,width:d.dims[3],height:d.dims[2]},u,m,r);return(x=t==null?void 0:t.on)==null||x.call(t,p),p}return{det:o}}function gn(t){const e=t;return[{box:[[0,0],[e.width,0],[e.width,e.height],[0,e.height]],img:e,style:{bg:[255,255,255],text:[0,0,0]}}]}async function Lt(t){var u;It();let e=48;const s=await wt(t.ort,t.input,t.ortOption),o=t.decodeDic.split(/\r\n|\r|\n/)||[];o.at(-1)===""?o[o.length-1]=" ":o.push(" "),t.imgh&&(e=t.imgh);const a=((u=t.optimize)==null?void 0:u.space)===void 0?!0:t.optimize.space;async function r(m,h){var y,b,I;const l=[];q.l("bf_rec");const d=Pn(m,e),p=(h==null?void 0:h.topK)||((y=t.multiChar)==null?void 0:y.topK)||2,x=(h==null?void 0:h.threshold)||((b=t.multiChar)==null?void 0:b.threshold)||1e-5;for(const[k,S]of d.entries()){const{b:v,imgH:A,imgW:_}=S,T=await yn(v,A,_,s,t.ort),U=En(T,o,{topK:p,threshold:x})[0];l.push({text:U,box:m[k].box,style:m[k].style}),(I=t==null?void 0:t.on)==null||I.call(t,k,U,m.length)}return q.l("rec_end"),l}async function i(m){const h=[],l=await r(m,{topK:2,threshold:1e-5});for(const d of l){const p=d.text.map(b=>a&&b[0].t===""&&b[1].t===" "&&b[1].mean>.001?b[1]:b[0]),x=p.map(b=>b.t).join("").trim(),y=p.map(b=>b.mean).reduce((b,I)=>b+I,0)/p.length;y<.5||h.push({text:x,mean:y,box:d.box,style:d.style})}return h}return{rec:i,rawRec:r}}async function bn(t,e,s,o){const a=Float32Array.from(t.flat(3)),r=new o.Tensor("float32",a,[1,3,e.height,e.width]),i={};return i[s.inputNames[0]]=r,(await s.run(i))[s.outputNames[0]]}async function yn(t,e,s,o,a){const r=Float32Array.from(t.flat(3)),i=new a.Tensor("float32",r,[1,3,e,s]),u={};return u[o.inputNames[0]]=i,(await o.run(u))[o.outputNames[0]]}function pn(t,e){const s=Math.max(Math.round(t.height*e/32)*32,32),o=Math.max(Math.round(t.width*e/32)*32,32);if(j){const i=H(t);st(i)}const a=gt(t,o,s,"fill"),r=bt(a,[.485,.456,.406],[.229,.224,.225]);if(L(a),j){const i=H(a);st(i)}return{data:{transposedData:r,image:a},width:o,height:s}}function In(t,e,s,o){Y.l("");const a=Math.min(o.width,e),r=Math.min(o.height,s),{data:i,width:u,height:m}=t,h=new Uint8Array(u*m);for(let x=0;x<i.length;x++){const y=i[x]>.3?255:0;h[x]=y}if(j){const x=new Uint8ClampedArray(u*m*4);for(let I=0;I<i.length;I++){const k=I*4,S=i[I]>.3?255:0;x[k]=x[k+1]=x[k+2]=S,x[k+3]=255,h[I]=S}const y=at(x,u,m),b=H(y);st(b,"det_ru")}Y.l("edge");const l=[],d=[];for(let x=0;x<m;x++)d.push(Array.from(h.slice(x*u,x*u+u)));const p=[];if(sn(d,p),j){const x=document.querySelector("#det_ru").getContext("2d");for(const y of p){x.moveTo(y[0].x,y[0].y);for(const b of y)x.lineTo(b.x,b.y);x.strokeStyle="red",x.closePath(),x.stroke()}}for(let x=0;x<p.length;x++){Y.l("get_box");const y=3,b=p[x],{points:I,sside:k}=Sn(b);if(k<y)continue;const S=kn(I),v=S.points;if(S.sside<y+2)continue;const A=o.width/a,_=o.height/r;for(let R=0;R<v.length;R++)v[R][0]*=A,v[R][1]*=_;Y.l("order");const T=Nn(v);for(const R of T)R[0]=X(Math.round(R[0]),0,o.width),R[1]=X(Math.round(R[1]),0,o.height);const U=Tt(Vt(T[0],T[1])),Ct=Tt(Vt(T[0],T[3]));if(U<=3||Ct<=3)continue;An(v,"","red","det_ru"),Y.l("crop");const Q=Dn(o,v);Y.l("match best");const{bg:z,text:Z}=Bn(Q),dt=Tn(v,Q,Z);l.push({box:dt,img:Q,style:{bg:z,text:Z}})}return Y.l("e"),L(l),l}function wn(t){let e=-1;const s=t.length;let o,a=t[s-1],r=0;for(;++e<s;)o=a,a=t[e],r+=o[1]*a[0]-o[0]*a[1];return r/2}function Mn(t){let e=-1;const s=t.length;let o=t[s-1],a,r,i=o[0],u=o[1],m=0;for(;++e<s;)a=i,r=u,o=t[e],i=o[0],u=o[1],a-=i,r-=u,m+=Math.hypot(a,r);return m}function kn(t){const s=Math.abs(wn(t)),o=Mn(t),a=s*1.5/o,r=[];for(const[h,l]of t.entries()){const d=t.at((h-1)%4),p=t.at((h+1)%4),x=l[0]-d[0],y=l[1]-d[1],b=Math.sqrt(x**2+y**2),I=x/b*a,k=y/b*a,S=l[0]-p[0],v=l[1]-p[1],A=Math.sqrt(S**2+v**2),_=S/A*a,T=v/A*a;r.push([l[0]+I+_,l[1]+k+T])}const i=[r[0][0]-r[1][0],r[0][1]-r[1][1]],u=[r[2][0]-r[1][0],r[2][1]-r[1][1]],m=i[0]*u[1]-i[1]*u[0];return{points:r,sside:Math.abs(m)}}function Cn(t,e,s){const o=e.width,a=e.height,r=s*Math.PI/180,i=Math.cos(r),u=Math.sin(r),m=t.x,h=t.y,l=o*.5,d=a*.5,p=[],x=m-l*i+d*u,y=h-l*u-d*i;p.push([x,y]);const b=m+l*i+d*u,I=h+l*u-d*i;p.push([b,I]);const k=m+l*i-d*u,S=h+l*u+d*i;p.push([k,S]);const v=m-l*i-d*u,A=h-l*u+d*i;return p.push([v,A]),p}function Sn(t){const s=en(t),o=Array.from(Cn(s.center,s.size,s.angle)).sort((l,d)=>l[0]-d[0]);let a=0,r=1,i=2,u=3;o[1][1]>o[0][1]?(a=0,u=1):(a=1,u=0),o[3][1]>o[2][1]?(r=2,i=3):(r=3,i=2);const m=[o[a],o[r],o[i],o[u]],h=Math.min(s.size.height,s.size.width);return{points:m,sside:h}}function Vt(t,e){return Math.sqrt((t[0]-e[0])**2+(t[1]-e[1])**2)}function Nn(t){const e=[[0,0],[0,0],[0,0],[0,0]],s=t.map(r=>r[0]+r[1]);e[0]=t[s.indexOf(Math.min(...s))],e[2]=t[s.indexOf(Math.max(...s))];const o=t.filter(r=>r!==e[0]&&r!==e[2]),a=o[1].map((r,i)=>r-o[0][i]);return e[1]=o[a.indexOf(Math.min(...a))],e[3]=o[a.indexOf(Math.max(...a))],e}function Dn(t,e){const[s,o,a,r]=e.map(T=>({x:T[0],y:T[1]})),i=Math.sqrt((o.x-s.x)**2+(o.y-s.y)**2),u=Math.sqrt((r.x-s.x)**2+(r.y-s.y)**2),m=o.x-s.x,h=o.y-s.y,l=r.x-s.x,d=r.y-s.y,p=m*d-l*h;if(p===0)throw new Error("点共线，无法形成矩形");const x=i*d/p,y=-l*i/p,b=-u*h/p,I=m*u/p,k=-x*s.x-y*s.y,S=-b*s.x-I*s.y,v=H(t),A=F(Math.ceil(i),Math.ceil(u)),_=A.getContext("2d");return _.setTransform(x,b,y,I,k,S),_.drawImage(v,0,0),_.resetTransform(),_.getImageData(0,0,A.width,A.height)}function Bn(t){var m,h;const e=new Map,s=t.data;for(let l=0;l<s.length;l+=4){if(l/4%t.width>t.height*4)continue;const p=s[l],x=s[l+1],y=s[l+2],b=[p,x,y].join(",");e.set(b,(e.get(b)||0)+1)}const o=vn(e,20).map(l=>({el:l.el.split(",").map(Number),count:l.count})),a=((m=o.at(0))==null?void 0:m.el)||[255,255,255],r=((h=o.at(1))==null?void 0:h.el)||[0,0,0];let i=r;const u=100;if(ut(r,a)<u){const l=o.slice(1).filter(d=>ut(d.el,a)>50);l.length>0&&(i=[0,1,2].map(d=>Math.round(jt(l.map(p=>[p.el[d],p.count]))))),(l.length===0||ut(i,a)<u)&&(i=a.map(d=>255-d)),un(`rgb(${i.join(",")})`)}return{bg:a,text:i,textEdge:r}}function ut(t,e){const s=t,o=e;return Math.sqrt((s[0]-o[0])**2+(s[1]-o[1])**2+(s[2]-o[2])**2)}function vn(t,e=1){let s=[];return t.forEach((o,a)=>{s.length===0?s.push({el:a,count:o}):(s.length<e?s.push({el:a,count:o}):s.find(r=>r.count<=o)&&s.push({el:a,count:o}),s.sort((r,i)=>i.count-r.count),s.length>e&&(s=s.slice(0,e)))}),s}function Tn(t,e,s){let o=0,a=e.height,r=0,i=e.width;function u(x){return ut(x,s)<200}t:for(let x=o;x<e.height;x++)for(let y=0;y<e.width;y++){const b=ht(e,y,x);if(u(b)){o=x;break t}}t:for(let x=a-1;x>=0;x--)for(let y=0;y<e.width;y++){const b=ht(e,y,x);if(u(b)){a=x;break t}}t:for(let x=r;x<e.width;x++)for(let y=o;y<=a;y++){const b=ht(e,x,y);if(u(b)){r=x;break t}}t:for(let x=i-1;x>=0;x--)for(let y=o;y<=a;y++){const b=ht(e,x,y);if(u(b)){i=x;break t}}const m=X(o-1,0,4),h=X(e.height-a-1,0,4),l=X(r-1,0,4),d=X(e.width-i-1,0,4);return[[t[0][0]+l,t[0][1]+m],[t[1][0]-d,t[1][1]+m],[t[2][0]-d,t[2][1]-h],[t[3][0]+l,t[3][1]-h]]}function ht(t,e,s){const o=(s*t.width+e)*4;return Array.from(t.data.slice(o,o+4))}function Pn(t,e){const s=[];function o(a){const r=Math.floor(e*(a.width/a.height)),i=gt(a,r,e,void 0,!1);return j&&st(H(i,r,e)),{data:i,w:r,h:e}}for(const a of t){let r=a.img;r.width<r.height&&(r=kt(r,-90));const i=o(r);s.push({b:bt(i.data,[.5,.5,.5],[.5,.5,.5]),imgH:i.h,imgW:i.w})}return L(s),s}function En(t,e,s){const o=t.dims[2],a=[];let r=t.dims[0]-1;const i=s.topK,u=s.threshold;function m(l){return e.at(l-1)??""}for(let l=0;l<t.data.length;l+=o*t.dims[1]){const d=[];for(let p=l;p<l+o*t.dims[1];p+=o){const x=t.data.slice(p,p+o),y=[];for(let b=0;b<x.length;b++){const I=x[b];if(!(I<u)){if(!(y.length===i&&I<=y.at(-1).v)){const k=y.findIndex(S=>S.v>I);k===-1?y.unshift({t:b,v:I}):y.splice(k+1,0,{t:b,v:I})}y.length>i&&y.pop()}}d.push(y)}a[r]=h(d),r--}function h(l){const d=[];for(let p=0;p<l.length;p++)l[p][0].t!==0&&(p>0&&l[p-1][0].t===l[p][0].t||d.push(l[p].map(x=>({t:m(x.t),mean:x.v}))));return d}return a}function Ft(t,e){var Xt;L(t);const s=(e==null?void 0:e.docDirs)??[{block:"tb",inline:"lr"},{block:"rl",inline:"tb"}],o={block:"tb",inline:"lr"},a={inline:[1,0],block:[0,1]},r={inline:[1,0],block:[0,1]};if(t.length===0)return{columns:[],parragraphs:[],readingDir:o,angle:{reading:{inline:0,block:90},angle:0}};const i=[{box:[[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],[Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY]],type:"none"}],u=0;function m(n){const c=l.center(n);for(let f=i.length-1;f>=0;f--){const w=i[f].box;if(c[0]>=w[0][0]&&c[0]<=w[1][0]&&c[1]>=w[0][1]&&c[1]<=w[3][1])return f}return u}const h={center:(n,c)=>[(n[0]+c[0])/2,(n[1]+c[1])/2],disByV:(n,c,f)=>Math.abs(f==="block"?d.dotMup(n,r.block)-d.dotMup(c,r.block):d.dotMup(n,r.inline)-d.dotMup(c,r.inline)),compare:(n,c,f)=>f==="block"?d.dotMup(n,r.block)-d.dotMup(c,r.block):d.dotMup(n,r.inline)-d.dotMup(c,r.inline),toInline:n=>d.dotMup(n,r.inline),toBlock:n=>d.dotMup(n,r.block)},l={inlineStart:n=>h.center(n[0],n[3]),inlineEnd:n=>h.center(n[1],n[2]),blockStart:n=>h.center(n[0],n[1]),blockEnd:n=>h.center(n[2],n[3]),inlineSize:n=>n[1][0]-n[0][0],blockSize:n=>n[3][1]-n[0][1],inlineStartDis:(n,c)=>h.disByV(n[0],c[0],"inline"),inlineEndDis:(n,c)=>h.disByV(n[1],c[1],"inline"),blockGap:(n,c)=>h.disByV(n[0],c[3],"block"),inlineCenter:n=>(n[2][0]+n[0][0])/2,blockCenter:n=>(n[2][1]+n[0][1])/2,inlineStartCenter:n=>l.inlineStart(n),center:n=>h.center(n[0],n[2])},d={fromPonts:(n,c)=>[n[0]-c[0],n[1]-c[1]],dotMup:(n,c)=>n[0]*c[0]+n[1]*c[1],numMup:(n,c)=>[n[0]*c,n[1]*c],add:(n,c)=>[n[0]+c[0],n[1]+c[1]]};function p(n){let c=0,f=0;const g=[];for(const[w,M]of n.entries()){const C=M>180?M-180:M,D=C-180,E=w===0?C:Math.abs(D-c)<Math.abs(C-c)?D:C;g.push(E),c=(c*f+E)/(f+1),f++}return{av:c,l:g}}function x(n,c){return Math.abs(n-c)<45||Math.abs(n-(c-180))<45||Math.abs(n-180-c)<45}function y(n){n.sort((f,g)=>f-g);const c=Math.floor(n.length/2);return n.length%2===0?(n[c-1]+n[c])/2:n[c]}function b(n){return n==="lr"||n==="rl"?"x":"y"}function I(n,c){let f=Number.POSITIVE_INFINITY,g=-1;for(let w=0;w<n.length;w++){const M=c(n[w]);M<f&&(f=M,g=w)}return n[g]}const k={lr:[1,0],rl:[-1,0],tb:[0,1],bt:[0,-1]};function S(n,c){const f=k[n.inline],g=k[n.block],w=k[c.inline],M=k[c.block],C=[d.dotMup(w,f),d.dotMup(w,g)],D=[d.dotMup(M,f),d.dotMup(M,g)];return E=>[d.dotMup(E,C),d.dotMup(E,D)]}function v(n,c){const f=S(n,c);return{b:g=>{for(const w of g){const[M,C]=f(w);w[0]=M,w[1]=C}},p:f}}function A(n){return c=>{const f=[[0,0],[0,0],[0,0],[0,0]];for(let g=0;g<n.length;g++)f[g]=c[n[g]];return f}}function _(n,c){return Math.sqrt((n[0]-c[0])**2+(n[1]-c[1])**2)}function T(n){const c=n.flatMap(P=>P.map(N=>N)),f=Math.min(...c.map(P=>d.dotMup(P,r.inline))),g=Math.max(...c.map(P=>d.dotMup(P,r.inline))),w=Math.min(...c.map(P=>d.dotMup(P,r.block))),M=Math.max(...c.map(P=>d.dotMup(P,r.block))),C=d.add(d.numMup(r.inline,f),d.numMup(r.block,w)),D=d.numMup(r.inline,g-f),E=d.numMup(r.block,M-w);return[C,d.add(C,D),d.add(d.add(C,D),E),d.add(C,E)]}function U(n){let c=null,f=Number.POSITIVE_INFINITY;for(const E in $){const P=$[E].src.at(-1);if(!P)continue;const N=_(n.box[0],P.box[0]);N<f&&(c=Number(E),f=N)}if(c===null){$.push({src:[n]});return}const g=$[c].src.at(-1),w=l.inlineSize(n.box),M=l.inlineSize(g.box),C=Math.min(w,M),D=l.blockSize(n.box);if(!((l.inlineStartDis(n.box,g.box)<3*D||l.inlineEndDis(n.box,g.box)<3*D||h.disByV(l.center(n.box),l.center(g.box),"inline")<C*.4)&&l.blockGap(n.box,g.box)<D*1.1)){$.push({src:[n]});return}$[c].src.push(n)}function Ct(n){var w,M;const c=new RegExp("\\p{Ideographic}","u"),f=/[。，！？；：“”‘’《》、【】（）…—]/,g={box:T(n.map(C=>C.box)),text:"",mean:jt(n.map(C=>[C.mean,C.text.length])),style:n[0].style};for(const C of n){const D=g.text.at(-1);D&&(!D.match(c)&&!D.match(f)||!((w=C.text.at(0))!=null&&w.match(c))&&!((M=C.text.at(0))!=null&&M.match(f)))&&(g.text+=" "),g.text+=C.text}return g}function Q(n){n.sort((c,f)=>{const g=c.src.at(0)?l.blockSize(c.src.at(0).box):2;return h.disByV(l.blockStart(c.outerBox),l.blockStart(f.outerBox),"block")<g?h.compare(l.inlineStart(c.outerBox),l.inlineStart(f.outerBox),"inline"):h.compare(l.blockStart(c.outerBox),l.blockStart(f.outerBox),"block")})}if(e!=null&&e.columnsTip)for(const n of e.columnsTip)i.push(structuredClone(n));const z={inline:0,block:90},Z=t.map(n=>{const c=n.box,f=c[1][0]-c[0][0],g=c[3][1]-c[0][1];let w={x:0,y:0};if(f<g){const C=d.fromPonts(h.center(c[2],c[3]),h.center(c[0],c[1]));w={x:C[0],y:C[1]}}else{const C=d.fromPonts(h.center(c[1],c[2]),h.center(c[0],c[3]));w={x:C[0],y:C[1]}}return ft(Math.atan2(w.y,w.x)*(180/Math.PI))}),dt=p(Z),R=Z.filter(n=>x(n,dt.av)),Yt=y(R),_n=y(R.map(n=>Math.abs(n-Yt))),Gt=R.filter(n=>Math.abs((n-Yt)/(_n*1.4826))<2),G=ft(p(Gt).av);L("dir0",Z,dt,R,Gt,G);const J=ft(G+90),On=x(G,0)?"x":"y",zn=x(J,90)?"y":"x",St=s.find(n=>On===b(n.inline)&&zn===b(n.block))??s.at(0);St&&(o.block=St.block,o.inline=St.inline);const Ht={lr:0,rl:180,tb:90,bt:270};z.inline=I([G,G-360,G-180,G+180],n=>Math.abs(n-Ht[o.inline])),z.block=I([J,J-360,J-180,J+180],n=>Math.abs(n-Ht[o.block])),a.inline=[Math.cos(z.inline*(Math.PI/180)),Math.sin(z.inline*(Math.PI/180))],a.block=[Math.cos(z.block*(Math.PI/180)),Math.sin(z.block*(Math.PI/180))],L("dir",o,z,a,G,J);const qt=[[o.inline[0],o.block[0]],[o.inline[1],o.block[0]],[o.inline[1],o.block[1]],[o.inline[0],o.block[1]]].map(([n,c])=>({lt:0,rt:1,rb:2,lb:3})[n==="l"||n==="r"?n+c:c+n]),xt=v({inline:"lr",block:"tb"},o),Wt=A(qt),Rn=t.map(n=>{const c=Wt(n.box);return xt.b(c),{...n,box:c}});for(const n of i)n.box=Wt(n.box),xt.b(n.box);r.inline=xt.p(a.inline),r.block=xt.p(a.block),L("相对坐标系",r);const Ln=Rn.sort((n,c)=>h.compare(l.blockStart(n.box),l.blockStart(c.box),"block")),tt=[];for(const n of Ln){const c=m(n.box),f=(Xt=tt.at(-1))==null?void 0:Xt.line.at(-1);if(!f){tt.push({line:[{src:n,colId:c}]});continue}const g=l.center(n.box),w=l.center(f.src.box);if(h.disByV(g,w,"block")<.5*l.blockSize(n.box)){const M=tt.at(-1);M?M.line.push({src:n,colId:c}):tt.push({line:[{src:n,colId:c}]})}else tt.push({line:[{src:n,colId:c}]})}const mt=[];for(const n of tt){if(n.line.length===1){mt.push({src:n.line[0].src,colId:n.line[0].colId});continue}const c=Mt(n.line.map(g=>l.blockSize(g.src.box)));n.line.sort((g,w)=>h.compare(l.inlineStart(g.src.box),l.inlineStart(w.src.box),"inline"));let f=n.line.at(0);for(const g of n.line.slice(1)){const w=l.inlineEnd(f.src.box),M=l.inlineStart(g.src.box);i[g.colId].type==="table"||g.colId!==f.colId||h.toInline(M)-h.toInline(w)>c?(mt.push({...f}),f=g):(f.src.text+=g.src.text,f.src.mean=(f.src.mean+g.src.mean)/2,f.src.box=T([f.src.box,g.src.box]))}mt.push({...f})}const $=[],Nt=[],ct=[];for(const n of mt)if(n.colId===u)Nt.push(n);else{const c=ct.find(f=>f.colId===n.colId);c?c.src.push(n.src):ct.push({src:[n.src],type:i[n.colId].type,colId:n.colId})}Nt.sort((n,c)=>h.compare(l.blockStart(n.src.box),l.blockStart(c.src.box),"block"));for(const n of Nt)U(n.src);const rt=[];for(const[n,c]of $.entries()){const f=c.src,g=T(f.map(D=>D.box)),w=l.blockCenter(g),M=l.inlineSize(g);if(n===0){rt.push({smallCol:[{src:f,outerBox:g,x:w,w:M}]});continue}const C=rt.find(D=>{const E=D.smallCol.at(-1),P=l.blockSize(f.at(0).box);return l.inlineStartDis(E.outerBox,g)<3*P&&l.inlineEndDis(E.outerBox,g)<3*P&&l.blockGap(g,E.outerBox)<P*2.1});C?C.smallCol.push({src:f,outerBox:g,x:w,w:M}):rt.push({smallCol:[{src:f,outerBox:g,x:w,w:M}]})}for(const n of rt)n.smallCol.sort((c,f)=>h.compare(l.blockStart(c.outerBox),l.blockStart(f.outerBox),"block"));for(const n of ct)n.src.sort((c,f)=>h.compare(l.blockStart(c.box),l.blockStart(f.box),"block"));const Dt=[];for(const n of rt){const c=T(n.smallCol.map(g=>g.outerBox)),f=n.smallCol.flatMap(g=>g.src);Dt.push({src:f,outerBox:c,type:"none"})}Q(Dt);const it=[];for(const n of Dt){const c=it.at(-1);if(!c){it.push(n);continue}if(c.type!=="none"){it.push(n);continue}const f=c.outerBox,g=l.blockSize(n.src[0].box);c.src.length===1&&l.inlineStartDis(f,n.outerBox)<3*g||n.src.length===1&&l.inlineStartDis(f,n.outerBox)<3*g||l.inlineStartDis(f,n.outerBox)<3*g&&l.inlineEndDis(f,n.outerBox)<3*g?(c.src.push(...n.src),c.outerBox=T(c.src.map(w=>w.box))):it.push(n)}let Bt=!1;const K=[];for(const n of it){const c=K.at(-1),f={...n,reCal:!1};if(!c){K.push(f);continue}const g=l.blockSize(f.src.at(0).box);h.compare(l.blockEnd(f.outerBox),l.blockEnd(c.outerBox),"block")<0&&(l.inlineStartDis(c.outerBox,f.outerBox)<3*g||l.inlineEndDis(c.outerBox,f.outerBox)<3*g)?(c.src.push(...f.src),c.reCal=!0,Bt=!0):K.push(f)}for(const n of K)n.reCal&&(n.src.sort((c,f)=>h.compare(l.blockStart(c.box),l.blockStart(f.box),"block")),n.outerBox=T(n.src.map(c=>c.box)));ct.length&&(Bt=!0);for(const n of ct){const c=T(n.src.map(g=>g.box)),f=n.src;K.push({src:f,outerBox:c,type:n.type,reCal:!1})}Bt&&Q(K);const $t=v(o,{inline:"lr",block:"tb"}),Kt=K.map(n=>{const c=n.src,f=[];if(n.type==="auto"||n.type==="none"){const M={};for(let N=1;N<c.length;N++){const V=c[N-1].box,et=c[N].box,ot=h.disByV(l.center(et),l.center(V),"block");M[ot]||(M[ot]=0),M[ot]++}const C=Mt(c.map(N=>l.blockSize(N.box))),D=[[]];for(const N of Object.keys(M).map(V=>Number(V)).sort()){const V=D.at(-1),et=V.at(-1);et!==void 0?Math.abs(et-N)<C*.5?V.push(N):D.push([]):V.push(N)}const E=D.map(N=>Mt(N)).sort((N,V)=>N-V).at(0)||0;L("d",M,D,E),f.push([c[0]]);let P=c[0];for(let N=1;N<c.length;N++){const V=d.add(d.add(l.inlineStartCenter(P.box),d.numMup(r.block,E)),d.numMup(r.inline,-l.inlineStartDis(P.box,n.outerBox))),et=l.inlineStartCenter(c[N].box),ot=l.blockSize(c[N].box);if(l.inlineEndDis(P.box,n.outerBox)>2*ot||_(V,et)>ot*.5)f.push([c[N]]);else{const Ut=f.at(-1);Ut?Ut.push(c[N]):f.push([c[N]])}P=c[N]}}else(n.type==="table"||n.type==="raw"||n.type==="raw-blank")&&f.push(c);for(const M of c)$t.b(M.box);$t.b(n.outerBox);const g=[];for(const[M,C]of qt.entries())g[C]=M;const w=A(g);for(const M of c)M.box=w(M.box);return n.outerBox=w(n.outerBox),L(f),{src:c,outerBox:n.outerBox,parragraphs:f.map(M=>({src:M,parse:Ct(M)}))}}),Vn=Kt.flatMap(n=>n.parragraphs.map(c=>c.parse));let nt=0;return o.inline==="lr"&&(nt=z.inline),o.inline==="rl"&&(nt=z.inline-180),o.block==="lr"&&(nt=z.block),o.block==="rl"&&(nt=z.block-180),L("angle",nt),{columns:Kt,parragraphs:Vn,readingDir:o,angle:{reading:z,angle:nt}}}function Mt(t){return t.reduce((e,s)=>e+s,0)/t.length}function jt(t){const e=t.map(o=>o[1]).reduce((o,a)=>o+a,0);let s=0;for(const o of t)s+=o[0]*o[1]/e;return s}function ft(t){return(t%360+360)%360}function kt(t,e){const s=ft(e);if(s===0)return t;if(![90,180,270].includes(s))throw new Error("只支持90度的旋转");const o=new Uint8ClampedArray(t.height*t.width*4);for(let i=0;i<t.height;i++)for(let u=0;u<t.width;u++){const m=i*t.width+u,h=s===90?u*t.height+(t.height-i-1):s===180?t.width-u-1+(t.height-i-1)*t.width:(t.width-u-1)*t.height+i;o.set(t.data.slice(m*4,m*4+4),h*4)}const a=s===90||s===270?t.height:t.width,r=s===90||s===270?t.width:t.height;return at(o,a,r)}function An(t,e="",s,o,a){if(!j)return;const i=document.querySelector(`#${o}`).getContext("2d");i.beginPath(),i.strokeStyle=s,i.moveTo(t[0][0],t[0][1]),i.lineTo(t[1][0],t[1][1]),i.lineTo(t[2][0],t[2][1]),i.lineTo(t[3][0],t[3][1]),i.lineTo(t[0][0],t[0][1]),i.stroke(),i.strokeStyle="black",i.strokeText(e,t[0][0],t[0][1])}B.analyzeLayout=Ft,B.det=dn,B.init=hn,B.initDet=Rt,B.initDocDirCls=zt,B.initRec=Lt,B.loadImg=Ot,B.ocr=fn,B.rec=xn,B.rotateImg=kt,B.setOCREnv=_t,B.warpDet=gn,Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})}));
