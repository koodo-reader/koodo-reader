function __awaiter(e,o,s,l){return new(s=s||Promise)(function(r,t){function i(e){try{a(l.next(e))}catch(e){t(e)}}function n(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(i,n)}a((l=l.apply(e,o||[])).next())})}const convertStyleNum=e=>e?parseFloat(e+""):0,convertComputedNum=e=>parseFloat(e.substring(0,e.length-2)),handleIframeHeight=(e,n,a,o)=>__awaiter(void 0,void 0,void 0,function*(){let t=a.contentDocument;if(t)if(yield Promise.all(Array.from([...t.images,...t.querySelectorAll("image")]).map(t=>t.complete?Promise.resolve(0!==t.naturalHeight):new Promise(e=>{t.addEventListener("load",()=>e(!0)),t.addEventListener("error",()=>e(!1))}))).then(e=>{e.every(e=>e)?console.log("all images loaded successfully!!"):console.log("some images failed to load, all finished loading")}),yield handleImageSize(e,n,o),"PDF"!==o&&handleTextStyle(),"scroll"!==n){if(a.height=e.clientHeight+"px","double"===n){var r=Math.floor(e.clientWidth/12),i=r%2==0?r:r-1,r=(e.clientWidth+i)/2;if((t.body.scrollWidth-t.body.clientWidth)/r%2==1){let e=document.createElement("div");e.setAttribute("style","height: "+t.body.clientHeight+"px; display: inline-block; width: "+(r-i)+"px"),t.body.appendChild(e)}}}else if("PDF"===o){let e=t.querySelector(".docLayer");a.height=e.getBoundingClientRect().height+100+"px"}else a.height=t.body.scrollHeight+"px",a.height=t.body.scrollHeight+300+"px"}),handleOneChapterDoc=r=>__awaiter(void 0,void 0,void 0,function*(){let t="";if(r.load){let e=yield fetch(yield r.load()).then(e=>e.blob());t=yield e.text()}return r.loadAsset&&(t=yield handlePrecacheAssets(t,r.loadAsset)),handleImageMarker(t)}),getImageElement=e=>Array.from(e.querySelectorAll("img, image")),handlePrecacheAssets=(n,a)=>__awaiter(void 0,void 0,void 0,function*(){let e=(new DOMParser).parseFromString(n,"text/html"),t=getImageElement(e);for(let e=0;e<t.length;e++)t[e].getAttribute("src")&&(t[e].src=yield a(t[e].getAttribute("src")));var r=Array.from(e.getElementsByTagName("link"));for(let e=0;e<r.length;e++){const i=r[e];i.getAttribute("href")&&(i.href=yield a(i.getAttribute("href")))}return e.documentElement.innerHTML}),handleImageMarker=e=>{var t=(new DOMParser).parseFromString(e,"text/html");let r=getImageElement(t);if(0===r.length)return e;for(let e=0;e<r.length;e++){var i=document.createElement("address"),n=document.createTextNode("img");i.appendChild(n),i.setAttribute("style","visibility: hidden; position: absolute"),r[e].parentNode&&r[e].parentNode.insertBefore(i,r[e])}return t.documentElement.innerHTML},createIframe=(e,t=0)=>{var r=document.createElement("iframe");r.style.width="100%",r.style.border="0",r.style.margin="0",r.style.padding="0",r.style.minHeight="calc(100% - 2px)",r.style.fontSize="100%",r.style.font="inherit",r.scrolling="no",r.tabIndex=0,r.style.verticalAlign="baseline",e.innerHTML="",e.appendChild(r)},progressInfo=r=>__awaiter(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){t=t.contentDocument;if(t)return 1===parseInt(t.body.scrollWidth/t.body.clientWidth+"")&&(yield new Promise(e=>setTimeout(e,1e3))),{totalPage:"scroll"===r?1:parseInt(t.body.scrollWidth/t.body.clientWidth+"")+1,currentPage:parseInt(convertStyleNum(t.body.scrollLeft)/t.body.clientWidth+"")+1}}}}),handleTextStyle=()=>{let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){let e=t.contentDocument;if(e){var r=e.querySelectorAll("a, article, cite, div, li, p, span, pre, table, bold, body");for(let e=0;e<r.length;e++){const i=r[e];-1===i.className.indexOf("kookit-text")&&(i.className=i.className+" kookit-text")}}}}},getImageMeta=t=>__awaiter(void 0,void 0,void 0,function*(){const e=new Image;return e.src=t,yield e.decode(),e}),handleImageSize=(c,d,h)=>__awaiter(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){let n=t.contentDocument;if(n){var a,t=Math.floor(c.clientWidth/12),o=t%2==0?t:t-1;for(a of n.querySelectorAll("img, image")){var s,l=a.parentElement;let e=0,t=0,r=a.naturalWidth,i=a.naturalHeight;"image"===a.tagName&&(s=yield getImageMeta(a.getAttribute("xlink:href")),r=s.naturalWidth,i=s.naturalHeight),h.startsWith("CB")&&"scroll"===d?t=l.offsetWidth:h.startsWith("CB")&&"single"===d?(e=c.clientHeight,t=c.clientWidth):r&&i?(i/r>l.clientHeight/l.clientWidth?(e=l.clientHeight,t=parseInt(e*r/i+"")):(t=l.clientWidth,e=parseInt(t*i/r+"")),e>n.body.clientHeight&&(t=parseInt(t*(n.body.clientHeight/e)+""),e=n.body.clientHeight)):e=l&&l.clientWidth&&0<l.clientWidth?(t=l.clientWidth,l.clientHeight):(t=c.clientWidth,c.clientHeight),t=t?Math.min("scroll"===d||"single"===d?c.clientWidth:(c.clientWidth-o)/2,t):"scroll"===d||"single"===d?c.clientWidth:(c.clientWidth-o)/2,r&&i&&(r>i||e/t>i/r?e=t*(i/r):t=e*(r/i)),(t||e)&&a.setAttribute("style",a.getAttribute("style")+";"+`max-width: ${0<t?t+"px":""};max-height:${0<e?e+"px":""}; margin: 0 auto; ${h.startsWith("CB")?"display: block; margin-left: auto; margin-right: auto;":""}`)}}}}}),handleLayout=(r,i)=>{let e=document.getElementById("page-area");if(e){var n=e.getElementsByTagName("iframe")[0];if(n){let t=n.contentDocument;if(t){let e=t.createElement("style");e.id="default-style",e.textContent="p,empty-line{display: inherit;margin-block-start: inherit;margin-block-end: inherit;margin-inline-start: inherit;margin-inline-end: inherit;}body{margin: 0px}",t.head.appendChild(e),"scroll"!==i&&(n="double"===i?2:1,i=(i=Math.floor(r.clientWidth/12))%2==0?i:i-1,t.body.setAttribute("style",`width: auto;height: 100%;overflow-y: hidden;overflow-X: hidden;padding-left: 0px;padding-right: 0px;margin: 0px;box-sizing: border-box;max-width: inherit;column-fill: auto;column-gap: ${i}px; column-width: ${(r.clientWidth-i)/n}px;`))}}}};class GeneralParser{constructor(e){this.book=e,this.chapterList=[],this.flattenChapters=[],this.chapterDocList=[]}getChapter(e){return __awaiter(this,void 0,void 0,function*(){return this.chapterList=e?yield Promise.all(e.map(t=>__awaiter(this,void 0,void 0,function*(){let e=-1;try{e=t.href&&(yield this.book.resolveHref(t.href))?(yield this.book.resolveHref(t.href)).index:-1}catch(e){console.log(e)}return{label:t.label||e,href:t.href||"title"+e,index:e,subitems:t.subitems?yield this.getChapter(t.subitems):[]}}))):yield Promise.all(this.book.sections.map((e,t)=>__awaiter(this,void 0,void 0,function*(){return{label:e.label||t,href:e.href||"title"+t,index:t,subitems:e.subitems?yield this.getChapter(e.subitems):[]}}))),this.flattenChapters=this.flatChapter(this.chapterList),this.chapterList})}getChapterDoc(){return __awaiter(this,void 0,void 0,function*(){const r=this.flattenChapters.map(e=>e.index);return this.book.sections.map((e,t)=>-1<r.indexOf(t)?{label:this.flattenChapters[r.indexOf(t)].label,href:this.flattenChapters[r.indexOf(t)].href,text:e}:{label:"",href:"",text:e})})}flatChapter(t){let r=[];for(let e=0;e<t.length;e++)t[e].subitems&&0<t[e].subitems.length?(r.push(t[e]),r=r.concat(this.flatChapter(t[e].subitems))):r.push(t[e]);return r}getMetadata(){return new Promise((n,a)=>__awaiter(this,void 0,void 0,function*(){const t=this.book.metadata;try{var e=yield this.book.getCover(),r=new FileReader;r.readAsDataURL(e),r.onloadend=()=>{n({name:t.title,author:t.author?t.author[0].name:"",description:t.description,publisher:t.publisher,cover:r.result})}}catch(e){try{var i=t.author&&t.author[0]&&t.author[0].name?t.author[0].name:t.author&&t.author[0]?t.author[0]:t.author||"";n({name:t.title,author:i,description:t.description,publisher:t.publisher,cover:""})}catch(e){console.log(e),a(e)}}}))}}const findIndices=(e,i)=>e.map((e,t,r)=>i(e,t,r)?t:null).filter(e=>null!=e),splitAt=(i,e)=>[-1,...e,i.length].reduce(({xs:e,a:t},r)=>({xs:e?.concat([i.slice(t+1,r)])??[],a:r}),{}).xs,concatArrays=(e,t)=>e.slice(0,-1).concat([e[e.length-1].concat(t[0])]).concat(t.slice(1)),isNumber=/\d/,isCFI=/^epubcfi\((.*)\)$/,escapeCFI=e=>e.replace(/[\^[\](),;=]/g,"^$&"),wrap=e=>isCFI.test(e)?e:`epubcfi(${e})`,unwrap=e=>e.match(isCFI)?.[1]??e,tokenizer=e=>{const t=[];let r,i,n="";var a=e=>(t.push(e),r=null,n=""),o=e=>(n+=e,i=!1);for(const s of Array.from(e.trim()).concat(""))if("^"!==s||i){if("!"===r)a(["!"]);else if(","===r)a([","]);else if("/"===r||":"===r){if(isNumber.test(s)){o(s);continue}a([r,parseInt(n)])}else if("~"===r){if(isNumber.test(s)||"."===s){o(s);continue}a(["~",parseFloat(n)])}else if("@"===r){if(":"===s){a(["@",parseFloat(n)]),r="@";continue}if(isNumber.test(s)||"."===s){o(s);continue}a(["@",parseFloat(n)])}else{if("["===r){";"!==s||i?","!==s||i?"]"!==s||i?o(s):a(["[",n]):(a(["[",n]),r="["):(a(["[",n]),r=";");continue}if(r?.startsWith(";")){"="!==s||i?";"!==s||i?"]"!==s||i?o(s):a([r,n]):(a([r,n]),r=";"):(r=`;${n}`,n="");continue}}"/"!==s&&":"!==s&&"~"!==s&&"@"!==s&&"["!==s&&"!"!==s&&","!==s||(r=s)}else i=!0;return t},findTokens=(e,t)=>findIndices(e,([e])=>e===t),parser=e=>{const t=[];let r;for(var[i,n]of e){if("/"===i)t.push({index:n});else{const a=t[t.length-1];if(":"===i)a.offset=n;else if("~"===i)a.temporal=n;else if("@"===i)a.spatial=(a.spatial??[]).concat(n);else if(";s"===i)a.side=n;else if("["===i){if("/"!==r||!n){a.text=(a.text??[]).concat(n);continue}a.id=n}}r=i}return t},parserIndir=e=>splitAt(e,findTokens(e,"!")).map(parser),parse=e=>{var t=tokenizer(unwrap(e)),r=findTokens(t,",");if(!r.length)return parserIndir(t);var[e,t,r]=splitAt(t,r).map(parserIndir);return{parent:e,start:t,end:r}},partToString=({index:e,id:t,offset:r,temporal:i,spatial:n,text:a,side:o})=>{var s=o?`;s=${o}`:"";return`/${e}`+(t?`[${escapeCFI(t)}${s}]`:"")+(null!=r&&e%2?`:${r}`:"")+(i?`~${i}`:"")+(n?`@${n.join(":")}`:"")+(a||!t&&o?"["+(a?.map(escapeCFI)?.join(",")??"")+s+"]":"")},toInnerString=e=>e.parent?[e.parent,e.start,e.end].map(toInnerString).join(","):e.map(e=>e.map(partToString).join("")).join("!"),toString=e=>wrap(toInnerString(e)),collapse=(e,t)=>"string"==typeof e?toString(collapse(parse(e),t)):e.parent?concatArrays(e.parent,e[t?"end":"start"]):e,isTextNode=({nodeType:e})=>3===e||4===e,isElementNode=({nodeType:e})=>1===e,indexChildNodes=e=>{const t=Array.from(e.childNodes).filter(e=>isTextNode(e)||isElementNode(e)).reduce((e,t)=>{let r=e[e.length-1];return r?isTextNode(t)?Array.isArray(r)?r.push(t):isTextNode(r)?e[e.length-1]=[r,t]:e.push(t):isElementNode(r)?e.push(null,t):e.push(t):e.push(t),e},[]);return isElementNode(t[0])&&t.unshift("first"),isElementNode(t[t.length-1])&&t.push("last"),t.unshift("before"),t.push("after"),t},getNodeByIndex=(e,t)=>e?indexChildNodes(e)[t]:null,partsToNode=(e,t)=>{var r,i=t[t.length-1]["id"];if(i){i=e.ownerDocument.getElementById(i);if(i)return{node:i,offset:0}}for({index:r}of t){var n=getNodeByIndex(e,r);if("first"===n)return{node:e.firstChild??e};if("last"===n)return{node:e.lastChild??e};if("before"===n)return{node:e,before:!0};if("after"===n)return{node:e,after:!0};e=n}var a=t[t.length-1]["offset"];if(!Array.isArray(e))return{node:e,offset:a};let o=0;for(const l of e){var s=l.nodeValue["length"];if(o+s>=a)return{node:l,offset:a-o};o+=s}},nodeToParts=(t,r)=>{var{parentNode:e,id:i}=t;const n=indexChildNodes(e);var a=n.findIndex(e=>Array.isArray(e)?e.some(e=>e===t):e===t),o=n[a];if(Array.isArray(o)){let e=0;for(const s of o){if(s===t){e+=r;break}e+=s.nodeValue.length}r=e}a={id:i,index:a,offset:r};return e!==t.ownerDocument.documentElement?nodeToParts(e).concat(a):[a]},toRange=(e,t)=>{var r=collapse(t),i=collapse(t,!0),t=e.documentElement,r=partsToNode(t,r[0]),i=partsToNode(t,i[0]);const n=e.createRange();return r.before?n.setStartBefore(r.node):r.after?n.setStartAfter(r.node):n.setStart(r.node,r.offset),i.before?n.setEndBefore(i.node):i.after?n.setEndAfter(i.node):n.setEnd(i.node,i.offset),n},fromElements=e=>{const t=[];var r,i,n=e[0]["parentNode"];const a=nodeToParts(n);for([r,i]of indexChildNodes(n).entries()){var o=e[t.length];i===o&&t.push(toString([a.concat({id:o.id,index:r})]))}return t},toElement=(e,t)=>partsToNode(e.documentElement,collapse(t)).node,NS$1={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",DCTERMS:"http://purl.org/dc/terms/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},MIME$2={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},camel=e=>e.toLowerCase().replace(/[-:](.)/g,(e,t)=>t.toUpperCase()),whitespacePreLine=e=>e?e.trim().replace(/\s{2,}/g," "):"",filterAttribute=(t,r,e)=>e?e=>e.getAttribute(t)?.split(/\s/)?.includes(r):"function"==typeof r?e=>r(e.getAttribute(t)):e=>e.getAttribute(t)===r,getAttributes=(...e)=>t=>t?Object.fromEntries(e.map(e=>[camel(e),t.getAttribute(e)])):null,getElementText$1=e=>whitespacePreLine(e?.textContent),childGetter=(e,r)=>{e=e.lookupNamespaceURI(null)===r||e.lookupPrefix(r);const i=e?(e,t)=>e=>e.namespaceURI===r&&e.localName===t:(e,t)=>e=>e.localName===t;return{$:(e,t)=>[...e.children].find(i(e,t)),$$:(e,t)=>[...e.children].filter(i(e,t)),$$$:e?(e,t)=>[...e.getElementsByTagNameNS(r,t)]:(e,t)=>[...e.getElementsByTagName(r,t)]}},resolveURL=(t,e)=>{try{if(e.includes(":"))return new URL(t,e);var r="whatever://whatever/";return decodeURI(new URL(t,r+e).href.replace(r,""))}catch(e){return console.warn(e),t}},isExternal=e=>/^(?!blob)\w+:/i.test(e),pathRelative=(e,t)=>{if(!e)return t;const r=e.replace(/\/$/,"").split("/"),i=t.replace(/\/$/,"").split("/");t=(r.length>i.length?r:i).findIndex((e,t)=>r[t]!==i[t]);return t<0?"":Array(r.length-t).fill("..").concat(i.slice(t)).join("/")},pathDirname=e=>e.slice(0,e.lastIndexOf("/")+1),replaceSeries$1=async(e,t,r)=>{const i=[];e.replace(t,(...e)=>(i.push(e),null));const n=[];for(const a of i)n.push(await r(...a));return e.replace(t,()=>n.shift())},regexEscape=e=>e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),LANGS={attrs:["dir","xml:lang"]},ALTS={name:"alternate-script",many:!0,...LANGS,props:["file-as"]},CONTRIB={many:!0,...LANGS,props:[{name:"role",many:!0,attrs:["scheme"]},"file-as",ALTS]},METADATA=[{name:"title",many:!0,...LANGS,props:["title-type","display-seq","file-as",ALTS]},{name:"identifier",many:!0,props:[{name:"identifier-type",attrs:["scheme"]}]},{name:"language",many:!0},{name:"creator",...CONTRIB},{name:"contributor",...CONTRIB},{name:"publisher",...LANGS,props:["file-as",ALTS]},{name:"description",...LANGS,props:[ALTS]},{name:"rights",...LANGS,props:[ALTS]},{name:"date"},{name:"dcterms:modified",type:"meta"},{name:"subject",many:!0,...LANGS,props:["term","authority",ALTS]},{name:"belongs-to-collection",type:"meta",many:!0,...LANGS,props:["collection-type","group-position","dcterms:identifier","file-as",ALTS,{name:"belongs-to-collection",recursive:!0}]}],getMetadata=e=>{const{$:t,$$:r}=childGetter(e,NS$1.OPF),i=t(e.documentElement,"metadata"),a=Array.from(i.children),l=(o,t)=>{if(!t)return null;const{props:e=[],attrs:r=[]}=o,i=getElementText$1(t);if(!e.length&&!r.length)return i;var n=t.getAttribute("id");const s=n?a.filter(filterAttribute("refines","#"+n)):[];return Object.fromEntries([["value",i]].concat(e.map(e=>{var{many:t,recursive:r}=e,i="string"==typeof e?e:e.name,n=filterAttribute("property",i);const a=r?o:e;return[camel(i),t?s.filter(n).map(e=>l(a,e)):l(a,s.find(n))]})).concat(r.map(e=>[camel(e),t.getAttribute(e)])))},o=a.filter(filterAttribute("refines",null));e=t=>Object.fromEntries(r(i,"meta").filter(filterAttribute("property",e=>e?.startsWith(t))).map(e=>[e.getAttribute("property").replace(t,""),getElementText$1(e)]));return{metadata:Object.fromEntries(METADATA.map(t=>{const{type:e,name:r,many:i}=t;var n="meta"===e?e=>e.namespaceURI===NS$1.OPF&&e.getAttribute("property")===r:e=>e.namespaceURI===NS$1.DC&&e.localName===r;return[camel(r),i?o.filter(n).map(e=>l(t,e)):l(t,o.find(n))]})),rendition:e("rendition:"),media:e("media:")}},parseNav=(e,a=e=>e)=>{const{$:o,$$:r,$$$:t}=childGetter(e,NS$1.XHTML),i=n=>e=>{const t=o(e,"a")??o(e,"span");var r=o(e,"ol"),e=(e=t?.getAttribute("href"))?decodeURI(a(e)):null;const i={label:getElementText$1(t)||t?.getAttribute("title"),href:e,subitems:s(r)};return n&&(i.type=t?.getAttributeNS(NS$1.EPUB,"type")?.split(/\s/)),i},s=(e,t)=>e?r(e,"li").map(i(t)):null;var n=(e,t)=>s(o(e,"ol"),t);let l=null,c=null,d=null,h=[];for(const u of t(e,"nav")){const f=u.getAttributeNS(NS$1.EPUB,"type")?.split(/\s/)??[];f.includes("toc")?l??=n(u):f.includes("page-list")?c??=n(u):f.includes("landmarks")?d??=n(u,!0):h.push({label:getElementText$1(u.firstElementChild),type:f,list:n(u)})}return{toc:l,pageList:c,landmarks:d,others:h}},parseNCX=(r,a=e=>e)=>{const{$:o,$$:s}=childGetter(r,NS$1.NCX),l=e=>{var t=o(e,"navLabel");const r=o(e,"content");var i=getElementText$1(t),t=(t=r.getAttribute("src"))?decodeURI(a(t)):null;if("navPoint"!==e.localName)return{label:i,href:t};{const n=s(e,"navPoint");return{label:i,href:t,subitems:n.length?n.map(l):null}}},i=(e,t)=>s(e,t).map(l);var e=(e,t)=>{e=o(r.documentElement,e);return e?i(e,t):null};return{toc:e("navMap","navPoint"),pageList:e("pageList","pageTarget"),others:s(r.documentElement,"navList").map(e=>({label:getElementText$1(o(e,"navLabel")),list:i(e,"navTarget")}))}},parseClock=e=>{if(e){var t=e.split(":").map(e=>parseFloat(e));if(3===t.length){var[r,i,n]=t;return 60*r*60+60*i+n}if(2===t.length){var[t,a]=t;return 60*t+a}var[a,e]=e.split(/(?=[^\d.])/);return parseFloat(a)*("h"===e?3600:"min"===e?60:"ms"===e?.001:1)}},parseSMIL=(e,i=e=>e)=>{const{$:n,$$$:t}=childGetter(e,NS$1.SMIL);return t(e,"par").map(e=>{var t=n(e,"text")?.getAttribute("src")?.split("#")?.[1];const r=n(e,"audio");return r?{id:t,audio:{src:(e=r.getAttribute("src"))?decodeURI(i(e)):null,clipBegin:parseClock(r.getAttribute("clipBegin")),clipEnd:parseClock(r.getAttribute("clipEnd"))}}:{id:t}})},isUUID=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,getUUID=e=>{for(const r of e.getElementsByTagNameNS(NS$1.DC,"identifier")){var[t]=getElementText$1(r).split(":").slice(-1);if(isUUID.test(t))return t}return""},getIdentifier=e=>getElementText$1(e.getElementById(e.documentElement.getAttribute("unique-identifier"))??e.getElementsByTagNameNS(NS$1.DC,"identifier")[0]),deobfuscate=async(e,t,r)=>{const i=new Uint8Array(await r.slice(0,t).arrayBuffer());t=Math.min(t,i.length);for(var n=0;n<t;n++)i[n]=i[n]^e[n%e.length];return new Blob([i,r.slice(t)],{type:r.type})},WebCryptoSHA1=async e=>{e=(new TextEncoder).encode(e),e=await globalThis.crypto.subtle.digest("SHA-1",e);return new Uint8Array(e)},deobfuscators=(t=WebCryptoSHA1)=>({"http://www.idpf.org/2008/embedding":{key:e=>t(getIdentifier(e).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(e,t)=>deobfuscate(e,1040,t)},"http://ns.adobe.com/pdf/enc#RC":{key:e=>{const r=getUUID(e).replaceAll("-","");return Uint8Array.from({length:16},(e,t)=>parseInt(r.slice(2*t,2*t+2),16))},decode:(e,t)=>deobfuscate(e,1024,t)}});class Encryption{#uris=new Map;#decoders=new Map;#algorithms;constructor(e){this.#algorithms=e}async init(e,t){var r,i;if(e)for({algorithm:r,uri:i}of Array.from(e.getElementsByTagNameNS(NS$1.ENC,"EncryptedData"),e=>({algorithm:e.getElementsByTagNameNS(NS$1.ENC,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:e.getElementsByTagNameNS(NS$1.ENC,"CipherReference")[0]?.getAttribute("URI")}))){if(!this.#decoders.has(r)){const n=this.#algorithms[r];if(!n){console.warn("Unknown encryption algorithm");continue}const a=await n.key(t);this.#decoders.set(r,e=>n.decode(a,e))}this.#uris.set(i,r)}}getDecoder(e){return this.#decoders.get(this.#uris.get(e))??(e=>e)}}class Resources{constructor({opf:e,resolveHref:i}){this.opf=e;const{$:t,$$:r,$$$:n}=childGetter(e,NS$1.OPF);var a=t(e.documentElement,"manifest");const o=t(e.documentElement,"spine"),s=r(o,"itemref");this.manifest=r(a,"item").map(getAttributes("href","id","media-type","properties","media-overlay")).map(e=>(e.href=i(e.href),e.properties=e.properties?.split(/\s/),e)),this.spine=s.map(getAttributes("idref","id","linear","properties")).map(e=>(e.properties=e.properties?.split(/\s/),e)),this.pageProgressionDirection=o.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(o.getAttribute("toc"))??this.manifest.find(e=>e.mediaType===MIME$2.NCX))?.href;a=t(e.documentElement,"guide");a&&(this.guide=r(a,"reference").map(getAttributes("type","title","href")).map(({type:e,title:t,href:r})=>({label:t,type:e.split(/\s/),href:i(r)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(n(e,"meta").find(filterAttribute("name","cover"))?.getAttribute("content"))??this.getItemByHref(this.guide?.find(e=>e.type.includes("cover"))?.href),this.cfis=fromElements(s)}getItemByID(t){return this.manifest.find(e=>e.id===t)}getItemByHref(t){return this.manifest.find(e=>e.href===t)}getItemByProperty(t){return this.manifest.find(e=>e.properties?.includes(t))}resolveCFI(e){const t=parse(e),r=(t.parent??t).shift();let i=toElement(this.opf,r);i&&"idref"!==i.nodeName&&(r.at(-1).id=null,i=toElement(this.opf,r));const n=i?.getAttribute("idref");return{index:this.spine.findIndex(e=>e.idref===n),anchor:e=>toRange(e,t)}}}class Loader{#cache=new Map;#children=new Map;#refCount=new Map;allowScript=!1;constructor({loadText:e,loadBlob:t,resources:r}){this.loadText=e,this.loadBlob=t,this.manifest=r.manifest,this.assets=r.manifest}createURL(e,t,r,i){if(!t)return"";r=URL.createObjectURL(new Blob([t],{type:r}));if(this.#cache.set(e,r),this.#refCount.set(e,1),i){const n=this.#children.get(i);n?n.push(e):this.#children.set(i,[e])}return r}ref(e,t){const r=this.#children.get(t);return r?.includes(e)||(this.#refCount.set(e,this.#refCount.get(e)+1),r?r.push(e):this.#children.set(t,[e])),this.#cache.get(e)}unref(e){if(this.#refCount.has(e)){var t=this.#refCount.get(e)-1;if(t<1){URL.revokeObjectURL(this.#cache.get(e)),this.#cache.delete(e),this.#refCount.delete(e);const r=this.#children.get(e);if(r)for(;r.length;)this.unref(r.pop());this.#children.delete(e)}else this.#refCount.set(e,t)}}async loadItem(e,t=[]){if(!e)return null;const{href:r,mediaType:i}=e;var n=MIME$2.JS.test(e.mediaType);if(n&&!this.allowScript)return null;var a=t.at(-1);return this.#cache.has(r)?this.ref(r,a):(n||[MIME$2.XHTML,MIME$2.HTML,MIME$2.CSS,MIME$2.SVG].includes(i))&&t.every(e=>e!==r)?this.loadReplaced(e,t):this.createURL(r,await this.loadBlob(r),i,a)}async loadHref(e,t,r=[]){if(isExternal(e))return e;const i=resolveURL(e,t);let n=this.manifest.find(e=>e.href===i);return n=n||{href:i,mediaType:""},this.loadItem(n,r.concat(t))}async loadReplaced(e,n=[]){const{href:a,mediaType:r}=e;var i,o=n.at(-1),s=await this.loadText(a);if(!s)return null;if([MIME$2.XHTML,MIME$2.HTML,MIME$2.SVG].includes(r)){let t=(new DOMParser).parseFromString(s,r);if(r===MIME$2.XHTML&&t.querySelector("parsererror")&&(console.warn(t.querySelector("parsererror").innerText),e.mediaType=MIME$2.HTML,t=(new DOMParser).parseFromString(s,e.mediaType)),[MIME$2.XHTML,MIME$2.SVG].includes(e.mediaType)){let e=t.firstChild;for(;e instanceof ProcessingInstruction;)e.data&&(i=await replaceSeries$1(e.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(e,t,r,i)=>this.loadHref(r,a,n).then(e=>`${t}${e}${i}`)),e.replaceWith(t.createProcessingInstruction(e.target,i))),e=e.nextSibling}var l=async(e,t)=>e.setAttribute(t,await this.loadHref(e.getAttribute(t),a,n));for(const d of t.querySelectorAll("link[href]"))await l(d,"href");for(const h of t.querySelectorAll("[src]"))await l(h,"src");for(const u of t.querySelectorAll("[poster]"))await l(u,"poster");for(const f of t.querySelectorAll("object[data]"))await l(f,"data");for(const m of t.querySelectorAll("[*|href]:not([href]"))m.setAttributeNS(NS$1.XLINK,"href",await this.loadHref(m.getAttributeNS(NS$1.XLINK,"href"),a,n));for(const g of t.querySelectorAll("style"))g.textContent&&(g.textContent=await this.replaceCSS(g.textContent,a,n));for(const p of t.querySelectorAll("[style]"))p.setAttribute("style",await this.replaceCSS(p.getAttribute("style"),a,n));const c=(new XMLSerializer).serializeToString(t);return this.createURL(a,c,e.mediaType,o)}const c=r===MIME$2.CSS?await this.replaceCSS(s,a,n):await this.replaceString(s,a,n);return this.createURL(a,c,r,o)}async replaceCSS(e,r,i=[]){e=await replaceSeries$1(e,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(e,t)=>this.loadHref(t,r,i).then(e=>`url("${e}")`));const t=await replaceSeries$1(e,/@import\s*["']([^"'\n]*?)["']/gi,(e,t)=>this.loadHref(t,r,i).then(e=>`@import "${e}"`)),n=window?.innerWidth??800,a=window?.innerHeight??600;return t.replace(/-epub-/gi,"").replace(/(\d*\.?\d+)vw/gi,(e,t)=>parseFloat(t)*n/100+"px").replace(/(\d*\.?\d+)vh/gi,(e,t)=>parseFloat(t)*a/100+"px").replace(/page-break-(after|before|inside)/gi,(e,t)=>`-webkit-column-break-${t}`)}replaceString(e,o,t=[]){const s=new Map,r=this.assets.map(e=>{if(e.href!==o){var t=pathRelative(pathDirname(o),e.href),r=encodeURI(t),i="/"+e.href,n=encodeURI(i),n=new Set([t,r,i,n]);for(const a of n)s.set(a,e);return Array.from(n)}}).flat().filter(e=>e);if(!r.length)return e;var i=new RegExp(r.map(regexEscape).join("|"),"g");return replaceSeries$1(e,i,async e=>this.loadItem(s.get(e.replace(/^\//,"")),t.concat(o)))}unloadItem(e){this.unref(e?.href)}}const getHTMLFragment=(e,t)=>e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`),getPageSpread$1=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};class EPUB{parser=new DOMParser;#encryption;constructor({loadText:e,loadBlob:t,getSize:r,sha1:i}){this.loadText=e,this.loadBlob=t,this.getSize=r,this.#encryption=new Encryption(deobfuscators(i))}#parseXML(e){return e?this.parser.parseFromString(e,MIME$2.XML):null}async#loadXML(e){return this.#parseXML(await this.loadText(e))}async init(){const e=await this.#loadXML("META-INF/container.xml");if(!e)throw new Error("Failed to load container file");var t=Array.from(e.getElementsByTagNameNS(NS$1.CONTAINER,"rootfile"),getAttributes("full-path","media-type")).filter(e=>"application/oebps-package+xml"===e.mediaType);if(!t.length)throw new Error("No package document defined in container");const r=t[0].fullPath;var i=await this.#loadXML(r);if(!i)throw new Error("Failed to load package document");t=await this.#loadXML("META-INF/encryption.xml");await this.#encryption.init(t,i),this.resources=new Resources({opf:i,resolveHref:e=>resolveURL(e,r)});const a=new Loader({loadText:this.loadText,loadBlob:e=>Promise.resolve(this.loadBlob(e)).then(this.#encryption.getDecoder(e)),resources:this.resources});this.sections=this.resources.spine.map((e,t)=>{var{idref:r,linear:i,properties:e=[]}=e;const n=this.resources.getItemByID(r);return n?{id:this.resources.getItemByID(r)?.href,load:()=>a.loadItem(n),unload:()=>a.unloadItem(n),createDocument:()=>this.loadDocument(n),size:this.getSize(n.href),cfi:this.resources.cfis[t],linear:i,pageSpread:getPageSpread$1(e),resolveHref:e=>resolveURL(e,n.href),loadMediaOverlay:()=>this.loadMediaOverlay(n)}:(console.warn(`Could not find item with ID "${r}" in manifest`),null)}).filter(e=>e);const{navPath:n,ncxPath:o}=this.resources;if(n)try{var s=parseNav(await this.#loadXML(n),e=>resolveURL(e,n));this.toc=s.toc,this.pageList=s.pageList,this.landmarks=s.landmarks}catch(e){console.warn(e)}if(!this.toc&&o)try{var l=parseNCX(await this.#loadXML(o),e=>resolveURL(e,o));this.toc=l.toc,this.pageList=l.pageList}catch(e){console.warn(e)}this.landmarks??=this.resources.guide;const{metadata:c,rendition:d,media:h}=getMetadata(i);this.rendition=d,this.media=h,h.duration=parseClock(h.duration),this.dir=this.resources.pageProgressionDirection,this.rawMetadata=c;l=c?.title?.[0];this.metadata={title:l?.value,sortAs:l?.fileAs,language:c?.language,identifier:getIdentifier(i),description:c?.description?.value,publisher:c?.publisher?.value,published:c?.date,modified:c?.dctermsModified,subject:c?.subject?.filter(({value:e,code:t})=>e||t)?.map(({value:e,code:t,scheme:r})=>({name:e,code:t,scheme:r})),rights:c?.rights?.value};const u={art:"artist",aut:"author",bkp:"producer",clr:"colorist",edt:"editor",ill:"illustrator",trl:"translator",pbl:"publisher"};i=r=>e=>{var t=[...new Set(e.role?.map(({value:e,scheme:t})=>(t&&"marc:relators"!==t?null:u[e])??r))],e={name:e.value,sortAs:e.fileAs};return[t.length?t:[r],e]};return c?.creator?.map(i("author"))?.concat(c?.contributor?.map?.(i("contributor")))?.forEach(([e,t])=>e.forEach(e=>{this.metadata[e]?this.metadata[e].push(t):this.metadata[e]=[t]})),this}async loadDocument(e){var t=await this.loadText(e.href);return this.parser.parseFromString(t,e.mediaType)}async loadMediaOverlay(e){e=e.mediaOverlay;if(!e)return null;const t=this.resources.getItemByID(e);e=await this.#loadXML(t.href);return parseSMIL(e,e=>resolveURL(e,t.href))}resolveCFI(e){return this.resources.resolveCFI(e)}resolveHref(e){const[t,r]=e.split("#"),i=this.resources.getItemByHref(decodeURI(t));return i?{index:this.resources.spine.findIndex(({idref:e})=>e===i.id),anchor:r?e=>getHTMLFragment(e,r):()=>0}:null}splitTOCHref(e){return e?.split("#")??[]}getTOCFragment(e,t){return e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`)}isExternal(e){return isExternal(e)}async getCover(){var e=this.resources?.cover;return e?.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){const e=await this.loadText("META-INF/calibre_bookmarks.txt");var t="encoding=json+base64:";if(e?.startsWith(t)){t=atob(e.slice(t.length));return JSON.parse(t)}}}let lock=!1;const getBlockElement=e=>Array.from(e.querySelectorAll("h1,h2,h3,h4,h5,h6,p,div,ul,dl,ol,pre,blockquote,address")),cleanText$1=e=>e.trim().replace(/(\r\n|\n|\r|\t)/gm,"").substring(0,100),handleScrollPage=(i,n,a,o,s,l,c,d,h)=>__awaiter(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t,r=e.getElementsByTagName("iframe")[0];if(r){let e=r.contentDocument;e&&(r=(t=Math.floor(i.clientWidth/12))%2==0?t:t-1,t=i.clientWidth,0<c?e.body.scrollBy({top:0,left:-t-r,behavior:"sliding"===l?"smooth":"auto"}):c<0&&(yield handleTurnChapter(i,n,a,o,s,d,h),e.body.scrollBy({top:0,left:t+r,behavior:"sliding"===l?"smooth":"auto"})))}}}),findValidChapter=(e,t,r,i)=>{let n=window._.findLastIndex(r,{href:t});return n=t&&-1<window._.findLastIndex(r,{href:t})?window._.findLastIndex(r,{href:t}):e,"prev"===i?Object.assign(Object.assign({},r[n-1]),{index:n-1}):Object.assign(Object.assign({},r[n+1]),{index:n+1})},handlePrevChapter=(r,e,i,n,a,o)=>__awaiter(void 0,void 0,void 0,function*(){var e=parseInt(o.chapterDocIndex||"0"),t=o.chapterHref||"";0===e||(t=findValidChapter(e,t,i,"prev"))&&(o.text="prevChapter",o.page="",yield handleRenderChatper(t.index,t.label,t.href,i,r,n,a,o))}),getPdfScale=(o,s,l,c)=>__awaiter(void 0,void 0,void 0,function*(){var{width:e,height:t}=yield l[c].text.getDimension(),r="double"===s?2:1,i=Math.floor(o.clientWidth/12);let n=(o.clientWidth-(i%2==0?i:i-1))/r;"single"===s&&(n=o.clientWidth);r=o.clientHeight;let a=Math.min(n/e,r/t);return"scroll"===s&&(a=n/e),a}),handleRenderChatper=(i,n,a,o,s,l,c,d)=>__awaiter(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){let t=e.getElementsByTagName("iframe")[0];if(t){let e=t.contentDocument;var r;e&&(e.body.innerHTML="",t.height="0px",e.body.scrollTo(0,0),!(n&&!i||o[i]&&o[i].label&&n&&n!==o[i].label&&-1===a.indexOf("#"))||-1!==(r=window._.findLastIndex(o,{label:n}))&&(i=r),(-1===i||i>o.length-1)&&(i=0),e.body.innerHTML=yield handleOneChapterDoc(o[i].text),"PDF"===c&&(r=yield getPdfScale(s,l,o,i),yield o[i].text.render(e,r)),yield handleCssLink(e),d.chapterDocIndex&&o[d.chapterDocIndex].text&&o[d.chapterDocIndex].text.unload&&(console.log("unloading"),o[d.chapterDocIndex].text.unload()),d.chapterTitle=n,d.chapterHref=a,d.chapterDocIndex=i+"",d.percentage=i/o.length+"",d.text="",yield handleIframeHeight(s,l,t,c),handleScrollPosition(s,l,"","","",""))}}}),handleCssLink=e=>__awaiter(void 0,void 0,void 0,function*(){var t=Array.from(e.getElementsByTagName("link"));for(let e=0;e<t.length;e++){const i=t[e];i.onload=()=>{console.log("finished")}}let r=[];for(let e=0;e<t.length;e++){const n=t[e];n.href.endsWith("null")||r.push(new Promise((e,t)=>{n.addEventListener("load",e)}))}try{yield Promise.race([Promise.all(r),new Promise((e,t)=>{setTimeout(()=>{t(new Error("Timeout"))},1e3)})])}catch(e){console.log(e)}}),handleScrollPosition=(l,c,d,h,u,f)=>__awaiter(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var a=e.getElementsByTagName("iframe")[0];if(a){let n=a.contentDocument;if(n){let t=0,r=0,i=n.body;if(f&&"scroll"!==c){var o=Math.floor(l.clientWidth/12),a=o%2==0?o:o-1,o=convertComputedNum(getComputedStyle(l).width);r=(o+a)*(parseInt(f)-1)}else if(d){let e=getBlockElement(n.body);var s=e.filter((e,t)=>cleanText$1(e.textContent).slim()&&(cleanText$1(e.textContent).slim()===cleanText$1(d).slim()||cleanText$1(e.textContent).slim()===window.ChineseS2T.t2s(cleanText$1(d).slim())||cleanText$1(e.textContent).slim()===window.ChineseS2T.s2t(cleanText$1(d)).slim())&&(Math.abs(t-parseInt(h))<2||"search"===h||"ignore"===h||"next"===h));if(0===s.length)return void console.log("failed");i=getCloestBlock(s[0],l,c),r=i?convertStyleNum(i.offsetLeft)-convertStyleNum(i.marginLeft||parseFloat(getComputedStyle(i).marginLeft)):"prevChapter"===d?n.body.scrollWidth:0,t=i?convertStyleNum(i.offsetTop)-convertStyleNum(i.marginTop||parseFloat(getComputedStyle(i).marginTop)):0}else if(u&&-1<u.indexOf("#")){s=CSS.escape(u.split("#").reverse()[0]);if(!n.body.querySelector("#"+s))return;i=getCloestBlock(n.body.querySelector("#"+s)||n.body,l,c),r=i?convertStyleNum(i.offsetLeft)-convertStyleNum(i.marginLeft||parseFloat(getComputedStyle(i).marginLeft)):0,t=i?convertStyleNum(i.offsetTop)-convertStyleNum(i.marginTop||parseFloat(getComputedStyle(i).marginTop)):0}"scroll"!==c?n.body.scrollTo(r,0):l.scrollTo(0,t)}}}}),getCloestBlock=(e,t,r)=>{var i=Math.floor(t.clientWidth/12),i=i%2==0?i:i-1;return"scroll"!==r&&parseInt(convertStyleNum(e.offsetLeft)-convertStyleNum(e.marginLeft||parseFloat(getComputedStyle(e).marginLeft))+"")%((t.clientWidth+i)/2)!=0&&e.parentElement?getCloestBlock(e.parentElement,t,r):e},handleTurnChapter=(r,i,n,a,o,s,l)=>__awaiter(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");var t;e&&(!(t=e.getElementsByTagName("iframe")[0])||(t=t.contentDocument)&&Math.abs(r.scrollHeight-convertStyleNum(r.scrollTop)-r.clientHeight)<10&&Math.abs(t.body.scrollWidth-convertStyleNum(t.body.scrollLeft)-t.body.clientWidth)<10&&(yield handleNextChapter(r,i,n,a,o,l),s("rendered")))}),handleRecord=(a,o,s,l)=>__awaiter(void 0,void 0,void 0,function*(){if(!lock){let e=document.getElementById("page-area");if(e){var i=e.getElementsByTagName("iframe")[0];if(i){var i=i.contentDocument;if(i){let t=getBlockElement(i.body);var i=t.filter(e=>isScrolledIntoView(a,e,o)&&(e.textContent||"").trim()),n=i[0];let r=0;for(let e=0;e<t.length;e++)if(isScrolledIntoView(a,t[e],o)&&n&&t[e].innerHTML===n.innerHTML){r=e;break}handleHashChapter(i,s,l),n&&!isCurrentNodeFarFromParrent(n,a,o)?(l.text=n&&n.textContent||"",l.count=r+"",l.page=""):l.page=(null===(i=yield progressInfo(o))||void 0===i?void 0:i.currentPage)+"",lock=!0,setTimeout(()=>{lock=!1},100)}}}}}),isCurrentNodeFarFromParrent=(e,t,r)=>{var i=Math.floor(t.clientWidth/12),i=i%2==0?i:i-1;return Math.abs(e.offsetLeft-getCloestBlock(e,t,r).offsetLeft)>(t.clientWidth+i)/2},handleHashChapter=(t,r,i)=>{let e=i.chapterHref||"";var n=e.lastIndexOf("#"),a=e.substring(0,n),o=e.substring(n+1);for(let e=0;e<t.length;e++){var s=t[e];o&&s.id&&(s=a+"#"+s.id,-1<window._.findLastIndex(r,{href:s})&&(i.chapterHref=s))}},handleNextChapter=(r,e,i,n,a,o)=>__awaiter(void 0,void 0,void 0,function*(){var e=parseInt(o.chapterDocIndex||"0"),t=o.chapterHref||"";e>=i.length-1?o.percentage="1":(t=findValidChapter(e,t,i,"next"))&&(o.page="",yield handleRenderChatper(t.index,t.label,t.href,i,r,n,a,o))}),getAudioText=(n,a)=>{let e=document.getElementById("page-area");if(e){var o=e.getElementsByTagName("iframe")[0];if(o){o=o.contentDocument;if(o){let e=getBlockElement(o.body).filter(e=>!isParentBlock(e)),t=e.filter(e=>(e.textContent||"").trim()),r=t.filter(e=>"img"!==e.textContent).map(e=>e.textContent),i=0;return getVisibleText(n,a)&&0<getVisibleText(n,a).length&&(a=getVisibleText(n,a)[0],i=r.indexOf(a)),r.slice(i)}}}},getVisibleText=(r,i)=>{let e=document.getElementById("page-area");if(e){var n=e.getElementsByTagName("iframe")[0];if(n){n=n.contentDocument;if(n){let e=getBlockElement(n.body).filter(e=>!isParentBlock(e)),t=e.filter(e=>isScrolledIntoView(r,e,i)&&(e.textContent||"").trim());return t.filter(e=>"img"!==e.textContent).map(e=>e.textContent)}}}},handleHighlightNode=(e,t,r,i)=>{let n=document.getElementById("page-area");if(n){var a=n.getElementsByTagName("iframe")[0];if(a){a=a.contentDocument;if(a){let e=getBlockElement(a.body),t=e.filter(e=>(e.getAttribute("style")===i&&e.setAttribute("style",""),(e.textContent||"").trim()&&e.textContent===r));0<t.length&&t[0].setAttribute("style",i)}}}},getSearchResult=(o,s)=>__awaiter(void 0,void 0,void 0,function*(){var i;let n=[];for(let r=0;r<s.length;r++){var e=(new DOMParser).parseFromString(yield handleOneChapterDoc(s[r].text),"text/html");let t=getBlockElement(e.body).filter(e=>!isParentBlock(e));for(let e=0;e<t.length;e++){var a=(t[e].textContent||"").indexOf(o);-1<a&&n.push({excerpt:(null===(i=t[e].textContent)||void 0===i?void 0:i.substring(a-100,a+100))||"",cfi:JSON.stringify({text:t[e].textContent,chapterTitle:s[r].label,chapterDocIndex:r,chapterHref:s[r].href,count:"search",percentage:r/s.length})})}}for(let e=0;e<s.length;e++)s[e].text&&s[e].text.unload&&s[e].text.unload();return window._.uniq(n,"excerpt")}),isParentBlock=e=>{var t=e.children;let r=!1;var i=/^(address|section|blockquote|body|center|dir|div|dl|fieldset|form|h[1-6]|hr|isindex|menu|noframes|noscript|ol|p|pre|table|ul|dd|dt|frameset|li|tbody|td|tfoot|th|thead|tr|html)$/i;if(Array.from(t).filter(e=>i.test(e.nodeName)).length<3)return!1;for(var n=0;n<t.length;n++)if(i.test(t[n].nodeName)){r=!0;break}return r},isScrolledIntoView=(e,t,r)=>{var i,n=!1,a=t.getBoundingClientRect();return"scroll"!==r&&t.textContent&&t.textContent.trim()?n=-10<(i=a.left)&&i<=e.clientWidth:"scroll"===r&&t.textContent&&t.textContent.trim()?n=(t=a.top)>=e.scrollTop&&t<=e.scrollTop+e.clientHeight:"scroll"!==r&&(n=0<=(a=a.left)&&a<=e.clientWidth),n};class EventEmitter{constructor(){this.callbacks={},this.callbacks.base={}}on(e,t){const r=this;if(void 0===e||""===e)return console.warn("wrong names"),!1;if(void 0===t)return console.warn("wrong callback"),!1;const i=this.resolveNames(e);return i.forEach(function(e){e=r.resolveName(e);r.callbacks[e.namespace]instanceof Object||(r.callbacks[e.namespace]={}),r.callbacks[e.namespace][e.value]instanceof Array||(r.callbacks[e.namespace][e.value]=[]),r.callbacks[e.namespace][e.value].push(t)}),this}off(e){const i=this;if(void 0===e||""===e)return console.warn("wrong name"),!1;const t=this.resolveNames(e);return t.forEach(function(e){var t=i.resolveName(e);if("base"!==t.namespace&&""===t.value)delete i.callbacks[t.namespace];else if("base"===t.namespace)for(const r in i.callbacks)i.callbacks[r]instanceof Object&&i.callbacks[r][t.value]instanceof Array&&(delete i.callbacks[r][t.value],0===Object.keys(i.callbacks[r]).length&&delete i.callbacks[r]);else i.callbacks[t.namespace]instanceof Object&&i.callbacks[t.namespace][t.value]instanceof Array&&(delete i.callbacks[t.namespace][t.value],0===Object.keys(i.callbacks[t.namespace]).length&&delete i.callbacks[t.namespace])}),this}trigger(e,t=[]){if(void 0===e||""===e)return console.warn("wrong name"),!1;const r=this;const i=t instanceof Array?t:[];let n=this.resolveNames(e);n=this.resolveName(n[0]),setTimeout(()=>{if("base"===n.namespace)for(const e in r.callbacks){if(r.callbacks[e]instanceof Object&&r.callbacks[e][n.value]instanceof Array&&r.callbacks[e][n.value])r.callbacks[e][n.value].forEach(function(e){e.apply(r,i)});else if(this.callbacks[n.namespace]instanceof Object&&r.callbacks[n.namespace][n.value]){if(""===n.value)return console.warn("wrong name"),this;r.callbacks[n.namespace][n.value].forEach(function(e){e.apply(r,i)})}return null}},100)}resolveNames(e){let t=e;return t=t.replace(/[^a-zA-Z0-9 ,/.]/g,""),t=t.replace(/[,/]+/g," "),t=t.split(" "),t}resolveName(e){const t={};var r=e.split(".");return t.original=e,t.value=r[0],t.namespace="base",1<r.length&&""!==r[1]&&(t.namespace=r[1]),t}}const mimetype={svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed",tar:"application/x-tar",html:"text/html",htm:"text/html",xml:"text/xml",xhtml:"application/xhtml+xml",css:"text/css"},mimetypeReverse={"image/svg+xml":"svg","image/png":"png","image/jpeg":"jpg","image/gif":"gif","image/webp":"webp","application/zip":"zip","application/x-rar-compressed":"rar","application/x-7z-compressed":"7z","application/x-tar":"tar","text/html":"html","text/xml":"xml","application/xhtml+xml":"xhtml","text/css":"css"},ELEMENT_NODE=Node.ELEMENT_NODE,TEXT_NODE=Node.TEXT_NODE,CDATA_SECTION_NODE=Node.CDATA_SECTION_NODE;function cfiEscape(e){return e.replace(/[\[\]\^,();]/g,"^$&")}function matchAll(e,t,r){r=r||0;const i=[];let n=0;for(var a;(a=e.match(t))&&(i.push(a.index+r),n+=a.index+a.length,e=e.slice(a.index+a.length),n<e.length););return i}function closest(e,t){let r,i,n;for(i=0;i<e.length;i++)n=Math.abs(e[i]-t),(!i||n<void 0)&&(n=void 0,r=e[i]);return r}function calcSiblingCount(e,t,r){let i=0,n,a=0,o=!0,s,l;for(s=0;s<e.length;s++)if(l=e[s],l.nodeType===ELEMENT_NODE){if(n||o?(i+=2,o=!1):i++,t===l)return"img"===l.tagName.toLowerCase()?{count:i,offset:r}:{count:i};a=0,n=!0}else if((null===l||void 0===l?void 0:l.nodeType)===TEXT_NODE||(null===l||void 0===l?void 0:l.nodeType)===CDATA_SECTION_NODE){if((n||o)&&(i++,o=!1),t===l)return{count:i,offset:r+a};a+=l.textContent.length,n=!1}throw new Error("The specified node was not found in the array of siblings")}function compareTemporal(e,t){var r="number"==typeof e,i="number"==typeof t;return r||i?!r&&i?-1:r&&!i?1:(e||0)-(t||0):0}function compareSpatial(e,t){if(!e&&!t)return 0;if(!e&&t)return-1;if(e&&!t)return 1;var r=(e.y||0)-(t.y||0);return r||(e.x||0)-(t.x||0)}class CFI{constructor(r,i){this.isRange=!1,this.opts=Object.assign({flattenRange:!1,stricter:!0},i||{}),this.cfi=r,this.parts=[];var n,a,o,i=(r=r.trim()).match(/^epubcfi\((.*)\)$/);if(!i)throw new Error("Not a valid CFI");if(!(i.length<2)){r=i[1]||"";let e=[],t=0;for(;r.length;){if({parsed:n,offset:a,newDoc:o}=this.parse(r),!n||null===a)throw new Error("Parsing failed");if(t&&o)throw new Error("CFI is a range that spans multiple documents. This is not allowed");e.push(n),(o||r.length-a<=0)&&(2===t?this.to=e:this.parts.push(e),e=[]),","===(r=r.slice(a))[0]&&(0===t?(e.length&&this.parts.push(e),e=[]):1===t&&(e.length&&(this.from=e),e=[]),r=r.slice(1),t++)}this.from&&this.from.length&&(!this.opts.flattenRange&&this.to&&this.to.length?this.isRange=!0:(this.parts=this.parts.concat(this.from),delete this.from,delete this.to)),this.opts.stricter&&this.removeIllegalOpts()}}removeIllegalOpts(e){if(!e)if(this.from){if(this.removeIllegalOpts(this.from),!this.to)return;e=this.to}else e=this.parts;let t,r,i,n;for(t=0;t<e.length;t++)for(i=e[t],r=0;r<i.length-1;r++)n=i[r],delete n.temporal,delete n.spatial,delete n.offset,delete n.textLocationAssertion}static generatePart(e,t,r){let i="";for(var n;e.parentNode;)n=calcSiblingCount(e.parentNode.childNodes,e,t),!i&&n.offset&&(i=":"+n.offset),i="/"+n.count+(e.id?"["+cfiEscape(e.id)+"]":"")+i,e=e.parentNode;return i}static generate(e,t,r){let i;if(Array.isArray(e)){const n=[];for(const a of e)n.push(this.generatePart(a.node,a.offset,r));i=n.join("!")}else i=this.generatePart(e,t,r);return r&&(i+=r),"epubcfi("+i+")"}static toParsed(e){return e.isRange?e.getFrom():e.get()}static comparePath(e,t){var r=Math.max(e.length,t.length);let i,n,a,o;for(i=0;i<r;i++){if(n=e[i],a=t[i],!n)return-1;if(!a)return 1;if(o=this.compareParts(n,a))return o}return 0}static sort(e){e.sort((e,t)=>this.compare(e,t))}static compare(e,t){let r=e.get(),i=t.get();if(e.isRange||t.isRange){if(e.isRange&&t.isRange){var n=this.comparePath(r.from,i.from);return n?n:this.comparePath(r.to,i.to)}return e.isRange&&(r=r.from),t.isRange&&(i=i.from),this.comparePath(r,i)}return this.comparePath(r,i)}static compareParts(e,t){var r=Math.max(e.length,t.length);let i,n,a,o;for(i=0;i<r;i++){if(n=e[i],a=t[i],!n)return-1;if(!a)return 1;if(o=n.nodeIndex-a.nodeIndex,o)return o;if(0===n.nodeIndex)return 0;if(!(i<r-1)){if(n.nodeIndex%2==0){if(o=compareTemporal(n.temporal,a.temporal),o)return o;if(o=compareSpatial(n.spatial,a.spatial),o)return o}if(o=(n.offset||0)-(a.offset||0),o)return o}}return 0}decodeEntities(e,t){try{const r=e.createElement("textarea");return r.innerHTML=t,r.value||""}catch(e){return t}}trueLength(e,t){return this.decodeEntities(e,t).length}getFrom(){if(!this.isRange)throw new Error("Trying to get beginning of non-range CFI");if(!this.from)return this.deepClone(this.parts);const e=this.deepClone(this.parts);return e[e.length-1]=e[e.length-1].concat(this.from),e}getTo(){if(!this.isRange)throw new Error("Trying to get end of non-range CFI");const e=this.deepClone(this.parts);return e[e.length-1]=e[e.length-1].concat(this.to),e}get(){return this.isRange?{from:this.getFrom(),to:this.getTo(),isRange:!0}:this.deepClone(this.parts)}parseSideBias(e,t){var r;t&&(!(r=t.trim().match(/^(.*);s=([ba])$/))||r.length<3?"object"==typeof e.textLocationAssertion?e.textLocationAssertion.post=t:e.textLocationAssertion=t:(r[1]&&("object"==typeof e.textLocationAssertion?e.textLocationAssertion.post=r[1]:e.textLocationAssertion=r[1]),"a"===r[2]?e.sideBias="after":e.sideBias="before"))}parseSpatialRange(e){if(e){e=e.trim().match(/^([\d\.]+):([\d\.]+)$/);if(e&&!(e.length<3)){e={x:parseInt(e[1]),y:parseInt(e[2])};if("number"==typeof e.x&&"number"==typeof e.y)return e}}}parse(e){const t={};var r=/[\d]/;let i,n,a,o,s,l=!1,c=!1,d;for(d=0;d<=e.length;d++)if(o=d<e.length?e[d]:"","^"!==o||s){if("/"===n){if(o.match(r)){i?i+=o:i=o,s=!1;continue}i&&(t.nodeIndex=parseInt(i),i=null),a=n,n=null}if(":"===n){if(o.match(r)){i?i+=o:i=o,s=!1;continue}i&&(t.offset=parseInt(i),i=null),a=n,n=null}if("@"===n){let e=!1;if(o.match(r)||"."===o||":"===o?":"===o&&(l?e=!0:l=!0):e=!0,!e){i?i+=o:i=o,s=!1;continue}a=n,n=null,i&&l&&(t.spatial=this.parseSpatialRange(i)),i=null}if("~"===n){if(o.match(r)||"."===o){i?i+=o:i=o,s=!1;continue}i&&(t.temporal=parseFloat(i)),a=n,n=null,i=null}if(!n){if("!"===o){d++,n=o;break}if(","===o)break;if("/"===o){if(c)break;c=!0,a=n,n=o,s=!1;continue}if(":"===o||"~"===o||"@"===o){if(this.opts.stricter){if(":"===o&&(void 0!==t.temporal||void 0!==t.spatial))break;if(("~"===o||"@"===o)&&void 0!==t.offset)break}a=n,n=o,s=!1,l=!1;continue}if("["===o&&!s&&":"===a){a=n,n="[",s=!1;continue}if("["===o&&!s&&"/"===a){a=n,n="nodeID",s=!1;continue}}s=("["!==n?"nodeID"!==n||("]"!==o||s?i?i+=o:i=o:(a=n,n=null,t.nodeID=i,i=null)):"]"!==o||s?","!==o||s?i?i+=o:i=o:(t.textLocationAssertion={},i&&(t.textLocationAssertion.pre=i),i=null):(a=n,n=null,this.parseSideBias(t,i),i=null),!1)}else s=!0;if(!t.nodeIndex&&0!==t.nodeIndex)throw new Error("Missing child node index in CFI");return{parsed:t,offset:d,newDoc:"!"===n}}getChildNodeByCFIIndex(e,t,r,i){var n=t.childNodes;if(!n.length)return{node:t,offset:0};if(r<=0)return{node:n[0],relativeToNode:"before",offset:0};let a=0,o,s,l;for(s=0;s<n.length;s++)switch(l=n[s],l.nodeType){case ELEMENT_NODE:if(a%2==0){if(a+=2,a>=r)return"img"===l.tagName.toLowerCase()&&i?{node:l,offset:i}:{node:l,offset:0}}else{if(a+=1,a===r)return"img"===l.tagName.toLowerCase()&&i?{node:l,offset:i}:{node:l,offset:0};if(a>r)return o?{node:o,offset:this.trueLength(e,o.textContent)}:{node:t,offset:0}}o=l;break;case TEXT_NODE:case CDATA_SECTION_NODE:if(0!==a&&a%2!=0||(a+=1),a===r){var c=this.trueLength(e,l.textContent);if(!(c<=i))return{node:l,offset:i};i-=c}o=l;break;default:continue}if(r>a){const d={relativeToNode:"after",offset:0};return o?d.node=o:d.node=t,this.isTextNode(d.node)&&(d.offset=this.trueLength(e,d.node.textContent.length)),d}}isTextNode(e){return!!e&&(e.nodeType===TEXT_NODE||e.nodeType===CDATA_SECTION_NODE)}correctOffset(e,t,r,i){let n=t,a;if(a="string"==typeof i?this.decodeEntities(e,i):(i.pre=this.decodeEntities(e,i.pre),i.post=this.decodeEntities(e,i.post),i.pre+"."+i.post),!this.isTextNode(t))return{node:t,offset:0};for(;this.isTextNode(n.previousSibling);)n=n.previousSibling;var o,s=n;const l=[];let c="",d=0;for(;this.isTextNode(n)&&(o=this.decodeEntities(e,n.textContent),l[d]=o.length,c+=o,n.nextSibling);)n=n.nextSibling,d++;i=i.pre?i.pre.length:0,i=matchAll(c,new RegExp(a),i);if(!i.length)return{node:t,offset:r};let h=closest(i,r);if(n===t&&h===r)return{node:t,offset:r};for(d=0,n=s;h>=l[d];){if(h-=l[d],h<0)return{node:t,offset:r};if(!n.nextSibling||d+1>=[].length)return{node:t,offset:r};d++,n=n.nextSibling}return{node:n,offset:h}}resolveNode(e,t,r,i){if(i=Object.assign({},i||{}),!r)throw new Error("Missing DOM argument");let n;if(0===e&&(n=r.querySelector("package")),!n)for(const d of r.childNodes)if(d.nodeType===ELEMENT_NODE){n=d;break}if(n=r,!n)throw new Error("Document incompatible with CFIs");let a=n,o=0,s,l;for(s=t.length-1;0<=s;s--)if(l=t[s],!i.ignoreIDs&&l.nodeID&&(a=r.getElementById(l.nodeID))){o=s+1;break}a=a||n;let c={node:a,offset:0};for(s=o;s<t.length;s++)l=t[s],l&&(c=this.getChildNodeByCFIIndex(r,c.node,l.nodeIndex,l.offset),l.textLocationAssertion&&(c=this.correctOffset(r,c.node,l.offset,l.textLocationAssertion)));return c}resolveURI(e,t,r){if(r=r||{},e<0||e>this.parts.length-2)throw new Error("index is out of bounds");var i=this.parts[e];if(!i)throw new Error("Missing CFI part for index: "+e);let n=this.resolveNode(e,i,t,r).node;r=n.tagName.toLowerCase();if("itemref"===r&&"spine"===n.parentNode.tagName.toLowerCase()){var a=n.getAttribute("idref");if(!a)throw new Error("Referenced node had not 'idref' attribute");if(n=t.getElementById(a),!n)throw new Error("Specified node is missing from manifest");a=n.getAttribute("href");if(!a)throw new Error("Manifest item is missing href attribute");return a}if("iframe"===r||"embed"===r){a=n.getAttribute("src");if(!a)throw new Error(r+" element is missing 'src' attribute");return a}if("object"===r){var o=n.getAttribute("data");if(!o)throw new Error(r+" element is missing 'data' attribute");return o}if("image"!==r&&"use"!==r)throw new Error("No URI found");o=n.getAttribute("xlink:href");if(!o)throw new Error(r+" element is missing 'xlink:href' attribute");return o}deepClone(e){return JSON.parse(JSON.stringify(e))}resolveLocation(e,t){var r=t.length-1,t=t[r];if(!t)throw new Error("Missing CFI part for index: "+r);const i=this.resolveNode(r,t,e),n=this.deepClone(t[t.length-1]);return delete n.nodeIndex,n.offset||delete i.offset,Object.assign(Object.assign({},n),i)}resolveLast(e,t){if(t=Object.assign({range:!1},t||{}),!this.isRange)return this.resolveLocation(e,this.parts);if(t.range){const r=e.createRange();t=this.getFrom();"before"===t.relativeToNode?r.setStartBefore(t.node,t.offset):"after"===t.relativeToNode?r.setStartAfter(t.node,t.offset):r.setStart(t.node,t.offset);t=this.getTo();return"before"===t.relativeToNode?r.setEndBefore(t.node,t.offset):"after"===t.relativeToNode?r.setEndAfter(t.node,t.offset):r.setEnd(t.node,t.offset),r}return{from:this.resolveLocation(e,this.getFrom()),to:this.resolveLocation(e,this.getTo()),isRange:!0}}resolve(e,t){return this.resolveLast(e,t)}}const classes=["color-0","color-1","color-2","color-3","line-0","line-1","line-2","line-3"],colors=["#FEF3CD","#FBFACC","#CEFACD","#CDE9FA"],pdfColors=["#fac106","#ebe702","#0be603","#0493e6"],lines=["#FF0000","#000080","#0000FF","#2EFF2E"],showNoteHighlight=(i,n,a,o)=>{var s,l=classes[n];let e=document.getElementById("page-area");if(e){n=e.getElementsByTagName("iframe")[0];if(n&&n.contentWindow){let t=n.contentWindow||(null===(c=n.contentDocument)||void 0===c?void 0:c.defaultView),r=n.contentDocument;if(r){var c=[i];window.rangy.getSelection(n).restoreCharacterRanges(r,c);let e=r.getSelection();if(e){for(var c=e.getRangeAt(0),d=getSafeRanges(c),h=0;h<d.length;h++)highlightRange(d[h],l,a,o,r);t&&t.getSelection()&&null!==(s=t.getSelection())&&void 0!==s&&s.empty()}}}}},showPDFHighlight=(t,n,a,o,s,l)=>{let e=document.getElementById("page-area");if(e){var r=e.getElementsByTagName("iframe")[0];if(r&&r.contentWindow){let e=r.contentDocument;if(e){let r=classes[n],i=e.querySelector(".noteLayer");var c=s.getViewport({scale:l});t.coords.forEach(e=>{var t=c.convertToViewportRectangle(e),e=document.createElement("div");null!=e&&e.setAttribute("style","position: absolute;"+(-1<r.indexOf("color")?"background-color: ":"border-bottom: ")+(-1<r.indexOf("color")?pdfColors[r.split("-")[1]]:`2px solid ${lines[r.split("-")[1]]}`)+"; left:"+Math.min(t[0],t[2])+"px; top:"+Math.min(t[1],t[3])+"px;width:"+Math.abs(t[0]-t[2])+"px; height:"+Math.abs(t[1]-t[3])+"px; z-index: 1;opacity: "+(-1<r.indexOf("color")?.3:1)+";"),null!=e&&e.setAttribute("data-key",a),null!=e&&e.setAttribute("class","kookit-note"),null!=e&&e.addEventListener("click",e=>{e&&e.target&&e.target.dataset&&e.target.dataset.key&&o(e)}),i.appendChild(e)})}}}},clearHighlight=()=>{let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t&&t.contentWindow){let e=t.contentDocument;if(e){var r=e.querySelectorAll(".kookit-note");for(let e=0;e<r.length;e++){const i=r[e];i.parentNode.removeChild(i)}}}}},highlightRange=(e,t,r,i,n)=>{var a=filterRects(e.getClientRects());for(let e=0;e<a.length;e++){var o=a[e],s=document.createElement("span");null!=s&&s.setAttribute("style","position: absolute;"+(-1<t.indexOf("color")?"background-color: ":"border-bottom: ")+(-1<t.indexOf("color")?colors[t.split("-")[1]]+";opacity: 1":`2px solid ${lines[t.split("-")[1]]}`)+";left:"+(Math.min(o.left,o.x)+n.body.scrollLeft)+"px; top:"+(Math.min(o.top,o.y)+n.body.scrollTop)+"px;width:"+o.width+"px; height:"+o.height+"px; z-index:-1;"),s.setAttribute("class"," kookit-note"),s.setAttribute("data-key",r),n.body.appendChild(s);s=document.createElement("span");null!=s&&s.setAttribute("style","position: absolute;left:"+(Math.min(o.left,o.x)+n.body.scrollLeft)+"px; top:"+(Math.min(o.top,o.y)+n.body.scrollTop)+"px;width:"+o.width+"px; height:"+o.height+"px; z-index:1;"),s.setAttribute("class"," kookit-note"),s.setAttribute("data-key",r),s.addEventListener("click",e=>{e&&e.target&&e.target.dataset&&e.target.dataset.key&&i(e)}),n.body.appendChild(s)}},filterRects=t=>{let r=[];for(let e=0;e<t.length;e++){var i=t[e];r.push(i)}return r},getSafeRanges=t=>{var r=t.commonAncestorContainer,i=new Array(0),n=new Array(0);if(t.startContainer!==r)for(let e=t.startContainer;e!==r;e=e.parentNode)i.push(e);if(0<i.length)for(let e=0;e<i.length;e++){var a=document.createRange();e?(a.setStartAfter(i[e-1]),a.setEndAfter(i[e].lastChild)):(a.setStart(i[e],t.startOffset),a.setEndAfter(i[e].nodeType===Node.TEXT_NODE?i[e]:i[e].lastChild)),n.push(a)}var o=new Array(0),s=new Array(0);if(t.endContainer!==r)for(var e=t.endContainer;e!==r;e=e.parentNode)o.push(e);if(0<o.length)for(let e=0;e<o.length;e++){var l=document.createRange();e?(l.setStartBefore(o[e].firstChild),l.setEndBefore(o[e-1])):(l.setStartBefore(o[e].nodeType===Node.TEXT_NODE?o[e]:o[e].firstChild),l.setEnd(o[e],t.endOffset)),s.unshift(l)}if(!(0<i.length&&0<o.length))return[t];var c=document.createRange();return c.setStartAfter(i[i.length-1]),c.setEndBefore(o[o.length-1]),n.push(c),n.concat(s)};class GeneralRender extends EventEmitter{constructor(e,t,r){super(),this.mode=e,this.animation=r,this.format=t,this.chapterList=[],this.chapterDocList=[],this.flattenChapters=[],this.book="",this.element="",this.tempLocation={}}getPageSize(){var e="double"===this.mode?2:1,t=Math.floor(this.element.clientWidth/12),t=t%2==0?t:t-1;return{width:this.element.clientWidth,height:this.element.clientHeight,left:this.element.offsetLeft,top:this.element.offsetTop,scrollTop:this.element.scrollTop,sectionWidth:(this.element.clientWidth-t)/e,gap:t}}getCache(h){return new Promise((d,e)=>__awaiter(this,void 0,void 0,function*(){let e=new GeneralParser(h);this.chapterList=yield e.getChapter(h.toc),this.chapterDocList=yield e.getChapterDoc();var t=this.chapterList,r=this.chapterDocList.map(e=>({href:e.href,label:e.label})),n=yield Promise.all(this.chapterDocList.map(r=>__awaiter(this,void 0,void 0,function*(){let t="";if(r.text.load){let e=yield fetch(yield r.text.load()).then(e=>e.blob());t=yield e.text()}return t})));let a=new window.JSZip;a.file("toc.json",JSON.stringify(t)),a.file("sections.json",JSON.stringify(r));let o=[];for(let i=0;i<n.length;i++){let e=(new DOMParser).parseFromString(n[i],"text/html"),r=getImageElement(e);for(let t=0;t<r.length;t++){let e=a.folder("imgs/"+i);if(r[t].getAttribute("src"))try{var s=yield fetch(yield r[t].getAttribute("src")).then(e=>e.blob());e.file(t+"."+mimetypeReverse[s.type],s),r[t].src="imgs/"+i+"/"+t+"."+mimetypeReverse[s.type]}catch(e){console.log(e)}}var l=Array.from(e.getElementsByTagName("link"));for(let r=0;r<l.length;r++){let e=l[r],t=a.folder("css/"+i);if(e.getAttribute("href"))try{var c=yield fetch(yield e.getAttribute("href")).then(e=>e.blob());t.file(r+"."+mimetypeReverse[c.type],c),e.href="css/"+i+"/"+r+"."+mimetypeReverse[c.type]}catch(e){console.log(e)}}o.push(e.documentElement.innerHTML)}let i=a.folder("chapters");for(let e=0;e<o.length;e++)i.file(e+".html",o[e]);a.generateAsync({type:"blob"}).then(e=>__awaiter(this,void 0,void 0,function*(){d(yield new Response(e).arrayBuffer())})).catch(e=>{d("err")})}))}resolveChapter(e){var r=e;let i=-1;for(let e=0;e<this.flattenChapters.length;e++)if(this.flattenChapters[e].href.includes(r)){i=e;break}if(-1<i)return this.flattenChapters[i];{let t=e.split("#")[0];for(let e=0;e<this.flattenChapters.length;e++)if(this.flattenChapters[e].href.includes(t.substring(1))){i=e;break}if(-1<i)return this.flattenChapters[i];for(let e=0;e<this.chapterDocList.length;e++)if(this.chapterDocList[e].text&&this.chapterDocList[e].text.id&&(this.chapterDocList[e].text.id+"").includes(r)){i=e;break}return-1<i?{label:"",href:"",index:i}:null}}flatChapter(t){let r=[];for(let e=0;e<t.length;e++)t[e].subitems&&0<t[e].subitems.length?(r.push(t[e]),r=r.concat(this.flatChapter(t[e].subitems))):r.push(t[e]);return this.flattenChapters=r,r}getChapter(){return this.chapterList}getChapterDoc(){return this.chapterDocList}goToPercentage(t){return __awaiter(this,void 0,void 0,function*(){var e;0<this.flattenChapters.length&&(e=1===t?this.flattenChapters.length-1:Math.floor(this.flattenChapters.length*t),yield this.goToChapter(this.flattenChapters[e].index.toString(),this.flattenChapters[e].href,this.flattenChapters[e].label))})}goToChapterIndex(e){return __awaiter(this,void 0,void 0,function*(){0<this.flattenChapters.length&&(yield this.goToChapter(this.flattenChapters[e].index,this.flattenChapters[e].href,this.flattenChapters[e].label))})}goToChapter(e,t,r){return __awaiter(this,void 0,void 0,function*(){yield handleRenderChatper(parseInt(e),r,t,this.chapterDocList,this.element,this.mode,this.format,this.tempLocation),t&&-1<t.indexOf("#")&&(yield handleScrollPosition(this.element,this.mode,"","",t,"")),yield this.record(),this.trigger("rendered")})}goToPosition(c){return __awaiter(this,void 0,void 0,function*(){this.tempLocation=JSON.parse(c);let{text:t,chapterTitle:e,chapterDocIndex:r,chapterHref:i,count:n,page:a,cfi:o}=this.tempLocation;if(yield handleRenderChatper(parseInt(r),e,i,this.chapterDocList,this.element,this.mode,this.format,this.tempLocation),o){const l=new CFI(o,{});let e=document.getElementById("page-area");if(!e)return;var s=e.getElementsByTagName("iframe")[0];if(!s)return;s=s.contentDocument;if(!s)return;var s=l.resolve(s,{})["node"];if(!s)return;n="ignore",t=s.textContent}yield handleScrollPosition(this.element,this.mode,t,n,"",a),yield this.record(),this.trigger("rendered")})}goToNode(i){return __awaiter(this,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t,r=e.getElementsByTagName("iframe")[0];if(r){let e=r.contentDocument;e&&(r=(t=getCloestBlock(i,this.element,this.mode))?convertStyleNum(t.offsetLeft)-convertStyleNum(t.marginLeft||parseFloat(getComputedStyle(t).marginLeft)):0,t=t?convertStyleNum(t.offsetTop)-convertStyleNum(t.marginTop||parseFloat(getComputedStyle(t).marginTop)):0,"scroll"!==this.mode?e.body.scrollTo(r,0):this.element.scrollTo(0,t),yield this.record(),this.trigger("rendered"))}}})}removeContent(){this.element.innerHTML=""}prev(){return __awaiter(this,void 0,void 0,function*(){this.trigger("page-changed");let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){let e=t.contentDocument;e&&("scroll"===this.mode||0===convertStyleNum(e.body.scrollLeft)?(yield handlePrevChapter(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.tempLocation),-1<parseInt(this.tempLocation.chapterDocIndex||"-1")&&e.body.scrollTo(e.body.scrollWidth,0),this.trigger("rendered")):yield handleScrollPage(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.animation,1,this.trigger,this.tempLocation),yield this.record())}}})}next(){return __awaiter(this,void 0,void 0,function*(){this.trigger("page-changed");let e=document.getElementById("page-area");var t;e&&(!(t=e.getElementsByTagName("iframe")[0])||(t=t.contentDocument)&&(Math.abs(t.body.scrollWidth-convertStyleNum(t.body.scrollLeft)-t.body.clientWidth)<10&&"scroll"!==this.mode||Math.abs(this.element.scrollHeight-convertStyleNum(this.element.scrollTop)-this.element.clientHeight)<10&&"scroll"===this.mode?(yield handleNextChapter(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.tempLocation),this.trigger("rendered")):"scroll"===this.mode?this.element.scrollBy({left:0,top:this.element.clientHeight-50,behavior:"smooth"}):yield handleScrollPage(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.animation,-1,this.trigger,this.tempLocation),yield this.record()))})}prevChapter(){return __awaiter(this,void 0,void 0,function*(){this.trigger("page-changed");let e=document.getElementById("page-area");var t;!e||(t=e.getElementsByTagName("iframe")[0])&&t.contentDocument&&(yield handlePrevChapter(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.tempLocation),yield this.record(),this.trigger("rendered"))})}nextChapter(){return __awaiter(this,void 0,void 0,function*(){this.trigger("page-changed");let e=document.getElementById("page-area");var t;!e||(t=e.getElementsByTagName("iframe")[0])&&t.contentDocument&&(yield handleNextChapter(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.tempLocation),yield this.record(),this.trigger("rendered"))})}visibleText(){return getVisibleText(this.element,this.mode)}audioText(){return getAudioText(this.element,this.mode)}highlightNode(e,t){handleHighlightNode(this.element,this.mode,e,t)}doSearch(e){return __awaiter(this,void 0,void 0,function*(){return yield getSearchResult(e,this.chapterDocList)})}getProgress(){return __awaiter(this,void 0,void 0,function*(){return yield progressInfo(this.mode)})}record(){return __awaiter(this,void 0,void 0,function*(){"sliding"===this.animation&&(yield new Promise(e=>setTimeout(e,1e3))),yield handleRecord(this.element,this.mode,this.flatChapter(this.chapterList),this.tempLocation)})}getPosition(){return this.tempLocation}setStyle(t){let e=document.getElementById("page-area");if(e){var r=e.getElementsByTagName("iframe")[0];if(r){let e=r.contentDocument;e&&e.body.setAttribute("style",t+e.body.getAttribute("style"))}}}getHightlightCoords(e){return __awaiter(this,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){var r=t.contentDocument;if(r)return window.rangy.getSelection(t).saveCharacterRanges(r.body)[0]}}})}renderHighlighters(r,i){return __awaiter(this,void 0,void 0,function*(){clearHighlight();for(let e=0;e<r.length;e++){var t=r[e];try{showNoteHighlight(JSON.parse(t.range),t.color,t.key,i)}catch(e){return void console.warn(e,"Exception has been caught when restore character ranges.")}}})}removeOneNote(t,e){let r=document.getElementById("page-area");if(r){var i=r.getElementsByTagName("iframe")[0];if(i&&i.contentWindow){let e=i.contentDocument;if(e){var n=e.querySelectorAll(".kookit-note");for(let e=0;e<n.length;e++){const a=n[e];a.getAttribute("data-key")===t&&a.parentNode.removeChild(a)}}}}}createOneNote(e,t){return __awaiter(this,void 0,void 0,function*(){showNoteHighlight(JSON.parse(e.range),e.color,e.key,t)})}}class EpubRender extends GeneralRender{constructor(e,t,r){super(t,"EPUB",r),this.epubBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book||(yield this.parse());let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){var e=new Blob([this.epubBuffer]),e=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});try{var t=yield this.makeZipLoader(e);this.book=yield new EPUB(t).init()}catch(e){throw console.log(e),e}})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}makeZipLoader(c){return __awaiter(this,void 0,void 0,function*(){const{ZipReader:e,BlobReader:t,TextWriter:r,BlobWriter:n}=window.zip;window.zip.configure({useWebWorkers:!1});let i;try{i=new e(new t(c))}catch(e){throw e}const a=yield i.getEntries(),o=new Map(a.map(e=>[e.filename,e]));var s=r=>(e,...t)=>o.has(e)?r(o.get(e),...t):null,l=s(e=>e.getData(new r)),s=s((r,i)=>new Promise((t,e)=>{r.getData(new n(i)).then(e=>{t(e)}).catch(e=>{t(new Blob)})}));return{entries:a,loadText:l,loadBlob:s,getSize:e=>{return null!==(e=null===(e=o.get(e))||void 0===e?void 0:e.uncompressedSize)&&void 0!==e?e:0}}})}getMetadata(){return __awaiter(this,void 0,void 0,function*(){try{this.book||(yield this.parse());let e=new GeneralParser(this.book);return yield e.getMetadata()}catch(e){throw console.log(e),e}})}}const unescapeHTML=e=>{if(!e)return"";const t=document.createElement("textarea");return t.innerHTML=e,t.value},MIME$1={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},PDB_HEADER={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},PALMDOC_HEADER={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},MOBI_HEADER={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},KF8_HEADER={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},EXTH_HEADER={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},INDX_HEADER={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},TAGX_HEADER={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},HUFF_HEADER={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},CDIC_HEADER={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},FDST_HEADER={magic:[0,4,"string"],numEntries:[8,4,"uint"]},FONT_HEADER={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},MOBI_ENCODING={1252:"windows-1252",65001:"utf-8"},EXTH_RECORD_TYPE={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},MOBI_LANG={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},concatTypedArray=(e,t)=>{const r=new e.constructor(e.length+t.length);return r.set(e),r.set(t,e.length),r},concatTypedArray3=(e,t,r)=>{const i=new e.constructor(e.length+t.length+r.length);return i.set(e),i.set(t,e.length),i.set(r,e.length+t.length),i},decoder=new TextDecoder,getString=e=>decoder.decode(e),getUint=e=>{if(e){var t=e.byteLength,t=4===t?"getUint32":2===t?"getUint16":"getUint8";return new DataView(e)[t](0)}},getStruct=(e,n)=>Object.fromEntries(Array.from(Object.entries(e)).map(([e,[t,r,i]])=>[e,("string"===i?getString:getUint)(n.slice(t,t+r))])),getDecoder=e=>new TextDecoder(MOBI_ENCODING[e]),getVarLen=(e,t=0)=>{let r=0,i=0;for(const n of e.subarray(t,t+4))if(r=r<<7|(127&n)>>>0,i++,128&n)break;return{value:r,length:i}},getVarLenFromEnd=e=>{let t=0;for(const r of e.subarray(-4))128&r&&(t=0),t=t<<7|127&r;return t},countBitsSet=e=>{let t=0;for(;0<e;e>>=1)1==(1&e)&&t++;return t},countUnsetEnd=e=>{let t=0;for(;0==(1&e);)e>>=1,t++;return t},decompressPalmDOC=t=>{let r=[];for(let e=0;e<t.length;e++){var i=t[e];if(0===i)r.push(0);else if(i<=8)for(const s of t.subarray(e+1,(e+=i)+1))r.push(s);else if(i<=127)r.push(i);else if(i<=191){var n=i<<8|t[1+e++],a=(16383&n)>>>3,o=3+(7&n);for(let e=0;e<o;e++)r.push(r[r.length-a])}else r.push(32,128^i)}return Uint8Array.from(r)},read32Bits=(t,r)=>{var e=r+32,i=e>>3;let n=0n;for(let e=r>>3;e<=i;e++)n=n<<8n|BigInt(t[e]??0);return n>>8n-BigInt(7&e)&0xffffffffn},huffcdic=async(t,r)=>{const i=await r(t.huffcdic),{magic:e,offset1:n,offset2:a}=getStruct(HUFF_HEADER,i);if("HUFF"!==e)throw new Error("Invalid HUFF record");const h=Array.from({length:256},(e,t)=>n+4*t).map(e=>getUint(i.slice(e,e+4))).map(e=>[128&e,31&e,e>>>8]),u=[null].concat(Array.from({length:32},(e,t)=>a+8*t).map(e=>[getUint(i.slice(e,e+4)),getUint(i.slice(e+4,e+8))])),f=[];for(let e=1;e<t.numHuffcdic;e++){const g=await r(t.huffcdic+e);var o=getStruct(CDIC_HEADER,g);if("CDIC"!==o.magic)throw new Error("Invalid CDIC record");var s=Math.min(1<<o.codeLength,o.numEntries-f.length);const p=g.slice(o.length);for(let e=0;e<s;e++){var l=getUint(p.slice(2*e,2*e+2)),c=getUint(p.slice(l,l+2)),d=32768&c,c=new Uint8Array(p.slice(l+2,l+2+(32767&c)));f.push([c,d])}}const m=o=>{let s=new Uint8Array;var l=8*o.byteLength;for(let a=0;a<l;){var c=Number(read32Bits(o,a));let[e,t,r]=h[c>>>24];if(!e){for(;c>>>32-t<u[t][0];)t+=1;r=u[t][1]}if((a+=t)>l)break;var d=r-(c>>>32-t);let[i,n]=f[d];n||(i=m(i),f[d]=[i,!0]),s=concatTypedArray(s,i)}return s};return m},getIndexData=async(t,r)=>{const e=await r(t),i=getStruct(INDX_HEADER,e);if("INDX"!==i.magic)throw new Error("Invalid INDX record");const n=getDecoder(i.encoding),a=e.slice(i.length);var o=getStruct(TAGX_HEADER,a);if("TAGX"!==o.magic)throw new Error("Invalid TAGX section");var s=(o.length-12)/4,l=Array.from({length:s},(e,t)=>new Uint8Array(a.slice(12+4*t,12+4*t+4)));const c={};let d=0;for(let e=0;e<i.numCncx;e++){const O=await r(t+i.numRecords+e+1);var h=new Uint8Array(O);for(let e=0;e<h.byteLength;){var u=e,{value:f,length:m}=getVarLen(h,e);e+=m;m=O.slice(e,e+f);e+=f,c[d+u]=n.decode(m)}d+=65536}const g=[];for(let e=0;e<i.numRecords;e++){const P=await r(t+1+e);var p=new Uint8Array(P);const i=getStruct(INDX_HEADER,P);if("INDX"!==i.magic)throw new Error("Invalid INDX record");for(let r=0;r<i.numRecords;r++){var y=i.idxt+4+2*r,b=getUint(P.slice(y,y+2)),v=getUint(P.slice(b,b+1)),y=getString(P.slice(b+1,b+1+v));const $=[];var w,x,S,T,C,E,_,L,I,N,A,k=b+1+v;let e=0,t=k+o.numControlBytes;for([w,x,S,T]of l)1&T?e++:(_=k+e,(C=getUint(P.slice(_,_+1))&S)===S?1<countBitsSet(S)?({value:E,length:_}=getVarLen(p,t),$.push([w,null,E,x]),t+=_):$.push([w,1,null,x]):$.push([w,C>>countUnsetEnd(S),null,x]));const F={};for([L,I,N,A]of $){const H=[];if(null!=I)for(let e=0;e<I*A;e++){var{value:B,length:M}=getVarLen(p,t);H.push(B),t+=M}else{let e=0;for(;e<N;){var{value:D,length:R}=getVarLen(p,t);H.push(D),t+=R,e+=R}}F[L]=H}g.push({name:y,tagMap:F})}}return{table:g,cncx:c}},getNCX=async(e,t)=>{const{table:r,cncx:i}=await getIndexData(e,t),n=r.map(({tagMap:e},t)=>({index:t,offset:e[1]?.[0],size:e[2]?.[0],label:i[e[3]]??"",headingLevel:e[4]?.[0],pos:e[6],parent:e[21]?.[0],firstChild:e[22]?.[0],lastChild:e[23]?.[0]})),a=t=>(null==t.firstChild||(t.children=n.filter(e=>e.parent===t.index).map(a)),t);return n.filter(e=>0===e.headingLevel).map(a)},getEXTH=(t,e)=>{var{magic:r,count:i}=getStruct(EXTH_HEADER,t);if("EXTH"!==r)throw new Error("Invalid EXTH header");const n=getDecoder(e),a={};let o=12;for(let e=0;e<i;e++){var s,l,c,d=getUint(t.slice(o,o+4)),h=getUint(t.slice(o+4,o+8));d in EXTH_RECORD_TYPE&&([s,l,c]=EXTH_RECORD_TYPE[d],d=t.slice(o+8,o+h),d="uint"===l?getUint(d):n.decode(d),c?(a[s]??=[],a[s].push(d)):a[s]=d),o+=h}return a},getFont=async(e,t)=>{var{flags:r,dataStart:i,keyLength:n,keyStart:a}=getStruct(FONT_HEADER,e);const o=new Uint8Array(e.slice(i));if(2&r)for(var i=16===n?1024:1040,s=new Uint8Array(e.slice(a,a+n)),l=Math.min(i,o.length),c=0;c<l;c++)o[c]=o[c]^s[c%s.length];if(1&r)try{return t(o)}catch(e){console.warn(e),console.warn("Failed to decompress font")}return o},isMOBI=async e=>{return"BOOKMOBI"===getString(await e.slice(60,68).arrayBuffer())};class PDB{#file;#offsets;pdb;async open(e){this.#file=e;var t=getStruct(PDB_HEADER,await e.slice(0,78).arrayBuffer());this.pdb=t;const r=await e.slice(78,78+8*t.numRecords).arrayBuffer();this.#offsets=Array.from({length:t.numRecords},(e,t)=>getUint(r.slice(8*t,8*t+4))).map((e,t,r)=>[e,r[t+1]])}loadRecord(e){e=this.#offsets[e];if(!e)throw new RangeError("Record index out of bounds");return this.#file.slice(...e).arrayBuffer()}async loadMagic(e){e=this.#offsets[e][0];return getString(await this.#file.slice(e,e+4).arrayBuffer())}}class MOBI extends PDB{#start=0;#resourceStart;#decoder;#encoder;#decompress;#removeTrailingEntries;constructor({unzlib:e}){super(),this.unzlib=e}async open(e){await super.open(e),this.headers=this.#getHeaders(await super.loadRecord(0)),this.#resourceStart=this.headers.mobi.resourceStart;let t=8<=this.headers.mobi.version;if(!t){e=this.headers.exth?.boundary;if(e<4294967295)try{this.headers=this.#getHeaders(await super.loadRecord(e)),this.#start=e,t=!0}catch(e){console.warn(e),console.warn("Failed to open KF8; falling back to MOBI")}}return await this.#setup(),new(t?KF8:MOBI6)(this).init()}#getHeaders(e){var t=getStruct(PALMDOC_HEADER,e);const r=getStruct(MOBI_HEADER,e);if("MOBI"!==r.magic)throw new Error("Missing MOBI header");var{titleOffset:i,titleLength:n,localeLanguage:a,localeRegion:o}=r;r.title=e.slice(i,i+n);a=MOBI_LANG[a];r.language=a?.[o>>2]??a?.[0];a=64&r.exthFlag?getEXTH(e.slice(r.length+16),r.encoding):null,e=8<=r.version?getStruct(KF8_HEADER,e):null;return{palmdoc:t,mobi:r,exth:a,kf8:e}}async#setup(){var{palmdoc:e,mobi:t}=this.headers;this.#decoder=getDecoder(t.encoding),this.#encoder=new TextEncoder;var e=e["compression"];if(this.#decompress=1===e?e=>e:2===e?decompressPalmDOC:17480===e?await huffcdic(t,this.loadRecord.bind(this)):null,!this.#decompress)throw new Error("Unknown compression type");var t=t["trailingFlags"];const i=1&t,n=countBitsSet(t>>>1);this.#removeTrailingEntries=t=>{for(let e=0;e<n;e++){var r=getVarLenFromEnd(t);t=t.subarray(0,-r)}var e;return i&&(e=1+(3&t[t.length-1]),t=t.subarray(0,-e)),t}}decode(...e){return this.#decoder.decode(...e)}encode(...e){return this.#encoder.encode(...e)}loadRecord(e){return super.loadRecord(this.#start+e)}loadMagic(e){return super.loadMagic(this.#start+e)}loadText(e){return this.loadRecord(e+1).then(e=>new Uint8Array(e)).then(this.#removeTrailingEntries).then(this.#decompress)}async loadResource(e){const t=await super.loadRecord(this.#resourceStart+e);e=getString(t.slice(0,4));return"FONT"===e?getFont(t,this.unzlib):"VIDE"===e||"AUDI"===e?t.slice(12):t}getNCX(){var e=this.headers.mobi.indx;if(e<4294967295)return getNCX(e,this.loadRecord.bind(this))}getMetadata(){const{mobi:e,exth:t}=this.headers;return{identifier:e.uid.toString(),title:unescapeHTML(t?.title||this.decode(e.title)),author:t?.creator?.map(unescapeHTML),publisher:unescapeHTML(t?.publisher),language:t?.language??e.language,published:t?.date,description:unescapeHTML(t?.description),subject:t?.subject?.map(unescapeHTML),rights:unescapeHTML(t?.rights)}}async getCover(){var e=this.headers["exth"],e=e?.coverOffset<4294967295?e?.coverOffset:e?.thumbnailOffset<4294967295?e?.thumbnailOffset:null;if(null!=e){e=await this.loadResource(e);return new Blob([e])}}}const mbpPagebreakRegex=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,fileposRegex=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi,getIndent=e=>{let t=0;for(;e;){const i=e.parentElement;var r;i&&("p"===(r=i.tagName.toLowerCase())?t+=1.5:"blockquote"===r&&(t+=2)),e=i}return t};class MOBI6{parser=new DOMParser;serializer=new XMLSerializer;#resourceCache=new Map;#textCache=new Map;#cache=new Map;#sections;#fileposList=[];#type=MIME$1.HTML;constructor(e){this.mobi=e}async init(){let t=new Uint8Array;for(let e=0;e<this.mobi.headers.palmdoc.numTextRecords;e++)t=concatTypedArray(t,await this.mobi.loadText(e));const i=Array.from(new Uint8Array(t),e=>String.fromCharCode(e)).join("");this.#sections=[0].concat(Array.from(i.matchAll(mbpPagebreakRegex),e=>e.index)).map((e,t,r)=>i.slice(e,r[t+1])).map(e=>Uint8Array.from(e,e=>e.charCodeAt(0))).map(e=>({book:this,raw:e})).reduce((e,t)=>{var r=e[e.length-1];return t.start=r?.end??0,t.end=t.start+t.raw.byteLength,e.concat(t)},[]),this.sections=this.#sections.map((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start}));try{this.landmarks=await this.getGuide();var e=this.landmarks.find(({type:e})=>e?.includes("toc"))?.href;if(e){var r=this.resolveHref(e)["index"];const n=await this.sections[r].createDocument();let a,o=0,s=0;const l=new Map,c=new Map;this.toc=Array.from(n.querySelectorAll("a[filepos]")).reduce((e,t)=>{var r=getIndent(t),i={label:t.innerText?.trim(),href:`filepos:${t.getAttribute("filepos")}`},t=r>s?o+1:r===s?o:l.get(r)??Math.max(0,o-1);if(t>o)a?(a.subitems??=[],a.subitems.push(i),c.set(t,a)):e.push(i);else{const n=c.get(t);(n?n.subitems:e).push(i)}return a=i,o=t,s=r,l.set(r,t),e},[])}}catch(e){console.warn(e)}return this.#fileposList=[...new Set(Array.from(i.matchAll(fileposRegex),e=>e[1]))].map(e=>({filepos:e,number:Number(e)})).sort((e,t)=>e.number-t.number),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const e=await this.createDocument(this.#sections[0]);return Array.from(e.getElementsByTagName("reference"),e=>({label:e.getAttribute("title"),type:e.getAttribute("type")?.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`}))}async loadResource(e){if(this.#resourceCache.has(e))return this.#resourceCache.get(e);var t=await this.mobi.loadResource(e),t=URL.createObjectURL(new Blob([t]));return this.#resourceCache.set(e,t),t}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(const a of e.querySelectorAll("img[recindex]")){var t=a.getAttribute("recindex");try{a.src=await this.loadRecindex(t)}catch(e){console.warn(`Failed to load image ${t}`)}}for(const o of e.querySelectorAll("[mediarecindex]")){var r=o.getAttribute("mediarecindex"),i=o.getAttribute("recindex");try{o.src=await this.loadRecindex(r),i&&(o.poster=await this.loadRecindex(i))}catch(e){console.warn(`Failed to load media ${r}`)}}for(const s of e.querySelectorAll("[filepos]")){var n=s.getAttribute("filepos");s.href=`filepos:${n}`}}async loadText(t){if(this.#textCache.has(t))return this.#textCache.get(t);const i=t["raw"],n=this.#fileposList.filter(({number:e})=>e>=t.start&&e<t.end).map(e=>({...e,offset:e.number-t.start}));let a=i;n.length&&(a=i.subarray(0,n[0].offset),n.forEach(({filepos:e,offset:t},r)=>{r=n[r+1],e=this.mobi.encode(`<a id="filepos${e}"></a>`);a=concatTypedArray3(a,e,i.subarray(t,r?.offset))}));var e=this.mobi.decode(a).replaceAll(mbpPagebreakRegex,"");return this.#textCache.set(t,e),e}async createDocument(e){e=await this.loadText(e);return this.parser.parseFromString(e,this.#type)}async loadSection(e){if(this.#cache.has(e))return this.#cache.get(e);const t=await this.createDocument(e),r=t.createElement("style");t.head.append(r),r.append(t.createTextNode(`blockquote {
            margin-block-start: 0;
            margin-block-end: 0;
            margin-inline-start: 1em;
            margin-inline-end: 0;
        }`)),await this.replaceResources(t);var i=this.serializer.serializeToString(t),i=URL.createObjectURL(new Blob([i],{type:this.#type}));return this.#cache.set(e,i),i}resolveHref(e){const t=e.match(/filepos:(.*)/)[1],r=Number(t);return{index:this.#sections.findIndex(e=>e.end>r),anchor:e=>e.getElementById(`filepos${t}`)}}splitTOCHref(e){e=e.match(/filepos:(.*)/)[1];const t=Number(e);return[this.#sections.findIndex(e=>e.end>t),`filepos${e}`]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}destroy(){for(const e of this.#resourceCache.values())URL.revokeObjectURL(e);for(const t of this.#cache.values())URL.revokeObjectURL(t)}}const kindleResourceRegex=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,kindlePosRegex=/kindle:pos:fid:(\w+):off:(\w+)/,parseResourceURI=e=>{var[t,r,e]=e.match(kindleResourceRegex).slice(1);return{resourceType:t,id:parseInt(r,32),type:e}},parsePosURI=e=>{var[t,e]=e.match(kindlePosRegex).slice(1);return{fid:parseInt(t,32),off:parseInt(e,32)}},makePosURI=(e=0,t=0)=>`kindle:pos:fid:${e.toString(32).toUpperCase().padStart(4,"0")}:off:${t.toString(32).toUpperCase().padStart(10,"0")}`,getFragmentSelector=e=>{var t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(t){var[,e,t]=t;return`[${e}="${CSS.escape(t)}"]`}},replaceSeries=async(e,t,r)=>{const i=[];e.replace(t,(...e)=>(i.push(e),null));const n=[];for(const a of i)n.push(await r(...a));return e.replace(t,()=>n.shift())},getPageSpread=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};class KF8{parser=new DOMParser;serializer=new XMLSerializer;#cache=new Map;#fragmentOffsets=new Map;#fragmentSelectors=new Map;#tables={};#sections;#fullRawLength;#rawHead=new Uint8Array;#rawTail=new Uint8Array;#lastLoadedHead=-1;#lastLoadedTail=-1;#type=MIME$1.XHTML;#inlineMap=new Map;constructor(e){this.mobi=e}async init(){const e=this.mobi.loadRecord.bind(this.mobi);var t=this.mobi.headers["kf8"];try{const d=await e(t.fdst);var r=getStruct(FDST_HEADER,d);if("FDST"!==r.magic)throw new Error("Missing FDST record");var i=Array.from({length:r.numEntries},(e,t)=>12+8*t).map(e=>[getUint(d.slice(e,e+4)),getUint(d.slice(e+4,e+8))]);this.#tables.fdstTable=i,this.#fullRawLength=i[i.length-1][1]}catch{}const n=(await getIndexData(t.skel,e)).table.map(({name:e,tagMap:t},r)=>({index:r,name:e,numFrag:t[1][0],offset:t[6][0],length:t[6][1]})),a=await getIndexData(t.frag,e),o=a.table.map(({name:e,tagMap:t})=>({insertOffset:parseInt(e),selector:a.cncx[t[2][0]],index:t[4][0],offset:t[6][0],length:t[6][1]}));this.#tables.skelTable=n,this.#tables.fragTable=o,this.#sections=n.reduce((e,t)=>{var r=e[e.length-1],i=r?.fragEnd??0,n=i+t.numFrag;const a=o.slice(i,n);i=t.length+a.map(e=>e.length).reduce((e,t)=>e+t);return e.concat({skel:t,frags:a,fragEnd:n,length:i,totalLength:(r?.totalLength??0)+i})},[]);t=await this.getResourcesByMagic(["RESC","PAGE"]);const s=new Map;if(t.RESC){const h=await this.mobi.loadRecord(t.RESC),u=this.mobi.decode(h.slice(16)).replace(/\0/g,"");t=u.search(/\?>/),t=`<package>${u.slice(t)}</package>`;const f=this.parser.parseFromString(t,MIME$1.XML);for(const m of f.querySelectorAll("spine > itemref")){var l=parseInt(m.getAttribute("skelid"));s.set(l,getPageSpread(m.getAttribute("properties")?.split(" ")??[]))}}this.sections=this.#sections.map((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length,pageSpread:s.get(t)}:{linear:"no"});try{const g=await this.mobi.getNCX(),p=({label:e,pos:t,children:r})=>{var[i,n]=t,t=makePosURI(i,n);const a=this.#fragmentOffsets.get(i);return a?a.push(n):this.#fragmentOffsets.set(i,[n]),{label:unescapeHTML(e),href:t,subitems:r?.map(p)}};this.toc=g?.map(p),this.landmarks=await this.getGuide()}catch(e){console.warn(e)}const c=this.mobi.headers["exth"];return this.dir=c.pageProgressionDirection,this.rendition={layout:"true"===c.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(c.originalResolution?.split("x")?.slice(0,2)?.map((e,t)=>[t?"height":"width",e])??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(t){const r={};var i=this.mobi.headers.kf8.resourceStart,n=this.mobi.pdb.numRecords;for(let e=i;e<n;e++)try{const o=await this.mobi.loadMagic(e);var a=t.find(e=>e===o);a&&(r[a]=e)}catch{}return r}async getGuide(){var e=this.mobi.headers.kf8.guide;if(e<4294967295){var t=this.mobi.loadRecord.bind(this.mobi);const{table:r,cncx:i}=await getIndexData(e,t);return r.map(({name:e,tagMap:t})=>({label:i[t[1][0]]??"",type:e?.split(/\s/),href:makePosURI(t[6]?.[0]??t[3]?.[0])}))}}async loadResourceBlob(e){var{resourceType:t,id:r,type:e}=parseResourceURI(e),r="flow"===t?await this.loadFlow(r):await this.mobi.loadResource(r-1),r=[MIME$1.XHTML,MIME$1.HTML,MIME$1.CSS,MIME$1.SVG].includes(e)?await this.replaceResources(this.mobi.decode(r)):r;const i=e===MIME$1.SVG?this.parser.parseFromString(r,e):null;return[new Blob([r],{type:e}),i?.getElementsByTagNameNS("http://www.w3.org/2000/svg","image")?.length?i.documentElement:null]}async loadResource(e){if(this.#cache.has(e))return this.#cache.get(e);var[t,r]=await this.loadResourceBlob(e),t=r?e:URL.createObjectURL(t);return r&&this.#inlineMap.set(t,r),this.#cache.set(e,t),t}replaceResources(e){var t=new RegExp(kindleResourceRegex,"g");return replaceSeries(e,t,this.loadResource.bind(this))}async loadRaw(e,t){var r=t-this.#rawHead.length,i=null==this.#fullRawLength?1/0:this.#fullRawLength-this.#rawTail.length-e;if(r<0||r<i){for(;this.#rawHead.length<t;){var n=++this.#lastLoadedHead,n=await this.mobi.loadText(n);this.#rawHead=concatTypedArray(this.#rawHead,n)}return this.#rawHead.slice(e,t)}for(;this.#fullRawLength-this.#rawTail.length>e;){var a=this.mobi.headers.palmdoc.numTextRecords-1-++this.#lastLoadedTail,a=await this.mobi.loadText(a);this.#rawTail=concatTypedArray(a,this.#rawTail)}i=this.#fullRawLength-this.#rawTail.length;return this.#rawTail.slice(e-i,t-i)}loadFlow(e){if(e<4294967295)return this.loadRaw(...this.#tables.fdstTable[e])}async loadText(e){var{skel:t,frags:r,length:e}=e;const i=await this.loadRaw(t.offset,t.offset+e);let n=i.slice(0,t.length);for(const c of r){var a=c.insertOffset-t.offset,o=t.length+c.offset,s=i.slice(o,o+c.length);n=concatTypedArray3(n.slice(0,a),s,n.slice(a));a=this.#fragmentOffsets.get(c.index);if(a)for(const d of a){var l=this.mobi.decode(s).slice(d),l=getFragmentSelector(l);this.#setFragmentSelector(c.index,d,l)}}return this.mobi.decode(n)}async createDocument(e){e=await this.loadText(e);return this.parser.parseFromString(e,this.#type)}async loadSection(e){if(this.#cache.has(e))return this.#cache.get(e);var t=await this.loadText(e),t=await this.replaceResources(t);let r=this.parser.parseFromString(t,this.#type);r.querySelector("parsererror")&&(this.#type=MIME$1.HTML,r=this.parser.parseFromString(t,this.#type));for(const[i,n]of this.#inlineMap)for(const a of r.querySelectorAll(`img[src="${i}"]`))a.replaceWith(n);const i=URL.createObjectURL(new Blob([this.serializer.serializeToString(r)],{type:this.#type}));return this.#cache.set(e,i),i}getIndexByFID(t){return this.#sections.findIndex(e=>e.frags.some(e=>e.index===t))}#setFragmentSelector(e,t,r){const i=this.#fragmentSelectors.get(e);if(i)i.set(t,r);else{const i=new Map;this.#fragmentSelectors.set(e,i),i.set(t,r)}}async resolveHref(e){const{fid:t,off:r}=parsePosURI(e);var i=this.getIndexByFID(t);if(!(i<0)){const a=this.#fragmentSelectors.get(t)?.get(r);if(a)return{index:i,anchor:e=>e.querySelector(a)};const{skel:o,frags:s}=this.#sections[i];var n=s.find(e=>e.index===t),e=o.offset+o.length+n.offset,n=await this.loadRaw(e,e+n.length),n=this.mobi.decode(n).slice(r);const l=getFragmentSelector(n);this.#setFragmentSelector(t,r,l);return{index:i,anchor:e=>e.querySelector(l)}}}splitTOCHref(e){e=parsePosURI(e);return[this.getIndexByFID(e.fid),e]}getTOCFragment(e,{fid:t,off:r}){r=this.#fragmentSelectors.get(t)?.get(r);return e.querySelector(r)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}destroy(){for(const e of this.#cache.values())URL.revokeObjectURL(e)}}class MobiRender extends GeneralRender{constructor(e,t,r){super(t,"MOBI",r),this.mobiBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book||(yield this.parse());let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){try{var e=new Blob([this.mobiBuffer]),t=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});(yield isMOBI(t))&&(this.book=yield new MOBI({unzlib:window.fflate.unzlibSync}).open(t))}catch(e){throw console.log(e),e}})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}getMetadata(){return __awaiter(this,void 0,void 0,function*(){try{this.book||(yield this.parse());let e=new GeneralParser(this.book);return yield e.getMetadata()}catch(e){throw console.log(e),e}})}}const pdfjsPath=e=>`./lib/pdfjs/${e}`,pdfjsLib=window.pdfjsLib,fetchText=async e=>(await fetch(e)).text(),textLayerBuilderCSS=async()=>fetchText(pdfjsPath("text_layer_builder.css")),annotationLayerBuilderCSS=async()=>fetchText(pdfjsPath("annotation_layer_builder.css")),render=async(e,t,r)=>{var i=r*devicePixelRatio;let n=t.querySelector(".docLayer");n.style.transform=`scale(${1/devicePixelRatio})`,n.style.transformOrigin="top left",n.style.setProperty("--scale-factor",i);r=e.getViewport({scale:i});const a=document.createElement("canvas");n.style.width=`${r.width}px`,n.style.height=`${r.height}px`,a.height=r.height,a.width=r.width;i=a.getContext("2d");await e.render({canvasContext:i,viewport:r}).promise,t.querySelector("#canvas").replaceChildren(t.adoptNode(a)),n.style.overflow="hidden";const o=t.querySelector(".textLayer"),s=new pdfjsLib.TextLayer({textContentSource:await e.streamTextContent(),container:o,viewport:r});await s.render();for(const a of document.querySelectorAll(".hiddenCanvasElement"))Object.assign(a.style,{position:"absolute",top:"0",left:"0",width:"0",height:"0",display:"none"});const l=document.createElement("div");l.className="endOfContent",o.append(l),o.onpointerdown=()=>o.classList.add("selecting"),o.onpointerup=()=>o.classList.remove("selecting");t=t.querySelector(".annotationLayer");await new pdfjsLib.AnnotationLayer({page:e,viewport:r,div:t}).render({annotations:await e.getAnnotations(),linkService:{goToDestination:()=>{},getDestinationHash:e=>JSON.stringify(e),addLinkAttributes:(e,t)=>e.href=t}})},renderPage=async(e,t)=>{var r=e.getViewport({scale:1});if(t){const i=document.createElement("canvas");i.height=r.height,i.width=r.width;t=i.getContext("2d");return await e.render({canvasContext:t,viewport:r}).promise,new Promise(e=>i.toBlob(e))}return URL.createObjectURL(new Blob([`
        <!DOCTYPE html>
        <html lang="en">
        <meta charset="utf-8">
        <meta name="viewport" content="width=${r.width}, height=${r.height}">
        <style>
        html, body {
            margin: 0;
            padding: 0;
        }
        ${await textLayerBuilderCSS()}
        ${await annotationLayerBuilderCSS()}
        </style>
        <div class="noteLayer"></div>
        <div class="docLayer">
            <div class="textLayer"></div>
            <div class="annotationLayer"></div>
            <div id="canvas"></div>
        </div>

    `],{type:"text/html"}))},makeTOCItem=e=>({label:e.title,href:JSON.stringify(e.dest),subitems:e.items.length?e.items.map(makeTOCItem):null}),makePDF=async r=>{const i=new pdfjsLib.PDFDataRangeTransport(r.size,[]);i.requestDataRange=(t,e)=>{r.slice(t,e).arrayBuffer().then(e=>{i.onDataRange(t,e)})};const n=await pdfjsLib.getDocument({range:i,cMapUrl:pdfjsPath("cmaps/"),standardFontDataUrl:pdfjsPath("standard_fonts/"),isEvalSupported:!1}).promise,e={rendition:{layout:"pre-paginated"}},{metadata:t,info:a}=await n.getMetadata()??{};e.metadata={title:t?.get("dc:title")??a?.Title,author:t?.get("dc:creator")??a?.Author,contributor:t?.get("dc:contributor"),description:t?.get("dc:description")??a?.Subject,language:t?.get("dc:language"),publisher:t?.get("dc:publisher"),subject:t?.get("dc:subject"),identifier:t?.get("dc:identifier"),source:t?.get("dc:source"),rights:t?.get("dc:rights")};const o=await n.getOutline();e.toc=o?.map(makeTOCItem);const s=new Map;return e.sections=Array.from({length:n.numPages}).map((e,r)=>({id:r,load:async()=>{var e=s.get(r);if(e)return e;e=await renderPage(await n.getPage(r+1));return console.log(e),s.set(r,e),e},unload:async()=>{var e=s.get(r);console.log(e),URL.revokeObjectURL(e),s.delete(r);let t=await n.getPage(r+1);t.cleanup()},render:async(e,t)=>render(await n.getPage(r+1),e,t),size:1e3,getDimension:async()=>{var e=(await n.getPage(r+1)).getViewport({scale:1});return{width:e.width,height:e.height}},getPage:async()=>n.getPage(r+1)})),e.isExternal=e=>/^\w+:/i.test(e),e.resolveHref=async e=>{e=JSON.parse(e),e="string"==typeof e?await n.getDestination(e):e;return{index:await n.getPageIndex(e[0])}},e.splitTOCHref=async e=>{e=JSON.parse(e),e="string"==typeof e?await n.getDestination(e):e;return[await n.getPageIndex(e[0]),null]},e.getTOCFragment=e=>e.documentElement,e.getCover=async()=>renderPage(await n.getPage(1),!0),e.destroy=()=>n.destroy(),e},isPDF=async e=>{e=new Uint8Array(await e.slice(0,5).arrayBuffer());return 37===e[0]&&80===e[1]&&68===e[2]&&70===e[3]&&45===e[4]};class PdfRender extends GeneralRender{constructor(e,t,r){super(t,"PDF",r),this.pdfBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book||(yield this.parse());let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){try{var e=new Blob([this.pdfBuffer]),t=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});(yield isPDF(t))&&(this.book=yield makePDF(t))}catch(e){throw console.log(e),e}})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}getMetadata(){return __awaiter(this,void 0,void 0,function*(){try{this.book||(yield this.parse());let e=new GeneralParser(this.book);return yield e.getMetadata()}catch(e){throw console.log(e),e}})}getHightlightCoords(l){return __awaiter(this,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var n=e.getElementsByTagName("iframe")[0];if(n&&n.contentWindow){let i=n.contentDocument;if(i){var a=i.getSelection().getRangeAt(0).getClientRects();let e=yield this.chapterDocList[l].text.getPage();var n=yield getPdfScale(this.element,this.mode,this.chapterDocList,l),o=e.getViewport({scale:n});let t=i.querySelector("canvas");var s=null===t||void 0===t?void 0:t.getClientRects()[0];let r=[];for(let e=0;e<a.length;e++)0!==e&&Math.abs(r[r.length-1].bottom-a[e].bottom)<5?(r[r.length-1].left>a[e].left&&(r[r.length-1].left=a[e].left),r[r.length-1].right<a[e].right&&(r[r.length-1].right=a[e].right)):r.push({bottom:a[e].bottom,top:a[e].top,left:a[e].left,right:a[e].right});n=r.map(function(e){return o.convertToPdfPoint(e.left-s.x,e.top-s.y).concat(o.convertToPdfPoint(e.right-s.x,e.bottom-s.y))});return{page:l,coords:n}}}}})}renderHighlighters(s,l){var c;return __awaiter(this,void 0,void 0,function*(){clearHighlight();for(let r=0;r<s.length;r++){var i=s[r];let e=document.getElementById("page-area");if(!e)return;var n=e.getElementsByTagName("iframe")[0];if(!n||!n.contentWindow)return;let t=n.contentWindow||(null===(c=n.contentDocument)||void 0===c?void 0:c.defaultView);var a=JSON.parse(i.range),o=a.page,n=yield this.chapterDocList[o].text.getPage(),o=yield getPdfScale(this.element,this.mode,this.chapterDocList,o);try{showPDFHighlight(a,i.color,i.key,l,n,o)}catch(e){return void console.warn(e,"Exception has been caught when restore character ranges.")}if(!t||!t.getSelection())return;null!==(c=t.getSelection())&&void 0!==c&&c.empty()}})}createOneNote(n,a){var o,s;return __awaiter(this,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t&&t.contentWindow){let e=t.contentWindow||(null===(o=t.contentDocument)||void 0===o?void 0:o.defaultView);var r=JSON.parse(n.range),i=r.page,t=yield this.chapterDocList[i].text.getPage(),i=yield getPdfScale(this.element,this.mode,this.chapterDocList,i);showPDFHighlight(r,n.color,n.key,a,t,i),e&&e.getSelection()&&null!==(s=e.getSelection())&&void 0!==s&&s.empty()}}})}}const makeHtmlBook=(e,t=!1)=>{e=(new DOMParser).parseFromString(t?txtToHtml(e):e,"text/html");let r=getTitleElement(e);0===r.length&&(r=getTitlefromText(e));for(let e=0;e<r.length;e++){var i=document.createElement("address"),n=document.createTextNode(" ");i.appendChild(n),r[e].parentNode&&r[e].parentNode.insertBefore(i,r[e])}const a=getChapterDoc(e.body.innerHTML),o={getCover:()=>""};return o.sections=a.map(e=>({id:e.index,load:()=>(e=>__awaiter(void 0,void 0,void 0,function*(){return URL.createObjectURL(new Blob([a[e].text],{type:"text/html"}))}))(e.index),unload:()=>{e.index}})),o.toc=a.map(e=>({label:e.label,href:"title"+e.index})).filter(e=>""!==e.label),o.rendition={layout:"pre-paginated"},o.resolveHref=e=>({index:parseInt(e.substring(5,e.length))}),o.splitTOCHref=e=>[e,null],o.getTOCFragment=e=>e.documentElement,o};let keywords=["","","","","","","","","","","",""," ",""],containChars=[],startWithChars=["CHAPTER","Chapter","","","","","","",""],startWithNumAndChars=[" ","","","",".","",":"];String.prototype.contains=function(e){return-1<this.indexOf(e)},String.prototype.slim=function(){return this.split("").filter(e=>"="!==e&&"-"!==e&&"_"!==e&&"+"!==e).join("")};const getTitleElement=e=>Array.from(e.querySelectorAll("h1,h2,h3,h4,h5,h6,title")),cleanText=e=>e.trim().replace(/(\r\n|\n|\r|\t)/gm,"").substring(0,100),isTitle=e=>e&&e.length<40&&!isContain(e)&&(isStartWithChars(e)||e.startsWith("")&&startWithDI(e)||e.startsWith("")&&startWithJUAN(e)||e.contains("")&&e.lastIndexOf("")<4&&startWithDI(e.substr(e.indexOf("")))||isStartWithNumAndChars(e)),isContain=t=>0<containChars.filter(e=>-1<t.indexOf(e)).length,isStartWithChars=t=>0<startWithChars.filter(e=>t.startsWith(e)||t.startsWith(window.ChineseS2T.s2t(e))||t.startsWith(window.ChineseS2T.t2s(e))).length,isStartWithNumAndChars=t=>0<startWithNumAndChars.filter(e=>-1<t.indexOf(e)&&(/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(t.substring(0,t.indexOf(e)))||/^\d+$/.test(t.substring(0,t.indexOf(e))))).length,startWithDI=t=>{let r=!1;for(let e=0;e<keywords.length&&((/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(t.substring(1,t.indexOf(keywords[e])).trim())||/^\d+$/.test(t.substring(1,t.indexOf(keywords[e])).trim()))&&(r=!0),!r);e++);return r},startWithJUAN=e=>!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf(" ")))&&!/^\d+$/.test(e.substring(1,e.indexOf(" "))))||(!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf("")))&&!/^\d+$/.test(e.substring(1,e.indexOf(""))))||!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1))&&!/^\d+$/.test(e.substring(1)))),getChapterDoc=e=>{let t=e.split("<address> </address>").filter(e=>""!==e.trim()),r=t.map(e=>getHFromStr(e)||getTitleFromStr(e));return t.map((e,t)=>({index:t,label:r[t],text:e,href:"title"+t}))},txtToHtml=e=>{let t="";var r;for(r of e.split("\n"))cleanText(r).slim()&&isTitle(cleanText(r).slim())?t+=`<h1>${cleanText(r).slim()}</h1>`:t+=`<p>${r}</p>`;return t||`<h1>Title</h1><p>${e}</p>`},getHFromStr=e=>{const t=/<h[1-6][^>]*>(.*?)<\/h[1-6]>/.exec(e);return t?t[1].replace(/&lt;/g,"<").replace(/&gt;/g,">"):""},getTitleFromStr=e=>{const t=/<title[^>]*>(.*?)<\/title>/.exec(e);return t?t[1].replace(/&lt;/g,"<").replace(/&gt;/g,">"):""},getTitlefromText=e=>{var e=e.getElementsByTagName("*"),t=Array.from(e).filter(e=>1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE&&isTitle(cleanText(e.textContent).slim()));let r=[];for(let e=0;e<t.length;e++){const i=t[e],n=document.createElement("h1");n.innerHTML=i.innerText,i.parentNode.replaceChild(n,i),r.push(n)}return r};var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var lib={},browser={};Object.defineProperty(browser,"__esModule",{value:!0}),browser.default=()=>{throw new Error("File system is not available")};var ascii={},match={};Object.defineProperty(match,"__esModule",{value:!0}),match.default=(e,t,r)=>({confidence:r,name:t.name(e),lang:t.language?t.language():void 0});var __importDefault$5=commonjsGlobal&&commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ascii,"__esModule",{value:!0});const match_1$5=__importDefault$5(match);class Ascii{name(){return"ASCII"}match(t){var r=t.rawInput;for(let e=0;e<t.rawLen;e++){var i=r[e];if(i<32||126<i)return(0,match_1$5.default)(t,this,0)}return(0,match_1$5.default)(t,this,100)}}ascii.default=Ascii;var utf8={},__importDefault$4=commonjsGlobal&&commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(utf8,"__esModule",{value:!0});const match_1$4=__importDefault$4(match);class Utf8{name(){return"UTF-8"}match(t){let e=!1,r=0,i=0,n=0,a;var o=t.rawInput;3<=t.rawLen&&239==(255&o[0])&&187==(255&o[1])&&191==(255&o[2])&&(e=!0);for(let e=0;e<t.rawLen;e++){var s=o[e];if(0!=(128&s)){if(192==(224&s))n=1;else if(224==(240&s))n=2;else if(240==(248&s))n=3;else{if(i++,5<i)break;n=0}for(;e++,!(e>=t.rawLen);){if(128!=(192&o[e])){i++;break}if(0==--n){r++;break}}}}if(a=0,e&&0==i)a=100;else if(e&&r>10*i)a=80;else if(3<r&&0==i)a=100;else if(0<r&&0==i)a=80;else if(0==r&&0==i)a=10;else{if(!(r>10*i))return null;a=25}return(0,match_1$4.default)(t,this,a)}}utf8.default=Utf8;var unicode={},__importDefault$3=commonjsGlobal&&commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(unicode,"__esModule",{value:!0}),unicode.UTF_32LE=unicode.UTF_32BE=unicode.UTF_16LE=unicode.UTF_16BE=void 0;const match_1$3=__importDefault$3(match);class UTF_16BE{name(){return"UTF-16BE"}match(e){var t=e.rawInput;return 2<=t.length&&254==(255&t[0])&&255==(255&t[1])?(0,match_1$3.default)(e,this,100):null}}unicode.UTF_16BE=UTF_16BE;class UTF_16LE{name(){return"UTF-16LE"}match(e){var t=e.rawInput;return!(2<=t.length&&255==(255&t[0])&&254==(255&t[1]))||4<=t.length&&0==t[2]&&0==t[3]?null:(0,match_1$3.default)(e,this,100)}}unicode.UTF_16LE=UTF_16LE;class UTF_32{name(){return"UTF-32"}getChar(e,t){return-1}match(e){let t=0,r=0,i=!1,n=0;var a=e.rawLen/4*4,o=e.rawInput;if(0==a)return null;65279==this.getChar(o,0)&&(i=!0);for(let e=0;e<a;e+=4){var s=this.getChar(o,e);s<0||1114111<=s||55296<=s&&s<=57343?r+=1:t+=1}return i&&0==r?n=100:i&&t>10*r?n=80:3<t&&0==r?n=100:0<t&&0==r?n=80:t>10*r&&(n=25),0==n?null:(0,match_1$3.default)(e,this,n)}}class UTF_32BE extends UTF_32{name(){return"UTF-32BE"}getChar(e,t){return(255&e[t+0])<<24|(255&e[t+1])<<16|(255&e[t+2])<<8|255&e[t+3]}}unicode.UTF_32BE=UTF_32BE;class UTF_32LE extends UTF_32{name(){return"UTF-32LE"}getChar(e,t){return(255&e[t+3])<<24|(255&e[t+2])<<16|(255&e[t+1])<<8|255&e[t+0]}}unicode.UTF_32LE=UTF_32LE;var mbcs$1={},__importDefault$2=commonjsGlobal&&commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(mbcs$1,"__esModule",{value:!0}),mbcs$1.gb_18030=mbcs$1.euc_kr=mbcs$1.euc_jp=mbcs$1.big5=mbcs$1.sjis=void 0;const match_1$2=__importDefault$2(match);function binarySearch(e,t){const a=(e,t,r,i)=>{if(i<r)return-1;var n=Math.floor(r+i>>>1);return t>e[n]?a(e,t,n+1,i):t<e[n]?a(e,t,r,n-1):n};return a(e,t,0,e.length-1)}class IteratedChar{constructor(){this.charValue=0,this.index=0,this.nextIndex=0,this.error=!1,this.done=!1}reset(){this.charValue=0,this.index=-1,this.nextIndex=0,this.error=!1,this.done=!1}nextByte(e){return this.nextIndex>=e.rawLen?(this.done=!0,-1):255&e.rawInput[this.nextIndex++]}}class mbcs{constructor(){this.commonChars=[]}name(){return"mbcs"}match(e){let t=0,r=0,i=0,n=0,a=0;const o=new IteratedChar;e:{for(o.reset();this.nextChar(o,e);){var s;if(n++,o.error?i++:255<(s=4294967295&o.charValue)&&(t++,null!=this.commonChars&&0<=binarySearch(this.commonChars,s)&&r++),2<=i&&5*i>=t)break e}var l;t<=10&&0==i?a=0==t&&n<10?0:10:t<20*i?a=0:null==this.commonChars?(a=30+t-20*i,100<a&&(a=100)):(l=90/Math.log(t/4),a=Math.floor(Math.log(r+1)*l+10),a=Math.min(a,100))}return 0==a?null:(0,match_1$2.default)(e,this,a)}nextChar(e,t){return!0}}class sjis extends mbcs{constructor(){super(...arguments),this.commonChars=[33088,33089,33090,33093,33115,33129,33130,33141,33142,33440,33442,33444,33449,33450,33451,33453,33455,33457,33459,33461,33463,33469,33470,33473,33476,33477,33478,33480,33481,33484,33485,33500,33504,33511,33512,33513,33514,33520,33521,33601,33603,33614,33615,33624,33630,33634,33639,33653,33654,33673,33674,33675,33677,33683,36502,37882,38314]}name(){return"Shift_JIS"}language(){return"ja"}nextChar(e,t){e.index=e.nextIndex,e.error=!1;var r=e.charValue=e.nextByte(t);if(r<0)return!1;if(r<=127||160<r&&r<=223)return!0;t=e.nextByte(t);return!(t<0)&&(e.charValue=r<<8|t,64<=t&&t<=127||128<=t&&t<=255||(e.error=!0),!0)}}mbcs$1.sjis=sjis;class big5 extends mbcs{constructor(){super(...arguments),this.commonChars=[41280,41281,41282,41283,41287,41289,41333,41334,42048,42054,42055,42056,42065,42068,42071,42084,42090,42092,42103,42147,42148,42151,42177,42190,42193,42207,42216,42237,42304,42312,42328,42345,42445,42471,42583,42593,42594,42600,42608,42664,42675,42681,42707,42715,42726,42738,42816,42833,42841,42970,43171,43173,43181,43217,43219,43236,43260,43456,43474,43507,43627,43706,43710,43724,43772,44103,44111,44208,44242,44377,44745,45024,45290,45423,45747,45764,45935,46156,46158,46412,46501,46525,46544,46552,46705,47085,47207,47428,47832,47940,48033,48593,49860,50105,50240,50271]}name(){return"Big5"}language(){return"zh"}nextChar(e,t){e.index=e.nextIndex,e.error=!1;var r=e.charValue=e.nextByte(t);if(r<0)return!1;if(r<=127||255==r)return!0;t=e.nextByte(t);return!(t<0)&&(e.charValue=e.charValue<<8|t,(t<64||127==t||255==t)&&(e.error=!0),!0)}}function eucNextChar(e,t){e.index=e.nextIndex,e.error=!1;var r,i,n;return(r=e.charValue=e.nextByte(t))<0?e.done=!0:r<=141||(i=e.nextByte(t),e.charValue=e.charValue<<8|i,!(161<=r&&r<=254)&&142!=r?143==r&&(n=e.nextByte(t),e.charValue=e.charValue<<8|n,n<161&&(e.error=!0)):i<161&&(e.error=!0)),0==e.done}mbcs$1.big5=big5;class euc_jp extends mbcs{constructor(){super(...arguments),this.commonChars=[41377,41378,41379,41382,41404,41418,41419,41430,41431,42146,42148,42150,42152,42154,42155,42156,42157,42159,42161,42163,42165,42167,42169,42171,42173,42175,42176,42177,42179,42180,42182,42183,42184,42185,42186,42187,42190,42191,42192,42206,42207,42209,42210,42212,42216,42217,42218,42219,42220,42223,42226,42227,42402,42403,42404,42406,42407,42410,42413,42415,42416,42419,42421,42423,42424,42425,42431,42435,42438,42439,42440,42441,42443,42448,42453,42454,42455,42462,42464,42465,42469,42473,42474,42475,42476,42477,42483,47273,47572,47854,48072,48880,49079,50410,50940,51133,51896,51955,52188,52689],this.nextChar=eucNextChar}name(){return"EUC-JP"}language(){return"ja"}}mbcs$1.euc_jp=euc_jp;class euc_kr extends mbcs{constructor(){super(...arguments),this.commonChars=[45217,45235,45253,45261,45268,45286,45293,45304,45306,45308,45496,45497,45511,45527,45538,45994,46011,46274,46287,46297,46315,46501,46517,46527,46535,46569,46835,47023,47042,47054,47270,47278,47286,47288,47291,47337,47531,47534,47564,47566,47613,47800,47822,47824,47857,48103,48115,48125,48301,48314,48338,48374,48570,48576,48579,48581,48838,48840,48863,48878,48888,48890,49057,49065,49088,49124,49131,49132,49144,49319,49327,49336,49338,49339,49341,49351,49356,49358,49359,49366,49370,49381,49403,49404,49572,49574,49590,49622,49631,49654,49656,50337,50637,50862,51151,51153,51154,51160,51173,51373],this.nextChar=eucNextChar}name(){return"EUC-KR"}language(){return"ko"}}mbcs$1.euc_kr=euc_kr;class gb_18030 extends mbcs{constructor(){super(...arguments),this.commonChars=[41377,41378,41379,41380,41392,41393,41457,41459,41889,41900,41914,45480,45496,45502,45755,46025,46070,46323,46525,46532,46563,46767,46804,46816,47010,47016,47037,47062,47069,47284,47327,47350,47531,47561,47576,47610,47613,47821,48039,48086,48097,48122,48316,48347,48382,48588,48845,48861,49076,49094,49097,49332,49389,49611,49883,50119,50396,50410,50636,50935,51192,51371,51403,51413,51431,51663,51706,51889,51893,51911,51920,51926,51957,51965,52460,52728,52906,52932,52946,52965,53173,53186,53206,53442,53445,53456,53460,53671,53930,53938,53941,53947,53972,54211,54224,54269,54466,54490,54754,54992]}name(){return"GB18030"}language(){return"zh"}nextChar(e,t){e.index=e.nextIndex,e.error=!1;var r,i,n,a;return(r=e.charValue=e.nextByte(t))<0?e.done=!0:r<=128||(i=e.nextByte(t),e.charValue=e.charValue<<8|i,129<=r&&r<=254&&(64<=i&&i<=126||80<=i&&i<=254||(48<=i&&i<=57&&129<=(n=e.nextByte(t))&&n<=254&&48<=(a=e.nextByte(t))&&a<=57?e.charValue=e.charValue<<16|n<<8|a:e.error=!0))),0==e.done}}mbcs$1.gb_18030=gb_18030;var sbcs$1={},__importDefault$1=commonjsGlobal&&commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(sbcs$1,"__esModule",{value:!0}),sbcs$1.KOI8_R=sbcs$1.windows_1256=sbcs$1.windows_1251=sbcs$1.ISO_8859_9=sbcs$1.ISO_8859_8=sbcs$1.ISO_8859_7=sbcs$1.ISO_8859_6=sbcs$1.ISO_8859_5=sbcs$1.ISO_8859_2=sbcs$1.ISO_8859_1=void 0;const match_1$1=__importDefault$1(match),N_GRAM_MASK=16777215;class NGramParser{constructor(e,t){this.byteIndex=0,this.ngram=0,this.ngramCount=0,this.hitCount=0,this.spaceChar=32,this.ngramList=e,this.byteMap=t}search(e,t){let r=0;return e[r+32]<=t&&(r+=32),e[r+16]<=t&&(r+=16),e[r+8]<=t&&(r+=8),e[r+4]<=t&&(r+=4),e[r+2]<=t&&(r+=2),e[r+1]<=t&&(r+=1),e[r]>t&&--r,r<0||e[r]!=t?-1:r}lookup(e){this.ngramCount+=1,0<=this.search(this.ngramList,e)&&(this.hitCount+=1)}addByte(e){this.ngram=(this.ngram<<8)+(255&e)&N_GRAM_MASK,this.lookup(this.ngram)}nextByte(e){return this.byteIndex>=e.inputLen?-1:255&e.inputBytes[this.byteIndex++]}parse(e,t){let r,i=!1;for(this.spaceChar=t;0<=(r=this.nextByte(e));){var n=this.byteMap[r];0!=n&&(n==this.spaceChar&&i||this.addByte(n),i=n==this.spaceChar)}this.addByte(this.spaceChar);t=this.hitCount/this.ngramCount;return.33<t?98:Math.floor(300*t)}}class NGramsPlusLang{constructor(e,t){this.fLang=e,this.fNGrams=t}}const isFlatNgrams=e=>Array.isArray(e)&&isFinite(e[0]);class sbcs{constructor(){this.spaceChar=32,this.nGramLang=void 0}ngrams(){return[]}byteMap(){return[]}name(e){return"sbcs"}language(){return this.nGramLang}match(t){this.nGramLang=void 0;var r=this.ngrams();if(isFlatNgrams(r)){const o=new NGramParser(r,this.byteMap());var e=o.parse(t,this.spaceChar);return e<=0?null:(0,match_1$1.default)(t,this,e)}let i=-1;for(let e=r.length-1;0<=e;e--){var n=r[e];const s=new NGramParser(n.fNGrams,this.byteMap());var a=s.parse(t,this.spaceChar);a>i&&(i=a,this.nGramLang=n.fLang)}return i<=0?null:(0,match_1$1.default)(t,this,i)}}class ISO_8859_1 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,170,32,32,32,32,32,32,32,32,32,32,181,32,32,32,32,186,32,32,32,32,32,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,255]}ngrams(){return[new NGramsPlusLang("da",[2122086,2122100,2122853,2123118,2123122,2123375,2123873,2124064,2125157,2125671,2126053,2126697,2126708,2126953,2127465,6383136,6385184,6385252,6386208,6386720,6579488,6579566,6579570,6579572,6627443,6644768,6644837,6647328,6647396,6648352,6648421,6648608,6648864,6713202,6776096,6776174,6776178,6907749,6908960,6909543,7038240,7039845,7103858,7104871,7105637,7169380,7234661,7234848,7235360,7235429,7300896,7302432,7303712,7398688,7479396,7479397,7479411,7496992,7566437,7610483,7628064,7628146,7629164,7759218]),new NGramsPlusLang("de",[2122094,2122101,2122341,2122849,2122853,2122857,2123113,2123621,2123873,2124142,2125161,2126691,2126693,2127214,2127461,2127471,2127717,2128501,6448498,6514720,6514789,6514804,6578547,6579566,6579570,6580581,6627428,6627443,6646126,6646132,6647328,6648352,6648608,6776174,6841710,6845472,6906728,6907168,6909472,6909541,6911008,7104867,7105637,7217249,7217252,7217267,7234592,7234661,7234848,7235360,7235429,7238757,7479396,7496805,7497065,7562088,7566437,7610468,7628064,7628142,7628146,7695972,7695975,7759218]),new NGramsPlusLang("en",[2122016,2122094,2122341,2122607,2123375,2123873,2123877,2124142,2125153,2125670,2125938,2126437,2126689,2126708,2126952,2126959,2127720,6383972,6384672,6385184,6385252,6386464,6386720,6386789,6386793,6561889,6561908,6627425,6627443,6627444,6644768,6647412,6648352,6648608,6713202,6840692,6841632,6841714,6906912,6909472,6909543,6909806,6910752,7217249,7217268,7234592,7235360,7238688,7300640,7302688,7303712,7496992,7500576,7544929,7544948,7561577,7566368,7610484,7628146,7628897,7628901,7629167,7630624,7631648]),new NGramsPlusLang("es",[2122016,2122593,2122607,2122853,2123116,2123118,2123123,2124142,2124897,2124911,2125921,2125935,2125938,2126197,2126437,2126693,2127214,2128160,6365283,6365284,6365285,6365292,6365296,6382441,6382703,6384672,6386208,6386464,6515187,6516590,6579488,6579564,6582048,6627428,6627429,6627436,6646816,6647328,6647412,6648608,6648692,6907246,6943598,7102752,7106419,7217253,7238757,7282788,7282789,7302688,7303712,7303968,7364978,7435621,7495968,7497075,7544932,7544933,7544944,7562528,7628064,7630624,7693600,15953440]),new NGramsPlusLang("fr",[2122101,2122607,2122849,2122853,2122869,2123118,2123124,2124897,2124901,2125921,2125935,2125938,2126197,2126693,2126703,2127214,2154528,6385268,6386793,6513952,6516590,6579488,6579571,6583584,6627425,6627427,6627428,6627429,6627436,6627440,6627443,6647328,6647412,6648352,6648608,6648864,6649202,6909806,6910752,6911008,7102752,7103776,7103859,7169390,7217252,7234848,7238432,7238688,7302688,7302772,7304562,7435621,7479404,7496992,7544929,7544932,7544933,7544940,7544944,7610468,7628064,7629167,7693600,7696928]),new NGramsPlusLang("it",[2122092,2122600,2122607,2122853,2122857,2123040,2124140,2124142,2124897,2125925,2125938,2127214,6365283,6365284,6365296,6365299,6386799,6514789,6516590,6579564,6580512,6627425,6627427,6627428,6627433,6627436,6627440,6627443,6646816,6646892,6647412,6648352,6841632,6889569,6889571,6889572,6889587,6906144,6908960,6909472,6909806,7102752,7103776,7104800,7105633,7234848,7235872,7237408,7238757,7282785,7282788,7282793,7282803,7302688,7302757,7366002,7495968,7496992,7563552,7627040,7628064,7629088,7630624,8022383]),new NGramsPlusLang("nl",[2122092,2122341,2122849,2122853,2122857,2123109,2123118,2123621,2123877,2124142,2125153,2125157,2125680,2126949,2127457,2127461,2127471,2127717,2128489,6381934,6381938,6385184,6385252,6386208,6386720,6514804,6579488,6579566,6579570,6627426,6627446,6645102,6645106,6647328,6648352,6648435,6648864,6776174,6841716,6907168,6909472,6909543,6910752,7217250,7217252,7217253,7217256,7217263,7217270,7234661,7235360,7302756,7303026,7303200,7303712,7562088,7566437,7610468,7628064,7628142,7628146,7758190,7759218,7761775]),new NGramsPlusLang("no",[2122100,2122102,2122853,2123118,2123122,2123375,2123873,2124064,2125157,2125671,2126053,2126693,2126699,2126703,2126708,2126953,2127465,2155808,6385252,6386208,6386720,6579488,6579566,6579572,6627443,6644768,6647328,6647397,6648352,6648421,6648864,6648948,6713202,6776174,6908779,6908960,6909543,7038240,7039845,7103776,7105637,7169380,7169390,7217267,7234848,7235360,7235429,7237221,7300896,7302432,7303712,7398688,7479411,7496992,7565165,7566437,7610483,7628064,7628142,7628146,7629164,7631904,7631973,7759218]),new NGramsPlusLang("pt",[2122016,2122607,2122849,2122853,2122863,2123040,2123123,2125153,2125423,2125600,2125921,2125935,2125938,2126197,2126437,2126693,2127213,6365281,6365283,6365284,6365296,6382693,6382703,6384672,6386208,6386273,6386464,6516589,6516590,6578464,6579488,6582048,6582131,6627425,6627428,6647072,6647412,6648608,6648692,6906144,6906721,7169390,7238757,7238767,7282785,7282787,7282788,7282789,7282800,7303968,7364978,7435621,7495968,7497075,7544929,7544932,7544933,7544944,7566433,7628064,7630624,7693600,14905120,15197039]),new NGramsPlusLang("sv",[2122100,2122102,2122853,2123118,2123510,2123873,2124064,2124142,2124655,2125157,2125667,2126053,2126699,2126703,2126708,2126953,2127457,2127465,2155634,6382693,6385184,6385252,6386208,6386804,6514720,6579488,6579566,6579570,6579572,6644768,6647328,6648352,6648864,6747762,6776174,6909036,6909543,7037216,7105568,7169380,7217267,7233824,7234661,7235360,7235429,7235950,7299944,7302432,7302688,7398688,7479393,7479411,7495968,7564129,7565165,7610483,7627040,7628064,7628146,7629164,7631904,7758194,14971424,16151072])]}name(e){return e&&e.c1Bytes?"windows-1252":"ISO-8859-1"}}sbcs$1.ISO_8859_1=ISO_8859_1;class ISO_8859_2 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,177,32,179,32,181,182,32,32,185,186,187,188,32,190,191,32,177,32,179,32,181,182,183,32,185,186,187,188,32,190,191,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,32]}ngrams(){return[new NGramsPlusLang("cs",[2122016,2122361,2122863,2124389,2125409,2125413,2125600,2125668,2125935,2125938,2126072,2126447,2126693,2126703,2126708,2126959,2127392,2127481,2128481,6365296,6513952,6514720,6627440,6627443,6627446,6647072,6647533,6844192,6844260,6910836,6972704,7042149,7103776,7104800,7233824,7268640,7269408,7269664,7282800,7300206,7301737,7304052,7304480,7304801,7368548,7368554,7369327,7403621,7562528,7565173,7566433,7566441,7566446,7628146,7630573,7630624,7676016,12477728,14773997,15296623,15540336,15540339,15559968,16278884]),new NGramsPlusLang("hu",[2122016,2122106,2122341,2123111,2123116,2123365,2123873,2123887,2124147,2124645,2124649,2124790,2124901,2125153,2125157,2125161,2125413,2126714,2126949,2156915,6365281,6365291,6365293,6365299,6384416,6385184,6388256,6447470,6448494,6645625,6646560,6646816,6646885,6647072,6647328,6648421,6648864,6648933,6648948,6781216,6844263,6909556,6910752,7020641,7075450,7169383,7170414,7217249,7233899,7234923,7234925,7238688,7300985,7544929,7567973,7567988,7568097,7596391,7610465,7631904,7659891,8021362,14773792,15299360]),new NGramsPlusLang("pl",[2122618,2122863,2124064,2124389,2124655,2125153,2125161,2125409,2125417,2125668,2125935,2125938,2126697,2127648,2127721,2127737,2128416,2128481,6365296,6365303,6385257,6514720,6519397,6519417,6582048,6584937,6627440,6627443,6627447,6627450,6645615,6646304,6647072,6647401,6778656,6906144,6907168,6907242,7037216,7039264,7039333,7170405,7233824,7235937,7235941,7282800,7305057,7305065,7368556,7369313,7369327,7369338,7502437,7502457,7563754,7564137,7566433,7825765,7955304,7957792,8021280,8022373,8026400,15955744]),new NGramsPlusLang("ro",[2122016,2122083,2122593,2122597,2122607,2122613,2122853,2122857,2124897,2125153,2125925,2125938,2126693,2126819,2127214,2144873,2158190,6365283,6365284,6386277,6386720,6386789,6386976,6513010,6516590,6518048,6546208,6579488,6627425,6627427,6627428,6627440,6627443,6644e3,6646048,6646885,6647412,6648692,6889569,6889571,6889572,6889584,6907168,6908192,6909472,7102752,7103776,7106418,7107945,7234848,7238770,7303712,7365998,7496992,7497057,7501088,7594784,7628064,7631477,7660320,7694624,7695392,12216608,15625760])]}name(e){return e&&e.c1Bytes?"windows-1250":"ISO-8859-2"}}sbcs$1.ISO_8859_2=ISO_8859_2;class ISO_8859_5 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,241,242,243,244,245,246,247,248,249,250,251,252,32,254,255,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,32,241,242,243,244,245,246,247,248,249,250,251,252,32,254,255]}ngrams(){return[2150944,2151134,2151646,2152400,2152480,2153168,2153182,2153936,2153941,2154193,2154462,2154464,2154704,2154974,2154978,2155230,2156514,2158050,13688280,13689580,13884960,14015468,14015960,14016994,14017056,14164191,14210336,14211104,14216992,14407133,14407712,14413021,14536736,14538016,14538965,14538991,14540320,14540498,14557394,14557407,14557409,14602784,14602960,14603230,14604576,14605292,14605344,14606818,14671579,14672085,14672088,14672094,14733522,14734804,14803664,14803666,14803672,14806816,14865883,14868e3,14868192,14871584,15196894,15459616]}name(){return"ISO-8859-5"}language(){return"ru"}}sbcs$1.ISO_8859_5=ISO_8859_5;class ISO_8859_6 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,32,32,32,32,32,224,225,226,227,228,229,230,231,232,233,234,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32]}ngrams(){return[2148324,2148326,2148551,2152932,2154986,2155748,2156006,2156743,13050055,13091104,13093408,13095200,13100064,13100227,13100231,13100232,13100234,13100236,13100237,13100239,13100243,13100249,13100258,13100261,13100264,13100266,13100320,13100576,13100746,13115591,13181127,13181153,13181156,13181157,13181160,13246663,13574343,13617440,13705415,13748512,13836487,14229703,14279913,14805536,14950599,14993696,15001888,15002144,15016135,15058720,15059232,15066656,15081671,15147207,15189792,15255524,15263264,15278279,15343815,15343845,15343848,15386912,15388960,15394336]}name(){return"ISO-8859-6"}language(){return"ar"}}sbcs$1.ISO_8859_6=ISO_8859_6;class ISO_8859_7 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,161,162,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,220,32,221,222,223,32,252,32,253,254,192,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,32,243,244,245,246,247,248,249,250,251,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,32]}ngrams(){return[2154989,2154992,2155497,2155753,2156016,2156320,2157281,2157797,2158049,2158368,2158817,2158831,2158833,2159604,2159605,2159847,2159855,14672160,14754017,14754036,14805280,14806304,14807292,14807584,14936545,15067424,15069728,15147252,15199520,15200800,15278324,15327520,15330014,15331872,15393257,15393268,15525152,15540449,15540453,15540464,15589664,15725088,15725856,15790069,15790575,15793184,15868129,15868133,15868138,15868144,15868148,15983904,15984416,15987951,16048416,16048617,16050157,16050162,16050666,16052e3,16052213,16054765,16379168,16706848]}name(e){return e&&e.c1Bytes?"windows-1253":"ISO-8859-7"}language(){return"el"}}sbcs$1.ISO_8859_7=ISO_8859_7;class ISO_8859_8 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,181,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,32,32,32,32,32]}ngrams(){return[new NGramsPlusLang("he",[2154725,2154727,2154729,2154746,2154985,2154990,2155744,2155749,2155753,2155758,2155762,2155769,2155770,2157792,2157796,2158304,2159340,2161132,14744096,14950624,14950625,14950628,14950636,14950638,14950649,15001056,15065120,15068448,15068960,15071264,15071776,15278308,15328288,15328762,15329773,15330592,15331104,15333408,15333920,15474912,15474916,15523872,15524896,15540448,15540449,15540452,15540460,15540462,15540473,15655968,15671524,15787040,15788320,15788525,15920160,16261348,16312813,16378912,16392416,16392417,16392420,16392428,16392430,16392441]),new NGramsPlusLang("he",[2154725,2154732,2155753,2155756,2155758,2155760,2157040,2157810,2157817,2158053,2158057,2158565,2158569,2160869,2160873,2161376,2161381,2161385,14688484,14688492,14688493,14688506,14738464,14738916,14740512,14741024,14754020,14754029,14754042,14950628,14950633,14950636,14950637,14950639,14950648,14950650,15002656,15065120,15066144,15196192,15327264,15327520,15328288,15474916,15474925,15474938,15528480,15530272,15591913,15591920,15591928,15605988,15605997,15606010,15655200,15655968,15918112,16326884,16326893,16326906,16376864,16441376,16442400,16442857])]}name(e){return e&&e.c1Bytes?"windows-1255":"ISO-8859-8"}language(){return"he"}}sbcs$1.ISO_8859_8=ISO_8859_8;class ISO_8859_9 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,170,32,32,32,32,32,32,32,32,32,32,181,32,32,32,32,186,32,32,32,32,32,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,105,254,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,255]}ngrams(){return[2122337,2122345,2122357,2122849,2122853,2123621,2123873,2124140,2124641,2124655,2125153,2125676,2126689,2126945,2127461,2128225,6365282,6384416,6384737,6384993,6385184,6385405,6386208,6386273,6386429,6386685,6388065,6449522,6578464,6579488,6580512,6627426,6627435,6644841,6647328,6648352,6648425,6648681,6909029,6909472,6909545,6910496,7102830,7102834,7103776,7103858,7217249,7217250,7217259,7234657,7234661,7234848,7235872,7235950,7273760,7498094,7535982,7759136,7954720,7958386,16608800,16608868,16609021,16642301]}name(e){return e&&e.c1Bytes?"windows-1254":"ISO-8859-9"}language(){return"tr"}}sbcs$1.ISO_8859_9=ISO_8859_9;class windows_1251 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,144,131,32,131,32,32,32,32,32,32,154,32,156,157,158,159,144,32,32,32,32,32,32,32,32,32,154,32,156,157,158,159,32,162,162,188,32,180,32,32,184,32,186,32,32,32,32,191,32,32,179,179,180,181,32,32,184,32,186,32,188,190,190,191,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255]}ngrams(){return[2155040,2155246,2155758,2156512,2156576,2157280,2157294,2158048,2158053,2158305,2158574,2158576,2158816,2159086,2159090,2159342,2160626,2162162,14740968,14742268,14937632,15068156,15068648,15069682,15069728,15212783,15263008,15263776,15269664,15459821,15460384,15465709,15589408,15590688,15591653,15591679,15592992,15593186,15605986,15605999,15606001,15655456,15655648,15655918,15657248,15657980,15658016,15659506,15724267,15724773,15724776,15724782,15786210,15787492,15856352,15856354,15856360,15859488,15918571,15920672,15920880,15924256,16249582,16512288]}name(){return"windows-1251"}language(){return"ru"}}sbcs$1.windows_1251=windows_1251;class windows_1256 extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,129,32,131,32,32,32,32,136,32,138,32,156,141,142,143,144,32,32,32,32,32,32,32,152,32,154,32,156,32,32,159,32,32,32,32,32,32,32,32,32,32,170,32,32,32,32,32,32,32,32,32,32,181,32,32,32,32,32,32,32,32,32,32,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,32,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,32,32,32,32,244,32,32,32,32,249,32,251,252,32,32,255]}ngrams(){return[2148321,2148324,2148551,2153185,2153965,2154977,2155492,2156231,13050055,13091104,13093408,13095200,13099296,13099459,13099463,13099464,13099466,13099468,13099469,13099471,13099475,13099482,13099486,13099491,13099494,13099501,13099808,13100064,13100234,13115591,13181127,13181149,13181153,13181155,13181158,13246663,13574343,13617440,13705415,13748512,13836487,14295239,14344684,14544160,14753991,14797088,14806048,14806304,14885063,14927648,14928160,14935072,14950599,15016135,15058720,15124449,15131680,15474887,15540423,15540451,15540454,15583520,15585568,15590432]}name(){return"windows-1256"}language(){return"ar"}}sbcs$1.windows_1256=windows_1256;class KOI8_R extends sbcs{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,163,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,163,32,32,32,32,32,32,32,32,32,32,32,32,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223]}ngrams(){return[2147535,2148640,2149313,2149327,2150081,2150085,2150338,2150607,2150610,2151105,2151375,2151380,2151631,2152224,2152399,2153153,2153684,2154196,12701385,12702936,12963032,12963529,12964820,12964896,13094688,13181136,13223200,13224224,13226272,13419982,13420832,13424846,13549856,13550880,13552069,13552081,13553440,13553623,13574352,13574355,13574359,13617103,13617696,13618392,13618464,13620180,13621024,13621185,13684684,13685445,13685449,13685455,13812183,13813188,13881632,13882561,13882569,13882583,13944268,13946656,13946834,13948960,14272544,14603471]}name(){return"KOI8-R"}language(){return"ru"}}sbcs$1.KOI8_R=KOI8_R;var iso2022={},__importDefault=commonjsGlobal&&commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(iso2022,"__esModule",{value:!0}),iso2022.ISO_2022_CN=iso2022.ISO_2022_KR=iso2022.ISO_2022_JP=void 0;const match_1=__importDefault(match);class ISO_2022{constructor(){this.escapeSequences=[]}name(){return"ISO_2022"}match(e){let t,r,i,n=0,a=0,o=0,s;var l=e.inputBytes,c=e.inputLen;e:for(t=0;t<c;t++){if(27==l[t]){t:for(i=0;i<this.escapeSequences.length;i++){var d=this.escapeSequences[i];if(!(c-t<d.length)){for(r=1;r<d.length;r++)if(d[r]!=l[t+r])continue t;n++,t+=d.length-1;continue e}}a++}14!=l[t]&&15!=l[t]||o++}return 0==n?null:(s=(100*n-100*a)/(n+a),n+o<5&&(s-=10*(5-(n+o))),s<=0?null:(0,match_1.default)(e,this,s))}}class ISO_2022_JP extends ISO_2022{constructor(){super(...arguments),this.escapeSequences=[[27,36,40,67],[27,36,40,68],[27,36,64],[27,36,65],[27,36,66],[27,38,64],[27,40,66],[27,40,72],[27,40,73],[27,40,74],[27,46,65],[27,46,70]]}name(){return"ISO-2022-JP"}language(){return"ja"}}iso2022.ISO_2022_JP=ISO_2022_JP;class ISO_2022_KR extends ISO_2022{constructor(){super(...arguments),this.escapeSequences=[[27,36,41,67]]}name(){return"ISO-2022-KR"}language(){return"kr"}}iso2022.ISO_2022_KR=ISO_2022_KR;class ISO_2022_CN extends ISO_2022{constructor(){super(...arguments),this.escapeSequences=[[27,36,41,65],[27,36,41,71],[27,36,42,72],[27,36,41,69],[27,36,43,73],[27,36,43,74],[27,36,43,75],[27,36,43,76],[27,36,43,77],[27,78],[27,79]]}name(){return"ISO-2022-CN"}language(){return"zh"}}iso2022.ISO_2022_CN=ISO_2022_CN;var utils={};Object.defineProperty(utils,"__esModule",{value:!0}),utils.isByteArray=void 0;const isByteArray=e=>null!=e&&"object"==typeof e&&(isFinite(e.length)&&0<=e.length);utils.isByteArray=isByteArray,function(l){var i=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,n)}:function(e,t,r,i){e[i=void 0===i?r:i]=t[r]}),n=commonjsGlobal&&commonjsGlobal.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),e=commonjsGlobal&&commonjsGlobal.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return n(t,e),t},t=commonjsGlobal&&commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(l,"__esModule",{value:!0}),l.detectFileSync=l.detectFile=l.analyse=l.detect=void 0;const c=t(browser),r=t(ascii),a=t(utf8),o=e(unicode),s=e(mbcs$1),d=e(sbcs$1),h=e(iso2022),u=utils,f=[new a.default,new o.UTF_16BE,new o.UTF_16LE,new o.UTF_32BE,new o.UTF_32LE,new s.sjis,new s.big5,new s.euc_jp,new s.euc_kr,new s.gb_18030,new h.ISO_2022_JP,new h.ISO_2022_KR,new h.ISO_2022_CN,new d.ISO_8859_1,new d.ISO_8859_2,new d.ISO_8859_5,new d.ISO_8859_6,new d.ISO_8859_7,new d.ISO_8859_8,new d.ISO_8859_9,new d.windows_1251,new d.windows_1256,new d.KOI8_R,new r.default];l.detect=e=>{e=(0,l.analyse)(e);return 0<e.length?e[0].name:null};l.analyse=t=>{if(!(0,u.isByteArray)(t))throw new Error("Input must be a byte array, e.g. Buffer or Uint8Array");const r=[];for(let e=0;e<256;e++)r[e]=0;for(let e=t.length-1;0<=e;e--)r[255&t[e]]++;let i=!1;for(let e=128;e<=159;e+=1)if(0!==r[e]){i=!0;break}const n={byteStats:r,c1Bytes:i,rawInput:t,rawLen:t.length,inputBytes:t,inputLen:t.length};return f.map(e=>e.match(n)).filter(e=>!!e).sort((e,t)=>t.confidence-e.confidence)};l.detectFile=(e,s={})=>new Promise((r,i)=>{let n;const a=(0,c.default)(),t=(e,t)=>{n&&a.closeSync(n),e?i(e):r((0,l.detect)(t))};if(s&&s.sampleSize){n=a.openSync(e,"r");const o=Buffer.allocUnsafe(s.sampleSize);a.read(n,o,0,s.sampleSize,s.offset,e=>{t(e,o)})}else a.readFile(e,t)});l.detectFileSync=(e,t={})=>{const r=(0,c.default)();if(t&&t.sampleSize){var i=r.openSync(e,"r"),n=Buffer.allocUnsafe(t.sampleSize);return r.readSync(i,n,0,t.sampleSize,t.offset),r.closeSync(i),(0,l.detect)(n)}return(0,l.detect)(r.readFileSync(e))},l.default={analyse:l.analyse,detect:l.detect,detectFileSync:l.detectFileSync,detectFile:l.detectFile}}(lib);var chardet=getDefaultExportFromCjs(lib);class TxtRender extends GeneralRender{constructor(e,t,r,i){super(t,"TXT",i),this.text=e,this.encoding=r,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element="",this.book=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book||(yield this.parse());let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){try{this.book=makeHtmlBook(this.text,!0)}catch(e){throw console.log(e),e}})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}getMetadata(t){return __awaiter(this,void 0,void 0,function*(){try{var e=new Uint8Array(t);return{charset:chardet.detect(e)||"utf8"}}catch(e){throw console.log(e),e}})}}const makeComicBook=({entries:e,loadBlob:i,getSize:t},r)=>{const n=new Map,a=new Map,o=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".svg"],s=e.map(e=>e.filename).filter(t=>o.some(e=>t.endsWith(e))).sort(),l={getCover:()=>i(s[0])};return l.metadata={title:r.name},l.sections=s.map(e=>({id:e,load:()=>(async e=>{if(n.has(e))return n.get(e);var t=URL.createObjectURL(await i(e)),r=URL.createObjectURL(new Blob([`<img src="${t}">`],{type:"text/html"}));return a.set(e,[t,r]),n.set(e,r),r})(e),unload:()=>(e=>{a.get(e)?.forEach?.(e=>URL.revokeObjectURL(e)),a.delete(e),n.delete(e)})(e),size:t(e)})),l.toc=s.map(e=>({label:e,href:e})),l.rendition={layout:"pre-paginated"},l.resolveHref=t=>({index:l.sections.findIndex(e=>e.id===t)}),l.splitTOCHref=e=>[e,null],l.getTOCFragment=e=>e.documentElement,l};class ComicRender extends GeneralRender{constructor(e,t,r,i){super(t,r,i),this.comicBuffer=e,this.mode=t,this.format=r,this.chapterList=[],this.chapterDocList=[],this.book="",this.element="",this.rpc}renderTo(i){return new Promise((t,r)=>__awaiter(this,void 0,void 0,function*(){if(this.element=i,createIframe(i),!this.book)try{yield this.parse()}catch(e){console.log(e),r(e)}let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),handleLayout(i,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){try{var e,t,r,i,n=new Blob([this.comicBuffer]),a=new File([n],"book."+this.format.toLocaleLowerCase(),{lastModified:(new Date).getTime(),type:n.type});"CBZ"===this.format?(e=yield this.makeZipLoader(a),this.book=makeComicBook(e,a)):"CBT"===this.format?(t=yield this.makeTarLoader(),this.book=makeComicBook(t,a)):"CBR"===this.format?(this.rpc=yield window.RPC.new("./lib/libunrar/worker.js",{loaded:function(){console.log("loaded")},progressShow:function(e,t,r){console.log(r)}}),yield new Promise(e=>setTimeout(e,200)),r=yield this.makeRarLoader(),this.book=makeComicBook(r,a)):"CB7"===this.format&&(i=yield this.make7zLoader(),this.book=makeComicBook(i,a))}catch(e){throw console.log(e),e}})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}makeZipLoader(c){return __awaiter(this,void 0,void 0,function*(){const{ZipReader:e,BlobReader:t,TextWriter:r,BlobWriter:i}=window.zip;window.zip.configure({useWebWorkers:!1});const n=new e(new t(c)),a=yield n.getEntries(),o=new Map(a.map(e=>[e.filename,e]));var s=r=>(e,...t)=>o.has(e)?r(o.get(e),...t):null,l=s(e=>e.getData(new r)),s=s((e,t)=>e.getData(new i(t)));return{entries:a,loadText:l,loadBlob:s,getSize:e=>{return null!==(e=null===(e=o.get(e))||void 0===e?void 0:e.uncompressedSize)&&void 0!==e?e:0}}})}makeTarLoader(){return __awaiter(this,void 0,void 0,function*(){const e=yield window.untar(this.comicBuffer),i=new Map(e.map(e=>[e.name,e]));var t=r=>(e,...t)=>i.has(e)?r(i.get(e),...t):null,r=t(e=>e.readAsString()),t=t((e,t)=>e.blob);return{entries:e.map(e=>({filename:e.name})),loadText:r,loadBlob:t,getSize:e=>{return null!==(e=null===(e=i.get(e))||void 0===e?void 0:e.size)&&void 0!==e?e:0}}})}makeRarLoader(){return __awaiter(this,void 0,void 0,function*(){return new Promise((n,t)=>{var e=[this.comicBuffer],r=[{name:"book.rar",content:this.comicBuffer}];this.rpc.transferables=e,this.rpc.unrar(r,null,0).then(e=>{var t=this.getRarEntries(e.ls);const i=new Map(Object.values(t).map(e=>[e.fullFileName,e]));var r=r=>(e,...t)=>i.has(e)?r(i.get(e),...t):null,e=r(e=>e.fullFileName),r=r((e,t)=>new Blob([e.fileContent]));n({entries:Object.values(t).map(e=>({filename:e.fullFileName})),loadText:e,loadBlob:r,getSize:e=>{return null!==(e=null===(e=i.get(e))||void 0===e?void 0:e.fileSize)&&void 0!==e?e:0}})}).catch(e=>{t(e),console.log(e)})})})}make7zLoader(){return __awaiter(this,void 0,void 0,function*(){var e="./lib/7z-wasm/7zz.wasm";if(!window.wasmBinary){const s=yield fetch(e,{credentials:"same-origin"});if(!s.ok)throw"failed to load wasm binary file at '"+e+"'";window.wasmBinary=yield s.arrayBuffer()}const t=yield window.SevenZip({wasmBinary:window.wasmBinary});var r=new Uint8Array(this.comicBuffer),i="archive.cb7",e=t.FS.open(i,"w+");t.FS.write(e,r,0,r.length),t.FS.close(e),t.callMain(["x",i]);const n=t.FS,a=this.get7zEntries(n.lookupPath("/").node),o=new Map(a.map(e=>[e.name,e]));e=r=>(e,...t)=>o.has(e)?r(o.get(e),...t):null,i=e(e=>e.name),e=e((e,t)=>new Blob([e.buffer]));return{entries:a.map(e=>({filename:e.name})),loadText:i,loadBlob:e,getSize:e=>{return null!==(e=null===(e=o.get(e))||void 0===e?void 0:e.packSize)&&void 0!==e?e:0}}})}getRarEntries(t){var r=Object.keys(t);let i=[];for(let e=0;e<r.length;e++){var n=r[e];"dir"===t[n].type?i=i.concat(this.getRarEntries(t[n].ls)):i.push({fullFileName:n,fileContent:t[n].fileContent,fileSize:t[n].fileSize})}return i}get7zEntries(e){var t=e.contents,r=Object.keys(t).filter(e=>"archive.cb7"!=e&&"dev"!=e&&"home"!=e&&"proc"!=e&&"tmp"!=e);let i=[];for(let e=0;e<r.length;e++){var n=r[e];t[n].isFolder?i=i.concat(this.get7zEntries(t[n])):i.push({name:n,buffer:t[n].contents,size:t[n].usedBytes})}return i}getMetadata(){return __awaiter(this,void 0,void 0,function*(){return new Promise((r,i)=>__awaiter(this,void 0,void 0,function*(){try{this.book||(yield this.parse());var e=yield this.book.getCover(),t=new FileReader;t.readAsDataURL(e),t.onloadend=()=>{r({cover:t.result})}}catch(e){console.log(e),i(e)}}))})}}const trim=e=>e?.trim()?.replace(/\s{2,}/g," "),getElementText=e=>trim(e?.textContent),NS={XLINK:"http://www.w3.org/1999/xlink",EPUB:"http://www.idpf.org/2007/ops"},MIME={XML:"application/xml",XHTML:"application/xhtml+xml"},STYLE={strong:["strong","self"],emphasis:["em","self"],style:["span","self"],a:"anchor",strikethrough:["s","self"],sub:["sub","self"],sup:["sup","self"],code:["code","self"],image:"image"},TABLE={tr:["tr",["align"]],th:["th",["colspan","rowspan","align","valign"]],td:["td",["colspan","rowspan","align","valign"]]},POEM={epigraph:["blockquote"],subtitle:["h2",STYLE],"text-author":["p",STYLE],date:["p",STYLE],stanza:"stanza"},SECTION={title:["header",{p:["h1",STYLE],"empty-line":["br"]}],epigraph:["blockquote","self"],image:"image",annotation:["aside"],section:["section","self"],p:["p",STYLE],poem:["blockquote",POEM],subtitle:["h2",STYLE],cite:["blockquote","self"],"empty-line":["br"],table:["table",TABLE],"text-author":["p",STYLE]};POEM.epigraph.push(SECTION);const BODY={image:"image",title:["section",{p:["h1",STYLE],"empty-line":["br"]}],epigraph:["section",SECTION],section:["section",SECTION]},getImageSrc=e=>{const t=e.getAttributeNS(NS.XLINK,"href");var[,r]=t.split("#");const i=e.getRootNode().getElementById(r);return i?`data:${i.getAttribute("content-type")};base64,${i.textContent}`:t};class FB2Converter{constructor(e){this.fb2=e,this.doc=document.implementation.createDocument(NS.XHTML,"html")}image(e){const t=this.doc.createElement("img");return t.alt=e.getAttribute("alt"),t.title=e.getAttribute("title"),t.setAttribute("src",getImageSrc(e)),t}anchor(e){const t=this.convert(e,{a:["a",STYLE]});return t.setAttribute("href",e.getAttributeNS(NS.XLINK,"href")),"note"===e.getAttribute("type")&&t.setAttributeNS(NS.EPUB,"epub:type","noteref"),t}stanza(e){const t=this.convert(e,{stanza:["p",{title:["header",{p:["strong",STYLE],"empty-line":["br"]}],subtitle:["p",STYLE]}]});for(const r of e.children)"v"===r.nodeName&&(t.append(this.doc.createTextNode(r.textContent)),t.append(this.doc.createElement("br")));return t}convert(e,t){if(3===e.nodeType)return this.doc.createTextNode(e.textContent);if(4===e.nodeType)return this.doc.createCDATASection(e.textContent);if(8===e.nodeType)return this.doc.createComment(e.textContent);var r=t?.[e.nodeName];if(!r)return null;if("string"==typeof r)return this[r](e);var[i,r]=r;const n=this.doc.createElement(i);if(e.id&&(n.id=e.id),n.classList.add(e.nodeName),Array.isArray(r))for(const l of r)n.setAttribute(l,e.getAttribute(l));var a="self"===r?t:Array.isArray(r)?null:r;let o=e.firstChild;for(;o;){var s=this.convert(o,a);s&&n.append(s),o=o.nextSibling}return n}}const parseXML=async e=>{var t=await e.arrayBuffer();const r=new TextDecoder("utf-8").decode(t),i=new DOMParser;e=i.parseFromString(r,MIME.XML);const n=e.xmlEncoding||r.match(/^<\?xml\s+version\s*=\s*["']1.\d+"\s+encoding\s*=\s*["']([A-Za-z0-9._-]*)["']/)?.[1];if(n&&"utf-8"!==n.toLowerCase()){const r=new TextDecoder(n).decode(t);return i.parseFromString(r,MIME.XML)}return e},style=URL.createObjectURL(new Blob([`
@namespace epub "http://www.idpf.org/2007/ops";
body > img, section > img {
    display: block;
    margin: auto;
}
.title {
    text-align: center;
}
body > section > .title, body.notesBodyType > .title {
    margin: 3em 0;
}
body.notesBodyType > section .title {
    text-align: left;
    margin: 1em 0;
}
p {
    text-indent: 1em;
    margin: 0;
}
:not(p) + p, p:first-child {
    text-indent: 0;
}
.poem p {
    text-indent: 0;
    margin: 1em 0;
}
.text-author, .date {
    text-align: end;
}
.text-author:before {
    content: "";
}
table {
    border-collapse: collapse;
}
td, th {
    padding: .25em;
}
a[epub|type~="noteref"] {
    font-size: .75em;
    vertical-align: super;
}
body:not(.notesBodyType) > .title, body:not(.notesBodyType) > .epigraph {
    margin: 3em 0;
}
`],{type:"text/css"})),template=e=>`<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head><link href="${style}" rel="stylesheet" type="text/css"/></head>
    <body>${e}</body>
</html>`,dataID="data-foliate-id",makeFB2=async e=>{const t={},r=await parseXML(e),i=new FB2Converter(r),n=e=>r.querySelector(e);var a=e=>[...r.querySelectorAll(e)],o=e=>{var t=getElementText(e.querySelector("nickname"));if(t)return t;const r=getElementText(e.querySelector("first-name")),i=getElementText(e.querySelector("middle-name")),n=getElementText(e.querySelector("last-name"));return{name:[r,i,n].filter(e=>e).join(" "),sortAs:n?[n,[r,i].filter(e=>e).join(" ")].join(", "):null}},s=e=>e?.getAttribute("value")??getElementText(e),e=n("title-info annotation");t.metadata={title:getElementText(n("title-info book-title")),identifier:getElementText(n("document-info id")),language:getElementText(n("title-info lang")),author:a("title-info author").map(o),translator:a("title-info translator").map(o),producer:a("document-info author").map(o).concat(a("document-info program-used").map(getElementText)),publisher:getElementText(n("publish-info publisher")),published:s(n("title-info date")),modified:s(n("document-info date")),description:e?i.convert(e,{annotation:["div",SECTION]}).innerHTML:null,subject:a("title-info genre").map(getElementText)},t.getCover=()=>fetch(getImageSrc(n("coverpage image"))).then(e=>e.blob());const l=Array.from(r.querySelectorAll("body"),e=>{e=i.convert(e,{body:["body",BODY]});return[Array.from(e.children,e=>{var t=[e,...e.querySelectorAll("[id]")].map(e=>e.id);return{el:e,ids:t}}),e]}),c=l[0][0].map(({el:e,ids:t})=>{return{ids:t,titles:Array.from(e.querySelectorAll(":scope > section > .title"),(e,t)=>(e.setAttribute(dataID,t),{title:getElementText(e),index:t})),el:e}}).concat(l.slice(1).map(([e,t])=>{e=e.map(e=>e.ids).flat();return t.classList.add("notesBodyType"),{ids:e,el:t,linear:"no"}})).map(({ids:e,titles:t,el:r,linear:i})=>{const n=template(r.outerHTML);var a=new Blob([n],{type:MIME.XHTML});const o=URL.createObjectURL(a);return{ids:e,title:trim(r.querySelector(".title, .subtitle, p")?.textContent??(r.classList.contains("title")?r.textContent:"")),titles:t,load:()=>o,createDocument:()=>(new DOMParser).parseFromString(n,MIME.XHTML),size:a.size-Array.from(r.querySelectorAll("[src]"),e=>e.getAttribute("src")?.length??0).reduce((e,t)=>e+t,0),linear:i}}),d=new Map;return t.sections=c.map((e,t)=>{var{ids:r,load:i,createDocument:n,size:a,linear:e}=e;for(const o of r)o&&d.set(o,t);return{id:t,load:i,createDocument:n,size:a,linear:e}}),t.toc=c.map(({title:e,titles:t},r)=>{const i=r.toString();return{label:e,href:i,subitems:t?.length?t.map(({title:e,index:t})=>({label:e,href:`${i}#${t}`})):null}}).filter(e=>e),t.resolveHref=e=>{const[t,r]=e.split("#");return t?{index:Number(t),anchor:e=>e.querySelector(`[${dataID}="${r}"]`)}:{index:d.get(r),anchor:e=>e.getElementById(r)}},t.splitTOCHref=e=>e?.split("#")?.map(e=>Number(e))??[],t.getTOCFragment=(e,t)=>e.querySelector(`[${dataID}="${t}"]`),t};class Fb2Render extends GeneralRender{constructor(e,t,r){super(t,"FB2",r),this.fb2Buffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book||(yield this.parse());let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){try{var e=new Blob([this.fb2Buffer]);this.book=yield makeFB2(e)}catch(e){throw console.log(e),e}})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}getMetadata(){return __awaiter(this,void 0,void 0,function*(){try{this.book||(yield this.parse());let e=new GeneralParser(this.book);return yield e.getMetadata()}catch(e){throw console.log(e),e}})}}const makeCacheBook=a=>__awaiter(void 0,void 0,void 0,function*(){let i=yield window.JSZip.loadAsync(a);var e=i.file("toc.json");let t=[];e&&(t=JSON.parse(yield e.async("string")));e=i.file("sections.json");let r=[];e&&(r=JSON.parse(yield e.async("string")));const n={getCover:()=>""};return n.sections=r.map((e,t)=>({id:e.href,load:()=>(r=>__awaiter(void 0,void 0,void 0,function*(){var e=i.file("chapters/"+r+".html");let t="";return e&&(t=yield e.async("string")),URL.createObjectURL(new Blob([t],{type:"text/html"}))}))(t),unload:()=>{},loadAsset:e=>(r=>__awaiter(void 0,void 0,void 0,function*(){var e=i.file(r);let t="";return e&&(t=yield e.async("arraybuffer")),URL.createObjectURL(new Blob([t],{type:mimetype[r.split(".").reverse()[0]]}))}))(e)})),n.toc=t.map(e=>({label:e.label,href:e.href,subitems:e.subitems})),n.rendition={layout:"pre-paginated"},n.resolveHref=e=>({index:window._.findLastIndex(r,{href:e})}),n.splitTOCHref=e=>[e,null],n.getTOCFragment=e=>e.documentElement,n});class CacheRender extends GeneralRender{constructor(e,t,r){super(t,"CACHE",r),this.cacheBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book=yield makeCacheBook(this.cacheBuffer);let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}}class DocxRender extends GeneralRender{constructor(e,t,r){super(t,"DOCX",r),this.docxBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book||(yield this.parse());let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){return new Promise((t,r)=>{try{window.mammoth.convertToHtml({arrayBuffer:this.docxBuffer}).then(e=>__awaiter(this,void 0,void 0,function*(){this.book=makeHtmlBook(e.value,!1),t()}))}catch(e){console.log(e),r(e)}})})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}}class MdRender extends GeneralRender{constructor(e,t,r){super(t,"MD",r),this.mdBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book||(yield this.parse());let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){return new Promise((r,t)=>{try{var e=new Blob([this.mdBuffer],{type:"text/plain"}),i=new FileReader;i.onload=t=>__awaiter(this,void 0,void 0,function*(){var e=window.marked(null===(e=t.target)||void 0===e?void 0:e.result);this.book=makeHtmlBook(e,!1),r()}),i.readAsText(e,"UTF-8")}catch(e){console.log(e),t(e)}})})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}}class HtmlRender extends GeneralRender{constructor(e,t,r,i){super(t,r,i),this.htmlBuffer=e,this.mode=t,this.format=r,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(r){return new Promise((t,e)=>__awaiter(this,void 0,void 0,function*(){this.element=r,this.book||(yield this.parse());let e=new GeneralParser(this.book);this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),createIframe(r),handleLayout(r,this.mode),t()}))}parse(){return __awaiter(this,void 0,void 0,function*(){return new Promise((i,t)=>{try{var e=new Blob([this.htmlBuffer],{type:mimetype[this.format.toLocaleLowerCase()]}),r=new FileReader;r.onload=r=>__awaiter(this,void 0,void 0,function*(){var e;let t=null===(e=r.target)||void 0===e?void 0:e.result;"MHTML"===this.format&&(t=window.mhtml2html.convert(t).window.document.documentElement.innerHTML),this.book=makeHtmlBook(t,!1),i()}),r.readAsText(e,"UTF-8")}catch(e){console.log(e),t(e)}})})}preCache(){return __awaiter(this,void 0,void 0,function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)})}}window.e=window.eval,window.a=window.atob;export{CacheRender,ComicRender,DocxRender,EpubRender,Fb2Render,HtmlRender,MdRender,MobiRender,PdfRender,TxtRender};
